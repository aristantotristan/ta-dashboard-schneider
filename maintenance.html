<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Log</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        /* TEMA */
        :root { --bg: #f0f2f5; --card: #fff; --text: #333; --red: #c62828; --green: #2e7d32; --blue: #1565c0; --gray: #546e7a; }
        [data-theme="dark"] { --bg: #0a192f; --card: #172a45; --text: #e0e0e0; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; transition: 0.3s; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Header & Controls */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .controls-bar {
            background: var(--card); padding: 15px; border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px;
            display: flex; align-items: center; gap: 15px; flex-wrap: wrap;
        }
        
        input[type="date"] { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; color: #333; }

        .btn { padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; text-decoration: none; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        .btn-back { background: #78909c; color: white; }
        .btn-refresh { background: var(--blue); color: white; }
        .btn-all { background: var(--gray); color: white; }
        .btn-export { background: var(--green); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); transition: 0.2s; }

        .log-card { background: var(--card); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ccc; }
        th { background: rgba(0,0,0,0.05); font-weight: bold; }
        
        .badge { padding: 5px 10px; border-radius: 4px; color: white; font-size: 0.8em; font-weight: bold; }
        .badge-TIMEOUT { background: var(--red); }
        .badge-TIMEOUT_CLOUD { background: #d32f2f; }
        .badge-RECOVERY { background: var(--green); }
        
        @media (max-width: 600px) {
            .header { flex-direction: column; align-items: flex-start; }
            .controls-bar { flex-direction: column; align-items: stretch; }
            th, td { padding: 10px; font-size: 0.85em; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <a href="index.html" class="btn btn-back">&#8592; Menu Utama</a>
            <h1 style="margin:0; font-size:1.5em;">Maintenance Log</h1>
        </div>
        <button onclick="exportAndReset()" class="btn btn-export">üì• Export & Reset</button>
    </div>

    <div class="controls-bar">
        <button onclick="fetchRecentLogs()" class="btn btn-all">üìÇ Lihat Semua Riwayat</button>
        <div style="width: 1px; height: 30px; background: #ccc; margin: 0 10px;"></div>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <label style="font-size:0.85em; font-weight:bold;">Cari Tanggal:</label>
            <input type="date" id="filter-date">
        </div>
        <button onclick="fetchLogsByDate()" class="btn btn-refresh" style="margin-top:auto;">üîç Cari</button>
    </div>

    <div class="log-card">
        <table id="log-table">
            <thead>
                <tr>
                    <th>Waktu</th>
                    <th>Mesin</th>
                    <th>Status</th>
                    <th>Keterangan</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="4" style="text-align:center; padding:30px;">Menghubungkan ke Database...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // --- CONFIG SUPABASE (Ganti dengan punya Anda) ---
    const SUPABASE_URL = "https://khevzqqtswbdatbkkmme.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoZXZ6cXF0c3diZGF0YmtrbW1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MTY4MDgsImV4cCI6MjA3OTA5MjgwOH0.N28mnbk8tTAJkm47DS2pzvsHHChlyCovT6vi2Z4aqHc"; 
    
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    let rawLogData = [];

    // --- 1. SAAT DIBUKA, LANGSUNG AMBIL SEMUA DATA ---
    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filter-date').value = today;
        fetchRecentLogs();
    };

    // Fungsi ambil data TERBARU (Bebas Tanggal)
    async function fetchRecentLogs() {
        const tbody = document.querySelector("#log-table tbody");
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Memuat semua riwayat...</td></tr>';

        try {
            // Ambil 100 data terakhir
            const { data, error } = await supabaseClient
                .from('system_logs')
                .select('*')
                .order('created_at', { ascending: false }) 
                .limit(100); 

            if (error) throw error;
            renderTable(data, "Database Kosong / Bersih.");

        } catch (err) {
            console.error("Error:", err);
            tbody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">Gagal: ${err.message}</td></tr>`;
        }
    }

    // Fungsi ambil data SPESIFIK TANGGAL
    async function fetchLogsByDate() {
        const dateVal = document.getElementById('filter-date').value;
        if(!dateVal) { alert("Pilih tanggal dulu!"); return; }

        const tbody = document.querySelector("#log-table tbody");
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Mencari data...</td></tr>';

        try {
            const startOfDay = dateVal + "T00:00:00";
            const endOfDay = dateVal + "T23:59:59";

            const { data, error } = await supabaseClient
                .from('system_logs')
                .select('*')
                .gte('created_at', startOfDay)
                .lte('created_at', endOfDay)
                .order('created_at', { ascending: false });

            if (error) throw error;
            renderTable(data, `Tidak ada log error pada tanggal ${dateVal}.`);

        } catch (err) {
            console.error("Error:", err);
            tbody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">Gagal: ${err.message}</td></tr>`;
        }
    }

    function renderTable(data, emptyMsg) {
        const tbody = document.querySelector("#log-table tbody");
        rawLogData = data; 

        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px; color:green;">‚úÖ ${emptyMsg}</td></tr>`;
            return;
        }

        let html = "";
        data.forEach(row => {
            const time = new Date(row.created_at).toLocaleString('id-ID', { day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit' });
            // Warna badge
            let badgeClass = 'badge-RECOVERY';
            if (row.event_type.includes('TIMEOUT')) badgeClass = 'badge-TIMEOUT';
            if (row.event_type.includes('CLOUD')) badgeClass = 'badge-TIMEOUT_CLOUD';
            
            html += `
                <tr>
                    <td>${time}</td>
                    <td style="font-weight:bold;">Mesin ${row.machine_id}</td>
                    <td><span class="badge ${badgeClass}">${row.event_type}</span></td>
                    <td>${row.description}</td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }

    // --- FUNGSI EXPORT ---
    async function exportAndReset() {
        if (rawLogData.length === 0) { alert("Tidak ada data di tampilan saat ini untuk diekspor!"); return; }
        if (!confirm("Yakin mau Export ke Excel lalu MENGHAPUS database?")) return;

        try {
            const excelData = rawLogData.map(row => ({
                ID_Log: row.id, Waktu: new Date(row.created_at).toLocaleString('id-ID'),
                Mesin: row.machine_id, Tipe: row.event_type, Keterangan: row.description
            }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Logs");
            XLSX.writeFile(wb, `Maintenance_Log.xlsx`);

            // Hapus data setelah download (Opsional, aktifkan jika perlu)
            // await supabaseClient.from('system_logs').delete().gt('id', 0);
            // fetchRecentLogs(); 

        } catch (err) { alert("Error: " + err.message); }
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monitoring 18 Mesin</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
    font-family: Arial;
    background: #111;
    color: white;
}
.container {
    padding: 20px;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}
table, th, td {
    border: 1px solid white;
}
th {
    background: #222;
}
</style>
</head>

<body>
<div class="container">

<h2>Monitoring 18 Mesin</h2>

<label>Dari tanggal:</label>
<input type="date" id="startDate">

<label>Sampai tanggal:</label>
<input type="date" id="endDate">

<button onclick="loadAllMachines()">TAMPILKAN SEMUA</button>
<button onclick="exportExcel()">EXPORT EXCEL</button>

<div id="dashboard"></div>

</div>

<script>
/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
    apiKey: "ISI PUNYA MU",
    authDomain: "ISI PUNYA MU",
    databaseURL: "ISI PUNYA MU",
    projectId: "ISI PUNYA MU",
    storageBucket: "ISI PUNYA MU",
    messagingSenderId: "ISI PUNYA MU",
    appId: "ISI PUNYA MU"
};
firebase.initializeApp(firebaseConfig);


/* ---------------- LOAD SEMUA MESIN ---------------- */
function loadAllMachines() {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;

    if (!start || !end) {
        alert("Isi tanggal dulu bro!");
        return;
    }

    const dashboard = document.getElementById("dashboard");
    dashboard.innerHTML = ""; // hapus tampilan lama

    for (let i = 1; i <= 18; i++) {
        let sid = i.toString().padStart(2, "0");

        const div = document.createElement("div");
        div.innerHTML = `
            <h3>SID ${sid}</h3>
            <table class="machine-table" id="table-SID${sid}" data-sid="SID_${sid}">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>SID</th>
                        <th>LWBP_kWh</th>
                        <th>LWBP_Rp</th>
                        <th>WBP_kWh</th>
                        <th>WBP_Rp</th>
                        <th>Total_kWh</th>
                        <th>Total_Rp</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        `;
        dashboard.appendChild(div);

        loadMachineData(sid, start, end);
    }
}


/* ---------------- LOAD DATA PER MESIN ---------------- */
function loadMachineData(sid, start, end) {
    const ref = firebase.database().ref("MeterHistory/SID" + sid);

    ref.orderByKey().startAt(start).endAt(end).once("value", snapshot => {
        const tbody = document.querySelector(`#table-SID${sid} tbody`);
        tbody.innerHTML = "";

        snapshot.forEach(child => {
            let d = child.val();

            let row = `
                <tr>
                    <td>${child.key}</td>
                    <td>${sid}</td>
                    <td>${d.LWBP_kWh || 0}</td>
                    <td>${d.LWBP_Rp || 0}</td>
                    <td>${d.WBP_kWh || 0}</td>
                    <td>${d.WBP_Rp || 0}</td>
                    <td>${d.Total_kWh || 0}</td>
                    <td>${d.Total_Rp || 0}</td>
                </tr>
            `;

            tbody.innerHTML += row;
        });
    });
}


/* ---------------- EXPORT EXCEL 18 SHEET OTOMATIS ---------------- */
function exportExcel() {
    const wb = XLSX.utils.book_new();

    const tables = document.querySelectorAll(".machine-table");

    tables.forEach((table, index) => {
        let sidName = table.getAttribute("data-sid") || `SID_${index+1}`;
        const ws = XLSX.utils.table_to_sheet(table);
        XLSX.utils.book_append_sheet(wb, ws, sidName);
    });

    XLSX.writeFile(wb, "MASTER_18SID.xlsx");
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Master Power Meter • Monitoring 18 Mesin</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#000000; --card:#0f0f0f; --glow:#00e5bd; --text:#e0f2fe; --muted:#8b949e; --border:#1a1a1a;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh;}
    
    header{text-align:center;padding:3rem 1rem 2rem;}
    h1{
      font-family:'Orbitron',sans-serif;
      font-size:4rem;
      font-weight:900;
      background:linear-gradient(135deg,#00e5bd,#00ffee);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow:0 0 50px rgba(0,229,189,0.45);
    }
    .subtitle{
      color:var(--muted);
      font-size:1.2rem;
      margin-top:1rem;
      letter-spacing:4px;
      text-transform:uppercase;
    }

    /* BLOCK DASHBOARD MESIN */
    .dashboard-block{
      background:#0f0f0f;
      border:1px solid var(--border);
      border-radius:20px;
      padding:2rem;
      margin:2rem auto;
      max-width:1300px;
      box-shadow:0 0 25px #000;
    }

    .machine-title h2{
      font-family:'Orbitron';
      color:var(--glow);
      font-size:1.8rem;
      margin-bottom:1.5rem;
    }

    .filter-row{
      display:grid;
      grid-template-columns:1fr 1fr auto auto;
      gap:20px;
      margin-bottom:1.5rem;
    }

    input[type="date"]{
      padding:1rem;
      border-radius:14px;
      border:2px solid var(--glow);
      background:#000;
      color:white;
      font-size:1rem;
      width:100%;
    }

    .load-btn,.excel-btn{
      padding:1rem 2rem;
      background:var(--glow);
      color:#000;
      border:none;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
    }

    .status{
      color:var(--glow);
      margin-bottom:1rem;
      font-size:1.1rem;
      font-weight:700;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:1.1rem;
      background:#0d0d0d;
      border-radius:18px;
      overflow:hidden;
    }
    th,td{
      padding:14px 12px;
      text-align:center;
    }
    th{
      background:#00e5bd;
      color:#000;
      font-family:'Orbitron';
      font-weight:900;
    }
    td{
      border-bottom:1px solid #1a1a1a;
      color:#e0f2fe;
      font-weight:bold;
    }

  </style>
</head>

<body>

<header>
  <h1>MASTER POWER METER</h1>
  <p class="subtitle">Monitoring Konsumsi Daya LWBP & WBP — 18 Mesin</p>
</header>

<div id="dashboardContainer"></div>

<script>
/* ===================== NAMA MESIN ===================== */
const MACHINE_TAGS = {
    1:'UNKNOW',2:'UNKNOW',3:'POMPA MC 12',4:'MC 9',5:'UNKNOW',6:'MC 40',7:'MC 39',8:'MC 6',
    9:'HEATER MC 5',10:'POMPA MC 5',11:'UNKNOW',12:'MC 34',13:'MC 35',14:'UNKNOW',15:'UNKNOW',
    16:'MC 38',17:'MC 36',18:'MC 37'
};

/* ===================== SUPABASE ===================== */
const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const TABLE_NAME = "daily_meter_summary";

/* ===================== TARIF ===================== */
const TARIF_LWBP = 1135;
const TARIF_WBP  = 996.74;

/* Cache per mesin */
let cachedData = {};

/* ===================== BUAT 18 MESIN ===================== */
function createDashboard() {
    const container = document.getElementById('dashboardContainer');

    for (let i = 1; i <= 18; i++) {
        const block = document.createElement('div');
        block.className = "dashboard-block";

        block.innerHTML = `
            <div class="machine-title">
                <h2>${MACHINE_TAGS[i]} • SID ${i}</h2>
            </div>

            <div class="filter-row">
                <div>
                    <label>Tanggal Awal</label>
                    <input type="date" id="start_${i}">
                </div>
                <div>
                    <label>Tanggal Akhir</label>
                    <input type="date" id="end_${i}">
                </div>
                <div>
                    <button class="load-btn" onclick="loadData(${i})">LOAD</button>
                </div>
                <div>
                    <button class="excel-btn" onclick="exportExcel(${i})">EXPORT</button>
                </div>
            </div>

            <div class="status" id="status_${i}">Masukkan tanggal lalu klik LOAD</div>

            <table>
                <thead>
                    <tr>
                        <th>MESIN</th>
                        <th>TGL AWAL</th>
                        <th>TGL AKHIR</th>
                        <th>LWBP kWh</th>
                        <th>LWBP Rp</th>
                        <th>WBP kWh</th>
                        <th>WBP Rp</th>
                        <th>Total kWh</th>
                        <th>Total Rp</th>
                    </tr>
                </thead>
                <tbody id="table_${i}">
                    <tr><td colspan="9">Belum ada data</td></tr>
                </tbody>
            </table>
        `;

        container.appendChild(block);
    }
}
createDashboard();

/* ===================== LOAD DATA PER MESIN ===================== */
async function loadData(id) {
  const start = document.getElementById(`start_${id}`).value;
  const end   = document.getElementById(`end_${id}`).value;
  const status = document.getElementById(`status_${id}`);

  if (!start || !end) {
      status.textContent = "Tanggal belum lengkap";
      return;
  }

  status.textContent = "Mengambil data...";

  const { data, error } = await supabase
    .from(TABLE_NAME)
    .select('tanggal, sid_mesin, lwbp_total, wbp_total')
    .eq('sid_mesin', id)
    .gte('tanggal', start)
    .lte('tanggal', end)
    .order('tanggal', { ascending: true });

  if (error) {
    status.textContent = "ERROR: " + error.message;
    return;
  }

  cachedData[id] = data;

  let totalLwbp = 0;
  let totalWbp = 0;

  data.forEach(row => {
      totalLwbp += parseFloat(row.lwbp_total || 0);
      totalWbp  += parseFloat(row.wbp_total || 0);
  });

  const totalKwh = totalLwbp + totalWbp;
  const totalRp = totalLwbp*TARIF_LWBP + totalWbp*TARIF_WBP;

  const tbody = document.getElementById(`table_${id}`);

  tbody.innerHTML = `
    <tr>
      <td>${id}</td>
      <td>${start}</td>
      <td>${end}</td>
      <td>${totalLwbp.toFixed(2)}</td>
      <td>${(totalLwbp*TARIF_LWBP).toLocaleString('id-ID')}</td>
      <td>${totalWbp.toFixed(2)}</td>
      <td>${(totalWbp*TARIF_WBP).toLocaleString('id-ID')}</td>
      <td>${totalKwh.toFixed(2)}</td>
      <td>${totalRp.toLocaleString('id-ID')}</td>
    </tr>
  `;

  status.textContent = `Sukses ✓ (${data.length} hari ditemukan)`;
}

/* ===================== EXPORT EXCEL ===================== */
function exportExcel(id) {
  if (!cachedData[id] || cachedData[id].length === 0) {
      alert("Belum ada data untuk diekspor");
      return;
  }

  const rows = cachedData[id].map(r => ({
      Tanggal: r.tanggal,
      SID_Mesin: r.sid_mesin,
      LWBP_kWh: r.lwbp_total,
      LWBP_Rp: r.lwbp_total * TARIF_LWBP,
      WBP_kWh: r.wbp_total,
      WBP_Rp: r.wbp_total * TARIF_WBP,
      Total_Rp: r.lwbp_total*TARIF_LWBP + r.wbp_total*TARIF_WBP
  }));

  const worksheet = XLSX.utils.json_to_sheet(rows);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, `SID_${id}`);

  XLSX.writeFile(workbook, `MESIN_SID_${id}.xlsx`);
}

</script>
</body>
</html>

<script>
// =======================================================
// --- KONFIGURASI SUPABASE ---
// GANTI DENGAN KREDENSIAL SUPABASE ANDA YANG ASLI
// =======================================================
const SUPA_URLÂ  = "https://rojhcadtqfynlqzubftx.supabase.co"; // Ganti URL
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs"; // Ganti Kunci ANON

let supa = supabase.createClient(SUPA_URL, SUPA_ANON);

// --- KONFIGURASI NAMA TABEL BARU ---
// Gunakan tabel final setelah data dikunci di jam 00:05 WIB
const FINAL_RESULT_TABLE = 'final_daily_result'; 
// Jika Anda ingin melihat data real-time HARI INI, ganti ke: 'wbp_lwbp_summary'
// const FINAL_RESULT_TABLE = 'wbp_lwbp_summary'; 

// --- DOM ELEMENTS ---
const wbpTableBody = document.querySelector('#wbpTable tbody');
const lwbpTableBody = document.querySelector('#lwbpTable tbody');
const analysisStatus = document.getElementById('analysisStatus');
const analysisDateInput = document.getElementById('analysisDate');


/**
 * Mengambil data FINAL dari tabel final_daily_result, difilter berdasarkan tanggal.
 */
async function renderDailyConsumptionData() {
    const targetDate = analysisDateInput.value;
    
    if (!targetDate) {
        analysisStatus.textContent = "Silakan pilih tanggal analisis.";
        return;
    }

    analysisStatus.textContent = `Sedang mengambil data final untuk tanggal ${targetDate}...`;
    wbpTableBody.innerHTML = '<tr><td colspan="4">Memuat...</td></tr>'; // Ubah colspan
    lwbpTableBody.innerHTML = '<tr><td colspan="4">Memuat...</td></tr>'; // Ubah colspan

    try {
        // --- AMBIL DATA DARI TABEL FINAL RESULT ---
        const { data: finalData, error } = await supa
            .from(FINAL_RESULT_TABLE)
            .select('tanggal, id_mesin, konsumsi_lwbp_kwh, konsumsi_wbp_kwh, konsumsi_total_harian')
            .eq('tanggal', targetDate) // FILTER BERDASARKAN TANGGAL!
            .order('id_mesin', { ascending: true });

        if (error) throw error;
        
        // --- CEK DATA ---
        if (finalData.length === 0) {
            analysisStatus.textContent = `Data final untuk tanggal ${targetDate} belum tersedia atau belum difinalisasi (jam 00:05 WIB).`;
            wbpTableBody.innerHTML = '<tr><td colspan="4">Tidak ada hasil final ditemukan.</td></tr>';
            lwbpTableBody.innerHTML = '<tr><td colspan="4">Tidak ada hasil final ditemukan.</td></tr>';
            return;
        }

        // --- RENDER TABEL WBP dan LWBP (Menggunakan data yang sama) ---
        wbpTableBody.innerHTML = '';
        lwbpTableBody.innerHTML = ''; 

        finalData.forEach(row => {
            // Data WBP
            const trWBP = wbpTableBody.insertRow();
            trWBP.insertCell().textContent = row.id_mesin;
            trWBP.insertCell().textContent = row.tanggal;
            // Kolom Ea Start/End dihapus, diganti dengan Total Konsumsi Harian
            trWBP.insertCell().textContent = row.konsumsi_total_harian ? row.konsumsi_total_harian.toFixed(2) : '---';
            trWBP.insertCell().textContent = row.konsumsi_lwbp_kwh ? row.konsumsi_lwbp_kwh.toFixed(2) : '---'; // Tambahan info LWBP

            const wbpCell = trWBP.insertCell();
            wbpCell.textContent = row.konsumsi_wbp_kwh.toFixed(2);
            wbpCell.style.fontWeight = 'bold';
            wbpCell.style.backgroundColor = '#4c0519';

            // Data LWBP
            const trLWBP = lwbpTableBody.insertRow();
            trLWBP.insertCell().textContent = row.id_mesin;
            trLWBP.insertCell().textContent = row.tanggal;
            trLWBP.insertCell().textContent = row.konsumsi_total_harian.toFixed(2);
            trLWBP.insertCell().textContent = row.konsumsi_wbp_kwh.toFixed(2);
            
            const lwbpCell = trLWBP.insertCell();
            lwbpCell.textContent = row.konsumsi_lwbp_kwh.toFixed(2);
            lwbpCell.style.fontWeight = 'bold';
            lwbpCell.style.backgroundColor = '#065f46';
        });

        analysisStatus.textContent = `Data final berhasil diambil untuk ${finalData.length} mesin pada tanggal ${targetDate}.`;
        
    } catch (e) {
        analysisStatus.textContent = `Gagal memuat data final: ${e.message}`;
        console.error("Error fetching daily consumption data:", e);
    }
}

// Atur tanggal default ke hari ini saat halaman dimuat
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().slice(0, 10);
    analysisDateInput.value = today;
});

</script>

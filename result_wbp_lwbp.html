<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Master Power Meter • Analisis Konsumsi</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0e17;--card:#111827;--accent:#00e5bd;--text:#e2e8f0;--muted:#94a3b8;--border:#1f2937;
      --lwbp:#065f46;--wbp:#7f1d1d;--total:#004d40;--online:#00d4aa;--offline:#ef4444;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden}
    h1{font-size:2.8rem;font-weight:700;color:var(--accent);text-align:center;margin:2rem 0 1rem;text-shadow:0 0 30px rgba(0,229,189,0.4)}
    .subtitle{text-align:center;color:var(--muted);margin-bottom:2rem;font-size:1.1rem}

    /* MENU UTAMA - 18 KARTU */
    #mainMenu{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.8rem;padding:0 2rem;max-width:1800px;margin:0 auto}
    .machine-card{
      background:var(--card);border:1px solid var(--border);border-radius:16px;padding:2rem 1.5rem;cursor:pointer;position:relative;overflow:hidden;
      transition:all .4s;box-shadow:0 10px 30px rgba(0,0,0,0.4)
    }
    .machine-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);opacity:0;transition:opacity .4s}
    .machine-card:hover{transform:translateY(-12px);border-color:var(--accent);box-shadow:0 20px 50px rgba(0,229,189,0.2)}
    .machine-card:hover::before{opacity:1}
    .card-title{font-size:1.4rem;font-weight:600;margin-bottom:0.5rem}
    .card-id{font-family:'JetBrains Mono',monospace;color:var(--accent);font-size:1.1rem}
    .status-dot{position:absolute;top:16px;right:16px;width:14px;height:14px;border-radius:50%;background:var(--offline);box-shadow:0 0 15px var(--offline)}

    /* PANEL ANALISIS */
    #analysisPanel{display:none;background:var(--bg);min-height:100vh;padding:2rem 1rem}
    .back-btn{
      position:fixed;top:20px;left:20px;background:var(--accent);color:#000;padding:12px 20px;border:none;border-radius:50px;
      font-weight:700;cursor:pointer;z-index:999;box-shadow:0 8px 25px rgba(0,229,189,0.4);transition:all .3s
    }
    .back-btn:hover{transform:scale(1.05)}
    .analysis-title{font-size:2.2rem;color:var(--accent);text-align:center;margin:1rem 0 2rem}

    /* Filter & Tabel sama seperti sebelumnya */
    .filter-panel{background:var(--card);padding:2rem;border-radius:16px;max-width:900px;margin:2rem auto;border:1px solid var(--border)}
    .filter-grid{display:grid;grid-template-columns:1fr 1fr auto;gap:1.2rem;align-items:end}
    input[type="date"]{padding:0.9rem;border-radius:8px;border:1px solid var(--border);background:#1a1a1a;color:white;font-family:'JetBrains Mono'}
    button{padding:0.9rem 2rem;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer}
    button:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(0,229,189,0.4)}

    .table-container{max-width:1400px;margin:2rem auto;overflow-x:auto;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
    table{width:100%;border-collapse:collapse;background:var(--card)}
    th{background:#1a1a1a;color:var(--accent);padding:1rem;text-transform:uppercase;font-size:0.9rem;letter-spacing:1px}
    td{padding:1rem;text-align:center;border-bottom:1px solid var(--border)}
    tbody tr:hover{background:rgba(0,229,189,0.06)}
    .lwbp{background:var(--lwbp);color:white;font-weight:bold}
    .wbp{background:var(--wbp);color:white;font-weight:bold}
    .total{background:var(--total);color:white;font-weight:bold}
    .footer-total{background:#001f1a !important;font-weight:800;font-size:1.2rem}
    .status{margin:1.5rem auto;text-align:center;max-width:900px;font-style:italic;color:var(--muted)}
  </style>
</head>
<body>

  <!-- MENU UTAMA -->
  <div id="mainMenu">
    <h1>Master Power Meter</h1>
    <p class="subtitle">Pilih mesin untuk melihat analisis konsumsi & biaya listrik</p>
    <div id="cardsContainer"></div>
  </div>

  <!-- PANEL ANALISIS -->
  <div id="analysisPanel">
    <button class="back-btn" onclick="backToMenu()">Kembali ke Menu Utama</button>
    <h2 class="analysis-title" id="selectedMachine">Analisis Konsumsi • Mesin --</h2>
    
    <div class="filter-panel">
      <div class="filter-grid">
        <div><label>Tanggal Awal</label><input type="date" id="startDate"></div>
        <div><label>Tanggal Akhir</label><input type="date" id="endDate"></div>
        <div><button onclick="loadData()">Tampilkan Data</button></div>
      </div>
      <div class="status" id="status">Pilih rentang tanggal lalu klik "Tampilkan Data"</div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Tgl Awal</th>
            <th>Tgl Akhir</th>
            <th colspan="2" class="lwbp">LWBP</th>
            <th colspan="2" class="wbp">WBP</th>
            <th colspan="2" class="total">TOTAL</th>
          </tr>
          <tr>
            <th>Mesin</th><th></th><th></th>
            <th>kWh</th><th>Rp</th><th>kWh</th><th>Rp</th><th>kWh</th><th>Rp</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td id="mesinId">-</td>
            <td id="tglAwal">-</td>
            <td id="tglAkhir">-</td>
            <td id="lwbpKwh" class="lwbp">-</td>
            <td id="lwbpRp" class="lwbp">-</td>
            <td id="wbpKwh" class="wbp">-</td>
            <td id="wbpRp" class="wbp">-</td>
            <td id="totalKwh" class="total">-</td>
            <td id="totalRp" class="total">-</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const MACHINE_TAGS = {
      1:'UNKNOW',2:'UNKNOW',3:'POMPA MC 12',4:'MC 9',5:'UNKNOW',6:'MC 40',7:'MC 39',8:'MC 6',
      9:'HEATER MC 5',10:'POMPA MC 5',11:'UNKNOW',12:'MC 34',13:'MC 35',14:'UNKNOW',15:'UNKNOW',
      16:'MC 38',17:'MC 36',18:'MC 37'
    };

    const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const TABLE_NAME = 'final_calculation_base';

    const TARIF_LWBP = 1352;
    const TARIF_WBP = 1650;

    let selectedMesin = null;

    // Buat 18 kartu
    function createCards() {
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      for (let i = 1; i <= 18; i++) {
        const tag = MACHINE_TAGS[i] || 'UNKNOW';
        const card = document.createElement('div');
        card.className = 'machine-card';
        card.onclick = () => selectMachine(i);
        card.innerHTML = `
          <div class="status-dot"></div>
          <div class="card-title">${tag}</div>
          <div class="card-id">MESIN ${i}</div>
        `;
        container.appendChild(card);
      }
    }

    function selectMachine(id) {
      selectedMesin = id;
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('analysisPanel').style.display = 'block';
      document.getElementById('selectedMachine').textContent = `Analisis Konsumsi • ${MACHINE_TAGS[id]} (Mesin ${id})`;
      document.getElementById('mesinId').textContent = id;

      // Set default tanggal 30 hari terakhir
      const today = new Date().toISOString().split('T')[0];
      const lastMonth = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
      document.getElementById('startDate').value = lastMonth;
      document.getElementById('endDate').value = today;

      loadData();
    }

    function backToMenu() {
      document.getElementById('analysisPanel').style.display = 'none';
      document.getElementById('mainMenu').style.display = 'block';
      selectedMesin = null;
    }

    async function loadData() {
      if (!selectedMesin) return;
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const status = document.getElementById('status');

      if (!start || !end) {
        status.textContent = "Pilih tanggal awal dan akhir!";
        status.style.color = "#f87171";
        return;
      }

      status.textContent = `Mengambil data ${start} → ${end}...`;
      
      try {
        const { data, error } = await supabase
          .from(TABLE_NAME)
          .select('konsumsi_lwbp_kwh, konsumsi_wbp_kwh')
          .eq('id_mesin', selectedMesin)
          .gte('tanggal', start)
          .lte('tanggal', end);

        if (error) throw error;

        let lwbp = 0, wbp = 0;
        data.forEach(row => {
          lwbp += parseFloat(row.konsumsi_lwbp_kwh || 0);
          wbp += parseFloat(row.konsumsi_wbp_kwh || 0);
        });

        const totalKwh = lwbp + wbp;
        const totalRp = (lwbp * TARIF_LWBP) + (wbp * TARIF_WBP);

        document.getElementById('tglAwal').textContent = start;
        document.getElementById('tglAkhir').textContent = end;
        document.getElementById('lwbpKwh').textContent = lwbp.toFixed(2);
        document.getElementById('lwbpRp').textContent = (lwbp * TARIF_LWBP).toLocaleString('id-ID');
        document.getElementById('wbpKwh').textContent = wbp.toFixed(2);
        document.getElementById('wbpRp').textContent = (wbp * TARIF_WBP).toLocaleString('id-ID');
        document.getElementById('totalKwh').textContent = totalKwh.toFixed(2);
        document.getElementById('totalRp').textContent = totalRp.toLocaleString('id-ID');

        status.textContent = `Sukses! ${data.length} hari data berhasil dimuat.`;
        status.style.color = "#86efac";

      } catch (err) {
        status.textContent = `Error: ${err.message}`;
        status.style.color = "#f87171";
      }
    }

    // Init
    createCards();
  </script>
</body>
</html>

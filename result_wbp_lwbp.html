<script>
// =======================================================
// --- KONFIGURASI SUPABASE ---
// PASTIKAN KREDENSIAL INI BENAR
// =======================================================
const SUPA_URLÂ  = "https://rojhcadtqfynlqzubftx.supabase.co"; // Ganti URL
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs"; // Ganti Kunci ANON

// Error: Uncaught ReferenceError: supabase is not defined
// Solusi: Pastikan library di head dimuat sebelum ini dijalankan.
let supa = supabase.createClient(SUPA_URL, SUPA_ANON);

// --- KONFIGURASI NAMA TABEL BARU ---
// Gunakan tabel final setelah data dikunci di jam 00:05 WIB
// Jika data belum dikunci, ganti ke 'final_calculation_base' (VIEW perhitungan)
const DATA_SOURCE_TABLE = 'final_daily_result'; 

// --- DOM ELEMENTS ---
const wbpTableBody = document.querySelector('#wbpTable tbody');
const lwbpTableBody = document.querySelector('#lwbpTable tbody');
const analysisStatus = document.getElementById('analysisStatus');
const analysisDateInput = document.getElementById('analysisDate');


/**
 * Mengambil data harian dari tabel final_daily_result/VIEW, difilter berdasarkan tanggal.
 */
async function renderDailyConsumptionData() {
    const targetDate = analysisDateInput.value;
    
    if (!targetDate) {
        analysisStatus.textContent = "Silakan pilih tanggal analisis.";
        return;
    }

    analysisStatus.textContent = `Sedang mengambil data final untuk tanggal ${targetDate}...`;
    wbpTableBody.innerHTML = '<tr><td colspan="5">Memuat...</td></tr>';
    lwbpTableBody.innerHTML = '<tr><td colspan="5">Memuat...</td></tr>';

    try {
        // --- AMBIL DATA DARI TABEL/VIEW FINAL ---
        const { data: finalData, error } = await supa
            .from(DATA_SOURCE_TABLE) // Gunakan tabel final (atau view kalkulasi)
            .select('tanggal, id_mesin, konsumsi_lwbp_kwh, konsumsi_wbp_kwh, konsumsi_total_harian')
            .eq('tanggal', targetDate) 
            .order('id_mesin', { ascending: true });

        if (error) throw error;
        
        // --- CEK DATA ---
        if (finalData.length === 0) {
            analysisStatus.textContent = `Data final untuk tanggal ${targetDate} belum tersedia.`;
            wbpTableBody.innerHTML = '<tr><td colspan="5">Tidak ada hasil ditemukan.</td></tr>';
            lwbpTableBody.innerHTML = '<tr><td colspan="5">Tidak ada hasil ditemukan.</td></tr>';
            return;
        }

        // --- RENDER TABEL WBP (HEADER: ID, Tanggal, Ea Start, Ea End, Konsumsi WBP) ---
        wbpTableBody.innerHTML = '';
        finalData.forEach(row => {
            const trWBP = wbpTableBody.insertRow();
            trWBP.insertCell().textContent = row.id_mesin;
            trWBP.insertCell().textContent = row.tanggal;
            
            // MENGISI KOLOM LAMA DENGAN DATA DUMMY/TOTAL AGAR TIDAK ERROR
            // Ea Start WBP (kWh) - Kolom 3
            trWBP.insertCell().textContent = row.konsumsi_total_harian ? row.konsumsi_total_harian.toFixed(2) : '---'; 
            // Ea End WBP (kWh) - Kolom 4
            trWBP.insertCell().textContent = row.konsumsi_lwbp_kwh ? row.konsumsi_lwbp_kwh.toFixed(2) : '---'; 

            const wbpCell = trWBP.insertCell(); // Kolom 5
            wbpCell.textContent = row.konsumsi_wbp_kwh.toFixed(2);
            wbpCell.style.fontWeight = 'bold';
            wbpCell.style.backgroundColor = '#4c0519';
        });

        // --- RENDER TABEL LWBP (HEADER: ID, Tanggal, Total Konsumsi, Konsumsi WBP, Konsumsi LWBP) ---
        lwbpTableBody.innerHTML = '';
        finalData.forEach(row => {
            const trLWBP = lwbpTableBody.insertRow();
            trLWBP.insertCell().textContent = row.id_mesin;
            trLWBP.insertCell().textContent = row.tanggal;
            trLWBP.insertCell().textContent = row.konsumsi_total_harian.toFixed(2);
            trLWBP.insertCell().textContent = row.konsumsi_wbp_kwh.toFixed(2);
            
            const lwbpCell = trLWBP.insertCell();
            lwbpCell.textContent = row.konsumsi_lwbp_kwh.toFixed(2);
            lwbpCell.style.fontWeight = 'bold';
            lwbpCell.style.backgroundColor = '#065f46';
        });

        analysisStatus.textContent = `Data final berhasil diambil untuk ${finalData.length} mesin pada tanggal ${targetDate}.`;
        
    } catch (e) {
        analysisStatus.textContent = `Gagal memuat data: ${e.message}`;
        console.error("Error fetching daily consumption data:", e);
    }
}

// Atur tanggal default ke hari ini saat halaman dimuat
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().slice(0, 10);
    analysisDateInput.value = today;
});

</script>

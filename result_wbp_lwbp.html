<script>
// =======================================================
// --- KONFIGURASI SUPABASE ---
// =======================================================
const SUPA_URLÂ  = "https://rojhcadtqfynlqzubftx.supabase.co"; // Ganti URL
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs"; // Ganti Kunci ANON

let supa = supabase.createClient(SUPA_URL, SUPA_ANON);

// Gunakan VIEW perhitungan utama untuk data real-time, atau 'final_daily_result' jika sudah jam 00:05 WIB
const DATA_SOURCE_TABLE = 'final_calculation_base'; 

// --- DOM ELEMENTS ---
const wbpTableBody = document.querySelector('#wbpTable tbody');
const lwbpTableBody = document.querySelector('#lwbpTable tbody');
const analysisStatus = document.getElementById('analysisStatus');
const analysisDateInput = document.getElementById('analysisDate');

// Data mesin (1-13) yang akan selalu ditampilkan sebagai default
const ALL_MESIN_IDS = Array.from({length: 13}, (_, i) => i + 1);


/**
 * Menampilkan data default 0.00 untuk semua mesin.
 */
function renderDefaultTables(targetDate = '---') {
    wbpTableBody.innerHTML = '';
    lwbpTableBody.innerHTML = '';
    
    ALL_MESIN_IDS.forEach(id => {
        const defaultData = {
            id_mesin: id,
            tanggal: targetDate,
            konsumsi_total_harian: 0.00,
            konsumsi_lwbp_kwh: 0.00,
            konsumsi_wbp_kwh: 0.00
        };

        // RENDER TABEL WBP (5 kolom: ID, Tgl, Start, End, Konsumsi WBP)
        const trWBP = wbpTableBody.insertRow();
        trWBP.insertCell().textContent = defaultData.id_mesin;
        trWBP.insertCell().textContent = defaultData.tanggal;
        // Kolom Ea Start WBP (diisi Total Harian)
        trWBP.insertCell().textContent = defaultData.konsumsi_total_harian.toFixed(2); 
        // Kolom Ea End WBP (diisi Konsumsi LWBP)
        trWBP.insertCell().textContent = defaultData.konsumsi_lwbp_kwh.toFixed(2); 

        const wbpCell = trWBP.insertCell();
        wbpCell.textContent = defaultData.konsumsi_wbp_kwh.toFixed(2);
        wbpCell.style.fontWeight = 'bold';
        wbpCell.style.backgroundColor = '#4c0519';
        
        // RENDER TABEL LWBP (5 kolom: ID, Tgl, Total Konsumsi, Konsumsi WBP, Konsumsi LWBP)
        const trLWBP = lwbpTableBody.insertRow();
        trLWBP.insertCell().textContent = defaultData.id_mesin;
        trLWBP.insertCell().textContent = defaultData.tanggal;
        trLWBP.insertCell().textContent = defaultData.konsumsi_total_harian.toFixed(2);
        trLWBP.insertCell().textContent = defaultData.konsumsi_wbp_kwh.toFixed(2);
        
        const lwbpCell = trLWBP.insertCell();
        lwbpCell.textContent = defaultData.konsumsi_lwbp_kwh.toFixed(2);
        lwbpCell.style.fontWeight = 'bold';
        lwbpCell.style.backgroundColor = '#065f46';
    });
}


/**
 * Mengambil data harian dari Supabase dan menggantikan default.
 */
async function renderDailyConsumptionData() {
    const targetDate = analysisDateInput.value;
    
    if (!targetDate) {
        analysisStatus.textContent = "Silakan pilih tanggal analisis.";
        renderDefaultTables(); // Reset ke default tanpa tanggal
        return;
    }
    
    // Tampilkan tabel default untuk tanggal yang dipilih saat mulai loading
    renderDefaultTables(targetDate);
    analysisStatus.textContent = `Sedang mengambil data untuk tanggal ${targetDate}...`;

    try {
        const { data: finalData, error } = await supa
            .from(DATA_SOURCE_TABLE) 
            .select('tanggal, id_mesin, konsumsi_lwbp_kwh, konsumsi_wbp_kwh, konsumsi_total_harian')
            .eq('tanggal', targetDate) 
            .order('id_mesin', { ascending: true });

        if (error) throw error;
        
        // Cek data, jika kosong, tetap tampilkan default
        if (finalData.length === 0) {
            analysisStatus.textContent = `Data konsumsi untuk tanggal ${targetDate} belum tersedia.`;
            // renderDefaultTables(targetDate); // Sudah dipanggil di atas
            return;
        }

        // Jika data ada, render ulang tabel dengan data Supabase
        renderDefaultTables(targetDate); // Kosongkan/reset dengan tanggal yang benar
        
        finalData.forEach(row => {
            const id = row.id_mesin;
            const wbpRow = wbpTableBody.children[id - 1]; // Ambil baris yang sudah ada
            const lwbpRow = lwbpTableBody.children[id - 1];

            // Update Kolom WBP
            if (wbpRow) {
                wbpRow.cells[2].textContent = row.konsumsi_total_harian.toFixed(2); 
                wbpRow.cells[3].textContent = row.konsumsi_lwbp_kwh.toFixed(2); 
                wbpRow.cells[4].textContent = row.konsumsi_wbp_kwh.toFixed(2); 
            }
            
            // Update Kolom LWBP
            if (lwbpRow) {
                lwbpRow.cells[2].textContent = row.konsumsi_total_harian.toFixed(2);
                lwbpRow.cells[3].textContent = row.konsumsi_wbp_kwh.toFixed(2);
                lwbpRow.cells[4].textContent = row.konsumsi_lwbp_kwh.toFixed(2);
            }
        });

        analysisStatus.textContent = `Data berhasil diperbarui untuk ${finalData.length} mesin pada tanggal ${targetDate}.`;
        
    } catch (e) {
        analysisStatus.textContent = `Gagal memuat data dari Supabase. (Pastikan koneksi dan VIEW sudah benar): ${e.message}`;
        console.error("Error fetching daily consumption data:", e);
        // Tampilkan default jika gagal
        renderDefaultTables(targetDate);
    }
}


// Saat halaman dimuat, atur tanggal default dan tampilkan tabel default
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().slice(0, 10);
    analysisDateInput.value = today;
    
    renderDefaultTables(today);
    analysisStatus.textContent = `Tabel siap. Silakan klik "Tampilkan Hasil" untuk mengambil data ${today}.`;
});

</script>

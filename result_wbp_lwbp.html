<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ==========================================
// CONFIG SUPABASE
// ==========================================
const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// ==========================================
// TARIF LISTRIK
// ==========================================
const TARIF_LWBP = 996.74;
const TARIF_WBP  = 1440.00;

let selectedMesin = null;

// ==========================================
// FUNGSI LOAD DATA
// ==========================================
async function loadData() {
  if (!selectedMesin) return;

  const start = document.getElementById("startDate").value;
  const end   = document.getElementById("endDate").value;
  const status = document.getElementById("status");

  status.textContent = "Mengambil data dari daily_meter_summary...";

  try {
    const { data, error } = await supabase
      .from("daily_meter_summary")
      .select("lwbp_total, wbp_total, tanggal")
      .eq("sid_mesin", selectedMesin)
      .gte("tanggal", start)
      .lte("tanggal", end)
      .order("tanggal", { ascending: true });

    if (error) throw error;

    let totalLwbp = 0;
    let totalWbp  = 0;

    data.forEach(row => {
      totalLwbp += parseFloat(row.lwbp_total || 0);
      totalWbp  += parseFloat(row.wbp_total  || 0);
    });

    const totalKwh = totalLwbp + totalWbp;
    const totalRp = (totalLwbp * TARIF_LWBP) + (totalWbp * TARIF_WBP);

    document.getElementById("tglAwal").textContent = start;
    document.getElementById("tglAkhir").textContent = end;
    document.getElementById("lwbpKwh").textContent = totalLwbp.toFixed(2);
    document.getElementById("lwbpRp").textContent = (totalLwbp * TARIF_LWBP).toLocaleString("id-ID");
    document.getElementById("wbpKwh").textContent = totalWbp.toFixed(2);
    document.getElementById("wbpRp").textContent = (totalWbp * TARIF_WBP).toLocaleString("id-ID");
    document.getElementById("totalKwh").textContent = totalKwh.toFixed(2);
    document.getElementById("totalRp").textContent = totalRp.toLocaleString("id-ID");

    status.innerHTML = `✔ Success — ${data.length} hari`;
    status.style.color = "#00e5bd";

  } catch (err) {
    console.error(err);
    status.textContent = `❌ Error: ${err.message}`;
    status.style.color = "#ef4444";
  }
}

// ==========================================
// AUTO LOAD KETIKA MODAL DIBUKA
// ==========================================
document.addEventListener("DOMContentLoaded", () => {
  if (selectedMesin) loadData();
});
</script>

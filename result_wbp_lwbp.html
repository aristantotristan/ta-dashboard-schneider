<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MASTER DASHBOARD TARIF • 18 Mesin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* (styling sama persis seperti versi kamu, tidak diubah) */
    :root {
      --bg: #0a0e17;
      --card: #111827;
      --accent: #00ff9d;
      --accent2: #00d0ff;
      --text: #e0f7ff;
      --muted: #94a3b8;
      --glow: 0 0 20px rgba(0, 255, 157, 0.5);
      --glow2: 0 0 30px rgba(0, 208, 255, 0.4);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'JetBrains Mono',monospace;
      background:var(--bg);color:var(--text);
      min-height:100vh;overflow-x:hidden;position:relative;
    }
    body::before{
      content:'';position:fixed;top:0;left:0;right:0;bottom:0;
      background:
        radial-gradient(circle at 20% 80%,rgba(0,255,157,0.08)0%,transparent 50%),
        radial-gradient(circle at 80% 20%,rgba(0,208,255,0.08)0%,transparent 50%),
        linear-gradient(90deg,transparent 48%,rgba(0,255,157,0.03)50%,transparent 52%);
      pointer-events:none;animation:electricFlow 18s linear infinite;z-index:-2;
    }
    body::after{
      content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;
      background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(0,255,157,0.02)10px,rgba(0,255,157,0.02)20px);
      animation:gridMove 40s linear infinite;z-index:-1;opacity:0.4;
    }
    @keyframes electricFlow{0%{transform:translateX(-100px)translateY(-100px)}100%{transform:translateX(100px)translateY(100px)}}
    @keyframes gridMove{0%{transform:translate(0,0)}100%{transform:translate(50px,50px)}}

    header{text-align:center;padding:30px 20px 10px}
    h1{
      font-family:'Orbitron',sans-serif;
      font-size:clamp(2rem,6vw,4.5rem);
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text;background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow:var(--glow);letter-spacing:8px;margin-bottom:8px;
    }
    .subtitle{color:var(--muted);font-size:1rem;opacity:0.9}

    .container{max-width:1600px;margin:0 auto;padding:0 20px}
    .layout{display:grid;grid-template-columns:1fr 380px;gap:24px;margin-top:20px}

    .controls{
      display:flex;gap:16px;flex-wrap:wrap;align-items:end;
      background:var(--card);padding:20px;border-radius:16px;
      box-shadow:var(--glow);border:1px solid rgba(0,255,157,0.1);
    }
    .group{display:flex;flex-direction:column}
    label{color:var(--muted);font-size:0.85rem;margin-bottom:6px}
    input[type="date"], input[type="time"]{
      padding:12px 16px;border-radius:12px;border:1px solid rgba(0,255,157,0.3);
      background:rgba(17,24,39,0.8);color:white;font-family:inherit;transition:all .3s;
    }
    input[type="date"]:focus, input[type="time"]:focus{outline:none;box-shadow:var(--glow)}

    .btn{
      padding:12px 24px;border:none;border-radius:12px;cursor:pointer;
      font-weight:700;font-size:0.95rem;transition:all .3s;position:relative;overflow:hidden;
    }
    .btn-primary{background:linear-gradient(45deg,var(--accent),#00ff9d);color:#000;box-shadow:var(--glow)}
    .btn-outline{background:transparent;border:2px solid var(--accent2);color:var(--accent2);box-shadow:var(--glow2)}
    .btn:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(0,255,157,0.4)}

    .table-wrap{margin-top:20px;border-radius:16px;overflow:hidden;box-shadow:var(--glow)}
    table{width:100%;border-collapse:collapse;background:var(--card);font-size:0.92rem}
    thead th{
      background:linear-gradient(90deg,rgba(0,255,157,0.15),rgba(0,208,255,0.15));
      padding:18px 12px;text-transform:uppercase;font-weight:700;
      letter-spacing:1.5px;color:var(--accent);font-size:0.8rem;
    }
    td{padding:16px 12px;border-bottom:1px solid rgba(0,255,157,0.08);transition:background .3s}
    tbody tr:hover{background:rgba(0,255,157,0.08)!important;box-shadow:var(--glow)}
    tbody tr:nth-child(even){background:rgba(17,24,39,0.6)}

    .card{
      background:rgba(17,24,39,0.6);backdrop-filter:blur(10px);
      border:1px solid rgba(0,255,157,0.2);border-radius:16px;
      padding:20px;box-shadow:var(--glow);animation:float 6s ease-in-out infinite;
    }
    .tarif-title{
      font-family:'Orbitron',sans-serif;font-size:1.4rem;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text;background-clip:text;
      -webkit-text-fill-color:transparent;margin-bottom:16px;
    }
    .tarif-value{font-size:1.5rem;font-weight:700;color:var(--accent);text-shadow:var(--glow);margin:12px 0}
    #statusBox{
      padding:16px;background:rgba(0,255,157,0.1);border-radius:12px;text-align:center;
      color:var(--accent);font-weight:600;text-shadow:var(--glow);
      animation:pulse 2s infinite;
    }
    @keyframes pulse{0%,100%{opacity:0.8}50%{opacity:1;transform:scale(1.02)}}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}

    @media(max-width:1024px){.layout{grid-template-columns:1fr}}
    @media(max-width:640px){
      h1{letter-spacing:4px}
      .controls{flex-direction:column;align-items:stretch}
      .btn{width:100%}
    }
  </style>
</head>
<body>
  <header>
    <h1>MASTER DASHBOARD</h1>
    <div class="subtitle">Tarif & Konsumsi Listrik • Mesin  </div>
     <div class="subtitle"> PT.Amarilys Karisma Gemilang </div>
  </header>

  <div class="container">
    <div class="layout">
      <div>
        <div class="controls">
          <div class="group">
            <label>TANGGAL AWAL</label>
            <input id="globalStart" type="date">
          </div>
          <div class="group">
            <label>TANGGAL AKHIR</label>
            <input id="globalEnd" type="date">
          </div>
          <div class="group">
            <label>JAM AWAL</label>
            <input id="globalStartTime" type="time" value="00:00">
          </div>
          <div class="group">
            <label>JAM AKHIR</label>
            <input id="globalEndTime" type="time" value="23:59">
          </div>
          <div style="display:flex;gap:12px;align-items:flex-end">
            <button id="btnShowAll" class="btn btn-outline">TAMPILKAN SEMUA</button>
            <button id="btnExport" class="btn btn-primary">EXPORT EXCEL</button>
          </div>
        </div>

        <div class="table-wrap">
          <table id="masterTable">
            <thead>
              <tr>
                <th>TGL AWAL</th><th>TGL AKHIR</th><th>MESIN</th>
                <th>LWBP (kWh)</th><th>LWBP (Rp)</th>
                <th>WBP (kWh)</th><th>WBP (Rp)</th>
                <th>TOTAL (kWh)</th><th>TOTAL TAGIHAN</th>
              </tr>
            </thead>
            <tbody id="masterTbody"></tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="tarif-title">TARIF LISTRIK PLN</div>
          <div>LWBP </div>
          <div class="tarif-value">Rp 1.135,00 / kWh</div>
          <div style="margin-top:16px">WBP</div>
          <div class="tarif-value">Rp 996,74 / kWh</div>
        </div>
        <div class="card" style="margin-top:20px">
          <div id="statusBox">Menunggu rentang tanggal...</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* kita pakai snapshot tabel sebagai sumber */
const TABLE_SNAPSHOT = "meter_tariff_snapshot";

/* tarif */
const TARIF_LWBP = 1135;
const TARIF_WBP = 996.74;

/* mesin tags (tetap) */
const MACHINE_TAGS = {
  1: "UNKNOW",
  2: "UNKNOW",
  3: "UNKNOW",
  4: "UNKNOW",
  5: "MESIN 41",
  6: "MC 40",
  7: "MC 39",
  8: "UNKNOW",
  9: "MC 5",
 10: "HEATER MC 5",
 11: "UNKNOW",
 12: "MC 34",
 13: "MC 35",
 14: "UNKNOW",
 15: "UNKNOW",
 16: "MC 38",
 17: "MC 36",
 18: "MC 37"
};

/* ===== HELPERS ===== */
function fmtNumber(n,d=2){return Number(n||0).toLocaleString('id-ID',{minimumFractionDigits:d,maximumFractionDigits:d})}
function fmtCurrency(n){return Number(n||0).toLocaleString('id-ID')}

/* build empty table skeleton (18 mesin) */
function buildTableSkeleton(){
  const tbody=document.getElementById('masterTbody');
  tbody.innerHTML='';
  for(let s=1;s<=18;s++){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="muted">-</td>
      <td class="muted">-</td>
      <td style="font-weight:600;color:var(--accent)">${MACHINE_TAGS[s]}</td>
      <td>0.00</td><td>0</td><td>0.00</td><td>0</td><td>0.00</td>
      <td style="color:var(--accent);font-weight:800">0</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ======= CORE: fetch snapshot rows untuk 1 mesin dalam rentang (dengan lookback 1 hari sebelum start)
   kita akan ambil semua snapshot dari (start -1 day) sampai end, supaya kita bisa interpolasi opening */
async function fetchSnapshotsForSid(sid, startDate, startTime, endDate, endTime){
  // build JS Date objects in local timezone (assumes browser in Asia/Jakarta)
  const startDtLocal = new Date(`${startDate}T${startTime}:00`);
  const endDtLocal = new Date(`${endDate}T${endTime}:00`);

  // lookback 1 day to be able to find previous reading for interpolation
  const lookback = new Date(startDtLocal.getTime() - 24*60*60*1000);

  // convert to ISO for querying (Supabase/Postgres handles timestamptz)
  const fromIso = lookback.toISOString();
  const toIso = endDtLocal.toISOString();

  const { data, error } = await supabase
    .from(TABLE_SNAPSHOT)
    .select('id, sid_mesin, "timestamp", tanggal, total_kwh, t1_lwbp_kwh, t2_wbp_kwh')
    .eq('sid_mesin', sid)
    .gte('timestamp', fromIso)
    .lte('timestamp', toIso)
    .order('timestamp', { ascending: true });

  if(error){
    console.error("fetchSnapshots error sid", sid, error);
    return { error };
  }
  return { data: data || [] , startDtLocal, endDtLocal };
}

/* helper: convert row.timestamp (string) to JS Date object */
function rowDate(row){ return new Date(row.timestamp); }

/* helper: get reading at specific datetime by interpolation */
function getReadingAt(dt, rows){ // dt is JS Date, rows sorted ascending
  if(!rows || rows.length === 0) return null;
  // exact match
  for(const r of rows) {
    const t = rowDate(r).getTime();
    if(t === dt.getTime()) return parseFloat(r.total_kwh || 0);
  }
  // find prev and next
  let prev = null;
  let next = null;
  for(const r of rows){
    const t = rowDate(r).getTime();
    if(t < dt.getTime()) prev = r;
    if(t > dt.getTime()){
      next = r;
      break;
    }
  }
  if(prev && next){
    const t0 = rowDate(prev).getTime();
    const t1 = rowDate(next).getTime();
    const v0 = parseFloat(prev.total_kwh || 0);
    const v1 = parseFloat(next.total_kwh || 0);
    if(t1 === t0) return v1;
    const frac = (dt.getTime() - t0) / (t1 - t0);
    return v0 + frac * (v1 - v0);
  }
  if(prev) return parseFloat(prev.total_kwh || 0);
  if(next) return parseFloat(next.total_kwh || 0);
  // fallback first row
  return parseFloat(rows[0].total_kwh || 0);
}

/* helper: get jakarta date string 'YYYY-MM-DD' from JS Date (assumes local tz is Jakarta) */
function toLocalDateStr(dt){
  // format like 2025-12-05
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const d = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

/* tariff boundaries (local time)
   LWBP = 22:00 - 17:00 (next day)  -> i.e. outside 17..22
   WBP  = 17:00 - 22:00              -> hours 17..21:59
   We'll treat WBP when hour >=17 and <22, else LWBP.
*/

/* helper: determine if a given local Date is WBP */
function isWbp(dt){
  const h = dt.getHours();
  return (h >= 17 && h < 22);
}

/* helper: find next tariff boundary after a given local date
   boundaries at hh:00 (17:00 and 22:00)
*/
function nextTariffBoundaryAfter(dt){
  // create a local Date copy
  const d = new Date(dt.getTime());
  const h = d.getHours();
  const m = d.getMinutes();
  const s = d.getSeconds();
  // if currently before today's 17:00 -> next is today 17:00
  const today17 = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 17, 0, 0);
  const today22 = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 22, 0, 0);
  if(d.getTime() < today17.getTime()) return today17;
  if(d.getTime() < today22.getTime()) return today22;
  // otherwise next boundary is tomorrow 17:00
  const tomorrow17 = new Date(d.getFullYear(), d.getMonth(), d.getDate()+1, 17, 0, 0);
  return tomorrow17;
}

/* allocate diff energy over interval [t0,t1) into lwbp & wbp based on tariff windows.
   We assume energy increases linearly over time; allocation proportional to duration in each tariff.
*/
function allocateIntervalEnergy(t0, t1, diff){
  if(diff <= 0) return { lwbp: 0, wbp: 0 };
  const totalMs = t1.getTime() - t0.getTime();
  if(totalMs <= 0) return { lwbp: 0, wbp: 0 };
  let cursor = new Date(t0.getTime());
  let rem = 0;
  let lwbp = 0;
  let wbp = 0;
  while(cursor.getTime() < t1.getTime()){
    const nb = nextTariffBoundaryAfter(cursor);
    const segEnd = (nb.getTime() < t1.getTime()) ? nb : t1;
    const segMs = segEnd.getTime() - cursor.getTime();
    const portion = segMs / totalMs;
    const energyPortion = diff * portion;
    if(isWbp(cursor)){
      wbp += energyPortion;
    } else {
      lwbp += energyPortion;
    }
    cursor = new Date(segEnd.getTime());
  }
  return { lwbp, wbp };
}

/* Given rows between start and end, produce timeline including start and end (interpolated)
   and compute total lwbp & wbp by summing allocations for each sub-interval.
*/
function computeEnergyFromTimeline(rows, startDt, endDt){
  // ensure rows sorted ascending by timestamp
  const sorted = rows.slice().sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));
  // create timeline points: startDt (value), then any rows strictly between, then endDt (value)
  const timeline = [];
  const startVal = getReadingAt(startDt, sorted);
  timeline.push({ ts: new Date(startDt.getTime()), val: startVal });
  for(const r of sorted){
    const t = new Date(r.timestamp);
    if(t.getTime() <= startDt.getTime() || t.getTime() >= endDt.getTime()) continue;
    timeline.push({ ts: t, val: parseFloat(r.total_kwh || 0) });
  }
  const endVal = getReadingAt(endDt, sorted);
  timeline.push({ ts: new Date(endDt.getTime()), val: endVal });

  // compute diffs across timeline
  let totalLwbp = 0;
  let totalWbp = 0;
  for(let i=0;i<timeline.length-1;i++){
    const p0 = timeline[i];
    const p1 = timeline[i+1];
    const diff = p1.val - p0.val;
    if(diff <= 0) continue;
    const alloc = allocateIntervalEnergy(p0.ts, p1.ts, diff);
    totalLwbp += alloc.lwbp;
    totalWbp += alloc.wbp;
  }
  return { lwbp: totalLwbp, wbp: totalWbp, total: totalLwbp + totalWbp };
}

/* fetch + compute per machine for the whole range (startDate + startTime) .. (endDate + endTime) */
async function computeForSidRange(sid, startDate, startTime, endDate, endTime){
  const res = await fetchSnapshotsForSid(sid, startDate, startTime, endDate, endTime);
  if(res.error) return { error: res.error };
  const rows = res.data;
  const startDtLocal = res.startDtLocal;
  const endDtLocal = res.endDtLocal;

  if(rows.length === 0){
    // no data at all - return zeros
    return { lwbp:0, wbp:0, total:0 };
  }

  // compute energy
  const energy = computeEnergyFromTimeline(rows, startDtLocal, endDtLocal);
  return energy;
}

/* render one row */
function renderSidResult(sid, start, end, lwbp, wbp, totalKwh){
  const tr=document.querySelector(`#masterTbody tr:nth-child(${sid})`);
  tr.children[0].textContent=start;
  tr.children[1].textContent=end;
  tr.children[3].textContent=fmtNumber(lwbp,3);
  tr.children[4].textContent=fmtCurrency(Math.round(lwbp*TARIF_LWBP));
  tr.children[5].textContent=fmtNumber(wbp,3);
  tr.children[6].textContent=fmtCurrency(Math.round(wbp*TARIF_WBP));
  tr.children[7].textContent=fmtNumber(totalKwh,3);
  tr.children[8].textContent=fmtCurrency(Math.round(lwbp*TARIF_LWBP + wbp*TARIF_WBP));
  tr.children[8].style.cssText="color:var(--accent);font-weight:800;font-size:1.1rem";
}

/* ===== showAll() main flow ===== */
async function showAll(){
  const start=document.getElementById('globalStart').value;
  const end=document.getElementById('globalEnd').value;
  const startTime=document.getElementById('globalStartTime').value || '00:00';
  const endTime=document.getElementById('globalEndTime').value || '23:59';
  const status=document.getElementById('statusBox');

  if(!start || !end){ alert('Isi tanggal dulu bro!'); return; }
  const startDt = new Date(`${start}T${startTime}:00`);
  const endDt = new Date(`${end}T${endTime}:00`);
  if(startDt.getTime() > endDt.getTime()){ alert('Range waktu tidak valid (start > end)'); return; }

  status.textContent='Memuat data 18 mesin...';
  buildTableSkeleton();

  // parallel compute for all sid
  const promises = [];
  for(let sid=1; sid<=18; sid++){
    promises.push(computeForSidRange(sid, start, startTime, end, endTime));
  }

  const results = await Promise.all(promises);
  let found=false;
  for(let i=0;i<results.length;i++){
    const r = results[i];
    if(r.error) {
      console.error("SID", i+1, r.error);
      continue;
    }
    if(r.total && r.total > 0) found = true;
    renderSidResult(i+1, `${start} ${startTime}`, `${end} ${endTime}`, r.lwbp || 0, r.wbp || 0, r.total || 0);
  }

  status.textContent = found ? 'SELESAI — DATA TERBARU' : 'TIDAK ADA DATA DI RANGE INI';
  status.style.animation="pulse 1.5s infinite";
}

/* export menggunakan data yang ada di tabel (DOM) */
function exportExcel(){
  const start=document.getElementById('globalStart').value||'start';
  const end=document.getElementById('globalEnd').value||'end';
  const rows=[['TGL AWAL','TGL AKHIR','MESIN','LWBP (kWh)','LWBP (Rp)','WBP (kWh)','WBP (Rp)','Total (kWh)','Total Tagihan']];
  document.querySelectorAll('#masterTbody tr').forEach(tr=>{
    const cells=Array.from(tr.cells).map(c=>c.textContent);
    rows.push(cells);
  });
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,'MASTER');
  XLSX.writeFile(wb,`MASTER_TARIF_${start}_sd_${end}.xlsx`);
}

/* wire handlers */
document.getElementById('btnShowAll').onclick = showAll;
document.getElementById('btnExport').onclick = exportExcel;

/* init defaults */
const today=new Date().toISOString().slice(0,10);
const last30=new Date(Date.now()-30*24*60*60*1000).toISOString().slice(0,10);
document.getElementById('globalEnd').value=today;
document.getElementById('globalStart').value=last30;
document.getElementById('globalStartTime').value='00:00';
document.getElementById('globalEndTime').value='23:59';
buildTableSkeleton();
</script>
</body>
</html>

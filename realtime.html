<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš¡ Master Power Meter Dashboard (18 SLAVES)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #E0E0E0;
    padding: 20px;
}
h2 {
    color: #00FFC2;
    border-bottom: 2px solid #3A3A3A;
    padding-bottom: 10px;
}
#conn {
    margin-bottom: 25px;
    font-size: 1.1em;
    font-weight: bold;
}
table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    overflow: hidden;
}
th, td {
    border: 1px solid #2A2A2A;
    padding: 10px;
    text-align: center;
}
thead th {
    background: #2A2A2A;
    color: #00FFC2;
    font-size: 0.85em;
}
tbody tr {
    background: #1E1E1E;
}
tbody tr:hover {
    background-color: #334155;
}
.cell-id { font-weight: bold; background: #111827; }
.status-online { color: #10B981; font-weight: bold; }
.status-offline { color: #EF4444; font-weight: bold; }

.col-power { background-color: #0F334A; color: #38BDF8; font-weight: 600; }
.col-energy { color: #4ADE80; font-weight: 600; }
.col-tariff { color: #FACC15; font-weight: 700; } /* âœ… T1 T2 */
</style>
</head>

<body>

<h2>âš¡ Real-time Power Meter Dashboard (18 Mesin)</h2>
<p id="conn">Connecting...</p>

<table>
<thead>
<tr>
  <th>ID</th>
  <th>Status</th>
  <th>V</th>
  <th>I1</th>
  <th>I2</th>
  <th>I3</th>
  <th>P (W)</th>
  <th>Q (VAR)</th>
  <th>S (kVA)</th>
  <th>PF</th>
  <th>Hz</th>
  <th>OpH</th>
  <th>Ea Tot</th>
  <th>Er Tot</th>
  <th>Ea Part</th>
  <th>Er Part</th>
  <th>ðŸ”¥ T1 (kWh)</th>
  <th>ðŸ”¥ T2 (kWh)</th>
</tr>
</thead>
<tbody id="tableBody">
<tr>
<td colspan="18" style="padding:30px; color:#94A3B8;">
Awaiting Real-time Data from ESP32...
</td>
</tr>
</tbody>
</table>

<script>
const options = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 2000,
};

const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  options
);

const tableBody = document.getElementById("tableBody");
const conn = document.getElementById("conn");
const devices = {};

// ðŸ”’ KEY HARUS MATCH MQTT PAYLOAD
const dataMap = [
  { key: 'V' }, { key: 'I1' }, { key: 'I2' }, { key: 'I3' },
  { key: 'P' }, { key: 'Q' }, { key: 'S' },
  { key: 'PF' }, { key: 'Hz' }, { key: 'OpH' },
  { key: 'EaT' }, { key: 'ErT' },
  { key: 'EaP' }, { key: 'ErP' },
  { key: 'T1', class:'col-tariff' }, // âœ…
  { key: 'T2', class:'col-tariff' }  // âœ…
];

function formatOpH(hours) {
  if (!hours || hours < 0) return '---';
  const d = Math.floor(hours / 24);
  const h = Math.floor(hours % 24);
  return d > 0 ? `${d} Hari ${h} Jam` : `${h} Jam`;
}

client.on("connect", () => {
  conn.innerHTML = "âœ… MQTT Connected";
  client.subscribe("politeknik/meter/data");
});

client.on("message", (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    const id = d.id;

    if (!devices[id]) {
      const row = tableBody.insertRow();
      devices[id] = row;

      row.insertCell().textContent = id;
      row.insertCell().textContent = d.status;

      dataMap.forEach(i => {
        const c = row.insertCell();
        if (i.class) c.className = i.class;
        c.textContent = '---';
      });

      if (tableBody.rows[0].cells.length === 1)
        tableBody.deleteRow(0);
    }

    const row = devices[id];
    row.cells[1].textContent = d.status.toUpperCase();
    row.cells[1].className =
      d.status === "online" ? "status-online" : "status-offline";

    dataMap.forEach((item, i) => {
      const cell = row.cells[i + 2];
      let val = d[item.key];
      if (item.key === "OpH") val = formatOpH(val);
      cell.textContent = (val === 0 || val) ? val : "---";
    });

  } catch (e) {
    console.error("JSON ERROR:", e);
  }
});
</script>

</body>
</html>

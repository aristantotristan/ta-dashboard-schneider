<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‚ö° Master Power Meter Dashboard (18 SLAVES)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
:root {
  --bg: #121212;
  --card: #1E1E1E;
  --muted: #94A3B8;
  --accent: #00FFC2;
  --online: #10B981;
  --offline: #EF4444;
  --tariff: #FACC15;
}
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg);
  color: #E0E0E0;
  padding: 20px;
  margin: 0;
}
h2 { color: var(--accent); margin: 0 0 12px 0; }
#conn { margin-bottom: 14px; font-weight: 600; color: var(--muted); }

#main-view {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: center;
}
.machine-card {
  background: var(--card);
  border-radius: 8px;
  padding: 20px 15px;
  width: 180px;
  height: 110px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  user-select: none;
}
.machine-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 20px rgba(0,0,0,0.7);
}
.card-label {
  font-size: 1.25rem;
  font-weight: 700;
  color: #38BDF8;
  margin: 0;
  line-height: 1.2;
}
.status-indicator {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 2px solid var(--bg);
  box-shadow: 0 0 6px rgba(0,0,0,0.8);
}
.status-online { background-color: var(--online); }
.status-offline { background-color: var(--offline); }

.machine-card[data-tooltip]:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 110%;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #fff;
  padding: 6px 10px;
  border-radius: 4px;
  white-space: nowrap;
  font-size: 0.85rem;
  pointer-events: none;
  opacity: 0.9;
  z-index: 10;
}

#detail-view {
  display: none;
  padding-top: 20px;
}
#detail-view h3 {
  color: var(--accent);
  margin-top: 0;
}
#back-button {
  background: #333;
  color: #fff;
  border: none;
  padding: 8px 15px;
  border-radius: 5px;
  cursor: pointer;
  margin-bottom: 15px;
  user-select: none;
}
#back-button:hover {
  background: #555;
}

#detail-table {
  width: 100%;
  border-collapse: collapse;
  box-shadow: 0 6px 20px rgba(0,0,0,0.6);
  border-radius: 8px;
  overflow: hidden;
}
#detail-table th, #detail-table td {
  padding: 10px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  text-align: left;
  font-size: 0.9rem;
}
#detail-table thead th {
  background: #2A2A2A;
  color: var(--accent);
  text-transform: uppercase;
}
#detail-table tbody tr { background: var(--card); }
#detail-table .param-name { font-weight: 600; width: 40%; }
#detail-table .param-value { color: #fff; font-weight: 400; }

.col-power { color: #38BDF8; }
.col-energy { color: #4ADE80; }
.col-tariff { color: var(--tariff); }

@media (max-width: 600px) {
  .machine-card { width: 45%; }
}
</style>
</head>
<body>

<h2>‚ö° Real-time Power Meter Dashboard</h2>
<p id="conn" class="muted">Connecting...</p>

<div id="main-view"></div>

<div id="detail-view">
  <button id="back-button">‚Üê Kembali ke Daftar Mesin</button>
  <h3 id="detail-title">Detail Parameter Mesin ID: --</h3>
  <table id="detail-table" aria-label="Power Meter Detail Table">
    <tbody id="detailBody"></tbody>
  </table>
</div>

<script>
const MQTT_OPTIONS = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 2000
};
const MQTT_URL = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_TOPIC = "politeknik/meter/data";
const TOTAL_DEVICES = 18;

const MACHINE_TAGS = {
  1: 'UNKNOW',
  2: 'UNKNOW',
  3: 'POMPA MC 12',
  4: 'MC 9',
  5: 'UNKNOW',
  6: 'MC 40',
  7: 'MC 39',
  8: 'MC 6',
  9: 'HEATER MC 5',
  10: 'POMPA MC 5',
  11: 'UNKNOW',
  12: 'MC 34',
  13: 'MC 35',
  14: 'UNKNOW',
  15: 'UNKNOW',
  16: 'MC 38',
  17: 'MC 36',
  18: 'MC 37'
};

function formatOpH(hours) {
  if (hours === null || hours === undefined || isNaN(hours) || hours < 0) return '---';
  const totalMinutes = Math.round(parseFloat(hours) * 60);
  const days = Math.floor(totalMinutes / (24 * 60));
  const rem = totalMinutes % (24 * 60);
  const hrs = Math.floor(rem / 60);
  const mins = rem % 60;
  if (days > 0) return `${days} Hari ${hrs} Jam`;
  if (hrs > 0) return `${hrs} Jam${mins>0 ? ' ' + mins + ' Mnt' : ''}`;
  if (mins > 0) return `${mins} Mnt`;
  return '0 Jam';
}
function fmt(val, key) {
  if (val === null || val === undefined || isNaN(val)) return '---';
  const n = Number(val);
  if (['V'].includes(key)) return n.toFixed(1);
  if (['I1','I2','I3'].includes(key)) return n.toFixed(3);
  if (['P','Q'].includes(key)) return Math.round(n).toString();
  if (['S'].includes(key)) return n.toFixed(2);
  if (['PF'].includes(key)) return n.toFixed(3);
  if (['Hz'].includes(key)) return n.toFixed(1);
  if (['EaT','ErT','EaP','ErP','T1','T2'].includes(key)) return n.toFixed(2);
  return n.toString();
}
function getStyleClass(key) {
  if (key === 'T1' || key === 'T2') return 'col-tariff';
  if (['EaT','ErT','EaP','ErP'].includes(key)) return 'col-energy';
  if (['P','Q','S'].includes(key)) return 'col-power';
  return '';
}
const dataLabels = {
  'V': 'Tegangan (V)', 'I1': 'Arus Fasa 1 (A)', 'I2': 'Arus Fasa 2 (A)', 'I3': 'Arus Fasa 3 (A)',
  'P': 'Daya Aktif (W)', 'Q': 'Daya Reaktif (VAR)', 'S': 'Daya Semu (kVA)', 'PF': 'Faktor Daya',
  'Hz': 'Frekuensi (Hz)', 'OpH': 'Jam Operasi',
  'EaT': 'Energi Aktif Total (kWh)', 'ErT': 'Energi Reaktif Total (kVARh)',
  'EaP': 'Energi Aktif Parsial (kWh)', 'ErP': 'Energi Reaktif Parsial (kVARh)',
  'T1': 'Tarif 1 (kWh)', 'T2': 'Tarif 2 (kWh)'
};

const mainView = document.getElementById('main-view');
const detailView = document.getElementById('detail-view');
const detailBody = document.getElementById('detailBody');
const detailTitle = document.getElementById('detail-title');
const backButton = document.getElementById('back-button');
const conn = document.getElementById('conn');

const dataMap = [
  'V','I1','I2','I3','P','Q','S','PF','Hz','OpH',
  'EaT','ErT','EaP','ErP','T1','T2'
];
const devices = {};
let currentViewedId = null;
const deviceData = {};
for (let id = 1; id <= TOTAL_DEVICES; id++) {
  deviceData[id] = {};
}

function showMainView() {
  mainView.style.display = 'flex';
  detailView.style.display = 'none';
  currentViewedId = null;
}
function showDetailView(id) {
  mainView.style.display = 'none';
  detailView.style.display = 'block';
  currentViewedId = id;
  detailTitle.textContent = `Detail Parameter Mesin ID: ${id} - ${MACHINE_TAGS[id] || 'NAMA MESIN'}`;
  updateDetailView(id);
}
function createCards() {
  mainView.innerHTML = '';
  for(let id=1; id<=TOTAL_DEVICES; id++) {
    const card = document.createElement('div');
    card.className = 'machine-card';
    card.setAttribute('data-id', id);
    const tag = MACHINE_TAGS[id] || 'Mesin Tidak Dikenal';
    card.setAttribute('data-tooltip', `Mesin ${id} = ${tag}`);
    card.innerHTML = `
      <div class="status-indicator status-offline" id="status-ind-${id}"></div>
      <p class="card-label">${tag}</p>
      <p style="font-size: 0.9rem; color: var(--muted); margin: 4px 0 0 0;">SID ${id}</p>
    `;
    card.onclick = () => showDetailView(id);
    mainView.appendChild(card);
    devices[id] = {
      card,
      indicator: document.getElementById(`status-ind-${id}`)
    };
  }
}
function updateDetailView(id) {
  if (currentViewedId !== id) return;
  detailBody.innerHTML = '';
  const data = deviceData[id];
  const statusRow = detailBody.insertRow();
  statusRow.innerHTML = `<td class="param-name">Status</td><td class="param-value ${data.status === 'online' ? 'status-online' : 'status-offline'}">${data.status ? data.status.toUpperCase() : '---'}</td>`;
  dataMap.forEach(key => {
    const tr = detailBody.insertRow();
    const raw = data[key];
    let displayValue;
    if (key === 'OpH') {
      displayValue = (raw === 0 || raw) ? formatOpH(raw) : '---';
    } else {
      displayValue = (raw === 0 || raw) ? fmt(raw, key) : '---';
    }
    tr.innerHTML = `<td class="param-name">${dataLabels[key]}</td><td class="param-value ${getStyleClass(key)}">${displayValue}</td>`;
  });
}
showMainView();
createCards();

backButton.onclick = showMainView;

const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);
client.on('connect', () => {
  conn.textContent = '‚úÖ MQTT Connected';
  client.subscribe(MQTT_TOPIC);
});
client.on('reconnect', () => {
  conn.textContent = 'üîÑ MQTT Reconnecting...';
});
client.on('error', (err) => {
  conn.textContent = '‚ùå MQTT Error';
  console.error('MQTT Error:', err);
});
client.on('message', (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    const id = Number(d.id);
    if (!id || id < 1 || id > TOTAL_DEVICES) {
      console.warn('Invalid ID in payload', d);
      return;
    }
    deviceData[id] = d;
    if (devices[id]) {
      const status = (d.status && d.status.toLowerCase() === 'online') ? 'online' : 'offline';
      devices[id].indicator.className = `status-indicator status-${status}`;
    }
    if (currentViewedId === id) {
      updateDetailView(id);
    }
  } catch (e) {
    console.error('Payload parse error:', e, message.toString());
  }
});
</script>

</body>
</html>

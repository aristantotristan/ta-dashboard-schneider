<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>âš¡ Master Power Meter Dashboard (18 SLAVES)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
  /* --- Styling (rapi & minimal) --- */
  :root {
    --bg: #121212;
    --card: #1E1E1E;
    --muted: #94A3B8;
    --accent: #00FFC2;
    --online: #10B981;
    --offline: #EF4444;
    --tariff: #FACC15;
  }
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: #E0E0E0;
    padding: 20px;
    margin: 0;
  }
  h2 { color: var(--accent); margin: 0 0 12px 0; }
  #conn { margin-bottom: 14px; font-weight: 600; color: #94A3B8; }

  table {
    width: 100%;
    border-collapse: collapse;
    box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    border-radius: 8px;
    overflow: hidden;
  }
  thead th {
    background: #2A2A2A;
    color: var(--accent);
    text-transform: uppercase;
    font-size: 0.8rem;
    padding: 10px 8px;
    border-bottom: 1px solid #151515;
  }
  th, td {
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.02);
    text-align: center;
    font-size: 0.86rem;
  }
  tbody tr { background: var(--card); }
  tbody tr:hover { background: #2b2b2b; }
  .cell-id { font-weight:700; background:#111827; }
  .status-online { color: var(--online); font-weight:700; }
  .status-offline { color: var(--offline); font-weight:700; }
  .col-power { background: #0F334A; color: #38BDF8; font-weight:600; }
  .col-energy { color: #4ADE80; font-weight:600; }
  .col-tariff { color: var(--tariff); font-weight:700; }
  .muted { color: var(--muted); }
  @media (max-width:1000px) {
    table { font-size: 0.78rem; }
  }

  /* Detail Panel Styling */
  #detailPanel {
    margin-top: 20px;
    padding: 15px;
    background: #222;
    border-radius: 8px;
    color: #eee;
    display: none;
    max-width: 600px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.7);
  }
  #detailPanel h3 {
    margin-top: 0;
    color: var(--accent);
  }
  #detailPanel table {
    width: 100%;
    border-collapse: collapse;
  }
  #detailPanel td {
    padding: 6px 8px;
    border-bottom: 1px solid #444;
  }
  #detailPanel td:first-child {
    text-align: left;
    font-weight: 600;
    width: 40%;
  }
  #detailPanel td:last-child {
    text-align: right;
  }
  #closeDetail {
    margin-top: 10px;
    padding: 6px 12px;
    background: #444;
    color: #eee;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  #closeDetail:hover {
    background: var(--accent);
    color: #121212;
  }
</style>
</head>
<body>

<h2>âš¡ Real-time Power Meter Dashboard (18 Mesin)</h2>
<p id="conn" class="muted">Connecting...</p>

<table aria-label="Power Meter Table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Status</th>
      <th>V</th>
      <th>I1</th>
      <th>I2</th>
      <th>I3</th>
      <th>P (W)</th>
      <th>Q (VAR)</th>
      <th>S (kVA)</th>
      <th>PF</th>
      <th>Hz</th>
      <th>OpH</th>
      <th>Ea Tot</th>
      <th>Er Tot</th>
      <th>Ea Part</th>
      <th>Er Part</th>
      <th class="col-tariff">T1 (kWh)</th>
      <th class="col-tariff">T2 (kWh)</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    <!-- Rows will be pre-populated by JS on load -->
  </tbody>
</table>

<!-- Detail Panel -->
<div id="detailPanel">
  <h3>Detail Mesin <span id="detailId"></span></h3>
  <table>
    <tbody id="detailBody"></tbody>
  </table>
  <button id="closeDetail">Tutup</button>
</div>

<script>
/* ================= CONFIG ================= */
const MQTT_OPTIONS = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 2000
};
const MQTT_URL = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_TOPIC = "politeknik/meter/data";
const TOTAL_DEVICES = 18;

/* ================= HELPERS ================= */
function formatOpH(hours) {
  if (hours === null || hours === undefined || isNaN(hours) || hours < 0) return '---';
  const totalMinutes = Math.round(parseFloat(hours) * 60);
  const days = Math.floor(totalMinutes / (24 * 60));
  const rem = totalMinutes % (24 * 60);
  const hrs = Math.floor(rem / 60);
  const mins = rem % 60;
  if (days > 0) return `${days} Hari ${hrs} Jam`;
  if (hrs > 0) return `${hrs} Jam${mins>0 ? ' ' + mins + ' Mnt' : ''}`;
  if (mins > 0) return `${mins} Mnt`;
  return '0 Jam';
}
function fmt(val, key) {
  if (val === null || val === undefined || isNaN(val)) return '---';
  const n = Number(val);
  if (['V'].includes(key)) return n.toFixed(1);
  if (['I1','I2','I3'].includes(key)) return n.toFixed(3);
  if (['P','Q'].includes(key)) return Math.round(n).toString();
  if (['S'].includes(key)) return n.toFixed(2);
  if (['PF'].includes(key)) return n.toFixed(3);
  if (['Hz'].includes(key)) return n.toFixed(1);
  if (['EaT','ErT','EaP','ErP','T1','T2'].includes(key)) return n.toFixed(2);
  return n.toString();
}

/* ================= TABLE SETUP ================= */
const tableBody = document.getElementById('tableBody');
const conn = document.getElementById('conn');

// dataMap order must match table columns after ID & Status
const dataMap = [
  'V','I1','I2','I3','P','Q','S','PF','Hz','OpH',
  'EaT','ErT','EaP','ErP','T1','T2'
];

// Pre-create 18 rows (ID 1..18) with default OFFLINE status and placeholders
const devices = {}; // store row references
function createInitialRows() {
  tableBody.innerHTML = ''; // clear
  for (let id=1; id<=TOTAL_DEVICES; id++) {
    const tr = tableBody.insertRow();
    // ID cell
    const tdId = tr.insertCell(); tdId.className = 'cell-id'; tdId.textContent = id;
    // Status cell
    const tdStatus = tr.insertCell(); tdStatus.textContent = 'OFFLINE'; tdStatus.className = 'status-offline';
    // Data cells
    dataMap.forEach(key => {
      const td = tr.insertCell();
      // style tariff cells
      if (key === 'T1' || key === 'T2') td.className = 'col-tariff';
      else if (['EaT','ErT','EaP','ErP'].includes(key)) td.className = 'col-energy';
      else if (['P','Q','S'].includes(key)) td.className = 'col-power';
      td.textContent = '---';
    });
    devices[id] = tr;
  }
}
createInitialRows();

/* Pasang event click ke setiap baris setelah dibuat */
function attachRowClicks() {
  for (let id = 1; id <= TOTAL_DEVICES; id++) {
    const row = devices[id];
    if (!row) continue;
    row.style.cursor = 'pointer';
    row.onclick = () => showDetail(id);
  }
}
attachRowClicks();

/* Fungsi untuk menampilkan detail mesin */
function showDetail(id) {
  const row = devices[id];
  if (!row) return;

  // Tampilkan ID di judul
  document.getElementById('detailId').textContent = id;

  // Ambil data dari sel row sesuai dataMap dan status
  const statusText = row.cells[1].textContent;

  // Susun detail sebagai key-value untuk tampilkan
  const detailData = {
    'Status': statusText,
  };

  // Masukkan semua key dari dataMap dan nilainya
  dataMap.forEach((key, idx) => {
    detailData[key] = row.cells[2 + idx].textContent;
  });

  // Render ke table detailBody
  const tbody = document.getElementById('detailBody');
  tbody.innerHTML = ''; // clear

  for (const [key, val] of Object.entries(detailData)) {
    const tr = document.createElement('tr');
    const tdKey = document.createElement('td');
    tdKey.textContent = key;
    const tdVal = document.createElement('td');
    tdVal.textContent = val;
    tr.appendChild(tdKey);
    tr.appendChild(tdVal);
    tbody.appendChild(tr);
  }

  // Tampilkan panel
  document.getElementById('detailPanel').style.display = 'block';
}

/* Tombol tutup detail */
document.getElementById('closeDetail').onclick = () => {
  document.getElementById('detailPanel').style.display = 'none';
};

/* ================= MQTT ================= */
const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);

client.on('connect', () => {
  conn.textContent = 'âœ… MQTT Connected';
  client.subscribe(MQTT_TOPIC);
});

client.on('reconnect', () => {
  conn.textContent = 'ðŸ”„ MQTT Reconnecting...';
});

client.on('error', (err) => {
  conn.textContent = 'âŒ MQTT Error';
  console.error('MQTT Error:', err);
});

client.on('message', (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    const id = Number(d.id);
    if (!id || id < 1 || id > TOTAL_DEVICES) {
      console.warn('Invalid ID in payload', d);
      return;
    }

    if (!devices[id]) {
      createInitialRows();
      attachRowClicks();
    }
    const row = devices[id];
    const status = (d.status && d.status.toLowerCase() === 'online') ? 'online' : 'offline';
    row.cells[1].textContent = status.toUpperCase();
    row.cells[1].className = status === 'online' ? 'status-online' : 'status-offline';

    dataMap.forEach((key, idx) => {
      const cell = row.cells[2 + idx];
      let raw = d[key];

      if (key === 'OpH') {
        cell.textContent = (raw === 0 || raw) ? formatOpH(raw) : '---';
      } else {
        cell.textContent = (raw === 0 || raw) ? fmt(raw, key) : '---';
      }
    });

  } catch (e) {
    console.error('Payload parse error:', e, message.toString());
  }
});
</script>
</body>
</html>

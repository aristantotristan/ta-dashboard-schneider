<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Realtime Dashboard</title>
    <style>
        body { font-family: Arial; background:#f2f2f2; padding:20px; }
        .card { padding:20px; background:white; border-radius:10px; margin-bottom:20px; }
        h2 { margin:0 0 10px 0; }
    </style>

    <!-- Supabase v2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="card">
    <h2>Realtime Energi</h2>
    <p>Voltage: <span id="v">-</span></p>
    <p>Current: <span id="c">-</span></p>
    <p>Power: <span id="p">-</span></p>
    <p>Total kWh: <span id="ea">-</span></p>
    <p>Δ kWh: <span id="delta">-</span></p>
</div>

<script>
/* -----------------------------
   1. SETUP SUPABASE
--------------------------------*/
const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* -----------------------------
   2. VARIABLES OFFLINE-SAFE
--------------------------------*/
let lastEa = null;  // Ea sebelumnya (persist)
let isFirst = true;

/* -----------------------------
   3. THINGSBOARD WEBSOCKET
--------------------------------*/
const ws = new WebSocket("wss://demo.thingsboard.io/api/ws/plugins/telemetry?token=YOUR_TOKEN");

ws.onopen = () => {
    ws.send(JSON.stringify({
        tsSubCmds: [{
            entityType: "DEVICE",
            entityId: "YOUR_DEVICE_ID",
            scope: "LATEST_TELEMETRY",
            cmdId: 1
        }],
        historyCmds: [],
        attrSubCmds: []
    }));
};

ws.onmessage = async (msg) => {
    const data = JSON.parse(msg.data);
    if (!data.data) return;

    const t = data.data;

    let v = t.voltage?.[0]?.value ?? null;
    let c = t.current?.[0]?.value ?? null;
    let p = t.power?.[0]?.value ?? null;
    let ea = t.energy?.[0]?.value ?? null;

    if (ea == null) return;

    document.getElementById("v").innerText = v;
    document.getElementById("c").innerText = c;
    document.getElementById("p").innerText = p;
    document.getElementById("ea").innerText = ea;

    /* -----------------------------
       4. HITUNG Δ kWh tahan offline
    --------------------------------*/
    let delta = 0;

    if (isFirst) {
        lastEa = ea;
        isFirst = false;
    } else {
        if (ea >= lastEa) {
            delta = ea - lastEa;   // normal
        } else {
            delta = ea;            // modul reset / ESP reboot
        }
        lastEa = ea;
    }

    document.getElementById("delta").innerText = delta.toFixed(3);

    /* -----------------------------
       5. INSERT KE TABEL T1 (raw)
    --------------------------------*/
    await supabase.from("T1").insert({
        voltage: v,
        current: c,
        power: p,
        ea_total: ea,
        delta_kwh: delta
    });

    /* -----------------------------
       6. INSERT KE TABEL T2 (rekap)
    --------------------------------*/
    await supabase.from("T2").insert({
        tanggal: new Date().toISOString(),
        energi: delta
    });
};

</script>
</body>
</html>

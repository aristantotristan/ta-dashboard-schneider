<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>âš¡ Master Power Meter Dashboard (18 SLAVES) - Mobile Friendly</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* -------------------------------------
Â  Â Theme & Responsive UI (Mobile-first)
Â  Â ------------------------------------- */
:root{
Â  --bg:#0f0f11; --card:#1a1a1a; --muted:#9aa7b2; --accent:#00ffc2;
Â  --online:#10b981; --offline:#ef4444; --tariff:#facc15;
Â  --power-color: #7dd3fc; /* Biru muda */
Â  --energy-color: #86efac; /* Hijau muda */
}
html,body{height:100%;}
body{
Â  margin:0; padding:16px; background:linear-gradient(180deg,#0b0b0b 0%, #0f0f11 100%);
Â  font-family:Inter, 'Segoe UI', system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial;
Â  color:#e6eef1; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
/* Header */
.header{
Â  display:flex; align-items:center; gap:12px; justify-content:space-between;
Â  max-width:1100px; margin:0 auto 12px auto; padding:6px 0;
}
.h-left{display:flex; flex-direction:column;}
h2{margin:0; color:var(--accent); font-size:clamp(1rem,4vw,1.4rem);}
#conn{font-size:0.85rem;color:var(--muted); margin-top:6px; display:flex; align-items:center; gap:6px;}

/* Grid container */
.container{max-width:1100px; margin:0 auto;}
#main-view{
Â  display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;
}

/* Card - DITINGKATKAN */
.machine-card{
Â  /* Efek Glassmorphism halus */
Â  background:rgba(255, 255, 255, 0.05);
Â  backdrop-filter: blur(4px);
Â  border:1px solid rgba(255,255,255,0.06);
Â  border-radius:12px; padding:12px 10px; height:100px;
Â  display:flex; flex-direction:column; justify-content:space-between; align-items:flex-start;
Â  position:relative; overflow:hidden;
Â  box-shadow:0 6px 18px rgba(0,0,0,0.6);
Â  cursor:pointer;
}
.card-top{display:flex; align-items:flex-start; width:100%; justify-content:space-between}
.card-title{font-weight:700; font-size:1.05rem; color:#bfefff; margin:0; line-height:1.2;}
.sid{font-size:0.75rem; color:var(--muted); margin-top:4px; font-weight:500;}
.small-badge{
Â  font-size:0.72rem; color:var(--muted);
Â  background:rgba(255,255,255,0.02);
Â  padding:6px 8px; border-radius:6px;
Â  font-weight:600;
}

/* Status Badge BARU */
.status-badge {
Â  font-size: 0.75rem;
Â  font-weight: 700;
Â  padding: 4px 8px;
Â  border-radius: 999px;
Â  align-self: flex-end;
Â  display: flex;
Â  align-items: center;
Â  gap: 4px;
Â  letter-spacing: 0.5px;
Â  text-transform: uppercase;
}

.status-online {
Â  background: rgba(16, 185, 129, 0.15);
Â  color: var(--online);
}

.status-offline {
Â  background: rgba(239, 68, 68, 0.15);
Â  color: var(--offline);
}
.badge-icon { font-size: 0.8em; }

/* Modal overlay */
#modal-overlay{
Â  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
Â  background:rgba(2,6,23,0.85);
Â  backdrop-filter:blur(10px); z-index:1000; padding:18px;
}
#modal{
Â  width:100%; max-width:780px;
Â  background:var(--card); border-radius:12px;
Â  box-shadow:0 12px 40px rgba(0,0,0,0.8);
Â  color:#eaf6f5; max-height:92vh; overflow:hidden;
Â  display: flex; flex-direction: column;
}
#modal-header {
Â  padding: 16px 20px;
Â  border-bottom: 1px solid rgba(255,255,255,0.05);
Â  position: relative;
}
#modal h3{ margin:0; color:var(--accent); font-size:1.4rem; display:flex; align-items:center; gap:10px;}
#close-modal{
Â  position:absolute; right:16px; top:14px; background:transparent; border:0;
Â  color:var(--muted); font-size:24px; cursor:pointer; opacity:0.7; transition:opacity 150ms;
}
#close-modal:hover{ opacity:1; }

#modal-content {
Â  overflow-y: auto;
Â  padding: 0 20px;
Â  flex-grow: 1;
}

#modal-footer {
Â  padding: 12px 20px;
Â  border-top: 1px solid rgba(255,255,255,0.05);
Â  font-size: 0.85rem;
Â  color: var(--muted);
Â  text-align: right;
}

/* Detail table (PROFESIONAL) */
#detail-table{ width:100%; border-collapse:separate; border-spacing:0 4px; margin-top:8px }
#detail-table th,#detail-table td{ padding:12px 10px; text-align:left; font-size:0.95rem; }
#detail-table thead th{
Â  color:var(--accent); font-weight:700; font-size:0.8rem;
Â  text-transform: uppercase; letter-spacing: 0.5px;
Â  background: rgba(0,255,194, 0.05);
}
#detail-table tbody tr {
Â  background: rgba(255,255,255,0.02);
Â  border-radius: 4px;
Â  transition: background 150ms;
}
#detail-table tbody tr:hover {
Â  background: rgba(255,255,255,0.05);
}

.param-name{ font-weight:600; width:45% }
.param-value{ font-family: 'Consolas', 'Courier New', monospace; font-weight: 700; }
.col-power{ color:var(--power-color) }
.col-energy{ color:var(--energy-color) }
.col-tariff{ color:var(--tariff) }
.col-status-modal {
Â  font-weight: 700;
Â  text-transform: uppercase;
Â  letter-spacing: 1px;
}
.col-status-modal.online { color: var(--online); }
.col-status-modal.offline { color: var(--offline); }

/* Responsive tweaks */
@media(min-width:720px){ #main-view{ grid-template-columns:repeat(3,1fr); } }
@media(min-width:980px){ #main-view{ grid-template-columns:repeat(6,1fr); } }
@media(max-width:420px){ .machine-card{ height:90px; padding:10px } }

/* subtle hover for desktop */
.machine-card:hover{
Â  transform:translateY(-4px);
Â  transition:transform 180ms, box-shadow 180ms;
Â  box-shadow:0 10px 25px rgba(0,0,0,0.7);
}

/* small helper */
.center-note{ text-align:center; color:var(--muted); font-size:0.9rem; margin-top:8px }
</style>
</head>
<body>

<div class="header container">
Â  <div class="h-left">
Â  Â  <h2><i class="fas fa-bolt" style="color:var(--accent);"></i> Power Meter Dashboard</h2>
Â  Â  <div id="conn"><i class="fas fa-sync fa-spin"></i>Connecting...</div>
Â  </div>
Â  <div class="h-right">
Â  Â  Â  </div>
</div>

<div class="container">
Â  <div id="main-view" aria-live="polite"></div>
Â  <div class="center-note">Tap kartu untuk lihat detail â€¢ SID = Sensor ID</div>
</div>

<div id="modal-overlay" role="dialog" aria-modal="true">
Â  <div id="modal">
Â  Â  <div id="modal-header">
Â  Â  Â  <button id="close-modal" aria-label="Tutup detail">&times;</button>
Â  Â  Â  <h3 id="modal-title"><i class="fas fa-chart-line"></i> Detail Mesin</h3>
Â  Â  </div>
Â  Â  <div id="modal-content">
Â  Â  Â  <table id="detail-table" aria-label="Detail Parameter">
Â  Â  Â  Â  <thead><tr><th>Parameter</th><th>Nilai</th></tr></thead>
Â  Â  Â  Â  <tbody id="detailBody"></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  Â  <div id="modal-footer">
Â  Â  Â  Data diperbarui secara real-time dari server MQTT
Â  Â  </div>
Â  </div>
</div>

<script>
/* ========== CONFIG (tidak diubah) ========== */
const MQTT_OPTIONS = { username: "web_dashboard", password: "Tristan12", connectTimeout: 4000, reconnectPeriod: 2000 };
const MQTT_URL = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_TOPIC = "politeknik/meter/data";
const TOTAL_DEVICES = 18;

/* ========== MACHINE TAGS ========== */
const MACHINE_TAGS = { 1:'UNKNOW',2:'UNKNOW',3:'POMPA MC 12',4:'MC 9',5:'UNKNOW',6:'MC 40',7:'MC 39',8:'MC 6',9:'HEATER MC 5',10:'POMPA MC 5',11:'UNKNOW',12:'MC 34',13:'MC 35',14:'UNKNOW',15:'UNKNOW',16:'MC 38',17:'MC 36',18:'MC 37' };

/* ========== HELPERS (TIDAK DIUBAH FUNGSINYA) ========== */
function formatOpH(hours){ if(hours===null||hours===undefined||isNaN(hours)||hours<0) return '---'; const totalMinutes=Math.round(parseFloat(hours)*60); const days=Math.floor(totalMinutes/(24*60)); const rem=totalMinutes%(24*60); const hrs=Math.floor(rem/60); const mins=rem%60; if(days>0) return `${days} Hari ${hrs} Jam`; if(hrs>0) return `${hrs} Jam${mins>0? ' '+mins+' Mnt':''}`; if(mins>0) return `${mins} Mnt`; return '0 Jam'; }
function fmt(val,key){ if(val===null||val===undefined||isNaN(val)) return '---'; const n=Number(val); if(['V'].includes(key)) return n.toFixed(1); if(['I1','I2','I3'].includes(key)) return n.toFixed(3); if(['P','Q'].includes(key)) return Math.round(n).toString(); if(['S'].includes(key)) return n.toFixed(2); if(['PF'].includes(key)) return n.toFixed(3); if(['Hz'].includes(key)) return n.toFixed(1); if(['EaT','ErT','EaP','ErP','T1','T2'].includes(key)) return n.toFixed(2); return n.toString(); }
function getStyleClass(key){ if(key==='T1'||key==='T2') return 'col-tariff'; if(['EaT','ErT','EaP','ErP'].includes(key)) return 'col-energy'; if(['P','Q','S'].includes(key)) return 'col-power'; return ''; }
const dataLabels={ 'V':'Tegangan (V)','I1':'Arus Fasa 1 (A)','I2':'Arus Fasa 2 (A)','I3':'Arus Fasa 3 (A)','P':'Daya Aktif (W)','Q':'Daya Reaktif (VAR)','S':'Daya Semu (kVA)','PF':'Faktor Daya','Hz':'Frekuensi (Hz)','OpH':'Jam Operasi','EaT':'Energi Aktif Total (kWh)','ErT':'Energi Reaktif Total (kVARh)','EaP':'Energi Aktif Parsial (kWh)','ErP':'Energi Reaktif Parsial (kVARh)','T1':'Tarif 1 (kWh)','T2':'Tarif 2 (kWh)'};

/* ========== DOM refs & storage ========== */
const mainView = document.getElementById('main-view');
const conn = document.getElementById('conn');
const modalOverlay = document.getElementById('modal-overlay');
const modalTitle = document.getElementById('modal-title');
const detailBody = document.getElementById('detailBody');
const closeModalBtn = document.getElementById('close-modal');

const dataMap = ['V','I1','I2','I3','P','Q','S','PF','Hz','OpH','EaT','ErT','EaP','ErP','T1','T2'];
const devices = {}; // store card refs
const deviceData = {};
for(let i=1;i<=TOTAL_DEVICES;i++) deviceData[i] = {};

/* ========== create cards (Perbaikan Template) ========== */
function createCards(){
Â  mainView.innerHTML='';
Â  for(let id=1;id<=TOTAL_DEVICES;id++){
Â  Â  const tag=MACHINE_TAGS[id]||'Mesin Tidak Dikenal';
Â  Â  const card=document.createElement('div');
Â  Â  card.className='machine-card';
Â  Â  card.dataset.id=id;
Â  Â  card.title = `Mesin ${id} = ${tag}`;
Â  Â  card.onclick = ()=> showDetailModal(id);

Â  Â  // Template Kartu Baru (dengan Badge Status)
Â  Â  card.innerHTML = `
Â  Â  Â  <div class="card-top">
Â  Â  Â  Â  <div style="display:flex;flex-direction:column">
Â  Â  Â  Â  Â  <p class="card-title">${tag}</p>
Â  Â  Â  Â  Â  <span class="sid">SID ${id}</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="small-badge">#${id}</div>
Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="status-badge-${id}" class="status-badge status-offline">
Â  Â  Â  Â  <i class="badge-icon fas fa-times-circle"></i> OFFLINE
Â  Â  Â  </div>
Â  Â  `;
Â  Â  mainView.appendChild(card);

Â  Â  // Store reference to the new status badge element
Â  Â  devices[id] = { card, indicator: document.getElementById(`status-badge-${id}`) };
Â  }
}
createCards();

/* ========== modal functions (TIDAK DIUBAH FUNGSINYA) ========== */
function showDetailModal(id){
Â  const d = deviceData[id]||{};
Â  const machineTag = MACHINE_TAGS[id]||'NAMA MESIN';
Â  const currentStatus = (d.status && d.status.toLowerCase()==='online') ? 'online' : 'offline';

Â  // Update modal title dengan ikon
Â  modalTitle.innerHTML = `<i class="fas fa-chart-line"></i> Detail SID ${id} â€” ${machineTag}`;

Â  detailBody.innerHTML='';

Â  // 1. Status Row
Â  const trStatus = document.createElement('tr');
Â  const icon = (currentStatus === 'online') ? '<i class="fas fa-circle-check"></i>' : '<i class="fas fa-circle-xmark"></i>';
Â  trStatus.innerHTML = `<td class="param-name">Status Sensor</td><td class="param-value col-status-modal ${currentStatus}">${icon} ${currentStatus.toUpperCase()}</td>`;
Â  detailBody.appendChild(trStatus);

Â  // 2. Data Rows
Â  dataMap.forEach(key=>{
Â  Â  const tr=document.createElement('tr');
Â  Â  const raw=d[key];
Â  Â  let v;
Â  Â  if(key==='OpH'){
Â  Â  Â  v=(raw===0||raw)?formatOpH(raw):'---';
Â  Â  } else {
Â  Â  Â  v=(raw===0||raw)?fmt(raw,key):'---';
Â  Â  }
Â  Â  tr.innerHTML = `<td class="param-name">${dataLabels[key]}</td><td class="param-value ${getStyleClass(key)}">${v}</td>`;
Â  Â  detailBody.appendChild(tr);
Â  });

Â  modalOverlay.style.display='flex';
Â  document.body.style.overflow='hidden';
}
function closeDetailModal(){ modalOverlay.style.display='none'; document.body.style.overflow=''; }
closeModalBtn.addEventListener('click', closeDetailModal); modalOverlay.addEventListener('click', e=>{ if(e.target===modalOverlay) closeDetailModal(); }); window.addEventListener('keydown', e=>{ if(e.key==='Escape' && modalOverlay.style.display==='flex') closeDetailModal(); });

/* ========== MQTT (Perbaikan Update Indikator) ========== */
const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);

client.on('connect', ()=>{
Â  conn.innerHTML = 'âœ… <i class="fas fa-cloud-arrow-up"></i> MQTT Connected';
Â  client.subscribe(MQTT_TOPIC);
});

client.on('reconnect', ()=>{
Â  conn.innerHTML = 'ğŸ”„ <i class="fas fa-sync fa-spin"></i> MQTT Reconnecting...';
});

client.on('error', err=>{
Â  conn.innerHTML = 'âŒ <i class="fas fa-triangle-exclamation"></i> MQTT Error';
Â  console.error('MQTT Error:',err);
});

client.on('message', (topic,message)=>{
Â  try{
Â  Â  const d = JSON.parse(message.toString());
Â  Â  const id = Number(d.id);
Â  Â  if(!id||id<1||id>TOTAL_DEVICES){ console.warn('Invalid ID',d); return; }
Â  Â  deviceData[id] = d;

Â  Â  // Perbaikan update status badge (indicator adalah elemen badge baru)
Â  Â  if(devices[id] && devices[id].indicator){
Â  Â  Â  const status = (d.status && d.status.toLowerCase()==='online') ? 'online' : 'offline';
Â  Â  Â  const indicator = devices[id].indicator;

Â  Â  Â  // Update class
Â  Â  Â  indicator.className = `status-badge status-${status}`;

Â  Â  Â  // Update content (text and icon)
Â  Â  Â  if (status === 'online') {
Â  Â  Â  Â  indicator.innerHTML = '<i class="badge-icon fas fa-circle-dot"></i> ONLINE';
Â  Â  Â  } else {
Â  Â  Â  Â  indicator.innerHTML = '<i class="badge-icon fas fa-times-circle"></i> OFFLINE';
Â  Â  Â  }
Â  Â  }
Â  }catch(e){ console.error('Payload parse error:', e, message.toString()); }
});

</script>
</body>
</html>

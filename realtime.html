<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Master Power Meter Dashboard (18 Mesin)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
/* Global Styling & Background */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0f0f0f;
    color: #E0E0E0;
    padding: 0;
    margin: 0;
    /* Background Tema Profesional (Energy Grid) */
    background-image: url('https://images.unsplash.com/photo-1542385108611-667dc9df9c40?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyMzZ8MHwxfHxtYXN0ZXIlMjBlbmVyZ3klMjBncmlkJTIwZGFzaGJvYXJkJTIwYmFja2dyb3VuZHR8ZW58MHx8fHwxNzA2NjI0NzAwfDA&ixlib=rb-4.0.3&q=80&w=1920');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    min-height: 100vh;
}
.container {
    padding: 20px 40px;
    background-color: rgba(15, 15, 15, 0.9); /* Overlay gelap */
    min-height: 100vh;
}
h2 {
    color: #00FFC2;
    text-shadow: 0 0 5px rgba(0, 255, 194, 0.5);
    border-bottom: 2px solid #3A3A3A;
    padding-bottom: 15px;
    margin-bottom: 10px;
}
#conn {
    margin-bottom: 30px;
    font-size: 1.1em;
    font-weight: bold;
    color: #38BDF8;
    animation: pulse 1.5s infinite;
}

/* --- SUMMARY VIEW (CARD GRID) --- */
#summaryView {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    padding: 10px 0;
}
.machine-card {
    background: #1E1E1E;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    padding: 25px;
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-left 0.3s ease;
    border-left: 5px solid #3A3A3A;
}
.machine-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.9);
}
.card-name { /* Warna default: Biru */
    font-size: 1.5em;
    font-weight: 700;
    color: #38BDF8;
    margin-bottom: 5px;
    letter-spacing: 1px;
}
.card-name.unknow-red {
    color: #FF4444; 
    text-shadow: 0 0 5px rgba(255, 68, 68, 0.4); 
}
.card-id-text {
    font-size: 0.9em;
    color: #B0B0B0;
    margin-bottom: 15px;
}
.status-wrapper {
    display: flex;
    align-items: center;
    font-size: 1.2em;
}
.status-indicator {
    display: inline-block;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    margin-right: 10px;
}
.status-online {
    background-color: #10B981;
    box-shadow: 0 0 10px #10B981;
    color: #10B981;
}
.status-offline {
    background-color: #EF4444;
    box-shadow: 0 0 10px #EF4444;
    color: #EF4444;
}
.detail-button {
    margin-top: 20px;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    background-color: #00FFC2;
    color: #121212;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
    text-transform: uppercase;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}
.detail-button:hover {
    background-color: #00E6B9;
    transform: scale(1.05);
}

.card-online {
    border-left: 5px solid #10B981 !important;
}
.card-offline {
    border-left: 5px solid #EF4444 !important;
}


/* --- DETAIL VIEW (TABLE) --- */
#detailView {
    background: #1E1E1E;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    margin-top: 40px;
    display: none;
}
#detailHeader {
    font-size: 1.8em;
    color: #00FFC2;
    margin-bottom: 25px;
    font-weight: 700;
    border-bottom: 1px solid #3A3A3A;
    padding-bottom: 10px;
}
table {
    border-collapse: collapse;
    width: 100%;
}
th, td {
    border: none;
    padding: 12px 15px;
    text-align: left;
}
thead th {
    background: #2A2A2A;
    color: #38BDF8;
    text-transform: uppercase;
    font-weight: 600;
    font-size: 0.9em;
}
tbody tr:nth-child(even) {
    background: #181818;
}
tbody tr:hover {
    background: #333333;
}
tbody td:nth-child(2) {
    font-weight: bold;
    color: #E0E0E0;
    text-align: right;
    font-size: 1.1em;
}

.back-button {
    margin-top: 30px;
    padding: 12px 25px;
    background-color: #EF4444;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
}
.back-button:hover {
    background-color: #D63030;
    transform: scale(1.05);
}

/* Keyframes for animation */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

</style>
</head>

<body>

<div class="container">
    <h2>Real-time Power Meter Dashboard (18 Mesin)</h2>
    <p id="conn">Connecting...</p>

    <div id="summaryView">
        <p style="grid-column: 1 / -1; text-align: center; color: #94A3B8;">Initializing 18 Machine Cards...</p>
    </div>

    <div id="detailView">
        <div id="detailHeader">Detail Parameter Mesin: <span id="currentMachineName">---</span></div>
        <table>
            <thead>
                <tr>
                    <th style="width: 50%;">Parameter</th>
                    <th style="width: 50%;">Nilai Real-time</th>
                </tr>
            </thead>
            <tbody id="detailTableBody">
                </tbody>
        </table>
        <button class="back-button" onclick="showSummary()">⬅️ Kembali ke Ringkasan</button>
    </div>

</div> 
<script>
// =======================================================
// --- FUNGIONALITAS UTAMA & KONFIGURASI ---
// =======================================================

// --- KONFIGURASI SUPABASE (PASTIKAN KREDENSIAL INI BENAR) ---
const SUPA_URL = "https://rojhcadtqfynlqzubftx.supabase.co"; 
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJojhcadtqfynlqzubftxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs"; 
const TABLE_NAME = "ea_18mesin";
const EA_THRESHOLD = 0.01; // Batas minimal perubahan EaT untuk trigger log (0.01 kWh)

let supa = supabase.createClient(SUPA_URL, SUPA_ANON);

// --- DOM ELEMENTS ---
const summaryView = document.getElementById("summaryView");
const detailView = document.getElementById("detailView");
const detailTableBody = document.getElementById("detailTableBody");
const currentMachineNameSpan = document.getElementById("currentMachineName");
const conn = document.getElementById("conn");

// --- VARIABEL GLOBAL ---
const MACHINE_IDS = Array.from({length: 18}, (_, i) => i + 1);
const dataBuffer = {}; // Buffer untuk menyimpan data real-time lengkap
const devices = {}; // Menyimpan referensi DOM setiap kartu mesin
let isSending = false;

// --- MAPPING NAMA MESIN ---
const MACHINE_NAMES = {
    1: 'UNKNOW', 2: 'UNKNOW', 3: 'POMPA MC 12', 4: 'MC 9', 5: 'UNKNOW', 6: 'MC 40', 
    7: 'MC 39', 8: 'MC 6', 9: 'HEATER MC 5', 10: 'POMPA MC 5', 11: 'UNKNOW', 
    12: 'MC 34', 13: 'MC 35', 14: 'UNKNOW', 15: 'UNKNOW', 16: 'MC 38', 
    17: 'MC 36', 18: 'MC 37',
};

// --- MAPPING PARAMETER UNTUK DETAIL TABLE ---
const dataMap = [
    { key: 'V', label: 'Tegangan (V)' }, { key: 'I1', label: 'Arus Fasa 1 (A)' }, { key: 'I2', label: 'Arus Fasa 2 (A)' },
    { key: 'I3', label: 'Arus Fasa 3 (A)' }, { key: 'P', label: 'Daya Aktif (Watt)' }, { key: 'Q', label: 'Daya Reaktif (VAR)' },
    { key: 'S', label: 'Daya Semu (kVA)' }, { key: 'PF', label: 'Faktor Daya (PF)' }, { key: 'Hz', label: 'Frekuensi (Hz)' },
    { key: 'OpH', label: 'Jam Operasi (OpH)' }, { key: 'EaT', label: 'Energi Aktif Total (kWh)' }, { key: 'ErT', label: 'Energi Reaktif Total (kVARh)' },
    { key: 'EaP', label: 'Energi Aktif Parsial (kWh)' }, { key: 'ErP', label: 'Energi Reaktif Parsial (kVARh)' }
];


// =======================================================
// --- FUNGSI NAVIGASI TAMPILAN ---
// =======================================================

function showDetail(id) {
    summaryView.style.display = 'none';
    detailView.style.display = 'block';
    currentMachineNameSpan.textContent = MACHINE_NAMES[id] + ` (ID: ${id})`;
    renderDetailTable(id);
}

function showSummary() {
    detailView.style.display = 'none';
    summaryView.style.display = 'grid';
}


// =======================================================
// --- FUNGSI TEMPLATE DAN RENDER ---
// =======================================================

function createMachineCard(id) {
    const card = document.createElement('div');
    const machineName = MACHINE_NAMES[id] || `Mesin ID ${id}`; 
    const nameClass = machineName === 'UNKNOW' ? 'card-name unknow-red' : 'card-name';

    card.className = 'machine-card';
    card.id = `card-${id}`;
    card.innerHTML = `
        <div class="${nameClass}">${machineName}</div>
        <div class="card-id-text">ID: ${id}</div>
        <div class="status-wrapper">
            <span id="statusIndicator-${id}" class="status-indicator status-offline"></span>
            <span id="statusText-${id}" class="status-offline">OFFLINE</span>
        </div>
        
        <p style="margin-top: 15px; font-size: 1.1em;">
            Daya Aktif (Watt): 
            <strong id="realtimePower-${id}" style="color: #FFC107;">---</strong>
        </p>

        <button class="detail-button" onclick="showDetail(${id})">Lihat Detail Parameter</button>
    `;
    summaryView.appendChild(card);
    devices[id] = {
        card: card,
        indicator: document.getElementById(`statusIndicator-${id}`),
        text: document.getElementById(`statusText-${id}`),
        powerValue: document.getElementById(`realtimePower-${id}`), // Referensi untuk update Daya
    };
}

/** Fungsionalitas: Mengisi tabel detail dengan data terbaru dari dataBuffer */
function renderDetailTable(id) {
    const data = dataBuffer[id] || {};
    detailTableBody.innerHTML = '';

    dataMap.forEach(item => {
        const tr = detailTableBody.insertRow();
        const tdLabel = tr.insertCell();
        tdLabel.textContent = item.label;
        const tdValue = tr.insertCell();

        let value = data[item.key] !== undefined ? data[item.key] : '---';

        if (item.key === 'OpH') {
            value = formatOperatingTime(value);
        } else if (typeof value === 'number' && value !== '---') {
            value = value.toFixed(3);
        }

        tdValue.textContent = value;
    });
}

function formatOperatingTime(totalHours) {
    if (totalHours === undefined || totalHours === null || isNaN(totalHours) || totalHours < 0) return '---';
    const totalMinutes = Math.round(parseFloat(totalHours) * 60);
    const days = Math.floor(totalMinutes / (24 * 60));
    const remainingMinutes = totalMinutes % (24 * 60);
    const hours = Math.floor(remainingMinutes / 60);
    const minutes = remainingMinutes % 60;

    let result = '';

    if (days > 0) result += `${days} Hari `;
    if (hours > 0 || days === 0) {
        result += `${hours} Jam`;
        if (minutes > 0) result += ` ${minutes} Mnt`;
    } else if (minutes > 0) {
        result += `${minutes} Mnt`;
    }
    return result.trim() || '0 Jam';
}

// =======================================================
// --- INISIALISASI ---
// =======================================================

document.addEventListener('DOMContentLoaded', () => {
    // 1. Inisialisasi semua kartu mesin di Summary View
    summaryView.innerHTML = ''; 
    MACHINE_IDS.forEach(id => createMachineCard(id));
});


// =======================================================
// --- LOGIKA UTAMA ON MESSAGE (UPDATE DASHBOARD & BUFFERING) ---
// =======================================================

// --- KONFIGURASI MQTT WEB CLIENT ---
const options = {
    username: "web_dashboard",
    password: "Tristan12",
    connectTimeout: 4000,
    reconnectPeriod: 2000,
};

const client = mqtt.connect(
    "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt", // GANTI INI DENGAN URL MQTT ANDA
    options
);

client.on("connect", () => {
    conn.innerHTML = "✅ MQTT Connected";
    client.subscribe("politeknik/meter/data");
});

client.on("error", err => {
    conn.innerHTML = "❌ MQTT Error";
    console.error("MQTT Connection Error:", err);
});

/** Handler utama data MQTT masuk */
client.on("message", (topic, message) => {
    try {
        const d = JSON.parse(message.toString());
        const id = Number(d.id);
        const ea = Number(d.EaT);

        // 1. SIMPAN DATA LENGKAP KE BUFFER
        if (id && ea !== null && !isNaN(ea)) {
            dataBuffer[id] = { ...d, ea: ea };
        }

        // 2. UPDATE SUMMARY CARD VIEW (STATUS & DAYA REAL-TIME)
        if (devices[id]) {
            const status = d.status ? d.status.toLowerCase() : 'offline';
            const statusClass = status === 'online' ? 'status-online' : 'status-offline';

            // Update Status Visual
            devices[id].card.classList.remove('card-online', 'card-offline');
            devices[id].card.classList.add(`card-${status}`);
            devices[id].indicator.className = `status-indicator ${statusClass}`;
            devices[id].text.textContent = status.toUpperCase();
            devices[id].text.className = statusClass;
            
            // Update nilai Daya Aktif (P) di Summary Card
            let power = d.P !== undefined && !isNaN(d.P) ? d.P.toFixed(2) : '---';
            devices[id].powerValue.textContent = power; 

            // 3. JIKA SEDANG DI DETAIL VIEW, UPDATE TABEL DETAIL
            const currentDetailText = currentMachineNameSpan.textContent;
            const currentDetailIdMatch = currentDetailText.match(/ID: (\d+)/);
            const currentDetailId = currentDetailIdMatch ? Number(currentDetailIdMatch[1]) : null;
            
            if (detailView.style.display === 'block' && currentDetailId === id) {
                renderDetailTable(id);
            }
        }

    } catch (e) {
        console.error(`JSON Parsing Error/Proses Data Gagal:`, e);
    }
});


// =======================================================
// --- LOGIKA PENGIRIMAN BERURUTAN & PAKSA LOG KE SUPABASE ---
// =======================================================

// --- FUNGSI BANTU LOGGING (LOCAL STORAGE) ---
function loadLastEa(id) {
    const s = localStorage.getItem("lastEa_" + id);
    return s ? Number(s) : undefined;
}
function saveLastEa(id, val) {
    localStorage.setItem("lastEa_" + id, val);
}
function saveLastSupaLogTime(id, time) {
    localStorage.setItem("lastSupaLogTime_" + id, time);
}

/** Fungsionalitas: Memasukkan log energi ke Supabase */
async function insertEnergyLog(entry) {
    try {
        const { id_mesin, ea } = entry;
        const now = new Date();
        
        // Objek yang dikirim ke Supabase harus match dengan skema: t, id_mesin, EaT
        const supaEntry = {
            t: now.toISOString(), 
            id_mesin: id_mesin,
            // PENTING: Menggunakan key "EaT" agar sesuai dengan nama kolom di PostgreSQL
            "EaT": ea
        };

        const { error } = await supa.from(TABLE_NAME).insert([supaEntry]);
        if (error) throw error;
        
        // Setelah sukses, simpan waktu log terakhir
        saveLastSupaLogTime(id_mesin, now.getTime());
        
    } catch (e) {
        console.error(`[LOG ID ${entry.id_mesin}] Gagal menyimpan log ke Supabase:`, e.message);
    }
}


/** Fungsionalitas: Iterasi melalui 18 Mesin dan mengirim data yang sudah di-buffer ke Supabase */
async function sendBufferedDataSequentially() {
    if (isSending) return;
    isSending = true;

    for (const id of MACHINE_IDS) {
        // Cek apakah data mesin ini ada di buffer
        if (dataBuffer[id] && dataBuffer[id].ea !== undefined) {
            const ea = dataBuffer[id].ea; // Nilai EaT Kumulatif
            const now = new Date();

            // --- Logika Cek Log Wajib 5 Menit ---
            const lastLogTime = localStorage.getItem("lastSupaLogTime_" + id);
            const fiveMinutes = 5 * 60 * 1000;
            const forceLog = !lastLogTime || (now.getTime() - Number(lastLogTime)) > fiveMinutes;

            const lastEa = loadLastEa(id); 

            // Kriteria Log: 1) Ada perubahan besar (>= 0.01) ATAU 2) Sudah waktunya untuk paksa log (setiap 5 menit)
            if (lastEa === undefined || Math.abs(ea - lastEa) >= EA_THRESHOLD || forceLog) {
                
                await insertEnergyLog({
                    id_mesin: id,
                    ea: ea, 
                });
                
                // Simpan nilai Ea Kumulatif terakhir yang berhasil dikirim
                saveLastEa(id, ea);
                
                // Memberi jeda sebentar antar pengiriman mesin (opsional, untuk mencegah overload database)
                await new Promise(resolve => setTimeout(resolve, 50)); 
            }
        }
    }

    isSending = false;
}

// Panggil fungsi pengiriman berurutan setiap 5 detik (5000ms)
setInterval(sendBufferedDataSequentially, 5000);

</script>

</body>
</html>

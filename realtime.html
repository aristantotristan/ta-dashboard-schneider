<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Master Power Meter • 18 Slaves</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --accent: #00e5bd;
      --text: #f0f6fc;
      --muted: #8b949e;
      --online: #00d4aa;
      --offline: #f85149;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100vh;
      background-image: radial-gradient(circle at 20% 80%, rgba(0,229,189,0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(0,229,189,0.05) 0%, transparent 50%);
    }
    .grid-bg {position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:0.4;
      background-image:linear-gradient(rgba(0,229,189,0.03) 1px,transparent 1px),
                       linear-gradient(90deg,rgba(0,229,189,0.03) 1px,transparent 1px);
      background-size:80px 80px;}
    header {text-align:center;padding:3rem 1rem 2rem;}
    h1 {font-size:2.8rem;font-weight:600;color:var(--accent);letter-spacing:-0.5px;margin-bottom:0.5rem;text-shadow:0 0 20px rgba(0,229,189,0.3);}
    .subtitle {font-size:0.95rem;color:var(--muted);letter-spacing:3px;text-transform:uppercase;font-weight:500;}
    #conn {text-align:center;padding:0.7rem 1.5rem;font-family:'JetBrains Mono',monospace;font-size:0.9rem;color:var(--accent);
      background:rgba(0,229,189,0.08);border:1px solid rgba(0,229,189,0.2);border-radius:8px;max-width:420px;margin:0 auto 3rem;}
    #main-view {display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.6rem;padding:0 2rem;max-width:1800px;margin:0 auto;}
    .machine-card {background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1.8rem 1.4rem;cursor:pointer;position:relative;overflow:hidden;transition:all .35s ease;}
    .machine-card::before {content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0;transition:opacity .4s;}
    .machine-card:hover {transform:translateY(-6px);border-color:rgba(0,229,189,0.4);box-shadow:0 12px 32px rgba(0,0,0,0.3),0 0 20px rgba(0,229,189,0.12);}
    .machine-card:hover::before {opacity:1;}
    .card-label {font-size:1.25rem;font-weight:600;color:var(--text);margin-bottom:0.4rem;}
    .sid-label {font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:var(--muted);letter-spacing:1px;}
    .status-indicator {position:absolute;top:16px;right:16px;width:12px;height:12px;border-radius:50%;background:var(--offline);box-shadow:0 0 12px var(--offline);transition:all .4s;}
    .status-online {background:var(--online);box-shadow:0 0 16px var(--online);animation:ping 2s infinite;}
    @keyframes ping {0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.4);opacity:0.7}}

    #modal-overlay {position:fixed;inset:0;background:rgba(13,17,23,0.95);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;z-index:9999;padding:1rem;}
    #modal {background:var(--card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:640px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.5);}
    #modal h3 {font-size:1.5rem;font-weight:600;color:var(--accent);padding:1.5rem 2rem;margin:0;border-bottom:1px solid var(--border);background:rgba(0,229,189,0.04);}
    #close-modal {position:absolute;top:1rem;right:1.5rem;background:none;border:none;font-size:1.8rem;color:var(--muted);cursor:pointer;transition:.3s;}
    #close-modal:hover {color:var(--accent);transform:scale(1.2);}
    #detail-table {width:100%;border-collapse:collapse;font-size:0.95rem;}
    #detail-table th {background:rgba(0,229,189,0.06);color:var(--accent);padding:1rem;text-align:left;font-weight:500;text-transform:uppercase;font-size:0.8rem;letter-spacing:1px;}
    #detail-table td {padding:0.9rem 1rem;border-bottom:1px solid var(--border);}
    #detail-table tbody tr:hover {background:rgba(0,229,189,0.04);}
    .param-name {color:var(--muted);width:52%;}
    .param-value {text-align:right;font-family:'JetBrains Mono',monospace;font-weight:500;}
    .col-energy {color:#a5f3b8;}
    .col-power {color:#7bb3ff;}
    .col-tariff {color:#f5d547;}
    @media (max-width:768px){h1{font-size:2.3rem;}#main-view{padding:0 1rem;gap:1.3rem;}}
    @media (max-width:480px){#main-view{grid-template-columns:1fr 1fr;}}
  </style>
</head>
<body>

<div class="grid-bg"></div>

<header>
  <h1>Master Power Meter</h1>
  <p class="subtitle">18 Slaves • Real-time Monitoring</p>
</header>

<div id="conn">Connecting to HiveMQ Cloud...</div>
<div id="main-view"></div>

<div id="modal-overlay">
  <div id="modal">
    <button id="close-modal" aria-label="Close">×</button>
    <h3 id="modal-title">Detail Parameter • SID --</h3>
    <table id="detail-table">
      <thead><tr><th>Parameter</th><th>Nilai</th></tr></thead>
      <tbody id="detailBody"></tbody>
    </table>
  </div>
</div>

<script>
  const MQTT_OPTIONS = {username:"web_dashboard",password:"Tristan12",connectTimeout:4000,reconnectPeriod:2000};
  const MQTT_URL = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
  const MQTT_TOPIC = "politeknik/meter/data";
  const TOTAL_DEVICES = 18;
  const MACHINE_TAGS = {1:'UNKNOW',2:'UNKNOW',3:'POMPA MC 12',4:'MC 9',5:'UNKNOW',6:'MC 40',7:'MC 39',8:'MC 6',9:'HEATER MC 5',10:'POMPA MC 5',11:'UNKNOW',12:'MC 34',13:'MC 35',14:'UNKNOW',15:'UNKNOW',16:'MC 38',17:'MC 36',18:'MC 37'};

  // PERSIS SEPERTI FOTO KAMU
  const order = ['EaT','ErT','EaP','ErP','V','I1','P','Q','S','PF','T1','Hz','OpH'];
  const labels = {
    'EaT': '1. Total Ea',
    'ErT': '2. Total Er',
    'EaP': '3. Partial Ea',
    'ErP': '4. Partial Er',
    'V':   '5. Voltage',
    'I1':  '6. Current',
    'P':   '7. Total Active(P)',
    'Q':   '8. Total Reactive (Q)',
    'S':   '9. Total Apparent (S)',
    'PF':  '10. PF',
    'T1':  '11. Tarif T1',
    'T2':  '    T2',
    'Hz':  '12. Freq',
    'OpH': '13. Op Time'
  };
  const units = {
    'EaT':'kWh','ErT':'kVARh','EaP':'kWh','ErP':'kVARh','V':'V','P':'Watt','Q':'VAR','S':'kVA','PF':'-','T1':'kWh','T2':'kWh','Hz':'Hz','OpH':'days , hrs'
  };

  function formatOpH(h){if(!h||h<0)return'---';let m=Math.round(h*60),d=Math.floor(m/1440),r=m%1440,H=Math.floor(r/60),M=r%60;return d?`${d} Hari ${H} Jam${M?` ${M} Mnt`:''}`:H?`${H} Jam${M?` ${M} Mnt`:''}`:M?`${M} Mnt`:'0 Jam';}
  function fmt(v,k){if(v===null||v===undefined||isNaN(v))return'---';let n=+v;return k==='V'?n.toFixed(1):['I1','I2','I3'].includes(k)?n.toFixed(3):k==='P'?Math.round(n).toLocaleString():k==='Q'?Math.round(n).toLocaleString():k==='S'?n.toFixed(2):k==='PF'?n.toFixed(3):k==='Hz'?n.toFixed(1):n.toFixed(2);}

  const mainView=document.getElementById('main-view'),modalOverlay=document.getElementById('modal-overlay'),detailBody=document.getElementById('detailBody'),modalTitle=document.getElementById('modal-title'),closeModal=document.getElementById('close-modal'),conn=document.getElementById('conn');
  const devices={},deviceData={};for(let i=1;i<=18;i++)deviceData[i]={};

  function createCards(){
    mainView.innerHTML='';
    for(let id=1;id<=18;id++){
      const card=document.createElement('div');card.className='machine-card';
      const tag=MACHINE_TAGS[id]||'UNKNOW';
      card.innerHTML=`<div class="status-indicator status-offline" id="status-ind-${id}"></div><div class="card-label">${tag}</div><div class="sid-label">SID ${id}</div>`;
      card.onclick=()=>showDetailModal(id);
      mainView.appendChild(card);
      devices[id]={indicator:document.getElementById(`status-ind-${id}`)};
    }
  }

  function showDetailModal(id){
    const d=deviceData[id];
    modalTitle.textContent=`Detail Parameter • SID ${id} — ${MACHINE_TAGS[id]||'UNKNOW'}`;
    detailBody.innerHTML='';

    // Status dulu
    const trS=document.createElement('tr');
    trS.innerHTML=`<td class="param-name">Status Koneksi</td><td class="param-value ${d.status==='online'?'status-online':''}">${d.status?d.status.toUpperCase():'OFFLINE'}</td>`;
    detailBody.appendChild(trS);

    order.forEach(key=>{
      if(key==='I2'||key==='I3') return;
      if(key==='T2'){ // T2 jadi baris sendiri, indent
        const tr=document.createElement('tr');
        const t2 = d.T2!==undefined ? (+d.T2).toFixed(2) : '---';
        tr.innerHTML=`<td class="param-name">    T2</td><td class="param-value col-tariff">${t2} <small>kWh</small></td>`;
        detailBody.appendChild(tr);
        return;
      }

      const tr=document.createElement('tr');
      let val = '---';

      if(d[key]!==undefined && d[key]!==null){
        if(key==='OpH') val = formatOpH(d[key]);
        else if(key==='I1'){
          const i1=fmt(d.I1,'I1'), i2=fmt(d.I2,'I2'), i3=fmt(d.I3,'I3');
          val = `I1 = ${i1}  I2 = ${i2}  I3 = ${i3}`;
        }
        else if(key==='T1'){
          const t1 = (+d.T1).toFixed(2);
          val = `${t1} <small>kWh</small>`;
        }
        else val = `${fmt(d[key],key)} <small>${units[key]}</small>`;
      }

      const unitDisplay = (key==='I1') ? 'A' : (key==='T1') ? '' : units[key];
      tr.innerHTML=`<td class="param-name">${labels[key]}</td><td class="param-value ${(key==='EaT'||key==='ErT'||key==='EaP'||key==='ErP')?'col-energy':(key==='P'||key==='Q'||key==='S')?'col-power':key==='T1'||key==='T2'?'col-tariff':''}">${val}</td>`;
      detailBody.appendChild(tr);
    });

    modalOverlay.style.display='flex';
    document.body.style.overflow='hidden';
  }

  function closeDetailModal(){modalOverlay.style.display='none';document.body.style.overflow='';}
  closeModal.onclick=closeDetailModal;
  modalOverlay.onclick=e=>e.target===modalOverlay&&closeDetailModal();
  window.addEventListener('keydown',e=>e.key==='Escape'&&closeDetailModal());

  createCards();

  const client=mqtt.connect(MQTT_URL,MQTT_OPTIONS);
  client.on('connect',()=>{conn.textContent='Connected • Online';client.subscribe(MQTT_TOPIC);});
  client.on('reconnect',()=>{conn.textContent='Reconnecting...';});
  client.on('error',()=>{conn.textContent='Connection Failed';});
  client.on('message',(t,m)=>{
    try{
      const p=JSON.parse(m.toString());
      const id=Number(p.id);
      if(id<1||id>18)return;
      deviceData[id]=p;
      if(devices[id]){
        const st=p.status&&p.status.toLowerCase()==='online'?'online':'offline';
        devices[id].indicator.className=`status-indicator status-${st}`;
      }
    }catch(e){console.error(e);}
  });
</script>
</body>
</html>

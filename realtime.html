<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Realtime Monitoring — 18 Mesin (Single MQTT)</title>

<!-- MQTT client -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
:root{
  --bg:#0b0f13; --panel:#111417; --muted:#94A3B8; --accent:#00FFC2;
}
body{margin:0;font-family:Inter,Arial;background:var(--bg);color:#e6eef1;padding:20px;}
.header{display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:20px;color:var(--accent)}
#mqttStatus{margin-left:auto;color:var(--muted);font-weight:700}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:14px;margin-top:18px}
.card{background:var(--panel);padding:18px;border-radius:10px;text-align:center;
      cursor:pointer;border:1px solid rgba(255,255,255,.03)}
.card:hover{transform:translateY(-4px);transition:.15s}
.card .title{font-weight:800}
.card .mini{margin-top:8px;color:var(--muted);font-size:13px}

.detail{display:none;margin-top:18px;background:var(--panel);padding:18px;border-radius:10px}
.detail h2{margin:0 0 8px 0;color:var(--accent)}
.controls{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.btn{background:#222;padding:8px 12px;border-radius:8px;color:#fff;border:1px solid rgba(255,255,255,.05);cursor:pointer}
.small-muted{color:var(--muted);font-size:13px;margin-top:8px}

.param-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.param{background:#0f1720;padding:12px;border-radius:8px}
.p-name{color:var(--muted);font-weight:700;font-size:13px}
.p-value{font-weight:800;font-size:18px;margin-top:6px}

@media(max-width:900px){
  .param-grid{grid-template-columns:1fr}
  .grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
}
</style>
</head>
<body>

<div class="header">
  <h1>Dashboard Monitoring Energi Realtime</h1>
  <div id="mqttStatus">MQTT: connecting...</div>
</div>

<section id="listView">
  <div class="small-muted">Pilih mesin untuk melihat detail</div>
  <div class="grid" id="machinesGrid"></div>
</section>

<section id="detailView" class="detail">
  <div class="controls">
    <button class="btn" id="backBtn">⬅ Kembali</button>
    <div style="margin-left:10px;font-weight:800" id="detailTitle">Mesin —</div>
    <div style="margin-left:auto;color:var(--muted)" id="lastUpdate">last: -</div>
  </div>

  <div class="param-grid" id="paramGrid">
    <div class="param"><div class="p-name">Total Ea</div><div class="p-value" id="TotalEa">---</div><div class="p-name">kWh</div></div>
    <div class="param"><div class="p-name">Total Er</div><div class="p-value" id="TotalEr">---</div><div class="p-name">kVARh</div></div>
    <div class="param"><div class="p-name">Partial Ea</div><div class="p-value" id="PartialEa">---</div><div class="p-name">kWh</div></div>
    <div class="param"><div class="p-name">Partial Er</div><div class="p-value" id="PartialEr">---</div><div class="p-name">kVARh</div></div>
    <div class="param"><div class="p-name">Voltage (L-L)</div><div class="p-value" id="Voltage">---</div><div class="p-name">Volt</div></div>
    <div class="param"><div class="p-name">Current (I1/I2/I3)</div><div class="p-value" id="Current">---</div><div class="p-name">Ampere</div></div>
    <div class="param"><div class="p-name">Power P</div><div class="p-value" id="PowerP">---</div><div class="p-name">W</div></div>
    <div class="param"><div class="p-name">Power Q</div><div class="p-value" id="PowerQ">---</div><div class="p-name">VAR</div></div>
    <div class="param"><div class="p-name">Power S</div><div class="p-value" id="PowerS">---</div><div class="p-name">kVA</div></div>
    <div class="param"><div class="p-name">PF</div><div class="p-value" id="PF">---</div><div class="p-name">-</div></div>
    <div class="param"><div class="p-name">Frequency</div><div class="p-value" id="Hz">---</div><div class="p-name">Hz</div></div>
    <div class="param"><div class="p-name">Operation Time</div><div class="p-value" id="OpTime">---</div><div class="p-name">days / hrs</div></div>
  </div>
</section>


<script>
// ===== CONFIG =====
const MQTT_URL = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_OPTIONS = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 3000
};
const MQTT_WILDCARD = "politeknik/meter/data/#";

// Supabase
const SUPABASE_URL   = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_ANON  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";

let supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// ===== DOM =====
const mqttStatusEl = document.getElementById("mqttStatus");
const machinesGrid = document.getElementById("machinesGrid");
const listView     = document.getElementById("listView");
const detailView   = document.getElementById("detailView");
const detailTitle  = document.getElementById("detailTitle");
const lastUpdateEl = document.getElementById("lastUpdate");

// ===== STATE =====
let activeId = null;
const cache = {};
const lastEaMap = {};
const EA_THRESHOLD = 0.01;

// localStorage helpers
function loadLastEa(id){
  const s = localStorage.getItem("lastEa_"+id);
  if(s){ const n = Number(s); if(!isNaN(n)) return n; }
  return undefined;
}
function saveLastEa(id,val){
  localStorage.setItem("lastEa_"+id,val);
}

// Round-robin
let nextId = 1;
const MAX_ID = 18;

// ===== Build Cards =====
for(let i=1;i<=18;i++){
  const c = document.createElement("div");
  c.className = "card";
  c.innerHTML = `<div class="title">Mesin ${i}</div><div class="mini" id="mini-${i}">ID:${i} • --</div>`;
  c.onclick = ()=> openDetail(i);
  machinesGrid.appendChild(c);
}

// ===== MQTT =====
const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);

client.on("connect",()=>{
  mqttStatusEl.textContent="MQTT: connected";
  client.subscribe(MQTT_WILDCARD);
});

client.on("reconnect",()=>mqttStatusEl.textContent="MQTT: reconnecting...");
client.on("close",()=>mqttStatusEl.textContent="MQTT: closed");
client.on("offline",()=>mqttStatusEl.textContent="MQTT: offline");

// JSON safe parse
function safeParse(t){
  try{return JSON.parse(t);}catch{return null;}
}

// Supabase insert
async function insertEnergyLog(entry){
  await supa.from("energy_log").insert([entry]);
}

// ===== MQTT MESSAGE =====
client.on("message",(topic,buf)=>{
  const txt = buf.toString();
  const data = safeParse(txt);
  if(!data) return;

  // extract ID
  let id = Number(topic.split("/")[3]);
  if(!id) id = Number(data.id);
  if(!id) return;

  data._t = Date.now();
  cache[id] = data;

  // update mini
  const mini = document.getElementById("mini-"+id);
  if(mini){
    const P = data.P ?? "--";
    const st = data.status ?? "--";
    mini.textContent = `ID:${id} • ${P}W • ${st}`;
  }

  // update detail view
  if(activeId === id) renderDetail(data);

  // ===== ROUND ROBIN SUPABASE =====
  const ea = Number(data.EaT);
  if(!isNaN(ea)){
    if(id === nextId){
      const last = loadLastEa(id);

      if(last === undefined || Math.abs(ea-last) >= EA_THRESHOLD){
        const entry = {
          id_mesin:id,
          v: data.V ?? null,
          i: data.I1 && data.I2 && data.I3 ? Number(data.I1)+Number(data.I2)+Number(data.I3) : null,
          p: data.P ?? null,
          pf:data.PF ?? null,
          ea: ea,
          f: data.Hz ?? null,
          t: new Date().toISOString()
        };
        insertEnergyLog(entry);
        saveLastEa(id,ea);
      }

      nextId++;
      if(nextId > MAX_ID) nextId = 1;
    }
  }
});

// ===== Detail View =====
function openDetail(id){
  activeId = id;
  detailTitle.textContent = "Mesin "+id+" — Detail Parameter";
  listView.style.display="none";
  detailView.style.display="block";

  if(cache[id]) renderDetail(cache[id]);
  else resetDetail();
}

document.getElementById("backBtn").onclick = ()=>{
  activeId=null;
  detailView.style.display="none";
  listView.style.display="block";
};

function resetDetail(){
  ["TotalEa","TotalEr","PartialEa","PartialEr","Voltage","Current",
   "PowerP","PowerQ","PowerS","PF","Hz","OpTime"]
   .forEach(id=>document.getElementById(id).textContent="---");
}

function renderDetail(d){
  const set = (id,val)=> document.getElementById(id).textContent = (val ?? "---");

  set("TotalEa", d.EaT);
  set("TotalEr", d.ErT);
  set("PartialEa",d.EaP);
  set("PartialEr",d.ErP);
  set("Voltage",  d.V);

  document.getElementById("Current").textContent =
    `${d.I1 ?? "---"} / ${d.I2 ?? "---"} / ${d.I3 ?? "---"}`;

  set("PowerP",d.P);
  set("PowerQ",d.Q);
  set("PowerS",d.S);
  set("PF",   d.PF);
  set("Hz",   d.Hz);

  set("OpTime", formatOp(d.OpTime));

  lastUpdateEl.textContent = "last: " + new Date().toLocaleTimeString();
}

// Format operation time (jam → hari/jam)
function formatOp(h){
  if(!h) return "---";
  const mins = Math.round(h*60);
  const days = Math.floor(mins/(24*60));
  const hrs = Math.floor((mins%(24*60))/60);
  return `${days}d ${hrs}h`;
}

</script>
</body>
</html>

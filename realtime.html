<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚡ Master Power Meter Dashboard (18 SLAVES)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #E0E0E0;
    padding: 20px;
}
h2 {
    color: #00FFC2;
    border-bottom: 2px solid #3A3A3A;
    padding-bottom: 10px;
}
#conn { margin-bottom: 25px; font-weight: bold; }

table {
    border-collapse: collapse;
    width: 100%;
}
th, td {
    border: 1px solid #2A2A2A;
    padding: 8px;
    text-align: center;
}
thead th { background: #2A2A2A; color: #00FFC2; }
tbody tr { background: #1E1E1E; }

.cell-id { font-weight: bold; background: #111827; }
.status-online { color: #10B981; font-weight: bold; }
.status-offline { color: #EF4444; font-weight: bold; }
.col-power { background-color: #0F334A; color: #38BDF8; }
.col-energy { color: #4ADE80; font-weight: bold; }
</style>
</head>

<body>

<h2>⚡ Real-time Power Meter Dashboard (18 Mesin)</h2>
<p id="conn">Connecting...</p>

<table>
<thead>
<tr>
  <th>ID</th>
  <th>Status</th>
  <th>V</th>
  <th>I1</th>
  <th>I2</th>
  <th>I3</th>
  <th>P (W)</th>
  <th>Q (VAR)</th>
  <th>S</th>
  <th>PF</th>
  <th>Hz</th>
  <th>OpH</th>
  <th>EaT</th>
  <th>ErT</th>
  <th>EaP</th>
  <th>ErP</th>
  <th>T1 (WBP)</th>
  <th>T2 (LWBP)</th>
</tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="18">Menunggu data MQTT...</td></tr>
</tbody>
</table>

<script>
const options = {
  username: "web_dashboard",
  password: "Tristan12",
  reconnectPeriod: 2000
};

const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  options
);

const tableBody = document.getElementById("tableBody");
const conn = document.getElementById("conn");
const devices = {};

const dataMap = [
  { key: 'V' }, { key: 'I1' }, { key: 'I2' }, { key: 'I3' },
  { key: 'P' }, { key: 'Q' }, { key: 'S' },
  { key: 'PF' }, { key: 'Hz' }, { key: 'OpH' },
  { key: 'EaT' }, { key: 'ErT' }, { key: 'EaP' }, { key: 'ErP' },
  { key: 'T1_WBP' }, { key: 'T2_LWBP' }
];

client.on("connect", () => {
  conn.innerHTML = "✅ MQTT Connected";
  client.subscribe("politeknik/meter/data");
});

client.on("message", (topic, message) => {
  const d = JSON.parse(message.toString());
  const id = d.id;

  if (!devices[id]) {
    const row = tableBody.insertRow();
    devices[id] = row;

    row.insertCell().textContent = id;
    row.insertCell().textContent = d.status;

    for (let i = 0; i < dataMap.length; i++) {
      row.insertCell().textContent = "---";
    }

    if (tableBody.rows.length > 1 && tableBody.rows[0].cells[0].colSpan) {
      tableBody.deleteRow(0);
    }
  }

  const row = devices[id];
  row.cells[1].textContent = d.status.toUpperCase();
  row.cells[1].className = d.status === "online"
    ? "status-online" : "status-offline";

  dataMap.forEach((item, i) => {
    const val = d[item.key];
    row.cells[i + 2].textContent =
      (val === 0 || val) ? val : "---";
  });
});
</script>

</body>
</html>

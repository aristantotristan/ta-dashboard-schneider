<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‚ö° Master Power Meter Dashboard (18 SLAVES)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
/* --- Styling (rapi & minimal) --- */
:root {
  --bg: #121212;
  --card: #1E1E1E;
  --muted: #94A3B8;
  --accent: #00FFC2;
  --online: #10B981;
  --offline: #EF4444;
  --tariff: #FACC15;
}
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg);
  color: #E0E0E0;
  padding: 20px;
  margin: 0;
}
h2 { color: var(--accent); margin: 0 0 12px 0; }
#conn { margin-bottom: 14px; font-weight: 600; color: #94A3B8; }

/* ------------------------------------- */
/* --- NEW CARD STYLES FOR MAIN VIEW --- */
/* ------------------------------------- */
#main-view {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: center; /* Center the cards */
}
.machine-card {
  background: var(--card);
  border-radius: 8px;
  padding: 15px;
  width: 180px; /* Lebar kartu */
  height: 100px; /* Tinggi kartu agar seragam */
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  align-items: center;
  text-align: center;
}
.machine-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.6);
}
.card-id {
  font-size: 2.2rem;
  font-weight: 800;
  color: #38BDF8;
  margin: 0;
  line-height: 1;
}
.card-label {
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--muted);
  text-align: center;
  margin: 0;
  line-height: 1.2;
}
.status-indicator {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid var(--bg);
  box-shadow: 0 0 4px rgba(0,0,0,0.8);
}
.status-online { background-color: var(--online); }
.status-offline { background-color: var(--offline); }

/* -------------------------------------- */
/* --- DETAIL VIEW STYLES (MODIFIED TABLE) --- */
/* -------------------------------------- */
#detail-view {
  display: none; /* Hidden by default */
  padding-top: 20px;
}
#detail-view h3 {
  color: var(--accent);
  margin-top: 0;
}
#back-button {
  background: #333;
  color: #fff;
  border: none;
  padding: 8px 15px;
  border-radius: 5px;
  cursor: pointer;
  margin-bottom: 15px;
}
#back-button:hover {
  background: #555;
}

/* Reusing and modifying table styles for detail view */
#detail-table {
  width: 100%;
  border-collapse: collapse;
  box-shadow: 0 6px 20px rgba(0,0,0,0.6);
  border-radius: 8px;
  overflow: hidden;
}
#detail-table th, #detail-table td {
  padding: 10px;
  border-bottom: 1px solid rgba(255,255,255,0.02);
  text-align: left;
  font-size: 0.9rem;
}
#detail-table thead th {
  background: #2A2A2A;
  color: var(--accent);
  text-transform: uppercase;
}
#detail-table tbody tr { background: var(--card); }
#detail-table .param-name { font-weight: 600; width: 35%; }
#detail-table .param-value { color: #fff; font-weight: 400; }

.col-power { color: #38BDF8; }
.col-energy { color: #4ADE80; }
.col-tariff { color: var(--tariff); }

@media (max-width: 600px) {
  .machine-card { width: 45%; }
}
</style>
</head>
<body>

<h2>‚ö° Real-time Power Meter Dashboard</h2>
<p id="conn" class="muted">Connecting...</p>

<div id="main-view">
  </div>

<div id="detail-view">
  <button id="back-button">‚Üê Kembali ke Daftar Mesin</button>
  <h3 id="detail-title">Detail Parameter Mesin ID: --</h3>
  <table id="detail-table" aria-label="Power Meter Detail Table">
    <tbody id="detailBody">
      </tbody>
  </table>
</div>

<script>
/* ================= CONFIG ================= */
const MQTT_OPTIONS = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 2000
};
const MQTT_URL = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_TOPIC = "politeknik/meter/data";
const TOTAL_DEVICES = 18;

/* ================= MACHINE TAGS ================= */
const MACHINE_TAGS = {
  1: 'UNKNOW',
  2: 'UNKNOW',
  3: 'POMPA MC 12',
  4: 'MC 9',
  5: 'UNKNOW',
  6: 'MC 40',
  7: 'MC 39',
  8: 'MC 6',
  9: 'HEATER MC 5',
  10: 'POMPA MC 5',
  11: 'UNKNOW',
  12: 'MC 34',
  13: 'MC 35',
  14: 'UNKNOW',
  15: 'UNKNOW',
  16: 'MC 38',
  17: 'MC 36',
  18: 'MC 37'
};

/* ================= HELPERS (TIDAK BERUBAH) ================= */
function formatOpH(hours) {
  if (hours === null || hours === undefined || isNaN(hours) || hours < 0) return '---';
  const totalMinutes = Math.round(parseFloat(hours) * 60);
  const days = Math.floor(totalMinutes / (24 * 60));
  const rem = totalMinutes % (24 * 60);
  const hrs = Math.floor(rem / 60);
  const mins = rem % 60;
  if (days > 0) return `${days} Hari ${hrs} Jam`;
  if (hrs > 0) return `${hrs} Jam${mins>0 ? ' ' + mins + ' Mnt' : ''}`;
  if (mins > 0) return `${mins} Mnt`;
  return '0 Jam';
}
function fmt(val, key) {
  if (val === null || val === undefined || isNaN(val)) return '---';
  const n = Number(val);
  if (['V'].includes(key)) return n.toFixed(1);
  if (['I1','I2','I3'].includes(key)) return n.toFixed(3);
  if (['P','Q'].includes(key)) return Math.round(n).toString();
  if (['S'].includes(key)) return n.toFixed(2);
  if (['PF'].includes(key)) return n.toFixed(3);
  if (['Hz'].includes(key)) return n.toFixed(1);
  if (['EaT','ErT','EaP','ErP','T1','T2'].includes(key)) return n.toFixed(2);
  return n.toString();
}
// Fungsi untuk mendapatkan kelas CSS yang sesuai untuk nilai parameter
function getStyleClass(key) {
  if (key === 'T1' || key === 'T2') return 'col-tariff';
  if (['EaT','ErT','EaP','ErP'].includes(key)) return 'col-energy';
  if (['P','Q','S'].includes(key)) return 'col-power';
  return '';
}
// Label yang mudah dibaca untuk Detail View
const dataLabels = {
  'V': 'Tegangan (V)', 'I1': 'Arus Fasa 1 (A)', 'I2': 'Arus Fasa 2 (A)', 'I3': 'Arus Fasa 3 (A)',
  'P': 'Daya Aktif (W)', 'Q': 'Daya Reaktif (VAR)', 'S': 'Daya Semu (kVA)', 'PF': 'Faktor Daya',
  'Hz': 'Frekuensi (Hz)', 'OpH': 'Jam Operasi',
  'EaT': 'Energi Aktif Total (kWh)', 'ErT': 'Energi Reaktif Total (kVARh)',
  'EaP': 'Energi Aktif Parsial (kWh)', 'ErP': 'Energi Reaktif Parsial (kVARh)',
  'T1': 'Tarif 1 (kWh)', 'T2': 'Tarif 2 (kWh)'
};

/* ================= VIEW ELEMENTS ================= */
const mainView = document.getElementById('main-view');
const detailView = document.getElementById('detail-view');
const detailBody = document.getElementById('detailBody');
const detailTitle = document.getElementById('detail-title');
const backButton = document.getElementById('back-button');
const conn = document.getElementById('conn');

/* ================= DATA STORAGE & SETUP ================= */
const dataMap = [
  'V','I1','I2','I3','P','Q','S','PF','Hz','OpH',
  'EaT','ErT','EaP','ErP','T1','T2'
];

const devices = {}; // stores references to card DOM elements
let currentViewedId = null;

// The latest data received for all devices
const deviceData = {};
for (let id = 1; id <= TOTAL_DEVICES; id++) {
    deviceData[id] = {}; // Store raw data for each device
}

// Function to switch views
function showMainView() {
    mainView.style.display = 'flex';
    detailView.style.display = 'none';
    currentViewedId = null;
}
function showDetailView(id) {
    mainView.style.display = 'none';
    detailView.style.display = 'block';
    currentViewedId = id;
    detailTitle.textContent = `Detail Parameter Mesin ID: ${id} - ${MACHINE_TAGS[id] || 'NAMA MESIN'}`;
    updateDetailView(id);
}

// Pre-create 18 cards
function createInitialCards() {
  mainView.innerHTML = '';
  for (let id=1; id<=TOTAL_DEVICES; id++) {
    const tagName = MACHINE_TAGS[id] || 'Mesin Tidak Dikenal';
    const card = document.createElement('div');
    card.className = 'machine-card';
    card.setAttribute('data-id', id);
    card.innerHTML = `
      <div class="status-indicator status-offline" id="status-ind-${id}"></div>
      <p class="card-label">${tagName}</p> 
      <p class="card-id">${id}</p>
    `;
    card.onclick = () => showDetailView(id); // Set click handler
    mainView.appendChild(card);
    devices[id] = {
        card: card,
        indicator: document.getElementById(`status-ind-${id}`)
    };
  }
}
createInitialCards();

// Function to update the detail table (when in detail view)
function updateDetailView(id) {
    if (currentViewedId !== id) return; 

    detailBody.innerHTML = ''; // Clear existing rows
    const data = deviceData[id];

    // Create a row for Status first
    const statusRow = detailBody.insertRow();
    statusRow.innerHTML = `<td class="param-name">Status</td><td class="param-value ${data.status === 'online' ? 'status-online' : 'status-offline'}">${data.status ? data.status.toUpperCase() : '---'}</td>`;

    // Then, create rows for all other parameters
    dataMap.forEach(key => {
        const tr = detailBody.insertRow();
        const raw = data[key];
        let displayValue;
        
        if (key === 'OpH') {
            displayValue = (raw === 0 || raw) ? formatOpH(raw) : '---';
        } else {
            displayValue = (raw === 0 || raw) ? fmt(raw, key) : '---';
        }

        tr.innerHTML = `<td class="param-name">${dataLabels[key]}</td><td class="param-value ${getStyleClass(key)}">${displayValue}</td>`;
    });
}

// Initial view: show main cards
showMainView();

// Back button handler
backButton.onclick = showMainView;

/* ================= MQTT ================= */
const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);

client.on('connect', () => {
  conn.textContent = '‚úÖ MQTT Connected';
  client.subscribe(MQTT_TOPIC);
});

client.on('reconnect', () => {
  conn.textContent = 'üîÑ MQTT Reconnecting...';
});

client.on('error', (err) => {
  conn.textContent = '‚ùå MQTT Error';
  console.error('MQTT Error:', err);
});

client.on('message', (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    const id = Number(d.id);

    if (!id || id < 1 || id > TOTAL_DEVICES) {
      console.warn('Invalid ID in payload', d);
      return;
    }

    // 1. SIMPAN SEMUA DATA BARU
    deviceData[id] = d; 
    
    // 2. UPDATE STATUS DI KARTU
    if (devices[id]) {
      const status = (d.status && d.status.toLowerCase() === 'online') ? 'online' : 'offline';
      devices[id].indicator.className = `status-indicator status-${status}`;
    }

    // 3. UPDATE TAMPILAN DETAIL JIKA MESIN INI SEDANG DILIHAT
    if (currentViewedId === id) {
        updateDetailView(id);
    }
    
  } catch (e) {
    console.error('Payload parse error:', e, message.toString());
  }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Realtime Dashboard</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #121212;
            color: #fff;
        }
        .title {
            text-align: center;
            padding: 10px;
            font-size: 22px;
            background: #1e1e1e;
            margin-bottom: 10px;
            border-bottom: 2px solid #333;
        }
        #log {
            font-size: 12px;
            white-space: pre;
            padding: 10px;
            background: #1b1b1b;
            height: 120px;
            overflow-y: scroll;
            border-top: 1px solid #333;
        }
        #cards {
            display: flex;
            flex-wrap: wrap;
            padding: 10px;
            gap: 10px;
        }
        .card {
            width: 180px;
            background: #1e1e1e;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
            box-shadow: 0 0 5px #0006;
        }
        .card h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #03A9F4;
        }
        .value {
            font-size: 22px;
            font-weight: bold;
            color: #fff;
        }
        .mini {
            font-size: 12px;
            margin-top: 5px;
            color: #aaa;
        }
    </style>
</head>

<body>
    <div class="title">Realtime Monitoring</div>

    <div id="cards"></div>
    <div id="log"></div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>

// =======================================================
// 1️⃣ WATCHDOG — NONSTOP MONITOR (TIDAK PERLU BROWSER TERBUKA)
// =======================================================

let lastMessageTime = Date.now();
let offlineSent = false;
let onlineSent  = false;

setInterval(() => {
    const now  = Date.now();
    const diff = (now - lastMessageTime) / 1000; // detik tanpa data

    // OFFLINE (3 menit tidak ada data)
    if (diff > 180 && !offlineSent) {
        offlineSent = true;
        onlineSent  = false;

        fetch("https://rojhcadtqfynlqzubftx.supabase.co/functions/v1/watchdog-offline", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                status: "offline",
                note: "Tidak ada data selama 3 menit"
            })
        });

        appendLog("⚠ OFFLINE dikirim ke Supabase (3 menit tanpa data)");
    }

    // ONLINE (data muncul lagi)
    if (diff < 5 && offlineSent && !onlineSent) {
        onlineSent = true;

        fetch("https://rojhcadtqfynlqzubftx.supabase.co/functions/v1/watchdog-offline", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                status: "online",
                note: "Data kembali muncul"
            })
        });

        appendLog("✅ ONLINE dikirim ke Supabase (data kembali)");
    }

}, 1000);

// dipanggil saat mqtt menerima data baru
function onNewData() {
    lastMessageTime = Date.now();
}

// =======================================================
// 2️⃣ MQTT SETUP
// =======================================================

const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt");

const log = document.getElementById("log");
function appendLog(msg) {
    log.textContent += msg + "\n";
    log.scrollTop = log.scrollHeight;
}

client.on("connect", () => {
    appendLog("Connected to MQTT Broker");
    client.subscribe("tristan/realtime/#");
});

client.on("reconnect", () => appendLog("Reconnecting..."));
client.on("error", (err) => appendLog("Error: " + err));

let cache = {};

client.on("message", (topic, buf) => {
    const payload = buf.toString();
    const parts   = topic.split("/");
    const id      = parts[2];

    // tandai ada data baru
    onNewData();

    // buat kartu jika belum ada
    if (!document.getElementById("card-" + id)) {
        createCard(id);
    }

    // update isi kartu
    document.getElementById("value-" + id).textContent = payload;
    document.getElementById("mini-" + id).textContent  = "Terakhir update: now";

    cache[id] = payload;
});

// =======================================================
// 3️⃣ BUAT CARD SENSOR
// =======================================================
function createCard(id) {
    const cards = document.getElementById("cards");

    const div = document.createElement("div");
    div.className = "card";
    div.id = "card-" + id;

    div.innerHTML = `
        <h3>Sensor ${id}</h3>
        <div class="value" id="value-${id}">--</div>
        <div class="mini"  id="mini-${id}">Waiting...</div>
    `;

    cards.appendChild(div);
}

// =======================================================
// END
// =======================================================

</script>
</body>
</html>

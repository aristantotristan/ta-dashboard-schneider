<script>
// GANTI INI AJA BRO — YANG LAIN TETAP SAMA
const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const previousTariff = {};

async function saveTariffData(sid, t1, t2) {
  t1 = parseFloat(t1) || 0;
  t2 = parseFloat(t2) || 0;

  console.log(`SID ${sid} → T1=${t1} | T2=${t2}`);

  // SNAPSHOT
  const snap = await supabase.from('meter_tariff_snapshot').insert({
    sid_mesin: sid,
    t1_lwbp_kwh: t1,
    t2_wbp_kwh: t2
  });

  if (snap.error) {
    console.error("GAGAL SNAPSHOT:", snap.error.message);
  } else {
    console.log("%c SNAPSHOT MASUK! ✓", "color:lime;font-size:16px;font-weight:bold");
  }

  // DELTA
  if (previousTariff[sid]) {
    const deltaLWBP = t1 - previousTariff[sid].t1;
    const deltaWBP  = t2 - previousTariff[sid].t2;

    if (deltaLWBP > 0 || deltaWBP > 0) {
      const delta = await supabase.from('meter_tariff_delta').insert({
        sid_mesin: sid,
        lwbp_kwh: Math.max(0, deltaLWBP),
        wbp_kwh:  Math.max(0, deltaWBP)
      });

      if (delta.error) {
        console.error("GAGAL DELTA:", delta.error.message);
      } else {
        console.log("%c DELTA MASUK! LWBP +" + deltaLWBP.toFixed(4) + " | WBP +" + deltaWBP.toFixed(4), "color:yellow;font-size:16px;font-weight:bold");
      }
    }
  }

  previousTariff[sid] = { t1, t2 };
}

// Sisanya (MQTT, tabel, dll) TETAP SAMA seperti kode lo yang sekarang
// Cuma ganti fungsi saveTariffData sama bagian client.on('message') panggil saveTariffData
</script>

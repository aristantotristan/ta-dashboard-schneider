<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>âš¡ Master Power Meter Dashboard (18 SLAVES)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
:root {
  --bg: #121212;
  --card: #1E1E1E;
  --muted: #94A3B8;
  --accent: #00FFC2;
  --online: #10B981;
  --offline: #EF4444;
  --tariff: #FACC15;
}
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg);
  color: #E0E0E0;
  padding: 20px;
  margin: 0;
  overflow-x: hidden;
}
h2 { color: var(--accent); margin: 0 0 12px 0; }
#conn { margin-bottom: 14px; font-weight: 600; color: var(--muted); }

#main-view {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: center;
}
.machine-card {
  background: var(--card);
  border-radius: 12px;
  padding: 20px 15px;
  width: 180px;
  height: 110px;
  cursor: pointer;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  user-select: none;
}
.machine-card:hover {
  transform: translateY(-7px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.7);
}
.card-label {
  font-size: 1.3rem;
  font-weight: 700;
  color: #38BDF8;
  margin: 0;
  line-height: 1.2;
}
.sid-label {
  font-size: 0.9rem;
  color: var(--muted);
  margin: 6px 0 0 0;
}

/* --- Estetik indikator status dengan animasi pulsing --- */
.status-indicator {
  position: absolute;
  top: 14px;
  right: 14px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
  animation: pulse 2s infinite;
}
.status-online {
  background-color: var(--online);
  box-shadow:
    0 0 6px var(--online),
    0 0 15px var(--online);
}
.status-offline {
  background-color: var(--offline);
  box-shadow:
    0 0 6px var(--offline),
    0 0 15px var(--offline);
}
@keyframes pulse {
  0% {
    transform: scale(0.9);
    opacity: 0.7;
  }
  50% {
    transform: scale(1.2);
    opacity: 1;
  }
  100% {
    transform: scale(0.9);
    opacity: 0.7;
  }
}

/* ---------------- Modal Detail ---------------- */
#modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(18,18,18,0.85);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
#modal {
  background: var(--card);
  border-radius: 12px;
  padding: 25px 30px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 0 25px rgba(0,255,194,0.5);
  position: relative;
  color: #eee;
  font-size: 1rem;
}
#modal h3 {
  margin-top: 0;
  color: var(--accent);
  font-weight: 700;
  user-select: text;
}
#close-modal {
  position: absolute;
  top: 12px;
  right: 12px;
  background: transparent;
  border: none;
  font-size: 1.5rem;
  color: var(--muted);
  cursor: pointer;
  transition: color 0.3s ease;
  user-select: none;
}
#close-modal:hover {
  color: var(--accent);
}

#detail-table {
  width: 100%;
  border-collapse: collapse;
  border-radius: 8px;
  overflow: hidden;
  margin-top: 15px;
}
#detail-table th, #detail-table td {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  text-align: left;
}
#detail-table thead th {
  background: #222;
  color: var(--accent);
  text-transform: uppercase;
  font-weight: 700;
  user-select: none;
}
#detail-table tbody tr {
  background: var(--bg);
  transition: background 0.2s ease;
}
#detail-table tbody tr:hover {
  background: #1a1a1a;
}
.param-name {
  font-weight: 600;
  width: 40%;
  user-select: text;
}
.param-value {
  font-weight: 400;
  color: #eee;
  user-select: text;
}

.col-power { color: #38BDF8; }
.col-energy { color: #4ADE80; }
.col-tariff { color: var(--tariff); }

@media (max-width: 600px) {
  .machine-card { width: 45%; }
  #modal {
    padding: 20px 15px;
  }
}
</style>
</head>
<body>

<h2>Power Meter Dashboard</h2>
<p id="conn" class="muted">Connecting...</p>

<div id="main-view"></div>

<!-- Modal Detail -->
<div id="modal-overlay">
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <button id="close-modal" aria-label="Close detail view">&times;</button>
    <h3 id="modal-title">Detail Parameter : --</h3>
    <table id="detail-table" aria-label="Power Meter Detail Table">
      <thead>
        <tr><th>Parameter</th><th>Nilai</th></tr>
      </thead>
      <tbody id="detailBody"></tbody>
    </table>
  </div>
</div>

<script>
const MQTT_OPTIONS = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 2000
};
const MQTT_URL = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_TOPIC = "politeknik/meter/data";
const TOTAL_DEVICES = 18;

const MACHINE_TAGS = {
  1: 'UNKNOW',
  2: 'UNKNOW',
  3: 'POMPA MC 12',
  4: 'MC 9',
  5: 'UNKNOW',
  6: 'MC 40',
  7: 'MC 39',
  8: 'MC 6',
  9: 'HEATER MC 5',
  10: 'POMPA MC 5',
  11: 'UNKNOW',
  12: 'MC 34',
  13: 'MC 35',
  14: 'UNKNOW',
  15: 'UNKNOW',
  16: 'MC 38',
  17: 'MC 36',
  18: 'MC 37'
};

function formatOpH(hours) {
  if (hours === null || hours === undefined || isNaN(hours) || hours < 0) return '---';
  const totalMinutes = Math.round(parseFloat(hours) * 60);
  const days = Math.floor(totalMinutes / (24 * 60));
  const rem = totalMinutes % (24 * 60);
  const hrs = Math.floor(rem / 60);
  const mins = rem % 60;
  if (days > 0) return `${days} Hari ${hrs} Jam`;
  if (hrs > 0) return `${hrs} Jam${mins>0 ? ' ' + mins + ' Mnt' : ''}`;
  if (mins > 0) return `${mins} Mnt`;
  return '0 Jam';
}
function fmt(val, key) {
  if (val === null || val === undefined || isNaN(val)) return '---';
  const n = Number(val);
  if (['V'].includes(key)) return n.toFixed(1);
  if (['I1','I2','I3'].includes(key)) return n.toFixed(3);
  if (['P','Q'].includes(key)) return Math.round(n).toString();
  if (['S'].includes(key)) return n.toFixed(2);
  if (['PF'].includes(key)) return n.toFixed(3);
  if (['Hz'].includes(key)) return n.toFixed(1);
  if (['EaT','ErT','EaP','ErP','T1','T2'].includes(key)) return n.toFixed(2);
  return n.toString();
}
function getStyleClass(key) {
  if (key === 'T1' || key === 'T2') return 'col-tariff';
  if (['EaT','ErT','EaP','ErP'].includes(key)) return 'col-energy';
  if (['P','Q','S'].includes(key)) return 'col-power';
  return '';
}
const dataLabels = {
  'V': 'Tegangan (V)', 'I1': 'Arus Fasa 1 (A)', 'I2': 'Arus Fasa 2 (A)', 'I3': 'Arus Fasa 3 (A)',
  'P': 'Daya Aktif (W)', 'Q': 'Daya Reaktif (VAR)', 'S': 'Daya Semu (kVA)', 'PF': 'Faktor Daya',
  'Hz': 'Frekuensi (Hz)', 'OpH': 'Jam Operasi',
  'EaT': 'Energi Aktif Total (kWh)', 'ErT': 'Energi Reaktif Total (kVARh)',
  'EaP': 'Energi Aktif Parsial (kWh)', 'ErP': 'Energi Reaktif Parsial (kVARh)',
  'T1': 'Tarif 1 (kWh)', 'T2': 'Tarif 2 (kWh)'
};

const mainView = document.getElementById('main-view');
const modalOverlay = document.getElementById('modal-overlay');
const detailBody = document.getElementById('detailBody');
const modalTitle = document.getElementById('modal-title');
const closeModal = document.getElementById('close-modal');
const conn = document.getElementById('conn');

const dataMap = [
  'V','I1','I2','I3','P','Q','S','PF','Hz','OpH',
  'EaT','ErT','EaP','ErP','T1','T2'
];
const devices = {};
const deviceData = {};
for (let id = 1; id <= TOTAL_DEVICES; id++) {
  deviceData[id] = {};
}

function createCards() {
  mainView.innerHTML = '';
  for(let id=1; id<=TOTAL_DEVICES; id++) {
    const card = document.createElement('div');
    card.className = 'machine-card';
    card.setAttribute('data-id', id);
    const tag = MACHINE_TAGS[id] || 'Mesin Tidak Dikenal';
    card.setAttribute('title', `Mesin ${id} = ${tag}`);
    card.innerHTML = `
      <div class="status-indicator status-offline" id="status-ind-${id}"></div>
      <p class="card-label">${tag}</p>
      <p class="sid-label">SID ${id}</p>
    `;
    card.onclick = () => showDetailModal(id);
    mainView.appendChild(card);
    devices[id] = {
      card,
      indicator: document.getElementById(`status-ind-${id}`)
    };
  }
}

function showDetailModal(id) {
  const data = deviceData[id];
  modalTitle.textContent = `Detail SID  ${id} - ${MACHINE_TAGS[id] || 'NAMA MESIN'}`;
  detailBody.innerHTML = '';

  const statusRow = document.createElement('tr');
  statusRow.innerHTML = `<td class="param-name">Status</td><td class="param-value ${data.status === 'online' ? 'status-online' : 'status-offline'}">${data.status ? data.status.toUpperCase() : '---'}</td>`;
  detailBody.appendChild(statusRow);

  dataMap.forEach(key => {
    const tr = document.createElement('tr');
    const raw = data[key];
    let displayValue;
    if (key === 'OpH') {
      displayValue = (raw === 0 || raw) ? formatOpH(raw) : '---';
    } else {
      displayValue = (raw === 0 || raw) ? fmt(raw, key) : '---';
    }
    tr.innerHTML = `<td class="param-name">${dataLabels[key]}</td><td class="param-value ${getStyleClass(key)}">${displayValue}</td>`;
    detailBody.appendChild(tr);
  });

  modalOverlay.style.display = 'flex';
  document.body.style.overflow = 'hidden'; // Disable background scroll
}

function closeDetailModal() {
  modalOverlay.style.display = 'none';
  document.body.style.overflow = ''; // Enable background scroll
}

closeModal.onclick = closeDetailModal;

// Close modal on overlay click outside modal box
modalOverlay.addEventListener('click', (e) => {
  if(e.target === modalOverlay) closeDetailModal();
});

// Close modal on pressing Escape key
window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && modalOverlay.style.display === 'flex') {
    closeDetailModal();
  }
});

createCards();

const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);
client.on('connect', () => {
  conn.textContent = 'MQTT Connected';
  client.subscribe(MQTT_TOPIC);
});
client.on('reconnect', () => {
  conn.textContent = 'ðŸ”„ MQTT Reconnecting...';
});
client.on('error', (err) => {
  conn.textContent = 'âŒ MQTT Error';
  console.error('MQTT Error:', err);
});
client.on('message', (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    const id = Number(d.id);
    if (!id || id < 1 || id > TOTAL_DEVICES) {
      console.warn('Invalid ID in payload', d);
      return;
    }
    deviceData[id] = d;
    if (devices[id]) {
      const status = (d.status && d.status.toLowerCase() === 'online') ? 'online' : 'offline';
      devices[id].indicator.className = `status-indicator status-${status}`;
    }
  } catch (e) {
    console.error('Payload parse error:', e, message.toString());
  }
});
</script>

</body>
</html>


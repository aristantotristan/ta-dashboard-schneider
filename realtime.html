<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Master Power Meter • 18 Slaves</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root{--bg:#0a0e17;--card:#111827;--border:#1f2937;--accent:#00e5bd;--text:#e2e8f0;--muted:#94a3b8;--online:#00d4aa;--offline:#ef4444}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh}
    header{text-align:center;padding:3rem 1rem 2rem}
    h1{font-size:2.8rem;font-weight:700;color:var(--accent);text-shadow:0 0 30px rgba(0,229,189,0.5)}
    .subtitle{font-size:0.95rem;color:var(--muted);letter-spacing:3px;text-transform:uppercase}
    #conn{text-align:center;padding:.8rem 1.5rem;background:rgba(0,229,189,0.1);border:1px solid rgba(0,229,189,0.3);border-radius:8px;max-width:500px;margin:0 auto 2.5rem;color:var(--accent);font-weight:600}
    #main-view{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.6rem;padding:0 2rem;max-width:1800px;margin:0 auto}
    .machine-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.8rem 1.4rem;cursor:pointer;position:relative;overflow:hidden;transition:all .3s}
    .machine-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);opacity:0;transition:opacity .3s}
    .machine-card:hover{transform:translateY(-8px);border-color:var(--accent);box-shadow:0 15px 35px rgba(0,0,0,0.4)}
    .machine-card:hover::before{opacity:1}
    .card-label{font-size:1.3rem;font-weight:600;color:var(--text)}
    .sid-label{font-size:0.9rem;color:var(--muted);margin-top:0.4rem}
    .status-indicator{position:absolute;top:16px;right:16px;width:14px;height:14px;border-radius:50%;background:var(--offline);box-shadow:0 0 12px var(--offline)}
    .status-online{background:var(--online);box-shadow:0 0 16px var(--online);animation:ping 2s infinite}
    @keyframes ping{0%,100%{transform:scale(1)}50%{transform:scale(1.4)}}

    #modal-overlay{position:fixed;inset:0;background:rgba(10,14,23,0.97);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;z-index:9999;padding:1rem}
    #modal{background:var(--card);border-radius:16px;width:100%;max-width:620px;max-height:92vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
    #modal h3{background:var(--accent);color:#000;padding:1.2rem 2rem;font-size:1.4rem;font-weight:700;margin:0}
    #close-modal{position:absolute;top:0.8rem;right:1.2rem;background:none;border:none;font-size:2rem;color:#000;cursor:pointer}
    #close-modal:hover{transform:scale(1.2)}
    #detail-table{width:100%;border-collapse:collapse}
    #detail-table th{background:#1a1a1a;color:var(--accent);padding:0.9rem 1.2rem;text-transform:uppercase;font-size:0.8rem;letter-spacing:1px}
    #detail-table td{padding:0.9rem 1.2rem;border-bottom:1px solid #2d2d2d}
    #detail-table tbody tr:hover{background:rgba(0,229,189,0.03)}
    .param-name{color:var(--muted);font-weight:500}
    .param-value{text-align:right;font-weight:600;color:var(--text);font-family:monospace}
    .status-offline{color:var(--offline);font-weight:700}
    .status-online{color:var(--online);font-weight:700}
    .col-energy{color:#86efac}
    .col-power{color:#60a5fa}
    .col-tariff{color:#fbbf24}
  </style>
</head>
<body>

<header>
  <h1>Master Power Meter</h1>
  <p class="subtitle">18 Slaves • Real-time Monitoring</p>
</header>
<div id="conn">Connecting to HiveMQ Cloud...</div>
<div id="main-view"></div>

<div id="modal-overlay">
  <div id="modal">
    <button id="close-modal">×</button>
    <h3 id="modal-title">Detail Parameter • SID --</h3>
    <table id="detail-table">
      <thead><tr><th>PARAMETER</th><th>NILAI</th></tr></thead>
      <tbody id="detailBody"></tbody>
    </table>
  </div>
</div>

<script>
  const MQTT_OPTIONS={username:"web_dashboard",password:"Tristan12",connectTimeout:4000,reconnectPeriod:2000};
  const MQTT_URL="wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
  const MQTT_TOPIC="politeknik/meter/data";
  const TOTAL_DEVICES=18;
  const MACHINE_TAGS={1:'UNKNOW',2:'UNKNOW',3:'POMPA MC 12',4:'MC 9',5:'UNKNOW',6:'MC 40',7:'MC 39',8:'MC 6',9:'HEATER MC 5',10:'POMPA MC 5',11:'UNKNOW',12:'MC 34',13:'MC 35',14:'UNKNOW',15:'UNKNOW',16:'MC 38',17:'MC 36',18:'MC 37'};

  // URUTAN 100% SESUAI LIST TERAKHIR KAMU
  const order = ['EaT','ErT','EaP','ErP','V','I1','I2','I3','P','Q','S','PF','T1','T2','Hz','OpH'];
  const labels = {
    'EaT':'1. Total Ea','ErT':'2. Total Er','EaP':'3. Partial Ea','ErP':'4. Partial Er',
    'V':'5. Voltage','I1':'6. Current I1','I2':'7. Current I2','I3':'8. Current I3',
    'P':'9. Total Active(P)','Q':'10. Total Reactive (Q)','S':'11. Total Apparent (S)',
    'PF':'12. PF','T1':'13. Tarif T1','T2':'14. Tarif T2','Hz':'15. Freq','OpH':'16. Op Time'
  };
  const units = {
    'EaT':'kWh','ErT':'kVARh','EaP':'kWh','ErP':'kVARh','V':'V','I1':'A','I2':'A','I3':'A',
    'P':'Watt','Q':'VAR','S':'kVA','PF':'','T1':'kWh','T2':'kWh','Hz':'Hz'
  };

  function formatOpH(h){
    if(!h||h<0)return'---';
    const totalMin = Math.round(h*60);
    const days = Math.floor(totalMin/1440);
    const hrs = Math.floor((totalMin%1440)/60);
    return (days>0?days+' days':'') + (days&&hrs?', ':'') + (hrs>0?hrs+' hrs':'') || '0 hrs';
  }

  function fmt(v,k){
    if(v===null||v===undefined||isNaN(v))return'---';
    const n=+v;
    return k==='V'?n.toFixed(1):k.startsWith('I')?n.toFixed(3):k==='P'?Math.round(n).toLocaleString():
           k==='Q'?Math.round(n).toLocaleString():k==='S'?n.toFixed(2):k==='PF'?n.toFixed(3):
           k==='Hz'?n.toFixed(1):n.toFixed(2);
  }

  const mainView=document.getElementById('main-view'),modalOverlay=document.getElementById('modal-overlay'),
        detailBody=document.getElementById('detailBody'),modalTitle=document.getElementById('modal-title'),
        closeModal=document.getElementById('close-modal'),conn=document.getElementById('conn');
  const devices={},deviceData={};for(let i=1;i<=18;i++)deviceData[i]={};

  function createCards(){
    mainView.innerHTML='';
    for(let id=1;id<=18;id++){
      const card=document.createElement('div');card.className='machine-card';
      const tag=MACHINE_TAGS[id]||'UNKNOW';
      card.innerHTML=`<div class="status-indicator status-offline" id="status-ind-${id}"></div>
                      <div class="card-label">${tag}</div><div class="sid-label">SID ${id}</div>`;
      card.onclick=()=>showDetailModal(id);
      mainView.appendChild(card);
      devices[id]={indicator:document.getElementById(`status-ind-${id}`)};
    }
  }

  function showDetailModal(id){
    const d=deviceData[id];
    modalTitle.textContent=`Detail Parameter • SID ${id} — ${MACHINE_TAGS[id]||'UNKNOW'}`;
    detailBody.innerHTML='';

    // Status
    const trS=document.createElement('tr');
    trS.innerHTML=`<td class="param-name">Status Koneksi</td>
                   <td class="param-value ${d.status==='online'?'status-online':'status-offline'}">
                     ${d.status?d.status.toUpperCase():'OFFLINE'}
                   </td>`;
    detailBody.appendChild(trS);

    // Parameter sesuai urutan terakhir kamu
    order.forEach(key=>{
      const tr=document.createElement('tr');
      let val = '---';
      let unit = units[key]||'';

      if(d[key]!==undefined && d[key]!==null){
        if(key==='OpH') val = formatOpH(d[key]);
        else val = fmt(d[key],key);
      }

      const color = (['EaT','ErT','EaP','ErP'].includes(key))?'col-energy':
                    (['P','Q','S'].includes(key))?'col-power':
                    (['T1','T2'].includes(key))?'col-tariff':'';

      tr.innerHTML=`<td class="param-name">${labels[key]}</td>
                    <td class="param-value ${color}">${val} ${unit?'<small style="opacity:0.7">'+unit+'</small>':''}</td>`;
      detailBody.appendChild(tr);
    });

    modalOverlay.style.display='flex';
    document.body.style.overflow='hidden';
  }

  function closeDetailModal(){modalOverlay.style.display='none';document.body.style.overflow='';}
  closeModal.onclick=closeDetailModal;
  modalOverlay.onclick=e=>e.target===modalOverlay&&closeDetailModal();
  window.addEventListener('keydown',e=>e.key==='Escape'&&closeDetailModal());

  createCards();

  const client=mqtt.connect(MQTT_URL,MQTT_OPTIONS);
  client.on('connect',()=>{conn.textContent='Connected • Online';client.subscribe(MQTT_TOPIC);});
  client.on('reconnect',()=>{conn.textContent='Reconnecting...';});
  client.on('error',()=>{conn.textContent='Connection Failed';});
  client.on('message',(t,m)=>{
    try{
      const p=JSON.parse(m.toString());
      const id=Number(p.id);
      if(id<1||id>18)return;
      deviceData[id]=p;
      if(devices[id]){
        const st=p.status&&p.status.toLowerCase()==='online'?'online':'offline';
        devices[id].indicator.className=`status-indicator status-${st}`;
      }
    }catch(e){console.error(e);}
  });
</script>
</body>
</html>

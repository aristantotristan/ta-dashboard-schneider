<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Realtime Mesin</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body { font-family: Arial; padding: 20px; }
  .btn { padding: 10px 15px; margin: 5px; background: #3498db; color:white; border:none; cursor:pointer; border-radius:5px; }
  .btn:hover { background:#2980b9; }
  #dataBox { margin-top:20px; padding:20px; border:1px solid #ddd; border-radius:10px; }
</style>
</head>
<body>

<h2>Pilih Mesin</h2>

<div id="buttonContainer"></div>

<h2>Realtime Parameter</h2>
<div id="dataBox">Belum ada data...</div>

<script>
  // ===========================
  // 1. MQTT CONNECT (SEKALI SAJA)
  // ===========================
  const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt");

  let currentTopic = ""; // simpan topic yang sedang aktif

  client.on("connect", () => {
      console.log("MQTT Connected!");
  });

  client.on("message", (topic, message) => {
      document.getElementById("dataBox").innerHTML =
          `<b>Topic:</b> ${topic}<br><b>Data:</b> ${message}`;
  });

  // ===========================
  // 2. GENERATE BUTTON MESIN
  // ===========================
  const container = document.getElementById("buttonContainer");

  for (let i = 1; i <= 18; i++) {
      let btn = document.createElement("button");
      btn.className = "btn";
      btn.innerText = "Mesin " + i;
      btn.onclick = () => loadMesin(i);
      container.appendChild(btn);
  }

  // ===========================
  // 3. LOAD MESIN TANPA RECONNECT
  // ===========================
  function loadMesin(no) {
      let newTopic = `pabrik/mesin/${no}/parameter`;

      // Unsubscribe topic lama (jika ada)
      if (currentTopic !== "") {
          client.unsubscribe(currentTopic);
          console.log("UNSUB:", currentTopic);
      }

      // Subscribe topic baru
      client.subscribe(newTopic);
      console.log("SUB:", newTopic);

      currentTopic = newTopic;

      document.getElementById("dataBox").innerHTML =
          `Menunggu data mesin ${no}...`;
  }
</script>

</body>
</html>

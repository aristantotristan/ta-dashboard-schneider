<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚡ Master Power Meter Dashboard (18 SLAVES)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script> 

<style>
/* ... (STYLE CSS ANDA TETAP SAMA) ... */
/* Global Styling */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212; 
    color: #E0E0E0; 
    padding: 20px;
}
h2 {
    color: #00FFC2; 
    border-bottom: 2px solid #3A3A3A;
    padding-bottom: 10px;
    margin-bottom: 5px;
}
#conn {
    margin-bottom: 25px;
    font-size: 1.1em;
    font-weight: bold;
}
table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    overflow: hidden; 
}
th, td {
    border: 1px solid #2A2A2A; 
    padding: 10px 12px;
    text-align: center;
    transition: background-color 0.3s;
}
thead th {
    background: #2A2A2A;
    color: #00FFC2;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9em;
}
tbody tr {
    background: #1E1E1E;
}
tbody tr:hover {
    background-color: #334155; 
}

/* Data Group Styling */
.cell-id { font-weight: bold; background: #111827; }
.status-online { color: #10B981; font-weight: bold; } 
.status-offline { color: #EF4444; font-weight: bold; }
.col-power { background-color: #0F334A; color: #38BDF8; font-weight: 600; }
.col-energy { color: #4ADE80; font-weight: 600; }
.col-v, .col-i, .col-pf { font-weight: 500; }
</style>
</head>

<body>

<h2>⚡ Real-time Power Meter Dashboard (18 Mesin)</h2>
<p id="conn">Connecting...</p>

<table>
<thead>
<tr>
  <th class="cell-id">ID</th>
  <th>Status</th>
  <th class="col-v">V (Volt)</th>
  <th class="col-i">I1 (A)</th>
  <th class="col-i">I2 (A)</th>
  <th class="col-i">I3 (A)</th>
  <th class="col-power">P (Watt)</th>
  <th class="col-power">Q (VAR)</th>
  <th class="col-power">S (kVA)</th>
  <th class="col-pf">PF</th>
  <th class="col-pf">Hz</th>
  <th class="col-pf">OpH (Hari/Jam)</th>
  <th class="col-energy">Ea Tot (kWh)</th>
  <th class="col-energy">Er Tot (kVARh)</th>
  <th class="col-energy">Ea Part (kWh)</th>
  <th class="col-energy">Er Part (kVARh)</th>
</tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="16" style="padding: 30px; color: #94A3B8;">Awaiting Real-time Data from ESP32...</td></tr>
</tbody>
</table>

<script>
// =======================================================
// --- KONFIGURASI SUPABASE ---
// =======================================================
const SUPA_URL  = "https://rojhcadtqfynlqzubftx.supabase.co"; 
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs"; 
const TABLE_NAME = "ea_18mesin";
const EA_THRESHOLD = 0.01; 

let supa = supabase.createClient(SUPA_URL, SUPA_ANON);

// =======================================================
// --- VARIABEL GLOBAL UNTUK LOGIKA URUTAN ---
// =======================================================
const MACHINE_IDS = Array.from({length: 18}, (_, i) => i + 1); // [1, 2, 3, ..., 18]
const dataBuffer = {}; // { 1: {ea: 123, log_type: 'REALTIME', ...}, 2: {...} }
let isSending = false; // Flag untuk mencegah pengiriman berbarengan

// =======================================================
// --- FUNGSI LOGGING & LOCALSTORAGE ---
// =======================================================

/** Menyimpan log energi ke tabel ea_18mesin di Supabase. */
async function insertEnergyLog(entry) {
    try {
        const { error } = await supa.from(TABLE_NAME).insert([entry]);
        if (error) throw error;
    } catch (e) {
        console.error("Gagal menyimpan log ke Supabase. Cek RLS/Kredensial:", e);
    }
}

/** Mendapatkan status flag transisi dari localStorage (Memori Harian) */
function getTransitionFlag(id, key) {
    const today = new Date().toISOString().slice(0, 10);
    return localStorage.getItem(`${key}_${id}_${today}`);
}

/** Menetapkan flag transisi ke localStorage */
function setTransitionFlag(id, key) {
    const today = new Date().toISOString().slice(0, 10);
    localStorage.setItem(`${key}_${id}_${today}`, 'true');
}

/** Mendapatkan nilai Ea terakhir (untuk EA_THRESHOLD) */
function loadLastEa(id) {
    const s = localStorage.getItem("lastEa_" + id);
    return s ? Number(s) : undefined;
}

/** Menyimpan nilai Ea terakhir */
function saveLastEa(id, val) {
    localStorage.setItem("lastEa_" + id, val);
}


// =======================================================
// --- LOGIKA PENGIRIMAN BERURUTAN (1 - 18) ---
// =======================================================

/**
 * Iterasi melalui ID mesin (1 s/d 18) dan mengirim data ke Supabase
 * hanya jika data tersebut baru dan memenuhi kriteria logging.
 */
async function sendBufferedDataSequentially() {
    if (isSending) return;
    isSending = true;

    for (const id of MACHINE_IDS) {
        // Cek apakah data mesin ini ada di buffer
        if (dataBuffer[id] && dataBuffer[id].ea !== undefined) {
            const entry = dataBuffer[id];
            const ea = entry.ea;
            const now = new Date();
            const currentHour = now.getHours();

            let logEntry = {
                id_mesin: id,
                ea: ea,
                t: now.toISOString(),
                log_type: 'REALTIME',
            };

            // 1. Logika T1/T2 (Prioritas Tertinggi)
            if (currentHour === 17 && getTransitionFlag(id, 'T1_WBP_START') === null) {
                logEntry.log_type = 'T1_WBP_START';
                await insertEnergyLog(logEntry);
                setTransitionFlag(id, 'T1_WBP_START');
                console.log(`[LOG WBP - Urut] Mesin ${id}: T1 WBP (17:00) dicatat.`);
            } else if (currentHour === 22 && getTransitionFlag(id, 'T2_WBP_END') === null) {
                logEntry.log_type = 'T2_WBP_END';
                await insertEnergyLog(logEntry);
                setTransitionFlag(id, 'T2_WBP_END');
                console.log(`[LOG WBP - Urut] Mesin ${id}: T2 WBP (22:00) dicatat.`);
            } 
            // 2. Logika Normal (Jika T1/T2 tidak dipicu)
            else {
                const lastEa = loadLastEa(id);
                if (lastEa === undefined || Math.abs(ea - lastEa) >= EA_THRESHOLD) {
                    await insertEnergyLog(logEntry);
                    saveLastEa(id, ea);
                }
            }

            // Hapus data dari buffer setelah berhasil diproses
            delete dataBuffer[id];
        }
    }

    isSending = false;
}

// Panggil fungsi pengiriman berurutan setiap 5 detik
// Interval 5 detik seharusnya cukup untuk memproses data dari 18 mesin yang masuk setiap 1-2 detik.
setInterval(sendBufferedDataSequentially, 5000); 


// =======================================================
// --- KONFIGURASI MQTT WEB CLIENT ---
// =======================================================
const options = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 2000,
};

const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  options
);

const tableBody = document.getElementById("tableBody");
const conn = document.getElementById("conn");
const devices = {}; 

const dataMap = [
    { key: 'V', class: 'col-v' }, { key: 'I1', class: 'col-i' }, { key: 'I2', class: 'col-i' }, 
    { key: 'I3', class: 'col-i' }, { key: 'P', class: 'col-power' }, { key: 'Q', class: 'col-power' }, 
    { key: 'S', class: 'col-power' }, { key: 'PF', class: 'col-pf' }, { key: 'Hz', class: 'col-pf' }, 
    { key: 'OpH', class: 'col-pf' }, { key: 'EaT', class: 'col-energy' }, { key: 'ErT', class: 'col-energy' }, 
    { key: 'EaP', class: 'col-energy' }, { key: 'ErP', class: 'col-energy' }
];

function formatOperatingTime(totalHours) {
    if (totalHours === undefined || totalHours === null || isNaN(totalHours) || totalHours < 0) {
        return '---';
    }
    const totalMinutes = Math.round(parseFloat(totalHours) * 60); 
    const days = Math.floor(totalMinutes / (24 * 60)); 
    const remainingMinutes = totalMinutes % (24 * 60);
    const hours = Math.floor(remainingMinutes / 60); 
    const minutes = remainingMinutes % 60; 
    let result = '';
    
    if (days > 0) result += `${days} Hari `;
    if (hours > 0 || days === 0) {
        result += `${hours} Jam`;
        if (minutes > 0) result += ` ${minutes} Mnt`;
    } else if (minutes > 0) {
        result += `${minutes} Mnt`;
    }
    return result.trim() || '0 Jam'; 
}


client.on("connect", () => {
  conn.innerHTML = "✅ MQTT Connected";
  client.subscribe("politeknik/meter/data");
});

client.on("error", err => {
  conn.innerHTML = "❌ MQTT Error";
  console.error("MQTT Connection Error:", err);
});

// =======================================================
// --- LOGIKA UTAMA ON MESSAGE (UPDATE DASHBOARD & BUFFERING) ---
// =======================================================
client.on("message", (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    const id = d.id;
    const ea = Number(d.EaT);

    // 1. SIMPAN DATA KE BUFFER (TIDAK LANGSUNG POST KE SUPABASE)
    if (ea !== null && !isNaN(ea)) {
        dataBuffer[id] = {
            ea: ea,
            // Simpan data lain yang mungkin perlu (seperti status, dll.)
        };
    }
    
    // 2. Logika Dashboard: Cek atau Buat Baris Baru
    if (!devices[id]) {
      const row = tableBody.insertRow(); 
      devices[id] = row;
        // Membuat sel tabel
        row.insertCell().textContent = id;
        row.cells[0].className = 'cell-id';
        row.insertCell().textContent = d.status;
        dataMap.forEach(item => {
          const cell = row.insertCell();
          cell.className = item.class;
          cell.textContent = '---'; 
        });
      
        if (tableBody.rows.length > 1 && tableBody.rows[0].cells[0].colSpan === 16) {
            tableBody.deleteRow(0);
        }
    }

    const row = devices[id];
    const cells = row.cells;
    
    // 3. Logika Dashboard: Update Status dan Data
    cells[1].textContent = d.status ? d.status.toUpperCase() : '---';
    cells[1].className = d.status === "online" ? "status-online" : "status-offline";
    
    dataMap.forEach((item, index) => {
      const cellIndex = index + 2; 
      const value = d[item.key];
      let displayValue = (value === 0 || value) ? value : '---';
      
      if (item.key === 'OpH') {
        displayValue = formatOperatingTime(value);
      }
      cells[cellIndex].textContent = displayValue;
    });

  } catch (e) {
    console.error(`JSON Parsing Error/Proses Data Gagal:`, e);
  }
});
</script>

</body>
</html>

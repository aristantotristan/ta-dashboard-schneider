<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Realtime Monitoring – 18 Mesin</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #111;
    color: white;
    padding: 20px;
}
h2 { color: #00FFC2; }

.hidden { display: none; }

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 15px;
}
.machine {
    padding: 20px;
    background: #1E1E1E;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    border: 2px solid #00FFC2;
    transition: 0.25s;
}
.machine:hover {
    background: #00FFC2;
    color: black;
}
.back {
    margin-top: 20px;
    display: inline-block;
    background: #444;
    padding: 10px 18px;
    border-radius: 8px;
    text-decoration: none;
    color: white;
}

table {
    width: 100%;
    margin-top: 15px;
    border-collapse: collapse;
}
th, td {
    padding: 10px;
    border: 1px solid #333;
    text-align: center;
}
th {
    background: #1E1E1E;
    color: #00FFC2;
}
td {
    background: #151515;
}
</style>
</head>
<body>

<!-- PAGE 1: LIST MESIN -->
<div id="page_list">
    <h2>⚡ Realtime Monitoring – Pilih Mesin</h2>

    <div class="grid">
        <script>
            for (let i = 1; i <= 18; i++) {
                document.write(`<div class="machine" onclick="selectMachine(${i})">Mesin ${i}</div>`);
            }
        </script>
    </div>
</div>

<!-- PAGE 2: DETAIL PARAMETER -->
<div id="page_detail" class="hidden">
    <h2 id="title">Realtime Parameter</h2>
    <p id="status">Status: ---</p>

    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Nilai</th>
                <th>Satuan</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <div class="back" onclick="goBack()">⬅ Kembali ke Daftar Mesin</div>
</div>

<script>
// HALAMAN
const pageList = document.getElementById("page_list");
const pageDetail = document.getElementById("page_detail");
const tbody = document.getElementById("tbody");

let activeID = null;

// PARAMETER
const params = [
    ["Total Ea", "EaT", "kWh"],
    ["Total Er", "ErT", "kVARh"],
    ["Partial Ea", "EaP", "kWh"],
    ["Partial Er", "ErP", "kVARh"],
    ["Voltage (L-L Avg)", "V", "Volt"],
    ["Current I1", "I1", "A"],
    ["Current I2", "I2", "A"],
    ["Current I3", "I3", "A"],
    ["Power P", "P", "Watt"],
    ["Power Q", "Q", "VAR"],
    ["Power S", "S", "kVA"],
    ["Power Factor", "PF", "-"],
    ["Frekuensi", "Hz", "Hz"],
    ["Operating Time", "OpH", "Jam"],
];

// GENERATE TABEL STANDBY
function buildTable() {
    tbody.innerHTML = "";
    params.forEach(p => {
        tbody.innerHTML += `
            <tr id="row_${p[1]}">
                <td>${p[0]}</td>
                <td>---</td>
                <td>${p[2]}</td>
            </tr>
        `;
    });
}

// PILIH MESIN
function selectMachine(id) {
    activeID = id;
    document.getElementById("title").textContent = "Realtime Parameter – Mesin " + id;

    buildTable();

    pageList.classList.add("hidden");
    pageDetail.classList.remove("hidden");
}

// KEMBALI
function goBack() {
    activeID = null;
    pageDetail.classList.add("hidden");
    pageList.classList.remove("hidden");
}

// MQTT CONNECT
const client = mqtt.connect("wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt", {
    username: "web_dashboard",
    password: "Tristan12",
});

client.on("connect", () => {
    document.getElementById("status").textContent = "Status: Connected";
    client.subscribe("politeknik/meter/data");
});

client.on("message", (topic, msg) => {
    const d = JSON.parse(msg.toString());

    // Hanya update ketika user memilih mesin
    if (!activeID) return;

    if (d.id != activeID) return;

    params.forEach(p => {
        const key = p[1];
        const row = document.getElementById("row_" + key);
        if (row) {
            row.cells[1].textContent = d[key] ?? "---";
        }
    });
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Master Power Meter Dashboard (18 SLAVES)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> <!-- TAMBAHAN SUPABASE -->
<style>
  :root {
    --bg: #121212;
    --card: #1E1E1E;
    --muted: #94A3B8;
    --accent: #00FFC2;
    --online: #10B981;
    --offline: #EF4444;
    --tariff: #FACC15;
  }
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: #E0E0E0;
    padding: 20px;
    margin: 0;
  }
  h2 { color: var(--accent); margin: 0 0 12px 0; }
  #conn { margin-bottom: 14px; font-weight: 600; color: #94A3B8; }
  table {
    width: 100%;
    border-collapse: collapse;
    box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    border-radius: 8px;
    overflow: hidden;
  }
  thead th {
    background: #2A2A2A;
    color: var(--accent);
    text-transform: uppercase;
    font-size: 0.8rem;
    padding: 10px 8px;
    border-bottom: 1px solid #151515;
  }
  th, td {
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.02);
    text-align: center;
    font-size: 0.86rem;
  }
  tbody tr { background: var(--card); }
  tbody tr:hover { background: #2b2b2b; }
  .cell-id { font-weight:700; background:#111827; }
  .status-online { color: var(--online); font-weight:700; }
  .status-offline { color: var(--offline); font-weight:700; }
  .col-power { background: #0F334A; color: #38BDF8; font-weight:600; }
  .col-energy { color: #4ADE80; font-weight:600; }
  .col-tariff { color: var(--tariff); font-weight:700; }
  .muted { color: var(--muted); }
  @media (max-width:1000px) {
    table { font-size: 0.78rem; }
  }
</style>
</head>
<body>
<h2>Real-time Power Meter Dashboard (18 Mesin)</h2>
<p id="conn" class="muted">Connecting...</p>
<table aria-label="Power Meter Table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Status</th>
      <th>V</th>
      <th>I1</th>
      <th>I2</th>
      <th>I3</th>
      <th>P (W)</th>
      <th>Q (VAR)</th>
      <th>S (kVA)</th>
      <th>PF</th>
      <th>Hz</th>
      <th>OpH</th>
      <th>Ea Tot</th>
      <th>Er Tot</th>
      <th>Ea Part</th>
      <th>Er Part</th>
      <th class="col-tariff">T1 (kWh)</th>
      <th class="col-tariff">T2 (kWh)</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
/* ================= SUPABASE SETUP ================= */
const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Simpan nilai T1 & T2 sebelumnya per mesin
const previousTariff = {};

/* ================= FUNGSI SIMPAN T1 T2 + HITUNG DELTA ================= */
async function saveTariffData(sid, t1, t2) {
  const now = new Date().toISOString();
  t1 = parseFloat(t1) || 0;
  t2 = parseFloat(t2) || 0;

  // 1. Simpan data mentah ke meter_tariff_snapshot
  await supabase.from('meter_tariff_snapshot').insert({
    sid_mesin: sid,
    t1_lwbp_kwh: t1,
    t2_wbp_kwh: t2
  }).catch(err => console.error('Snapshot error:', err));

  // 2. Hitung delta kalau ada data sebelumnya
  const key = sid;
  if (previousTariff[key]) {
    const prev = previousTariff[key];
    const deltaLWBP = t1 - prev.t1;
    const deltaWBP  = t2 - prev.t2;

    // Hanya simpan kalau ada kenaikan (hindari bug reset meter)
    if (deltaLWBP > 0 || deltaWBP > 0) {
      await supabase.from('meter_tariff_delta').insert({
        sid_mesin: sid,
        lwbp_kwh: Math.max(0, deltaLWBP),
        wbp_kwh:  Math.max(0, deltaWBP)
      }).catch(err => console.error('Delta error:', err));
    }
  }

  // Simpan nilai terbaru
  previousTariff[key] = { t1, t2 };
}

/* ================= CONFIG MQTT & TABEL ================= */
const MQTT_OPTIONS = { username: "web_dashboard", password: "Tristan12", connectTimeout: 4000, reconnectPeriod: 2000 };
const MQTT_URL = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_TOPIC = "politeknik/meter/data";
const TOTAL_DEVICES = 18;

function formatOpH(hours) {
  if (hours === null || hours === undefined || isNaN(hours) || hours < 0) return '---';
  const totalMinutes = Math.round(parseFloat(hours) * 60);
  const days = Math.floor(totalMinutes / (24 * 60));
  const rem = totalMinutes % (24 * 60);
  const hrs = Math.floor(rem / 60);
  const mins = rem % 60;
  if (days > 0) return `${days} Hari ${hrs} Jam`;
  if (hrs > 0) return `${hrs} Jam${mins>0 ? ' ' + mins + ' Mnt' : ''}`;
  if (mins > 0) return `${mins} Mnt`;
  return '0 Jam';
}

function fmt(val, key) {
  if (val === null || val === undefined || isNaN(val)) return '---';
  const n = Number(val);
  if (['V'].includes(key)) return n.toFixed(1);
  if (['I1','I2','I3'].includes(key)) return n.toFixed(3);
  if (['P','Q'].includes(key)) return Math.round(n).toString();
  if (['S'].includes(key)) return n.toFixed(2);
  if (['PF'].includes(key)) return n.toFixed(3);
  if (['Hz'].includes(key)) return n.toFixed(1);
  if (['EaT','ErT','EaP','ErP','T1','T2'].includes(key)) return n.toFixed(2);
  return n.toString();
}

const tableBody = document.getElementById('tableBody');
const conn = document.getElementById('conn');
const dataMap = ['V','I1','I2','I3','P','Q','S','PF','Hz','OpH','EaT','ErT','EaP','ErP','T1','T2'];
const devices = {};

function createInitialRows() {
  tableBody.innerHTML = '';
  for (let id=1; id<=TOTAL_DEVICES; id++) {
    const tr = tableBody.insertRow();
    const tdId = tr.insertCell(); tdId.className = 'cell-id'; tdId.textContent = id;
    const tdStatus = tr.insertCell(); tdStatus.textContent = 'OFFLINE'; tdStatus.className = 'status-offline';
    dataMap.forEach(key => {
      const td = tr.insertCell();
      if (key === 'T1' || key === 'T2') td.className = 'col-tariff';
      else if (['EaT','ErT','EaP','ErP'].includes(key)) td.className = 'col-energy';
      else if (['P','Q','S'].includes(key)) td.className = 'col-power';
      td.textContent = '---';
    });
    devices[id] = tr;
  }
}
createInitialRows();

const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);
client.on('connect', () => {
  conn.textContent = 'MQTT Connected â€¢ Data T1/T2 otomatis disimpan ke Supabase';
  client.subscribe(MQTT_TOPIC);
});
client.on('reconnect', () => conn.textContent = 'MQTT Reconnecting...');
client.on('error', () => conn.textContent = 'MQTT Error');

client.on('message', (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    const id = Number(d.id);
    if (!id || id < 1 || id > TOTAL_DEVICES) return;

    const row = devices[id];
    const status = (d.status && d.status.toLowerCase() === 'online') ? 'online' : 'offline';
    row.cells[1].textContent = status.toUpperCase();
    row.cells[1].className = status === 'online' ? 'status-online' : 'status-offline';

    dataMap.forEach((key, idx) => {
      const cell = row.cells[2 + idx];
      let raw = d[key];
      if (key === 'OpH') {
        cell.textContent = (raw === 0 || raw) ? formatOpH(raw) : '---';
      } else {
        cell.textContent = (raw === 0 || raw) ? fmt(raw, key) : '---';
      }
    });

    // === INI FITUR BARU: SIMPAN T1 & T2 + HITUNG DELTA ===
    if (d.T1 != null && d.T2 != null) {
      saveTariffData(id, d.T1, d.T2);
    }

  } catch (e) {
    console.error('Payload error:', e);
  }
});
</script>
</body>
</html>

<script>
// =======================================================
// --- KONFIGURASI SUPABASE ---
// =======================================================

// GANTI DENGAN KREDENSIAL SUPABASE ANDA
const SUPA_URLÂ  = "https://rojhcadtqfynlqzubftx.supabase.co"; 
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs"; 
const TABLE_NAME = "ea_18mesin";
const EA_THRESHOLD = 0.01; // Ambang batas perubahan kWh untuk logging normal

let supa = supabase.createClient(SUPA_URL, SUPA_ANON);

// =======================================================
// --- FUNGSI LOGGING & LOCALSTORAGE (Memori Harian) ---
// =======================================================

/**
 * Menyimpan log energi ke tabel ea_18mesin di Supabase.
 * @param {object} entry - { id_mesin, ea, t, log_type }
 */
async function insertEnergyLog(entry) {
    try {
        const { error } = await supa.from(TABLE_NAME).insert([entry]);
        if (error) throw error;
    } catch (e) {
        console.error("Gagal menyimpan log ke Supabase:", e);
    }
}

/** Mendapatkan status flag transisi (misal: 'WBP_START_LOGGED_2025-12-01') */
function getTransitionFlag(id, key) {
    const today = new Date().toISOString().slice(0, 10);
    return localStorage.getItem(`${key}_${id}_${today}`);
}

/** Menetapkan flag transisi setelah log T1/T2 berhasil disimpan */
function setTransitionFlag(id, key) {
    const today = new Date().toISOString().slice(0, 10);
    localStorage.setItem(`${key}_${id}_${today}`, 'true');
}

/** Mendapatkan nilai Ea terakhir (untuk EA_THRESHOLD) */
function loadLastEa(id) {
    const s = localStorage.getItem("lastEa_" + id);
    return s ? Number(s) : undefined;
}

/** Menyimpan nilai Ea terakhir */
function saveLastEa(id, val) {
    localStorage.setItem("lastEa_" + id, val);
}

// =======================================================
// --- KONFIGURASI MQTT WEB CLIENT ---
// =======================================================
const options = {
Â  username: "web_dashboard",
Â  password: "Tristan12",
Â  connectTimeout: 4000,
Â  reconnectPeriod: 2000,
};

const client = mqtt.connect(
Â  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
Â  options
);

const tableBody = document.getElementById("tableBody");
const conn = document.getElementById("conn");
const devices = {}; // Menyimpan referensi baris tabel berdasarkan ID meter

// Definisikan urutan KEY JSON dan CLASS CSS
const dataMap = [
Â  Â  { key: 'V', class: 'col-v' }, { key: 'I1', class: 'col-i' }, { key: 'I2', class: 'col-i' },Â 
Â  Â  { key: 'I3', class: 'col-i' }, { key: 'P', class: 'col-power' }, { key: 'Q', class: 'col-power' },Â 
Â  Â  { key: 'S', class: 'col-power' }, { key: 'PF', class: 'col-pf' }, { key: 'Hz', class: 'col-pf' },Â 
Â  Â  { key: 'OpH', class: 'col-pf' }, { key: 'EaT', class: 'col-energy' }, { key: 'ErT', class: 'col-energy' },Â 
Â  Â  { key: 'EaP', class: 'col-energy' }, { key: 'ErP', class: 'col-energy' }
];

/**
Â * Mengonversi total jam (decimal) menjadi format Hari dan Jam.
Â * (Fungsi ini tetap sama)
Â */
function formatOperatingTime(totalHours) {
Â  Â  if (totalHours === undefined || totalHours === null || isNaN(totalHours) || totalHours < 0) {
Â  Â  Â  Â  return '---';
Â  Â  }
Â  Â  const totalMinutes = Math.round(parseFloat(totalHours) * 60); 

Â  Â  const days = Math.floor(totalMinutes / (24 * 60)); 
Â  Â  const remainingMinutes = totalMinutes % (24 * 60);
Â  Â Â 
Â  Â  const hours = Math.floor(remainingMinutes / 60); 
Â  Â  const minutes = remainingMinutes % 60; 
Â  Â Â 
Â  Â  let result = '';
Â  Â Â 
Â  Â  if (days > 0) {
Â  Â  Â  Â  result += `${days} Hari `;
Â  Â  }
Â  Â Â 
Â  Â  if (hours > 0 || days === 0) {
Â  Â  Â  Â  result += `${hours} Jam`;
Â  Â  Â  Â  if (minutes > 0) {
Â  Â  Â  Â  Â  Â  result += ` ${minutes} Mnt`;
Â  Â  Â  Â  }
Â  Â  } else if (minutes > 0) {
Â  Â  Â  Â  result += `${minutes} Mnt`;
Â  Â  }
Â  Â Â 
Â  Â  return result.trim() || '0 Jam';Â 
}


client.on("connect", () => {
Â  conn.innerHTML = "âœ… MQTT Connected";
Â  client.subscribe("politeknik/meter/data/#"); // Subscribing ke semua mesin
});

client.on("error", err => {
Â  conn.innerHTML = "âŒ MQTT Error";
Â  console.error("MQTT Connection Error:", err);
});

// =======================================================
// --- LOGIKA UTAMA ON MESSAGE (UPDATE DASHBOARD & LOGGING) ---
// =======================================================
client.on("message", (topic, message) => {
Â  try {
Â  Â  const d = JSON.parse(message.toString());
Â  Â  const id = d.id;
    const now = new Date();
    const currentHour = now.getHours(); // Jam 0 s/d 23

Â  Â  // 1. Cek atau Buat Baris Baru (Logika Dashboard)
Â  Â  if (!devices[id]) {
Â  Â  Â  const row = tableBody.insertRow();Â 
Â  Â  Â  devices[id] = row;
Â  Â  Â  // ... (Logika membuat sel tabel) ...
        row.insertCell().textContent = id;
Â  Â  Â  Â  row.cells[0].className = 'cell-id';
Â  Â  Â  Â  row.insertCell().textContent = d.status;
Â  Â  Â  Â  dataMap.forEach(item => {
Â  Â  Â  Â  Â  const cell = row.insertCell();
Â  Â  Â  Â  Â  cell.className = item.class;
Â  Â  Â  Â  Â  cell.textContent = '---';Â 
Â  Â  Â  Â  });
Â  Â  Â  
        if (tableBody.rows.length > 1 && tableBody.rows[0].cells[0].colSpan === 16) {
Â  Â  Â  Â  Â  Â  tableBody.deleteRow(0);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const row = devices[id];
Â  Â  const cells = row.cells;
Â  Â Â 
Â  Â  // 2. Update Status dan Data (Logika Dashboard)
Â  Â  cells[1].textContent = d.status ? d.status.toUpperCase() : '---';
Â  Â  cells[1].className = d.status === "online" ? "status-online" : "status-offline";
Â  Â Â 
Â  Â  dataMap.forEach((item, index) => {
Â  Â  Â  const cellIndex = index + 2;Â 
Â  Â  Â  const value = d[item.key];
Â  Â  Â  let displayValue = (value === 0 || value) ? value : '---';
Â  Â  Â Â 
Â  Â  Â  if (item.key === 'OpH') {
Â  Â  Â  Â  displayValue = formatOperatingTime(value);
Â  Â  Â  }
Â  Â  Â  cells[cellIndex].textContent = displayValue;
Â  Â  });


    // =======================================================
    // 3. LOGIKA SUPABASE: Logging EA (T1, T2, dan Normal)
    // =======================================================
    const ea = Number(d.EaT);
    if (isNaN(ea) || ea === null || ea === undefined) return; 

    const entry = {
        id_mesin: id,
        ea: ea,
        t: now.toISOString(),
        log_type: 'REALTIME' 
    };

    // --- A. Logika Normal (Jika ada perubahan signifikan) ---
    const lastEa = loadLastEa(id);
    if (lastEa === undefined || Math.abs(ea - lastEa) >= EA_THRESHOLD) {
        insertEnergyLog(entry);
        saveLastEa(id, ea);
    }

    // --- B. Logika Transisi WBP/LWBP (Mencatat T1 dan T2) ---
    
    // ðŸš¨ T1 WBP (Jam 17:xx)
    // WBP Dimulai (Akhir LWBP)
    if (currentHour === 17 && getTransitionFlag(id, 'T1_WBP_START') === null) {
        entry.log_type = 'T1_WBP_START'; 
        insertEnergyLog(entry);
        setTransitionFlag(id, 'T1_WBP_START');
        console.log(`[LOG WBP] Mesin ${id}: T1 WBP (17:00) dicatat.`);
    }
    
    // ðŸš¨ T2 WBP (Jam 22:xx)
    // WBP Berakhir (Awal LWBP Hari Berikutnya)
    if (currentHour === 22 && getTransitionFlag(id, 'T2_WBP_END') === null) {
        entry.log_type = 'T2_WBP_END'; 
        insertEnergyLog(entry);
        setTransitionFlag(id, 'T2_WBP_END');
        console.log(`[LOG WBP] Mesin ${id}: T2 WBP (22:00) dicatat.`);
    }


Â  } catch (e) {
Â  Â  console.error(`JSON Parsing Error/Proses Data Gagal:`, e);
Â  }
});
</script>

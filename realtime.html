<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš¡ Master Power Meter Dashboard (18 SLAVES)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script> 

<style>
/* Global Styling */
body {
Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  background: #121212; /* Deep Dark Background */
Â  Â  color: #E0E0E0; /* Soft White Text */
Â  Â  padding: 20px;
}
h2 {
Â  Â  color: #00FFC2; /* Neon Green/Cyan for title */
Â  Â  border-bottom: 2px solid #3A3A3A;
Â  Â  padding-bottom: 10px;
Â  Â  margin-bottom: 5px;
}
#conn {
Â  Â  margin-bottom: 25px;
Â  Â  font-size: 1.1em;
Â  Â  font-weight: bold;
}
table {
Â  Â  border-collapse: collapse;
Â  Â  width: 100%;
Â  Â  margin-top: 15px;
Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
Â  Â  border-radius: 8px;
Â  Â  overflow: hidden;Â 
}
th, td {
Â  Â  border: 1px solid #2A2A2A; /* Border antar sel */
Â  Â  padding: 10px 12px;
Â  Â  text-align: center;
Â  Â  transition: background-color 0.3s;
}
thead th {
Â  Â  background: #2A2A2A;
Â  Â  color: #00FFC2;
Â  Â  font-weight: 600;
Â  Â  text-transform: uppercase;
Â  Â  font-size: 0.9em;
}
tbody tr {
Â  Â  background: #1E1E1E;
}
tbody tr:hover {
Â  Â  background-color: #334155;Â 
}

/* Data Group Styling */
.cell-id { font-weight: bold; background: #111827; }
.status-online { color: #10B981; font-weight: bold; }Â 
.status-offline { color: #EF4444; font-weight: bold; }
.col-power { background-color: #0F334A; color: #38BDF8; font-weight: 600; }
.col-energy { color: #4ADE80; font-weight: 600; }
.col-v, .col-i, .col-pf { font-weight: 500; }
</style>
</head>

<body>

<h2>âš¡ Real-time Power Meter Dashboard (18 Mesin)</h2>
<p id="conn">Connecting...</p>

<table>
<thead>
<tr>
Â  <th class="cell-id">ID</th>
Â  <th>Status</th>
Â  <th class="col-v">V (Volt)</th>
Â  <th class="col-i">I1 (A)</th>
Â  <th class="col-i">I2 (A)</th>
Â  <th class="col-i">I3 (A)</th>
Â  <th class="col-power">P (Watt)</th>
Â  <th class="col-power">Q (VAR)</th>
Â  <th class="col-power">S (kVA)</th>
Â  <th class="col-pf">PF</th>
Â  <th class="col-pf">Hz</th>
Â  <th class="col-pf">OpH (Hari/Jam)</th>
Â  <th class="col-energy">Ea Tot (kWh)</th>
Â  <th class="col-energy">Er Tot (kVARh)</th>
Â  <th class="col-energy">Ea Part (kWh)</th>
Â  <th class="col-energy">Er Part (kVARh)</th>
</tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="16" style="padding: 30px; color: #94A3B8;">Awaiting Real-time Data from ESP32...</td></tr>
</tbody>
</table>

<script>
// =======================================================
// --- KONFIGURASI SUPABASE ---
// HARAP GANTI URL DAN KUNCI ANON DENGAN DATA ASLI ANDA
// =======================================================
const SUPA_URLÂ  = "https://rojhcadtqfynlqzubftx.supabase.co"; 
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs"; 
const TABLE_NAME = "ea_18mesin";
const EA_THRESHOLD = 0.01; // Log normal jika perubahan EA >= 0.01 kWh

let supa = supabase.createClient(SUPA_URL, SUPA_ANON);

// =======================================================
// --- FUNGSI LOGGING & LOCALSTORAGE (Memori Harian) ---
// =======================================================

/** Menyimpan log energi ke tabel ea_18mesin di Supabase. */
async function insertEnergyLog(entry) {
    try {
        const { error } = await supa.from(TABLE_NAME).insert([entry]);
        if (error) throw error;
        // console.log(`[Supabase Log] Mesin ${entry.id_mesin} (${entry.log_type}) berhasil.`);
    } catch (e) {
        console.error("Gagal menyimpan log ke Supabase. Cek RLS/Kredensial:", e);
    }
}

/** Mendapatkan status flag transisi dari localStorage (Memori Harian) */
function getTransitionFlag(id, key) {
    const today = new Date().toISOString().slice(0, 10);
    return localStorage.getItem(`${key}_${id}_${today}`);
}

/** Menetapkan flag transisi ke localStorage */
function setTransitionFlag(id, key) {
    const today = new Date().toISOString().slice(0, 10);
    localStorage.setItem(`${key}_${id}_${today}`, 'true');
}

/** Mendapatkan nilai Ea terakhir (untuk EA_THRESHOLD) */
function loadLastEa(id) {
    const s = localStorage.getItem("lastEa_" + id);
    return s ? Number(s) : undefined;
}

/** Menyimpan nilai Ea terakhir */
function saveLastEa(id, val) {
    localStorage.setItem("lastEa_" + id, val);
}

// =======================================================
// --- KONFIGURASI MQTT WEB CLIENT ---
// =======================================================
const options = {
Â  username: "web_dashboard",
Â  password: "Tristan12",
Â  connectTimeout: 4000,
Â  reconnectPeriod: 2000,
};

const client = mqtt.connect(
Â  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
Â  options
);

const tableBody = document.getElementById("tableBody");
const conn = document.getElementById("conn");
const devices = {}; 

// Definisikan urutan KEY JSON dan CLASS CSS
const dataMap = [
Â  Â  { key: 'V', class: 'col-v' }, { key: 'I1', class: 'col-i' }, { key: 'I2', class: 'col-i' },Â 
Â  Â  { key: 'I3', class: 'col-i' }, { key: 'P', class: 'col-power' }, { key: 'Q', class: 'col-power' },Â 
Â  Â  { key: 'S', class: 'col-power' }, { key: 'PF', class: 'col-pf' }, { key: 'Hz', class: 'col-pf' },Â 
Â  Â  { key: 'OpH', class: 'col-pf' }, { key: 'EaT', class: 'col-energy' }, { key: 'ErT', class: 'col-energy' },Â 
Â  Â  { key: 'EaP', class: 'col-energy' }, { key: 'ErP', class: 'col-energy' }
];

/** Mengonversi total jam (decimal) menjadi format Hari dan Jam. */
function formatOperatingTime(totalHours) {
Â  Â  if (totalHours === undefined || totalHours === null || isNaN(totalHours) || totalHours < 0) {
Â  Â  Â  Â  return '---';
Â  Â  }
Â  Â  const totalMinutes = Math.round(parseFloat(totalHours) * 60); 

Â  Â  const days = Math.floor(totalMinutes / (24 * 60)); 
Â  Â  const remainingMinutes = totalMinutes % (24 * 60);
Â  Â Â 
Â  Â  const hours = Math.floor(remainingMinutes / 60); 
Â  Â  const minutes = remainingMinutes % 60; 
Â  Â Â 
Â  Â  let result = '';
Â  Â Â 
Â  Â  if (days > 0) {
Â  Â  Â  Â  result += `${days} Hari `;
Â  Â  }
Â  Â Â 
Â  Â  if (hours > 0 || days === 0) {
Â  Â  Â  Â  result += `${hours} Jam`;
Â  Â  Â  Â  if (minutes > 0) {
Â  Â  Â  Â  Â  Â  result += ` ${minutes} Mnt`;
Â  Â  Â  Â  }
Â  Â  } else if (minutes > 0) {
Â  Â  Â  Â  result += `${minutes} Mnt`;
Â  Â  }
Â  Â Â 
Â  Â  return result.trim() || '0 Jam';Â 
}


client.on("connect", () => {
Â  conn.innerHTML = "âœ… MQTT Connected";
Â  client.subscribe("politeknik/meter/data");
});

client.on("error", err => {
Â  conn.innerHTML = "âŒ MQTT Error";
Â  console.error("MQTT Connection Error:", err);
});

// =======================================================
// --- LOGIKA UTAMA ON MESSAGE (UPDATE DASHBOARD & LOGGING) ---
// =======================================================
client.on("message", (topic, message) => {
Â  try {
Â  Â  const d = JSON.parse(message.toString());
Â  Â  const id = d.id;
    const now = new Date();
    const currentHour = now.getHours(); // Jam 0 s/d 23

Â  Â  // 1. Logika Dashboard: Cek atau Buat Baris Baru
Â  Â  if (!devices[id]) {
Â  Â  Â  const row = tableBody.insertRow();Â 
Â  Â  Â  devices[id] = row;
        // Membuat sel tabel
        row.insertCell().textContent = id;
Â  Â  Â  Â  row.cells[0].className = 'cell-id';
Â  Â  Â  Â  row.insertCell().textContent = d.status;
Â  Â  Â  Â  dataMap.forEach(item => {
Â  Â  Â  Â  Â  const cell = row.insertCell();
Â  Â  Â  Â  Â  cell.className = item.class;
Â  Â  Â  Â  Â  cell.textContent = '---';Â 
Â  Â  Â  Â  });
Â  Â  Â  
        if (tableBody.rows.length > 1 && tableBody.rows[0].cells[0].colSpan === 16) {
Â  Â  Â  Â  Â  Â  tableBody.deleteRow(0);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const row = devices[id];
Â  Â  const cells = row.cells;
Â  Â Â 
Â  Â  // 2. Logika Dashboard: Update Status dan Data
Â  Â  cells[1].textContent = d.status ? d.status.toUpperCase() : '---';
Â  Â  cells[1].className = d.status === "online" ? "status-online" : "status-offline";
Â  Â Â 
Â  Â  dataMap.forEach((item, index) => {
Â  Â  Â  const cellIndex = index + 2;Â 
Â  Â  Â  const value = d[item.key];
Â  Â  Â  let displayValue = (value === 0 || value) ? value : '---';
Â  Â  Â Â 
Â  Â  Â  if (item.key === 'OpH') {
Â  Â  Â  Â  displayValue = formatOperatingTime(value);
Â  Â  Â  }
Â  Â  Â  cells[cellIndex].textContent = displayValue;
Â  Â  });


    // =======================================================
    // 3. LOGIKA SUPABASE: Logging EA (T1, T2, dan Normal)
    // =======================================================
    const ea = Number(d.EaT);
    if (isNaN(ea) || ea === null || ea === undefined) return; 

    const entry = {
        id_mesin: id,
        ea: ea,
        t: now.toISOString(),
        log_type: 'REALTIME' 
    };

    // --- A. Logika Normal (Jika ada perubahan signifikan) ---
    const lastEa = loadLastEa(id);
    if (lastEa === undefined || Math.abs(ea - lastEa) >= EA_THRESHOLD) {
        insertEnergyLog(entry);
        saveLastEa(id, ea);
    }

    // --- B. Logika Transisi WBP/LWBP (Mencatat T1 dan T2) ---
    
    // ðŸš¨ T1 WBP (Jam 17:xx)
    // WBP Dimulai (Akhir LWBP: 17:00)
    if (currentHour === 17 && getTransitionFlag(id, 'T1_WBP_START') === null) {
        entry.log_type = 'T1_WBP_START'; 
        insertEnergyLog(entry);
        setTransitionFlag(id, 'T1_WBP_START');
        console.log(`[LOG WBP] Mesin ${id}: T1 WBP (17:00) dicatat.`);
    }
    
    // ðŸš¨ T2 WBP (Jam 22:xx)
    // WBP Berakhir (Awal LWBP: 22:00)
    if (currentHour === 22 && getTransitionFlag(id, 'T2_WBP_END') === null) {
        entry.log_type = 'T2_WBP_END'; 
        insertEnergyLog(entry);
        setTransitionFlag(id, 'T2_WBP_END');
        console.log(`[LOG WBP] Mesin ${id}: T2 WBP (22:00) dicatat.`);
    }


Â  } catch (e) {
Â  Â  console.error(`JSON Parsing Error/Proses Data Gagal:`, e);
Â  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>⚡ Realtime Monitoring (MQTT)</title>

<!-- MQTT over WebSocket -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
:root{--bg:#0b1220; --panel:#071028; --muted:#94a3b8; --accent:#00FFC2; --blue:#38BDF8; --gold:#FFD700; --ok:#10B981; --err:#EF4444}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, "Segoe UI",system-ui,Roboto,Arial;background:linear-gradient(180deg,#021021,#041428);color:#e6eef6;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
.title{display:flex;align-items:center;gap:12px}
.title h2{margin:0;color:var(--accent);font-size:1.2rem}
.controls{display:flex;gap:8px;align-items:center}
.input{background:#0b1724;border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:#e6eef6}
.button{background:var(--gold);color:#111;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.statusBar{font-weight:700;color:var(--muted)}
.table-wrap{overflow:auto;border-radius:10px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
table{width:100%;border-collapse:collapse;min-width:1100px}
th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.02);text-align:center;font-size:0.9rem}
thead th{background:#071426;color:var(--blue);text-transform:uppercase;letter-spacing:0.5px;font-weight:700}
tbody tr{background:#071a26}
.cell-id{font-weight:800;background:#02131a;color:var(--muted)}
.status-online{color:var(--ok);font-weight:700}
.status-offline{color:var(--err);font-weight:700}
.col-power{background:#062938;color:var(--blue);font-weight:700}
.col-energy{color:#4ADE80;font-weight:700}
.small{font-size:0.85rem;color:var(--muted)}
.footer{margin-top:12px;color:var(--muted);font-size:0.9rem}
.badge{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:10px;font-weight:700}
@media(max-width:980px){ table{min-width:900px} }
@media(max-width:720px){ thead th{font-size:0.72rem} td{font-size:0.78rem} }
</style>
</head>
<body>

<div class="header">
  <div class="title">
    <h2>⚡ Realtime Monitoring — 18 Meter</h2>
    <div class="small">(MQTT → HiveMQ WebSocket)</div>
  </div>

  <div class="controls">
    <input id="broker" class="input" style="width:360px" placeholder="wss://broker:port/mqtt" value="wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt">
    <input id="topic" class="input" style="width:260px" value="politeknik/meter/data">
    <input id="user" class="input" style="width:140px" value="web_dashboard">
    <input id="pass" class="input" style="width:140px" value="Tristan12" type="password">
    <button id="btnConnect" class="button">Connect</button>
  </div>
</div>

<div id="connStatus" class="statusBar small">Not connected</div>

<div style="height:12px"></div>

<div class="table-wrap">
  <table aria-live="polite">
    <thead>
      <tr>
        <th class="cell-id">ID</th><th>Status / Last Seen</th><th>V (V)</th><th>I1 (A)</th><th>I2 (A)</th><th>I3 (A)</th>
        <th class="col-power">P (W)</th><th class="col-power">Q (VAR)</th><th class="col-power">S (kVA)</th>
        <th>PF</th><th>Hz</th><th>OpH</th><th class="col-energy">Ea Tot</th><th class="col-energy">Er Tot</th><th class="col-energy">Ea Part</th><th class="col-energy">Er Part</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <!-- rows generated by JS -->
    </tbody>
  </table>
</div>

<div class="footer">
  Broker: <span class="badge" id="brokerLabel">—</span> • Topic: <span class="badge" id="topicLabel">—</span>
  • Status: <span id="summary">waiting</span>
  <a style="margin-left:10px;color:var(--muted)" href="./index.html">← Back</a>
</div>

<script>
/* ---------- Configuration & helpers ---------- */
const START_ID = 1, END_ID = 18;
const DEFAULT_BROKER = document.getElementById('broker').value;
const tableBody = document.getElementById('tableBody');
const connStatus = document.getElementById('connStatus');
const brokerLabel = document.getElementById('brokerLabel');
const topicLabel = document.getElementById('topicLabel');
const summary = document.getElementById('summary');

/* Build rows */
function buildRows() {
  tableBody.innerHTML = '';
  for (let id = START_ID; id <= END_ID; id++) {
    const tr = document.createElement('tr');
    tr.id = `row-${id}`;
    tr.innerHTML = `
      <td class="cell-id">${id}</td>
      <td class="small status-cell" id="status-${id}"><span class="status-offline">offline</span><div class="small" id="seen-${id}">--</div></td>
      <td id="V-${id}">---</td>
      <td id="I1-${id}">---</td>
      <td id="I2-${id}">---</td>
      <td id="I3-${id}">---</td>
      <td id="P-${id}" class="col-power">---</td>
      <td id="Q-${id}" class="col-power">---</td>
      <td id="S-${id}" class="col-power">---</td>
      <td id="PF-${id}">---</td>
      <td id="Hz-${id}">---</td>
      <td id="OpH-${id}">---</td>
      <td id="EaT-${id}" class="col-energy">---</td>
      <td id="ErT-${id}" class="col-energy">---</td>
      <td id="EaP-${id}" class="col-energy">---</td>
      <td id="ErP-${id}" class="col-energy">---</td>
    `;
    tableBody.appendChild(tr);
  }
}
buildRows();

/* Format helpers */
function fmtNum(v, digits = 3) {
  if (v === null || v === undefined) return '---';
  if (isNaN(v)) return '---';
  if (Math.abs(v) >= 1000) return Number(v).toLocaleString('id-ID', { maximumFractionDigits: 0 });
  return Number(v).toLocaleString('id-ID', { maximumFractionDigits: digits });
}
function fmtOpH(totalHours) {
  if (totalHours === null || totalHours === undefined || isNaN(totalHours)) return '---';
  totalHours = Number(totalHours);
  const minutes = Math.round(totalHours * 60);
  const days = Math.floor(minutes / (24 * 60));
  const rem = minutes % (24 * 60);
  const hours = Math.floor(rem / 60);
  const mins = rem % 60;
  let out = '';
  if (days) out += `${days}d `;
  if (hours || (!days && mins)) out += `${hours}h `;
  if (mins) out += `${mins}m`;
  return out.trim();
}

/* ---------- MQTT logic ---------- */
let client = null;
let lastMessageAt = Array(END_ID+1).fill(0);
const OFFLINE_TIMEOUT = 12000; // ms -> mark offline if no message in 12s

function connectMQTT(brokerUrl, topic, user, pass) {
  if (client) { try { client.end(true); } catch(e){} client = null; }
  connStatus.textContent = 'Connecting...';
  brokerLabel.textContent = brokerUrl;
  topicLabel.textContent = topic;
  summary.textContent = 'connecting';

  const opts = { username: user || '', password: pass || '', reconnectPeriod: 3000, connectTimeout: 5000, keepalive: 30 };
  try {
    client = mqtt.connect(brokerUrl, opts);
  } catch(e) {
    connStatus.textContent = 'Invalid broker URL';
    summary.textContent = 'error';
    console.error(e);
    return;
  }

  client.on('connect', () => {
    connStatus.textContent = '✅ Connected to broker';
    summary.textContent = 'subscribed';
    client.subscribe(topic, { qos: 0 }, (err) => {
      if (err) { connStatus.textContent = 'Subscribe failed'; console.error(err); }
      else connStatus.textContent = '✅ Subscribed to ' + topic;
    });
  });

  client.on('error', (err) => {
    connStatus.textContent = '❌ MQTT Error';
    summary.textContent = 'error';
    console.error('MQTT error', err);
  });

  client.on('reconnect', () => { connStatus.textContent = 'Reconnecting...'; });

  client.on('message', (topic, msg) => {
    try {
      const d = JSON.parse(msg.toString());
      if (!d || !d.id) return;
      const id = Number(d.id);
      lastMessageAt[id] = Date.now();

      // status
      const statusEl = document.getElementById(`status-${id}`);
      const seenEl = document.getElementById(`seen-${id}`);
      statusEl.innerHTML = `<span class="status-online">online</span>`;
      seenEl.textContent = new Date().toLocaleTimeString();

      // mapping keys (case-insensitive tolerance)
      const map = key => d[key] !== undefined ? d[key] : (d[key.toUpperCase()] !== undefined ? d[key.toUpperCase()] : null);

      // numeric update
      const toUpdate = {
        V: map('V'),
        I1: map('I1'),
        I2: map('I2'),
        I3: map('I3'),
        P: map('P'),
        Q: map('Q'),
        S: map('S'),
        PF: map('PF'),
        Hz: map('Hz'),
        OpH: map('OpH'),
        EaT: map('EaT'),
        ErT: map('ErT'),
        EaP: map('EaP'),
        ErP: map('ErP')
      };
      for (const k in toUpdate) {
        const el = document.getElementById(`${k}-${id}`);
        if (!el) continue;
        if (k === 'OpH') el.textContent = fmtOpH(Number(toUpdate[k]));
        else el.textContent = (toUpdate[k] === 0 || toUpdate[k]) ? fmtNum(Number(toUpdate[k]), 3) : '---';
      }
    } catch (e) {
      console.error('Invalid message', e, msg.toString());
    }
  });
}

/* Monitor offline states */
setInterval(() => {
  const now = Date.now();
  let onlineCount = 0;
  for (let id=START_ID; id<=END_ID; id++){
    const last = lastMessageAt[id] || 0;
    const statusCell = document.getElementById(`status-${id}`);
    const seenCell = document.getElementById(`seen-${id}`);
    if (!statusCell) continue;
    if (last === 0 || (now - last) > OFFLINE_TIMEOUT){
      statusCell.innerHTML = `<span class="status-offline">offline</span>`;
      if (seenCell) seenCell.textContent = '--';
    } else {
      onlineCount++;
    }
  }
  summary.textContent = `${onlineCount} online / ${END_ID} total`;
}, 1500);

/* UI connect button */
document.getElementById('btnConnect').addEventListener('click', () => {
  const broker = document.getElementById('broker').value.trim();
  const topic = document.getElementById('topic').value.trim();
  const user = document.getElementById('user').value.trim();
  const pass = document.getElementById('pass').value.trim();
  if (!broker || !topic) { alert('Isi broker & topic dulu'); return; }
  connectMQTT(broker, topic, user, pass);
});

/* connect on load with defaults */
window.addEventListener('load', () => {
  const broker = document.getElementById('broker').value.trim();
  const topic = document.getElementById('topic').value.trim();
  const user = document.getElementById('user').value.trim();
  const pass = document.getElementById('pass').value.trim();
  connectMQTT(broker, topic, user, pass);
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚡ Real-time Power Meter Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#121212; color:#E0E0E0; padding:20px; }
h2 { color:#00FFC2; border-bottom:2px solid #3A3A3A; padding-bottom:10px; margin-bottom:5px; }
#conn { margin-bottom:25px; font-size:1.1em; font-weight:bold; }
.back { display:inline-block; margin-bottom:20px; padding:10px 16px; background:#00FFC2; color:black; border-radius:8px; text-decoration:none; font-weight:bold; }
table { border-collapse:collapse; width:100%; margin-top:15px; box-shadow:0 4px 12px rgba(0,0,0,0.5); border-radius:8px; overflow:hidden; }
th,td { border:1px solid #2A2A2A; padding:10px 12px; text-align:center; transition:background-color .3s; }
thead th { background:#2A2A2A; color:#00FFC2; font-weight:600; text-transform:uppercase; font-size:.9em; }
tbody tr { background:#1E1E1E; }
tbody tr:hover { background:#334155; }
.cell-id { font-weight:bold; background:#111827; }
.status-online { color:#10B981; font-weight:bold; }
.status-offline { color:#EF4444; font-weight:bold; }
.col-power { background:#0F334A; color:#38BDF8; font-weight:600; }
.col-energy { color:#4ADE80; font-weight:600; }
</style>
</head>
<body>
<a href="index.html" class="back">⬅ Back</a>
<h2>⚡ Real-time Power Meter Dashboard (18 Mesin)</h2>
<p id="conn">Connecting...</p>
<table>
<thead>
<tr>
<th class="cell-id">ID</th>
<th>Status</th>
<th>V</th><th>I1</th><th>I2</th><th>I3</th>
<th class="col-power">P</th><th class="col-power">Q</th><th class="col-power">S</th>
<th>PF</th><th>Hz</th><th>OpH</th>
<th class="col-energy">Ea Tot</th><th class="col-energy">Er Tot</th>
<th class="col-energy">Ea Part</th><th class="col-energy">Er Part</th>
</tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="16" style="padding:30px; color:#94A3B8;">Awaiting Real-time Data...</td></tr>
</tbody>
</table>
<script>
const options={username:"web_dashboard",password:"Tristan12",connectTimeout:4000,reconnectPeriod:2000};
const client=mqtt.connect("wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",options);
const tableBody=document.getElementById("tableBody");
const conn=document.getElementById("conn");
const devices={};
const dataMap=[{key:'V'},{key:'I1'},{key:'I2'},{key:'I3'},{key:'P'},{key:'Q'},{key:'S'},{key:'PF'},{key:'Hz'},{key:'OpH'},{key:'EaT'},{key:'ErT'},{key:'EaP'},{key:'ErP'}];
function formatOperatingTime(h){if(!h&&h!==0)return '---';const m=Math.round(parseFloat(h)*60);const d=Math.floor(m/(24*60));const rm=m%(24*60);const hh=Math.floor(rm/60);const mm=rm%60;let r='';if(d>0)r+=`${d} Hari `;if(hh>0||d===0)r+=`${hh} Jam`;if(mm>0)r+=` ${mm} Mnt`;return r.trim()||'0 Jam';}
client.on("connect",()=>{conn.innerHTML="✅ MQTT Connected";client.subscribe("politeknik/meter/data");});
client.on("error",e=>{conn.innerHTML="❌ MQTT Error";});
client.on("message",(topic,message)=>{try{const d=JSON.parse(message.toString());const id=d.id;if(!devices[id]){const row=tableBody.insertRow();devices[id]=row;row.insertCell().textContent=id;row.cells[0].className='cell-id';row.insertCell().textContent=d.status;dataMap.forEach(()=>{const c=row.insertCell();c.textContent='---';});if(tableBody.rows.length>1&&tableBody.rows[0].cells[0].colSpan===16)tableBody.deleteRow(0);}const row=devices[id];const cells=row.cells;cells[1].textContent=d.status.toUpperCase();cells[1].className=d.status==="online"?"status-online":"status-offline";dataMap.forEach((item,i)=>{const idx=i+2;let val=d[item.key];cells[idx].textContent=item.key==='OpH'?formatOperatingTime(val):(val||val===0?val:'---');});}catch(e){console.error("JSON Error",e);}});
</script>
</body>
</html>

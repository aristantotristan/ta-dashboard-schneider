<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MASTER POWER METER • 18 MESIN</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0e17;--card:#111827;--accent:#00ff9d;--secondary:#00d0ff;
      --online:#00ff9d;--offline:#ff4757;--glow:0 0 30px rgba(0,255,157,0.5);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:var(--bg);color:#e0f7ff;font-family:'JetBrains Mono',monospace;
      min-height:100vh;padding:20px 16px;overflow-x:hidden;position:relative;
    }

    /* TOMBOL HOME KIRI ATAS - KECIL & KEREN */
    .home-btn{
      position:fixed;top:16px;left:16px;z-index:999;
      background:rgba(17,24,39,0.8);backdrop-filter:blur(12px);
      border:2px solid var(--accent);border-radius:50px;
      padding:10px 18px;color:var(--accent);font-weight:700;
      font-size:0.9rem;letter-spacing:2px;text-decoration:none;
      box-shadow:0 8px 30px rgba(0,0,0,0.6);transition:all 0.4s;
      display:flex;align-items:center;gap:8px;
    }
    .home-btn:hover{
      transform:translateY(-4px);box-shadow:0 15px 40px rgba(0,255,157,0.5);
      background:var(--accent);color:black;
    }
    .home-btn::before{
      content:"←";font-size:1.4rem;
    }

    header{text-align:center;margin:60px 0 30px}
    h1{
      font-family:'Orbitron',sans-serif;font-size:clamp(2.5rem,8vw,4.5rem);
      font-weight:900;letter-spacing:8px;
      background:linear-gradient(90deg,var(--accent),var(--secondary));
      -webkit-background-clip:text;background-clip:text;
      -webkit-text-fill-color:transparent;text-shadow:var(--glow);
    }
    .subtitle{color:#94a3b8;font-size:1rem;letter-spacing:3px;margin-top:8px}

    #conn{
      text-align:center;padding:12px;background:rgba(0,255,157,0.1);
      border:1px solid rgba(0,255,157,0.3);border-radius:12px;max-width:600px;
      margin:0 auto 30px;color:var(--accent);font-weight:700;
    }

    .grid{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:24px;max-width:1600px;margin:0 auto;
    }
    .card{
      background:var(--card);border-radius:20px;padding:24px;
      text-align:center;position:relative;overflow:hidden;
      border:1px solid rgba(0,255,157,0.2);box-shadow:0 10px 30px rgba(0,0,0,0.6);
      transition:all 0.4s cubic-bezier(0.175,0.885,0.32,1.275);cursor:pointer;
    }
    .card:hover{
      transform:translateY(-12px) scale(1.03);
      box-shadow:0 20px 60px rgba(0,255,157,0.4);border-color:var(--accent);
    }
    .card::before{
      content:'';position:absolute;top:0;left:50%;width:0;height:4px;
      background:var(--accent);box-shadow:var(--glow);transition:0.6s;
      transform:translateX(-50%);
    }
    .card:hover::before{width:100%}

    .status{
      position:absolute;top:16px;right:16px;width:16px;height:16px;
      border-radius:50%;background:var(--offline);box-shadow:0 0 20px var(--offline);
      transition:all 0.4s;
    }
    .status.online{
      background:var(--online);box-shadow:0 0 30px var(--online);
      animation:pulse 2s infinite;
    }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}

    .machine-name{
      font-size:1.4rem;font-weight:700;color:var(--accent);margin:12px 0;
      text-shadow:0 0 20px rgba(0,255,157,0.6);
    }
    .sid{
      font-size:2rem;font-weight:900;color:var(--primary);
      font-family:'Orbitron',sans-serif;text-shadow:var(--glow);
    }

    /* MODAL DETAIL */
    #modal{
      position:fixed;inset:0;background:rgba(0,0,0,0.95);backdrop-filter:blur(16px);
      display:none;justify-content:center;align-items:center;z-index:9999;padding:20px;
    }
    .modal-content{
      background:rgba(17,24,39,0.95);border:2px solid var(--accent);
      border-radius:24px;max-width:500px;width:100%;max-height:90vh;
      overflow-y:auto;box-shadow:0 20px 80px rgba(0,255,157,0.6);
      animation:modalIn 0.6s ease;position:relative;
    }
    @keyframes modalIn{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}

    .modal-header{
      background:linear-gradient(135deg,var(--accent),var(--secondary));
      padding:20px;text-align:center;color:#000;font-family:'Orbitron',sans-serif;
      font-size:1.8rem;font-weight:900;border-radius:22px 22px 0 0;position:relative;
    }
    .back-btn{
      position:absolute;top:12px;left:16px;background:rgba(0,0,0,0.5);color:white;
      border:none;padding:8px 16px;border-radius:50px;font-weight:700;cursor:pointer;
      transition:0.3s;
    }
    .back-btn:hover{background:var(--accent);color:black}

    .params{padding:24px}
    .param{
      display:flex;justify-content:space-between;padding:14px 0;
      border-bottom:1px solid rgba(0,255,157,0.2);
    }
    .param:last-child{border:none}
    .param-name{color:#94a3b8;font-weight:600}
    .param-value{font-weight:700;color:var(--accent);font-size:1.1rem}

    @media(max-width:640px){
      .grid{grid-template-columns:1fr 1fr;gap:16px}
      .card{padding:20px}
      .sid{font-size:1.6rem}
      .machine-name{font-size:1.2rem}
      .home-btn{top:12px;left:12px;padding:8px 14px;font-size:0.8rem}
    }
  </style>
</head>
<body>

  <!-- TOMBOL HOME KIRI ATAS -->
  <a href="index.html" class="home-btn">HOME</a>

  <header>
    <h1>MASTER POWER METER</h1>
    <div class="subtitle">Real-time Monitoring • 18 Mesin</div>
  </header>
  <div id="conn">Menghubungkan ke server...</div>

  <div class="grid" id="grid"></div>

  <!-- MODAL DETAIL -->
  <div id="modal" onclick="if(event.target===this) closeModal()">
    <div class="modal-content">
      <div class="modal-header">
        <button class="back-btn" onclick="closeModal()">← BACK</button>
        DETAIL PARAMETER
      </div>
      <div class="params" id="params"></div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://rojhcadtqfynlqzubftx.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs'
    );
    const previousTariff = {};

    const MACHINE_NAMES = {
      1:"UNKNOW",2:"UNKNOW",3:"UNKNOW",4:"UNKNOW",5:"MESIN 41",6:"MC 40",
      7:"MC 39",8:"UNKNOW",9:"MC 5",10:"HEATER MC 5",11:"UNKNOW",12:"MC 34",
      13:"MC 35",14:"UNKNOW",15:"UNKNOW",16:"MC 38",17:"MC 36",18:"MC 37"
    };

    const client = mqtt.connect("wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",{
      username:"web_dashboard",password:"Tristan12"
    });

    const latestData = {};

    const grid = document.getElementById('grid');
    for(let i=1;i<=18;i++){
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="status offline" id="status-${i}"></div>
        <div class="machine-name">${MACHINE_NAMES[i]}</div>
        <div class="sid">SID ${i}</div>
      `;
      card.onclick = () => showDetail(i);
      grid.appendChild(card);
      latestData[i] = {};
    }

    function showDetail(id){
      const d = latestData[id] || {};
      document.getElementById('params').innerHTML = `
        <div class="param"><span class="param-name">1. Total Ea</span><span class="param-value">${(d.EaT??'---').toFixed?.(2)||'---'} kWh</span></div>
        <div class="param"><span class="param-name">2. Total Er</span><span class="param-value">${(d.ErT??'---').toFixed?.(2)||'---'} kVARh</span></div>
        <div class="param"><span class="param-name">3. Partial Ea</span><span class="param-value">${(d.EaP??'---').toFixed?.(2)||'---'} kWh</span></div>
        <div class="param"><span class="param-name">4. Partial Er</span><span class="param-value">${(d.ErP??'---').toFixed?.(2)||'---'} kVARh</span></div>
        <div class="param"><span class="param-name">5. Voltage</span><span class="param-value">${(d.V??'---').toFixed?.(1)||'---'} V</span></div>
        <div class="param"><span class="param-name">6. Current I1</span><span class="param-value">${(d.I1??'---').toFixed?.(3)||'---'} A</span></div>
        <div class="param"><span class="param-name">7. Current I2</span><span class="param-value">${(d.I2??'---').toFixed?.(3)||'---'} A</span></div>
        <div class="param"><span class="param-name">8. Current I3</span><span class="param-value">${(d.I3??'---').toFixed?.(3)||'---'} A</span></div>
        <div class="param"><span class="param-name">9. Total Active (P)</span><span class="param-value">${Math.round(d.P||0).toLocaleString()} Watt</span></div>
        <div class="param"><span class="param-name">10. Total Reactive (Q)</span><span class="param-value">${Math.round(d.Q||0).toLocaleString()} VAR</span></div>
        <div class="param"><span class="param-name">11. Total Apparent (S)</span><span class="param-value">${(d.S??'---').toFixed?.(2)||'---'} kVA</span></div>
        <div class="param"><span class="param-name">12. Power Factor (PF)</span><span class="param-value">${(d.PF??'---').toFixed?.(3)||'---'}</span></div>
        <div class="param"><span class="param-name">13. Tarif T1 (LWBP)</span><span class="param-value">${(d.T1??'---').toFixed?.(2)||'---'} kWh</span></div>
        <div class="param"><span class="param-name">14. Tarif T2 (WBP)</span><span class="param-value">${(d.T2??'---').toFixed?.(2)||'---'} kWh</span></div>
        <div class="param"><span class="param-name">15. Frequency</span><span class="param-value">${(d.Hz??'---').toFixed?.(1)||'---'} Hz</span></div>
        <div class="param"><span class="param-name">16. Operating Time</span><span class="param-value">${formatOpH(d.OpH)||'---'}</span></div>
      `;
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal(){
      document.getElementById('modal').style.display = 'none';
    }

    function formatOpH(h){
      if(!h) return '---';
      const t = Math.round(h*1440);
      const d = Math.floor(t/1440), hr = Math.floor((t%1440)/60);
      return d?`${d}d ${hr}h`:`${hr}h`;
    }

    async function saveTariffData(sid,t1,t2){
      t1=parseFloat(t1)||0;t2=parseFloat(t2)||0;
      await supabase.from('meter_tariff_snapshot').insert({sid_mesin:sid,t1_lwbp_kwh:t1,t2_wbp_kwh:t2});
      if(previousTariff[sid]){
        const dl=t1-previousTariff[sid].t1,dw=t2-previousTariff[sid].t2;
        if(dl>0||dw>0) await supabase.from('meter_tariff_delta').insert({sid_mesin:sid,lwbp_kwh:Math.max(0,dl),wbp_kwh:Math.max(0,dw)});
      }
      previousTariff[sid]={t1,t2};
    }

    client.on('connect',()=>{document.getElementById('conn').textContent='TERHUBUNG • Data T1/T2 otomatis tersimpan';client.subscribe('politeknik/meter/data')});
    client.on('message',(_,m)=>{
      try{
        const d=JSON.parse(m);
        const id=Number(d.id);
        if(id<1||id>18) return;
        latestData[id]=d;
        document.getElementById(`status-${id}`).className = d.status==='online'?'status online':'status offline';
        if(d.T1!=null&&d.T2!=null) saveTariffData(id,d.T1,d.T2);
      }catch(e){console.error(e)}
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>⚡ Master Power Meter • 18 Slaves</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e17;
      --card: #111827;
      --card-hover: #1f2937;
      --accent: #00ffc2;
      --online: #00ff9d;
      --offline: #ff2e63;
      --warning: #ff9500;
      --text: #e0fbfc;
      --muted: #64748b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Roboto Mono', monospace;
      min-height: 100vh;
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(0, 255, 194, 0.15) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(0, 255, 194, 0.1) 0%, transparent 20%);
    }

    /* Background grid halus */
    .bg-grid {
      position: fixed;
      inset: 0;
      background-image: 
        linear-gradient(rgba(0,255,194,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,255,194,0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: -1;
      animation: gridMove 80s linear infinite;
    }
    @keyframes gridMove { 0% { transform: translate(0,0); } 100% { transform: translate(50px,50px); } }

    header { text-align: center; padding: 2.5rem 1rem; position: relative; }
    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.8rem;
      font-weight: 900;
      background: linear-gradient(90deg, #00ffc2, #00b894, #00ffc2);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 40px rgba(0,255,194,0.7);
      letter-spacing: 6px;
      animation: glow 4s infinite alternate;
    }
    @keyframes glow { from { text-shadow: 0 0 30px rgba(0,255,194,0.6); } to { text-shadow: 0 0 50px rgba(0,255,194,0.9); } }
    .subtitle { font-size: 1.1rem; color: var(--muted); letter-spacing: 4px; text-transform: uppercase; margin-top: 0.5rem; }

    #conn {
      text-align: center;
      padding: 0.9rem 2rem;
      font-weight: 500;
      letter-spacing: 1.5px;
      color: var(--accent);
      background: rgba(0,255,194,0.12);
      border: 1px solid rgba(0,255,194,0.3);
      border-radius: 12px;
      max-width: 600px;
      margin: 0 auto 2.5rem;
      text-shadow: 0 0 10px var(--accent);
    }

    #main-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
      gap: 1.8rem;
      padding: 0 2rem;
      max-width: 1700px;
      margin: 0 auto;
    }

    .machine-card {
      background: var(--card);
      border: 1px solid rgba(0,255,194,0.25);
      border-radius: 18px;
      padding: 2rem 1.5rem;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.4s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .machine-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0; transition: opacity 0.4s;
    }
    .machine-card:hover {
      transform: translateY(-14px) scale(1.04);
      background: var(--card-hover);
      border-color: var(--accent);
      box-shadow: 0 25px 50px rgba(0,0,0,0.7), 0 0 40px rgba(0,255,194,0.4);
    }
    .machine-card:hover::before { opacity: 1; }

    .card-label {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent);
      text-shadow: 0 0 15px rgba(0,255,194,0.6);
      margin-bottom: 0.5rem;
    }
    .sid-label {
      font-size: 0.95rem;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .status-indicator {
      position: absolute; top: 18px; right: 18px;
      width: 26px; height: 26px;
      border-radius: 50%;
      border: 3px solid;
      animation: pulse-glow 2s infinite;
    }
    .status-online { background: rgba(0,255,157,0.2); border-color: var(--online); box-shadow: 0 0 25px var(--online); }
    .status-offline { background: rgba(255,46,99,0.2); border-color: var(--offline); box-shadow: 0 0 25px var(--offline); }
    @keyframes pulse-glow { 0%,100% { transform: scale(1); } 50% { transform: scale(1.25); } }

    /* Modal */
    #modal-overlay {
      position: fixed; inset: 0; background: rgba(10,14,23,0.97); backdrop-filter: blur(12px);
      display: none; align-items: center; justify-content: center; z-index: 9999; padding: 1rem;
    }
    #modal {
      background: linear-gradient(135deg, #111827, #1e293b);
      border: 1.5px solid var(--accent);
      border-radius: 24px;
      width: 100%; max-width: 720px; max-height: 90vh; overflow: hidden;
      box-shadow: 0 0 80px rgba(0,255,194,0.5);
      animation: modalPop 0.5s ease;
    }
    @keyframes modalPop { from { transform: scale(0.85); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    #modal h3 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem; color: var(--accent); text-align: center;
      padding: 1.8rem; margin: 0;
      background: rgba(0,255,194,0.1);
      border-bottom: 1px solid rgba(0,255,194,0.4);
      text-shadow: 0 0 20px rgba(0,255,194,0.7);
    }
    #close-modal {
      position: absolute; top: 1rem; right: 1.8rem;
      background: none; border: none; font-size: 3rem; color: var(--muted);
      cursor: pointer; transition: 0.3s;
    }
    #close-modal:hover { color: var(--accent); transform: rotate(90deg) scale(1.3); text-shadow: 0 0 20px var(--accent); }

    #detail-table { width: 100%; border-collapse: collapse; font-size: 1.05rem; }
    #detail-table th { background: rgba(0,255,194,0.12); color: var(--accent); padding: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
    #detail-table td { padding: 1rem 1.2rem; border-bottom: 1px solid rgba(100,116,139,0.3); }
    #detail-table tbody tr:hover { background: rgba(0,255,194,0.1); }
    .param-name { color: var(--muted); font-weight: 500; }
    .param-value { text-align: right; font-weight: 600; }
    .col-power { color: #38bdf8; } .col-energy { color: #34d399; } .col-tariff { color: #fbbf24; }

    @media (max-width: 768px) {
      h1 { font-size: 2.8rem; }
      #main-view { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.4rem; padding: 0 1rem; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 2.3rem; }
      #main-view { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

  <div class="bg-grid"></div>

  <header>
    <h1>MASTER POWER METER</h1>
    <p class="subtitle">18 Active Slaves • Real-Time Monitoring System</p>
  </header>

  <div id="conn">Connecting to HiveMQ Cloud...</div>
  <div id="main-view"></div>

  <!-- Modal -->
  <div id="modal-overlay">
    <div id="modal">
      <button id="close-modal" aria-label="Close">×</button>
      <h3 id="modal-title">Detail Parameter • SID --</h3>
      <table id="detail-table">
        <thead><tr><th>Parameter</th><th>Nilai</th></tr></thead>
        <tbody id="detailBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ================== SEMUA SCRIPT ASLI KAMU (100% SAMA) ==================
    const MQTT_OPTIONS = {
      username: "web_dashboard",
      password: "Tristan12",
      connectTimeout: 4000,
      reconnectPeriod: 2000
    };
    const MQTT_URL = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
    const MQTT_TOPIC = "politeknik/meter/data";
    const TOTAL_DEVICES = 18;
    const MACHINE_TAGS = {
      1: 'UNKNOW', 2: 'UNKNOW', 3: 'POMPA MC 12', 4: 'MC 9', 5: 'UNKNOW', 6: 'MC 40',
      7: 'MC 39', 8: 'MC 6', 9: 'HEATER MC 5', 10: 'POMPA MC 5', 11: 'UNKNOW', 12: 'MC 34',
      13: 'MC 35', 14: 'UNKNOW', 15: 'UNKNOW', 16: 'MC 38', 17: 'MC 36', 18: 'MC 37'
    };

    // ... (semua fungsi formatOpH, fmt, getStyleClass, dataLabels, dll — gua tempel full di bawah ini)
    function formatOpH(hours) {
      if (hours === null || hours === undefined || isNaN(hours) || hours < 0) return '---';
      const totalMinutes = Math.round(parseFloat(hours) * 60);
      const days = Math.floor(totalMinutes / (24 * 60));
      const rem = totalMinutes % (24 * 60);
      const hrs = Math.floor(rem / 60);
      const mins = rem % 60;
      if (days > 0) return `${days} Hari ${hrs} Jam`;
      if (hrs > 0) return `${hrs} Jam${mins>0 ? ' ' + mins + ' Mnt' : ''}`;
      if (mins > 0) return `${mins} Mnt`;
      return '0 Jam';
    }
    function fmt(val, key) {
      if (val === null || val === undefined || isNaN(val)) return '---';
      const n = Number(val);
      if (['V'].includes(key)) return n.toFixed(1);
      if (['I1','I2','I3'].includes(key)) return n.toFixed(3);
      if (['P','Q'].includes(key)) return Math.round(n).toString();
      if (['S'].includes(key)) return n.toFixed(2);
      if (['PF'].includes(key)) return n.toFixed(3);
      if (['Hz'].includes(key)) return n.toFixed(1);
      if (['EaT','ErT','EaP','ErP','T1','T2'].includes(key)) return n.toFixed(2);
      return n.toString();
    }
    function getStyleClass(key) {
      if (key === 'T1' || key === 'T2') return 'col-tariff';
      if (['EaT','ErT','EaP','ErP'].includes(key)) return 'col-energy';
      if (['P','Q','S'].includes(key)) return 'col-power';
      return '';
    }
    const dataLabels = {
      'V': 'Tegangan (V)', 'I1': 'Arus Fasa 1 (A)', 'I2': 'Arus Fasa 2 (A)', 'I3': 'Arus Fasa 3 (A)',
      'P': 'Daya Aktif (W)', 'Q': 'Daya Reaktif (VAR)', 'S': 'Daya Semu (kVA)', 'PF': 'Faktor Daya',
      'Hz': 'Frekuensi (Hz)', 'OpH': 'Jam Operasi',
      'EaT': 'Energi Aktif Total (kWh)', 'ErT': 'Energi Reaktif Total (kVARh)',
      'EaP': 'Energi Aktif Parsial (kWh)', 'ErP': 'Energi Reaktif Parsial (kVARh)',
      'T1': 'Tarif Lwbp (kWh)', 'T2': 'Tarif Wbp (kWh)'
    };

    const mainView = document.getElementById('main-view');
    const modalOverlay = document.getElementById('modal-overlay');
    const detailBody = document.getElementById('detailBody');
    const modalTitle = document.getElementById('modal-title');
    const closeModal = document.getElementById('close-modal');
    const conn = document.getElementById('conn');
    const dataMap = ['V','I1','I2','I3','P','Q','S','PF','Hz','OpH','EaT','ErT','EaP','ErP','T1','T2'];
    const devices = {};
    const deviceData = {};
    for (let id = 1; id <= TOTAL_DEVICES; id++) deviceData[id] = {};

    function createCards() {
      mainView.innerHTML = '';
      for(let id=1; id<=TOTAL_DEVICES; id++) {
        const card = document.createElement('div');
        card.className = 'machine-card';
        card.setAttribute('data-id', id);
        const tag = MACHINE_TAGS[id] || 'UNKNOW';
        card.innerHTML = `
          <div class="status-indicator status-offline" id="status-ind-${id}"></div>
          <p class="card-label">${tag}</p>
          <p class="sid-label">SID ${id}</p>
        `;
        card.onclick = () => showDetailModal(id);
        mainView.appendChild(card);
        devices[id] = { card, indicator: document.getElementById(`status-ind-${id}`) };
      }
    }

    function showDetailModal(id) {
      const data = deviceData[id];
      modalTitle.textContent = `Detail SID ${id} - ${MACHINE_TAGS[id] || 'UNKNOW'}`;
      detailBody.innerHTML = '';
      const statusRow = document.createElement('tr');
      statusRow.innerHTML = `<td class="param-name">Status</td><td class="param-value ${data.status === 'online' ? 'status-online' : 'status-offline'}">${data.status ? data.status.toUpperCase() : '---'}</td>`;
      detailBody.appendChild(statusRow);

      dataMap.forEach(key => {
        const tr = document.createElement('tr');
        const raw = data[key];
        let displayValue = (key === 'OpH') ? formatOpH(raw) : fmt(raw, key);
        if (raw === 0 || raw) displayValue = (key === 'OpH') ? formatOpH(raw) : fmt(raw, key);
        else displayValue = '---';
        tr.innerHTML = `<td class="param-name">${dataLabels[key]}</td><td class="param-value ${getStyleClass(key)}">${displayValue}</td>`;
        detailBody.appendChild(tr);
      });
      modalOverlay.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeDetailModal() {
      modalOverlay.style.display = 'none';
      document.body.style.overflow = '';
    }
    closeModal.onclick = closeDetailModal;
    modalOverlay.addEventListener('click', e => { if(e.target === modalOverlay) closeDetailModal(); });
    window.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetailModal(); });

    createCards();

    const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);
    client.on('connect', () => { conn.textContent = 'MQTT Connected • Online'; client.subscribe(MQTT_TOPIC); });
    client.on('reconnect', () => { conn.textContent = 'MQTT Reconnecting...'; });
    client.on('error', err => { conn.textContent = 'MQTT Error'; console.error(err); });
    client.on('message', (topic, message) => {
      try {
        const d = JSON.parse(message.toString());
        const id = Number(d.id);
        if (!id || id < 1 || id > TOTAL_DEVICES) return;
        deviceData[id] = d;
        if (devices[id]) {
          const status = (d.status && d.status.toLowerCase() === 'online') ? 'online' : 'offline';
          devices[id].indicator.className = `status-indicator status-${status}`;
        }
      } catch (e) { console.error('Parse error:', e); }
    });
  </script>
</body>
</html>

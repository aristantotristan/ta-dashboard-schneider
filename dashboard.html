<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        /* --- CSS MODERN UI --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 25px;
        }
        
        /* Header dengan Dropdown */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .header-title h1 { text-align: left; color: #1a237e; margin: 0; font-size: 2.2em; }
        .header-title h2 { text-align: left; color: #546e7a; font-size: 1em; margin: 5px 0 0 0; font-weight: 400; }
        
        select#machine-selector {
            padding: 10px 15px;
            font-size: 1.1em;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: white;
            cursor: pointer;
            font-weight: bold;
            color: #1a237e;
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: auto;
            gap: 20px;
        }

        /* Kartu */
        .card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
            padding: 25px;
        }

        /* KPI Card Style */
        .kpi-card { display: flex; flex-direction: column; justify-content: space-between; }
        .kpi-card .label { font-size: 0.9em; font-weight: 600; color: #546e7a; margin-bottom: 8px; text-transform: uppercase; }
        .kpi-card .value { font-size: 2.8em; font-weight: 700; color: #0d47a1; line-height: 1; }
        .kpi-card .unit { font-size: 1.2em; font-weight: 500; color: #444; margin-left: 5px; }
        
        /* Chart Card Style */
        .chart-card { grid-column: span 2; }
        .chart-card.full { grid-column: span 4; }
        .chart-card h3 { margin-top: 0; margin-bottom: 20px; font-size: 1.1em; color: #333; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        .chart-container.half-height { height: 250px; }

        /* Status Bar */
        #status {
            position: fixed; bottom: 20px; right: 20px;
            padding: 10px 20px; border-radius: 50px;
            color: white; font-weight: bold; font-size: 0.9em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .bg-ok { background: #2e7d32; }
        .bg-wait { background: #f57c00; }
        .bg-err { background: #c62828; }

        /* Responsive */
        @media (max-width: 1200px) {
            .chart-card { grid-column: span 2; }
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            .header-container { flex-direction: column; align-items: flex-start; gap: 15px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .kpi-card, .chart-card, .chart-card.full { grid-column: span 1; }
        }
    </style>
</head>
<body>

    <div id="status" class="bg-wait">Connecting MQTT...</div>

    <div class="header-container">
        <div class="header-title">
            <h1>Energy Dashboard</h1>
            <h2 id="machine-label">Data Real-time - Mesin 1</h2>
        </div>
        
        <select id="machine-selector" onchange="changeMachine(this.value)">
            </select>
    </div>

    <div class="dashboard-grid">

        <div class="card kpi-card">
            <div class="label">TEGANGAN</div>
            <div><span class="value" id="val-v">0.0</span><span class="unit">V</span></div>
        </div>
        <div class="card kpi-card">
            <div class="label">ARUS</div>
            <div><span class="value" id="val-i">0.00</span><span class="unit">A</span></div>
        </div>
        <div class="card kpi-card">
            <div class="label">FREKUENSI</div>
            <div><span class="value" id="val-hz">0.0</span><span class="unit">Hz</span></div>
        </div>
        <div class="card kpi-card">
            <div class="label">POWER FACTOR</div>
            <div><span class="value" id="val-pf">0.00</span><span class="unit"></span></div>
        </div>
        
        <div class="card chart-card full">
            <h3>Tren Tegangan (V) & Arus (A)</h3>
            <div class="chart-container">
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <div class="card chart-card">
            <h3>Komposisi Daya</h3>
            <div class="chart-container half-height">
                <canvas id="barChart"></canvas>
            </div>
        </div>
        <div class="card chart-card">
            <h3>Komposisi Energi (kWh)</h3>
            <div class="chart-container half-height">
                <canvas id="donutChart"></canvas>
            </div>
        </div>

    </div>

<script>
// --- 1. CONFIG ---
const MQTT_HOST = "701d32236feb43b38c22855a611f4d42.s1.eu.hivemq.cloud";
const MQTT_PORT = 8884;
const MQTT_USER = "web_dashboard";
const MQTT_PASS = "Tristan12";
const MQTT_TOPIC = "politeknik/meter/data";

let client;
let activeMachineId = 1; // Default Mesin 1
let machineData = {}; // Menyimpan data terakhir setiap mesin
const MAX_DATA_POINTS = 20;
let lineChart, barChart, donutChart;

// --- 2. INISIALISASI CHART ---
function setupCharts() {
    // Line Chart
    const ctxLine = document.getElementById('lineChart').getContext('2d');
    lineChart = new Chart(ctxLine, {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Tegangan (V)', data: [], borderColor: '#2196f3', yAxisID: 'yV', tension: 0.2, fill: false },
            { label: 'Arus (A)', data: [], borderColor: '#e91e63', yAxisID: 'yA', tension: 0.2, fill: false }
        ]},
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, yV: { position: 'left', min: 200, max: 250 }, yA: { position: 'right', min: 0 } } }
    });

    // Bar Chart
    const ctxBar = document.getElementById('barChart').getContext('2d');
    barChart = new Chart(ctxBar, {
        type: 'bar',
        data: { labels: ['P (W)', 'Q (VAR)', 'S (VA)'], datasets: [{ label: 'Daya', data: [0,0,0], backgroundColor: ['#4caf50', '#ff9800', '#9c27b0'] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    // Donut Chart
    const ctxDonut = document.getElementById('donutChart').getContext('2d');
    donutChart = new Chart(ctxDonut, {
        type: 'doughnut',
        data: { labels: ['Total EA', 'Partial EA'], datasets: [{ data: [1, 0], backgroundColor: ['#03a9f4', '#ff5722'] }] },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

// --- 3. FUNGSI UPDATE UI ---
function updateDashboard(id) {
    // Hanya update jika data mesin yg dipilih tersedia
    if (!machineData[id]) return; 
    const d = machineData[id];

    // Update Angka
    document.getElementById('val-v').textContent = d.v.toFixed(1);
    document.getElementById('val-i').textContent = d.i.toFixed(2);
    document.getElementById('val-hz').textContent = d.hz.toFixed(1);
    document.getElementById('val-pf').textContent = d.pf.toFixed(2);

    // Update Grafik Line (Realtime push)
    const timeLabel = new Date().toLocaleTimeString();
    lineChart.data.labels.push(timeLabel);
    lineChart.data.datasets[0].data.push(d.v);
    lineChart.data.datasets[1].data.push(d.i);
    if(lineChart.data.labels.length > MAX_DATA_POINTS) {
        lineChart.data.labels.shift();
        lineChart.data.datasets[0].data.shift();
        lineChart.data.datasets[1].data.shift();
    }
    lineChart.update('none'); // 'none' biar animasi gak berat

    // Update Grafik Bar
    barChart.data.datasets[0].data = [d.p, d.q, d.s];
    barChart.update();

    // Update Grafik Donut
    donutChart.data.datasets[0].data = [d.e, d.e_part];
    donutChart.update();
}

// --- 4. LOGIKA GANTI MESIN ---
function changeMachine(id) {
    activeMachineId = parseInt(id);
    document.getElementById('machine-label').textContent = "Data Real-time - Mesin " + id;
    
    // Reset Grafik saat ganti mesin (biar tidak nyampur)
    lineChart.data.labels = [];
    lineChart.data.datasets[0].data = [];
    lineChart.data.datasets[1].data = [];
    lineChart.update();
    
    // Paksa update jika data cache ada
    if (machineData[activeMachineId]) {
        updateDashboard(activeMachineId);
    }
}

// --- 5. KONEKSI MQTT ---
function startMQTT() {
    const clientId = "WebClient-" + new Date().getTime();
    client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, clientId);

    client.onConnectionLost = (responseObject) => {
        document.getElementById("status").className = "bg-err";
        document.getElementById("status").textContent = "Connection Lost";
        setTimeout(startMQTT, 5000);
    };

    client.onMessageArrived = (message) => {
        try {
            const d = JSON.parse(message.payloadString);
            // Simpan data ke cache (berdasarkan ID mesin)
            if (d.id) {
                machineData[d.id] = d;
                // Jika data yg masuk = mesin yg sedang dilihat, update UI
                if (d.id === activeMachineId) {
                    updateDashboard(d.id);
                }
            }
        } catch (e) { console.error(e); }
    };

    client.connect({
        useSSL: true,
        userName: MQTT_USER,
        password: MQTT_PASS,
        onSuccess: () => {
            document.getElementById("status").className = "bg-ok";
            document.getElementById("status").textContent = "System Online";
            client.subscribe(MQTT_TOPIC);
        },
        onFailure: () => {
            document.getElementById("status").className = "bg-err";
            document.getElementById("status").textContent = "Failed to Connect";
            setTimeout(startMQTT, 5000);
        }
    });
}

// --- INIT ---
window.onload = function() {
    // 1. Isi Dropdown
    const select = document.getElementById("machine-selector");
    for (let i = 1; i <= 18; i++) {
        let option = document.createElement("option");
        option.value = i;
        option.text = "Mesin " + i;
        select.appendChild(option);
    }

    setupCharts();
    startMQTT();
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Monitoring Energi — PT Amarilys</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body{font-family:Arial,Helvetica; background:#0b1220; color:#e6eef8; padding:18px;}
  h1{color:#7ef0c7}
  .btn{padding:10px 12px;border-radius:8px;background:#0ea5a0;color:#001;margin-right:8px;cursor:pointer}
  .card{background:#071022;padding:12px;border-radius:8px;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:center}
  thead th{color:#7ef0c7}
  .hidden{display:none}
</style>
</head>
<body>
  <h1>⚡ Monitoring Energi — PT Amarilys</h1>
  <div style="margin-bottom:12px">
    <button id="btnHome" class="btn">Home</button>
    <button id="btnRealtime" class="btn">Monitoring Real-Time</button>
    <button id="btnTarif" class="btn">Monitoring Tarif Mesin</button>
  </div>

  <div id="pageHome" class="card">
    <h2>Home</h2>
    <p>Pilih menu:</p>
    <button id="goRealtime" class="btn">Monitoring Real-Time</button>
    <button id="goTarif" class="btn">Monitoring Tarif Mesin</button>
  </div>

  <div id="pageRealtime" class="card hidden">
    <h2>Realtime — Mesin 1</h2>
    <p id="conn">Connecting to MQTT...</p>
    <table>
      <thead>
        <tr><th>Machine</th><th>Status</th><th>kWh</th><th>EAP</th><th>Volt</th><th>I1</th><th>I2</th><th>I3</th><th>P(W)</th><th>Q</th><th>PF</th><th>Hz</th><th>OpH</th></tr>
      </thead>
      <tbody id="rtBody">
        <tr><td>1</td><td id="st">-</td><td id="kwh">-</td><td id="eap">-</td><td id="v">-</td><td id="i1">-</td><td id="i2">-</td><td id="i3">-</td><td id="p">-</td><td id="q">-</td><td id="pf">-</td><td id="hz">-</td><td id="oph">-</td></tr>
      </tbody>
    </table>
  </div>

  <div id="pageTarif" class="card hidden">
    <h2>Tarif Mesin</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <label>Tarif (Rp/kWh):</label>
      <input id="inputTarif" type="number" step="0.01" />
      <button id="saveTarif" class="btn">Simpan</button>
      <span id="tarifMsg" style="color:#9fd8c9;margin-left:8px"></span>
    </div>
    <div style="margin-top:12px">
      <strong>Ringkasan Hari ini:</strong>
      <div id="summary" style="margin-top:8px">-</div>
    </div>
    <canvas id="chartEnergy" width="800" height="250" style="margin-top:12px"></canvas>
  </div>

<script>
/* CONFIG (already set) */
const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";
const MQTT_WS = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_USER = "vercel_client";
const MQTT_PASS = "VercelPass123!";
const MQTT_TOPIC = "politeknik/meter/data";

/* NAV */
const pageHome = document.getElementById("pageHome");
const pageRealtime = document.getElementById("pageRealtime");
const pageTarif = document.getElementById("pageTarif");
document.getElementById("btnHome").onclick = ()=>show('home');
document.getElementById("btnRealtime").onclick = ()=>show('realtime');
document.getElementById("btnTarif").onclick = ()=>show('tarif');
document.getElementById("goRealtime").onclick = ()=>show('realtime');
document.getElementById("goTarif").onclick = ()=>show('tarif');
function show(p){ pageHome.classList.add('hidden'); pageRealtime.classList.add('hidden'); pageTarif.classList.add('hidden'); if(p==='home') pageHome.classList.remove('hidden'); if(p==='realtime') pageRealtime.classList.remove('hidden'); if(p==='tarif') {pageTarif.classList.remove('hidden'); loadTarifAndSummary();} }

/* MQTT client */
const client = mqtt.connect(MQTT_WS, { username: MQTT_USER, password: MQTT_PASS, reconnectPeriod:2000 });
const connEl = document.getElementById('conn');
client.on('connect', ()=>{ connEl.textContent = '✅ MQTT Connected'; client.subscribe(MQTT_TOPIC); });
client.on('error', e=>{ connEl.textContent = '❌ MQTT Error'; console.error(e); });
client.on('message', (topic, msg)=> {
  try {
    const d = JSON.parse(msg.toString());
    document.getElementById('st').innerText = d.status || '-';
    document.getElementById('kwh').innerText = (d.kwh===undefined?'-':d.kwh+' kWh');
    document.getElementById('eap').innerText = (d.eap===undefined?'-':d.eap+' kWh');
    document.getElementById('v').innerText = d.v || '-';
    document.getElementById('i1').innerText = d.i1 || '-';
    document.getElementById('i2').innerText = d.i2 || '-';
    document.getElementById('i3').innerText = d.i3 || '-';
    document.getElementById('p').innerText = d.p || '-';
    document.getElementById('q').innerText = d.q || '-';
    document.getElementById('pf').innerText = d.pf || '-';
    document.getElementById('hz').innerText = d.hz || '-';
    document.getElementById('oph').innerText = d.oph || '-';
  } catch(e) { console.error(e); }
});

/* Supabase helpers */
async function supaFetch(path) {
  const res = await fetch(SUPABASE_URL + path, { headers: { apikey: SUPABASE_KEY, Authorization: 'Bearer '+SUPABASE_KEY }});
  if (!res.ok) throw new Error('Supa fail');
  return res.json();
}
async function supaPatch(path, body) {
  const res = await fetch(SUPABASE_URL + path, {
    method:'PATCH', headers:{apikey:SUPABASE_KEY, Authorization:'Bearer '+SUPABASE_KEY,'Content-Type':'application/json', Prefer:'return=representation'},
    body: JSON.stringify(body)
  });
  if(!res.ok) throw new Error('Patch fail');
  return res.json();
}

/* Tariff functions */
document.getElementById('saveTarif').onclick = async ()=>{
  const v = parseFloat(document.getElementById('inputTarif').value);
  if(isNaN(v)){ alert('Masukkan tarif'); return; }
  try {
    await supaPatch('/rest/v1/tariff?id=eq.1', { price_per_kwh: v });
    document.getElementById('tarifMsg').innerText = 'Saved ✅';
    setTimeout(()=>document.getElementById('tarifMsg').innerText='',2000);
    loadTarifAndSummary();
  } catch(e){ console.error(e); alert('Gagal simpan tarif'); }
};

async function loadTarifAndSummary() {
  try {
    const t = await supaFetch('/rest/v1/tariff?id=eq.1');
    const price = (t && t[0]) ? t[0].price_per_kwh : null;
    if(price!==null) document.getElementById('inputTarif').value = price;
    // load today's history
    const today = new Date(); const start = new Date(today.getFullYear(),today.getMonth(),today.getDate()).toISOString();
    const rows = await supaFetch(`/rest/v1/energy_history?created_at=gte.${start}`);
    // sum eap
    let totalE = 0;
    rows.forEach(r=>{ totalE += (r.eap?parseFloat(r.eap):0); });
    const estCost = price ? Math.round(totalE * price) : '-';
    document.getElementById('summary').innerText = `Total energi hari ini: ${totalE.toFixed(3)} kWh • Est biaya: ${estCost==='-'?'-':'Rp '+estCost.toLocaleString('id-ID')}`;
    buildChart(rows);
  } catch(e){ console.error(e); document.getElementById('summary').innerText='Gagal load'; }
}

/* chart */
let chart=null;
function buildChart(rows){
  // aggregate per hour
  const byHour = Array(24).fill(0);
  rows.forEach(r=>{
    const d = new Date(r.created_at);
    const h = d.getHours();
    byHour[h] += (r.eap?parseFloat(r.eap):0);
  });
  const ctx = document.getElementById('chartEnergy').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx,{ type:'bar', data:{ labels: Array.from({length:24},(_,i)=>i+':00'), datasets:[{ label:'kWh per jam', data: byHour }] }, options:{plugins:{legend:{display:false}}} });
}

/* init */
show('home');
</script>
</body>
</html>

<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard Tarif & History — Mesin 1</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --bg:#071022; --card:#0b1624; --accent:#7ef0c7; --btn:#0ea5a0; color-scheme: dark; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#e6eef8}
    .wrap{max-width:1000px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    h1{margin:0;color:var(--accent);font-size:20px}
    .btn{background:var(--btn);color:#012;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
    .muted{color:#9aa6b2;font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;font-size:13px}
    thead th{color:var(--accent);font-weight:700}
    input[type=number]{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071022;color:#e6eef8}
    footer{margin-top:18px;color:#8ea3ad;font-size:13px;text-align:center}
    .small{font-size:13px;color:#aab7bf}
    .right{text-align:right}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>⚡ Dashboard Tarif & History — Mesin 1</h1>
      <div class="small">Supabase: <span id="supaUrl"></span></div>
    </header>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div class="small">Tarif saat ini (Rp / kWh)</div>
          <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
            <input id="inputTarif" type="number" step="0.01" style="width:160px" />
            <button id="saveTarif" class="btn">Simpan Tarif</button>
            <span id="tarifMsg" class="muted" style="margin-left:8px"></span>
          </div>
        </div>
        <div class="right">
          <div class="small">Ringkasan Hari Ini</div>
          <div id="summary" style="margin-top:6px;font-weight:600">Memuat...</div>
          <div class="muted" style="margin-top:4px;font-size:13px">Data diambil dari tabel <code>energy_history</code></div>
        </div>
      </div>
    </section>

    <div style="height:12px"></div>

    <div class="grid">
      <div class="card">
        <h3 style="margin:0 0 8px 0">Grafik Energi (hari ini)</h3>
        <canvas id="chartEnergy" width="700" height="280" style="background:#06121a;border-radius:8px"></canvas>
        <div style="margin-top:12px" class="muted">Grafik menunjukkan total kWh per jam (hari ini).</div>
      </div>

      <div class="card" style="overflow:auto;max-height:420px">
        <h3 style="margin:0 0 8px 0">History Terbaru</h3>
        <table id="tblHistory">
          <thead>
            <tr><th style="width:100px">Waktu</th><th class="right">kWh</th><th class="right">Power (W)</th><th class="right">Voltage (V)</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="muted">Memuat...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <footer>Project TA — PT Amarilys Karisma Gemilang</footer>
  </div>

<script>
/* =========================
   CONFIG — ganti hanya jika perlu
   ========================= */
const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";

/* helper fetch for Supabase REST */
async function supaFetch(path, options = {}) {
  const url = SUPABASE_URL + path;
  const headers = {
    apikey: SUPABASE_KEY,
    Authorization: 'Bearer ' + SUPABASE_KEY,
    'Content-Type': options.contentType || 'application/json',
    ...(options.headers||{})
  };
  const res = await fetch(url, {
    method: options.method || 'GET',
    headers,
    body: options.body ? JSON.stringify(options.body) : undefined
  });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error(`Supabase ${res.status} ${res.statusText} — ${txt}`);
  }
  // for PATCH which might return empty, try parse if possible
  const txt = await res.text();
  try { return txt ? JSON.parse(txt) : null; } catch(e) { return txt; }
}

/* UI elements */
document.getElementById('supaUrl').innerText = SUPABASE_URL.replace(/^https?:\/\//,'');

const inputTarif = document.getElementById('inputTarif');
const saveTarifBtn = document.getElementById('saveTarif');
const tarifMsg = document.getElementById('tarifMsg');
const summaryEl = document.getElementById('summary');
const tblBody = document.querySelector('#tblHistory tbody');

let chartInstance = null;

/* Load tariff on start */
async function loadTariff() {
  try {
    const data = await supaFetch('/rest/v1/tariff?id=eq.1');
    if (Array.isArray(data) && data[0]) {
      inputTarif.value = data[0].price_per_kwh;
    } else {
      // create default row if not exists
      await supaFetch('/rest/v1/tariff', { method:'POST', body:{ price_per_kwh: 1444.7 } });
      inputTarif.value = 1444.7;
    }
  } catch(err) {
    console.error('loadTariff', err);
    tarifMsg.innerText = 'Gagal load tariff';
  }
}

/* Save tariff */
saveTarifBtn.addEventListener('click', async ()=>{
  const v = parseFloat(inputTarif.value);
  if (isNaN(v)) return alert('Masukkan tarif (angka)');
  try {
    // try update row id=1; if fails, insert with id=1
    await supaFetch('/rest/v1/tariff?id=eq.1', { method: 'PATCH', body: { price_per_kwh: v } });
    tarifMsg.innerText = 'Saved ✅';
    setTimeout(()=> tarifMsg.innerText = '', 1800);
    await loadSummaryAndChart();
  } catch (err) {
    // try insert
    try {
      await supaFetch('/rest/v1/tariff', { method: 'POST', body: { price_per_kwh: v } });
      tarifMsg.innerText = 'Saved ✅';
      setTimeout(()=> tarifMsg.innerText = '', 1800);
      await loadSummaryAndChart();
    } catch(e) {
      console.error('saveTarif', e);
      alert('Gagal simpan tarif: ' + e.message);
    }
  }
});

/* Load today's history & build summary + chart */
async function loadSummaryAndChart() {
  try {
    // get tariff
    const t = await supaFetch('/rest/v1/tariff?id=eq.1');
    const price = (Array.isArray(t) && t[0]) ? parseFloat(t[0].price_per_kwh) : null;

    // start of today (midnight)
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();

    // fetch today's rows (use energy_kwh column)
    const rows = await supaFetch(`/rest/v1/energy_history?created_at=gte.${encodeURIComponent(start)}&order=created_at.asc&select=created_at,energy_kwh,kwh,power,watt,voltage`);
    // rows is array
    let totalE = 0;
    rows.forEach(r => {
      const e = parseFloat(r.energy_kwh ?? r.kwh ?? 0);
      if (!isNaN(e)) totalE += e;
    });
    const estCost = (price !== null) ? Math.round(totalE * price) : '-';
    summaryEl.innerText = `Total energi hari ini: ${totalE.toFixed(3)} kWh • Est. biaya: ${estCost === '-' ? '-' : 'Rp ' + estCost.toLocaleString('id-ID')}`;

    // fill history table (latest first)
    const latest = await supaFetch(`/rest/v1/energy_history?order=created_at.desc&limit=50&select=created_at,energy_kwh,kwh,power,watt,voltage`);
    tblBody.innerHTML = '';
    if (Array.isArray(latest) && latest.length) {
      latest.forEach(r => {
        const tr = document.createElement('tr');
        const ts = new Date(r.created_at).toLocaleString();
        const e = (r.energy_kwh ?? r.kwh ?? 0);
        const p = (r.power ?? r.watt ?? 0);
        const v = (r.voltage ?? '-');
        tr.innerHTML = `<td style="width:160px">${ts}</td><td class="right">${Number(e).toFixed(4)}</td><td class="right">${Number(p).toFixed(2)}</td><td class="right">${v}</td>`;
        tblBody.appendChild(tr);
      });
    } else {
      tblBody.innerHTML = `<tr><td colspan="4" class="muted">Belum ada data history.</td></tr>`;
    }

    // build hourly chart from rows
    buildChartFromRows(rows);
  } catch(err) {
    console.error('loadSummaryAndChart', err);
    summaryEl.innerText = 'Gagal load data. Cek Supabase & policy.';
    tblBody.innerHTML = `<tr><td colspan="4" class="muted">Gagal load data: ${err.message}</td></tr>`;
    if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  }
}

/* Build Chart */
function buildChartFromRows(rows) {
  const hourly = Array.from({length:24}, () => 0);
  rows.forEach(r => {
    const ts = r.created_at || r.createdAt;
    if (!ts) return;
    const d = new Date(ts);
    const h = d.getHours();
    hourly[h] += parseFloat(r.energy_kwh ?? r.kwh ?? 0);
  });

  const ctx = document.getElementById('chartEnergy').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Array.from({length:24}, (_,i) => `${i}:00`),
      datasets: [{ label: 'kWh per jam (hari ini)', data: hourly }]
    },
    options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

/* Init page */
(async function init(){
  try {
    await loadTariff();
    await loadSummaryAndChart();
  } catch(e) {
    console.warn('init', e);
  }
})();

/* Optional: refresh summary every 60s */
setInterval(loadSummaryAndChart, 60000);
</script>
</body>
</html>

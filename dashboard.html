<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard (Safe Mode)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* TEMA & CSS (SAMA) */
        :root { --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #333333; --text-sub: #546e7a; --text-value: #0d47a1; --border-card: #e0e0e0; --accent: #1a237e; --shadow: rgba(0, 0, 0, 0.07); --nav-bg: #ffffff; }
        [data-theme="dark"] { --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --text-sub: #b0bec5; --text-value: #64b5f6; --border-card: #333333; --accent: #82b1ff; --shadow: rgba(0, 0, 0, 0.5); --nav-bg: #2c2c2c; }
        body { font-family: sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 25px; padding-top: 70px; transition: 0.3s; }
        
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-button { background: #78909c; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; }
        .card { background: var(--bg-card); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .data-point { margin-bottom: 15px; }
        .value { font-size: 2em; font-weight: bold; color: var(--text-value); }
        .label { font-size: 0.9em; color: var(--text-sub); }
        .unit { font-size: 1em; color: var(--text-main); opacity: 0.7; }
        .phase-box { display: flex; justify-content: space-between; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; }
        .machine-select { padding: 10px; font-weight: bold; }
        
        /* MENU GRID STYLE */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; margin-top: 20px; }
        .menu-card { background: var(--bg-card); padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; border-top: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-card.online { border-top-color: #2e7d32; }
        
        .view-section { display: none; } .view-section.active { display: block; }
        
        /* UPDATE TIME BADGE */
        .last-update { font-size: 0.8em; color: #e65100; font-weight: bold; margin-top: 5px; display: block; }
    </style>
</head>
<body>

    <div id="view-grid" class="view-section active">
        <div style="max-width:1200px; margin:0 auto;">
            <a href="menu.html" class="back-button">&#8592; Menu</a>
            <h1 style="text-align:center; color:var(--accent);">Pilih Mesin (Live)</h1>
            <div class="menu-grid" id="machine-grid"></div>
        </div>
    </div>

    <div id="view-detail" class="view-section">
        <div class="header-container">
            <button onclick="showGrid()" class="back-button">&#8592; Kembali</button>
            <div style="text-align: right;">
                <h1 id="page-title" style="margin:0;">Mesin 1</h1>
                <span id="update-badge" class="last-update">Menunggu Data...</span>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>Energi</h3>
                <div class="data-point"><span class="label">Total Active</span><div><span class="value" id="val-e">-</span> kWh</div></div>
                <div class="data-point"><span class="label">Total Reactive</span><div><span class="value" id="val-q_tot">-</span> kVARh</div></div>
            </div>
            <div class="card">
                <h3>Listrik</h3>
                <div class="data-point"><span class="label">Voltage (Avg)</span><div><span class="value" id="val-v">-</span> V</div></div>
                <div class="phase-box">
                    <div><small>R</small><br><b id="val-i1">-</b> A</div>
                    <div><small>S</small><br><b id="val-i2">-</b> A</div>
                    <div><small>T</small><br><b id="val-i3">-</b> A</div>
                </div>
                <div class="data-point" style="margin-top:10px;"><span class="label">Avg Current</span><div><span class="value" id="val-i">-</span> A</div></div>
            </div>
            <div class="card">
                <h3>Daya</h3>
                <div class="data-point"><span class="label">Active (P)</span><div><span class="value" id="val-p">-</span> W</div></div>
                <div class="data-point"><span class="label">PF / Freq</span><div><b id="val-pf">-</b> / <b id="val-hz">-</b> Hz</div></div>
            </div>
             <div class="card">
                <h3>Info</h3>
                <div class="data-point"><span class="label">Op Time</span><div><span class="value" id="val-op">-</span> Jam</div></div>
            </div>
        </div>
    </div>

<script>
// --- CONFIG SUPABASE (GANTI DENGAN PUNYA ANDA) ---
const SUPABASE_URL = "https://khevzqqtswbdatbkkmme.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoZXZ6cXF0c3diZGF0YmtrbW1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MTY4MDgsImV4cCI6MjA3OTA5MjgwOH0.N28mnbk8tTAJkm47DS2pzvsHHChlyCovT6vi2Z4aqHc";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const MQTT_HOST = "701d32236feb43b38c22855a611f4d42.s1.eu.hivemq.cloud";
const MQTT_PORT = 8884;
const MQTT_USER = "web_dashboard";
const MQTT_PASS = "Tristan12";
const MQTT_TOPIC = "politeknik/meter/data";

let activeId = 1;
let client;
let cache = {};
let lastUpd = {};

const fmt = (n, d) => (n != null && !isNaN(n)) ? Number(n).toFixed(d) : "-";

// --- NAVIGATION ---
function showGrid() {
    document.getElementById('view-detail').classList.remove('active');
    document.getElementById('view-grid').classList.add('active');
}
function openDetail(id) {
    activeId = id;
    document.getElementById('page-title').innerText = "Mesin " + id;
    document.getElementById('view-grid').classList.remove('active');
    document.getElementById('view-detail').classList.add('active');
    updateUI();
}

// --- UPDATE UI ---
function updateUI() {
    const d = cache[activeId];
    if (!d) return;

    // Update Waktu Terakhir
    const now = Date.now();
    const diffSec = Math.floor((now - lastUpd[activeId]) / 1000);
    document.getElementById('update-badge').innerText = `Update: ${diffSec} detik lalu`;

    // Update Nilai (Tanpa Reset ke 0)
    document.getElementById('val-e').innerText = fmt(d.e, 2);
    document.getElementById('val-q_tot').innerText = fmt(d.q_tot, 2);
    document.getElementById('val-v').innerText = fmt(d.v, 1);
    
    // Handle I1, I2, I3 (Jika ada)
    document.getElementById('val-i1').innerText = fmt(d.i1, 1);
    document.getElementById('val-i2').innerText = fmt(d.i2, 1);
    document.getElementById('val-i3').innerText = fmt(d.i3, 1);
    document.getElementById('val-i').innerText = fmt(d.i, 2);

    document.getElementById('val-p').innerText = fmt(d.p, 0);
    document.getElementById('val-pf').innerText = fmt(d.pf, 2);
    document.getElementById('val-hz').innerText = fmt(d.hz, 1);
    
    // Op Time (Cek apakah detik atau jam)
    // Kalau angkanya besar (>10000) kemungkinan detik, bagi 3600
    let op = parseFloat(d.op_time);
    if (op > 10000) op = op / 3600; 
    document.getElementById('val-op').innerText = fmt(op, 1);
}

// --- MQTT ---
function startMQTT() {
    client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "web_safe_" + Date.now());
    
    client.onConnectionLost = (r) => { 
        if (r.errorCode !== 0) setTimeout(startMQTT, 5000); 
    };

    client.onMessageArrived = (m) => {
        try {
            const d = JSON.parse(m.payloadString);
            
            // TOLERANSI ID: Bisa 'id' atau 'id_mesin'
            let id = d.id || d.id_mesin;
            if (!id) return;

            cache[id] = d;
            lastUpd[id] = Date.now();

            // Update Grid Badge (Jadi Hijau)
            const card = document.getElementById(`card-${id}`);
            if (card) {
                card.style.borderTopColor = "#2e7d32"; // Hijau
                card.querySelector('.badge').innerText = "ONLINE";
                card.querySelector('.badge').style.color = "#2e7d32";
            }

            // Jika sedang buka detail mesin ini, update angkanya
            if (activeId == id && document.getElementById('view-detail').classList.contains('active')) {
                updateUI();
            }
        } catch (e) { console.error(e); }
    };

    client.connect({
        useSSL: true, userName: MQTT_USER, password: MQTT_PASS,
        onSuccess: () => { client.subscribe(MQTT_TOPIC); }
    });
}

// --- TIMER UPDATE STATUS (Bukan Reset Data) ---
setInterval(() => {
    const now = Date.now();
    for(let i=1; i<=18; i++) {
        // Jika data > 60 detik, anggap offline di Grid, TAPI JANGAN HAPUS DATA DETAIL
        if(lastUpd[i] && (now - lastUpd[i] > 60000)) {
            const card = document.getElementById(`card-${i}`);
            if (card) {
                card.style.borderTopColor = "#ccc";
                card.querySelector('.badge').innerText = "OFFLINE (" + Math.floor((now - lastUpd[i])/60000) + "m)";
                card.querySelector('.badge').style.color = "gray";
            }
        }
    }
    // Update tulisan "X detik lalu" di detail
    if(document.getElementById('view-detail').classList.contains('active')) {
         const d = lastUpd[activeId];
         if(d) {
             const diff = Math.floor((now - d) / 1000);
             document.getElementById('update-badge').innerText = `Update: ${diff} detik lalu`;
         }
    }
}, 1000);

window.onload = () => {
    const grid = document.getElementById('machine-grid');
    for(let i=1; i<=18; i++) {
        grid.innerHTML += `
        <div class="menu-card" id="card-${i}" onclick="openDetail(${i})">
            <div style="font-weight:bold; font-size:1.2em; margin-bottom:5px;">Mesin ${i}</div>
            <div class="badge" style="color:gray; font-size:0.8em;">WAITING...</div>
        </div>`;
    }
    startMQTT();
};
</script>
</body>
</html>

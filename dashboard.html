<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitoring Energi â€” PT Amarilys (Mesin 1)</title>

  <!-- MQTT.js & Chart.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --bg:#071022; --card:#0b1624; --accent:#7ef0c7; --btn:#0ea5a0; color-scheme: dark; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#e6eef8}
    .wrap{max-width:1100px;margin:20px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    h1{margin:0;color:var(--accent);font-size:20px}
    .btn{background:var(--btn);color:#012;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .nav {display:flex;gap:8px}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:center}
    thead th{color:var(--accent);font-weight:700}
    .hidden{display:none}
    .form-inline{display:flex;gap:8px;align-items:center;margin-top:8px}
    input[type=number]{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071022;color:#e6eef8}
    #conn{font-size:13px;margin-top:6px}
    .muted{color:#9aa6b2;font-size:13px}
    footer{margin-top:18px;color:#8ea3ad;font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>âš¡ Monitoring Energi â€” PT Amarilys (Mesin 1)</h1>
      <div class="nav">
        <button id="btnHome" class="btn">Home</button>
        <button id="btnRealtime" class="btn">Realtime</button>
        <button id="btnTarif" class="btn">Tarif</button>
      </div>
    </header>

    <!-- HOME -->
    <section id="pageHome" class="card">
      <h2 style="margin:0 0 8px 0">Home</h2>
      <p class="muted">Pilih menu: Monitoring Real-time untuk melihat data langsung dari ESP32 (MQTT). Monitoring Tarif untuk lihat dan ubah tarif kWh yang tersimpan di Supabase.</p>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="goRealtime" class="btn">Monitoring Real-Time</button>
        <button id="goTarif" class="btn">Monitoring Tarif Mesin</button>
      </div>
    </section>

    <!-- REALTIME -->
    <section id="pageRealtime" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 style="margin:0">Realtime â€” Mesin 1</h2>
        <div id="conn">Connecting to MQTT...</div>
      </div>

      <table aria-label="Realtime table">
        <thead>
          <tr>
            <th>Mesin</th><th>Status</th><th>kWh</th><th>EAP</th><th>Volt</th><th>I1</th><th>I2</th><th>I3</th><th>P (W)</th><th>Q</th><th>PF</th><th>Hz</th><th>OpH</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td id="st">-</td>
            <td id="kwh">-</td>
            <td id="eap">-</td>
            <td id="v">-</td>
            <td id="i1">-</td>
            <td id="i2">-</td>
            <td id="i3">-</td>
            <td id="p">-</td>
            <td id="q">-</td>
            <td id="pf">-</td>
            <td id="hz">-</td>
            <td id="oph">-</td>
          </tr>
        </tbody>
      </table>
      <p class="muted" style="margin-top:10px">*Jika tidak muncul data: cek ESP (WiFi & MQTT), cek topik <code>politeknik/meter/data</code> di MQTTX.</p>
    </section>

    <!-- TARIF -->
    <section id="pageTarif" class="card hidden">
      <h2 style="margin:0 0 8px 0">Tarif Mesin</h2>

      <div class="form-inline">
        <label for="inputTarif" style="min-width:120px">Tarif (Rp/kWh)</label>
        <input id="inputTarif" type="number" step="0.01" placeholder="e.g. 1444.70" />
        <button id="saveTarif" class="btn">Simpan</button>
        <span id="tarifMsg" class="muted"></span>
      </div>

      <div style="margin-top:14px">
        <strong>Ringkasan Hari Ini</strong>
        <div id="summary" style="margin-top:8px" class="muted">Memuat...</div>
      </div>

      <canvas id="chartEnergy" width="900" height="300" style="margin-top:14px;background:#06121a;border-radius:8px"></canvas>
    </section>

    <footer>Project TA â€” PT Amarilys Karisma Gemilang â€¢ Tes: 1 mesin</footer>
  </div>

<script>
/* =========================
   CONFIG â€” sesuaikan jika perlu
   ========================= */
const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";

const MQTT_WS = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_USER = "vercel_client";
const MQTT_PASS = "VercelPass123!";
const MQTT_TOPIC = "politeknik/meter/data";

/* =========================
   UI Navigation
   ========================= */
const pageHome = document.getElementById('pageHome');
const pageRealtime = document.getElementById('pageRealtime');
const pageTarif = document.getElementById('pageTarif');
document.getElementById('btnHome').onclick = ()=>show('home');
document.getElementById('btnRealtime').onclick = ()=>show('realtime');
document.getElementById('btnTarif').onclick = ()=>show('tarif');
document.getElementById('goRealtime').onclick = ()=>show('realtime');
document.getElementById('goTarif').onclick = ()=>show('tarif');

function show(p){
  pageHome.classList.add('hidden');
  pageRealtime.classList.add('hidden');
  pageTarif.classList.add('hidden');
  if(p==='home') pageHome.classList.remove('hidden');
  if(p==='realtime') pageRealtime.classList.remove('hidden');
  if(p==='tarif'){ pageTarif.classList.remove('hidden'); loadTarifAndSummary(); }
}

/* =========================
   MQTT (Realtime)
   ========================= */
const clientId = 'web-' + Math.random().toString(16).slice(2,10);
const client = mqtt.connect(MQTT_WS, { username: MQTT_USER, password: MQTT_PASS, clientId, reconnectPeriod: 2000 });
const connEl = document.getElementById('conn') || (()=>{ const el=document.createElement('div'); el.id='conn'; document.querySelector('header')?.appendChild(el); return el; })();

client.on('connect', () => {
  connEl.textContent = 'âœ… MQTT Connected';
  client.subscribe(MQTT_TOPIC, err => { if(err) connEl.textContent = 'âŒ Subscribe failed'; });
});
client.on('reconnect', ()=> connEl.textContent = 'ðŸ” Reconnecting...');
client.on('error', e => { connEl.textContent = 'âŒ MQTT Error'; console.error('MQTT error', e); });
client.on('message', (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    // support both old keys and new keys
    document.getElementById('st').innerText = d.status || d.state || '-';
    document.getElementById('kwh').innerText = (d.kwh ?? d.energy_kwh ?? d.EaT ?? '-') + (d.kwh||d.energy_kwh||d.EaT ? ' kWh' : '');
    document.getElementById('eap').innerText = (d.eap ?? d.EaP ?? '-') + ((d.eap||d.EaP) ? ' kWh' : '');
    document.getElementById('v').innerText = d.v ?? d.voltage ?? d.V ?? '-';
    document.getElementById('i1').innerText = d.i1 ?? d.I1 ?? '-';
    document.getElementById('i2').innerText = d.i2 ?? d.I2 ?? '-';
    document.getElementById('i3').innerText = d.i3 ?? d.I3 ?? '-';
    document.getElementById('p').innerText = d.p ?? d.P ?? '-';
    document.getElementById('q').innerText = d.q ?? d.Q ?? '-';
    document.getElementById('pf').innerText = d.pf ?? d.PF ?? '-';
    document.getElementById('hz').innerText = d.hz ?? d.Hz ?? '-';
    document.getElementById('oph').innerText = d.oph ?? d.OpH ?? '-';
  } catch(err) {
    console.warn('Bad MQTT msg', err);
  }
});

/* =========================
   Supabase helpers (REST)
   ========================= */
async function supaFetch(path, opts={}) {
  const res = await fetch(SUPABASE_URL + path, {
    method: opts.method || 'GET',
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: 'Bearer ' + SUPABASE_KEY,
      'Content-Type': opts.contentType || 'application/json',
      ...opts.headers
    },
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });
  if (!res.ok) {
    const t = await res.text();
    throw new Error('Supabase error: ' + res.status + ' - ' + t);
  }
  return res.json();
}

/* =========================
   Tarif & Summary
   ========================= */
document.getElementById('saveTarif').addEventListener('click', async ()=>{
  const v = parseFloat(document.getElementById('inputTarif').value);
  if (isNaN(v)) return alert('Masukkan tarif (angka)');
  try {
    await supaFetch('/rest/v1/tariff?id=eq.1', { method:'PATCH', body: { price_per_kwh: v }, contentType:'application/json' });
    document.getElementById('tarifMsg').innerText = 'Saved âœ…';
    setTimeout(()=>document.getElementById('tarifMsg').innerText='', 2000);
    loadTarifAndSummary();
  } catch (e) {
    console.error(e);
    alert('Gagal update tariff: ' + e.message);
  }
});

async function loadTarifAndSummary() {
  try {
    // get tariff
    const t = await supaFetch('/rest/v1/tariff?id=eq.1');
    const price = (Array.isArray(t) && t[0]) ? t[0].price_per_kwh : null;
    if (price !== null) document.getElementById('inputTarif').value = price;

    // load today's history (created_at >= today midnight)
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
    const rows = await supaFetch(`/rest/v1/energy_history?created_at=gte.${encodeURIComponent(start)}&order=created_at.asc`);
    // sum energy_kwh or fallback to kwh field
    let totalE = 0;
    rows.forEach(r => { totalE += parseFloat(r.energy_kwh ?? r.kwh ?? r.EaT ?? 0); });

    const estCost = price ? Math.round(totalE * price) : '-';
    document.getElementById('summary').innerText = `Total energi hari ini: ${totalE.toFixed(3)} kWh â€¢ Est. biaya: ${estCost==='-'?'-':'Rp ' + estCost.toLocaleString('id-ID')}`;

    buildChart(rows);
  } catch (err) {
    console.error('loadTarifAndSummary', err);
    document.getElementById('summary').innerText = 'Gagal load data. Cek Supabase & policy.';
  }
}

/* =========================
   Chart (hourly kWh)
   ========================= */
let chartInstance = null;
function buildChart(rows) {
  // rows may contain multiple machine entries; group by hour
  const hourly = Array.from({length:24}, () => 0);
  rows.forEach(r => {
    const ts = r.created_at || r.createdAt || r.ts;
    if (!ts) return;
    const d = new Date(ts);
    const hr = d.getHours();
    hourly[hr] += parseFloat(r.energy_kwh ?? r.kwh ?? 0);
  });

  const ctx = document.getElementById('chartEnergy').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Array.from({length:24}, (_,i) => `${i}:00`),
      datasets: [{ label: 'kWh per jam', data: hourly }]
    },
    options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

/* =========================
   Init
   ========================= */
show('home');

// pre-load tariff if possible
(supaFetch('/rest/v1/tariff?id=eq.1').then(t => {
  if (Array.isArray(t) && t[0]) document.getElementById('inputTarif').value = t[0].price_per_kwh;
}).catch(()=>{}));

</script>
</body>
</html>

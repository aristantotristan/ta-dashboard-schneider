<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Realtime Parameter Mesin</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #111;
    color: white;
    padding: 20px;
}

h2 { color: #00FFC2; }

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
th, td {
    border: 1px solid #333;
    padding: 10px;
    text-align: center;
}
th {
    background: #1E1E1E;
    color: #00FFC2;
}
td { background: #151515; }

.back {
    margin-top: 20px;
    display: inline-block;
    background: #444;
    padding: 10px 18px;
    border-radius: 8px;
    text-decoration: none;
    color: white;
}
</style>
</head>
<body>

<h2 id="title">Realtime Parameter</h2>
<p id="status">Status: ---</p>

<table>
<thead>
<tr>
    <th>Parameter</th>
    <th>Nilai</th>
    <th>Satuan</th>
</tr>
</thead>

<tbody id="tbody">
<tr><td colspan="3">Menunggu data...</td></tr>
</tbody>
</table>

<a class="back" href="realtime.html">⬅ Kembali ke Daftar Mesin</a>

<script>
// --- Ambil ID mesin dari URL ---
const urlParams = new URLSearchParams(window.location.search);
const mesinID = urlParams.get("id");

document.getElementById("title").textContent = "Realtime Parameter – Mesin " + mesinID;

// --- MQTT CONFIG ---
const client = mqtt.connect("wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt", {
    username: "web_dashboard",
    password: "Tristan12",
    connectTimeout: 4000,
    reconnectPeriod: 2000,
});

client.on("connect", () => {
    document.getElementById("status").textContent = "Status: MQTT Connected";
    client.subscribe("politeknik/meter/data");
});

client.on("error", () => {
    document.getElementById("status").textContent = "Status: MQTT Error";
});

const tbody = document.getElementById("tbody");

// Mapping parameter
const params = [
    ["Total Ea", "EaT", "kWh"],
    ["Total Er", "ErT", "kVARh"],
    ["Partial Ea", "EaP", "kWh"],
    ["Partial Er", "ErP", "kVARh"],
    ["Voltage (L-L Avg)", "V", "Volt"],
    ["Current I1", "I1", "A"],
    ["Current I2", "I2", "A"],
    ["Current I3", "I3", "A"],
    ["Power P (Active)", "P", "Watt"],
    ["Power Q (Reactive)", "Q", "VAR"],
    ["Power S (Apparent)", "S", "kVA"],
    ["Power Factor", "PF", "-"],
    ["Frekuensi", "Hz", "Hz"],
    ["Operating Time", "OpH", "Jam"],
];

// Buat tabel tetap (standby)
tbody.innerHTML = "";
params.forEach(p => {
    tbody.innerHTML += `
        <tr id="row_${p[1]}">
            <td>${p[0]}</td>
            <td>---</td>
            <td>${p[2]}</td>
        </tr>
    `;
});

// Update realtime dari MQTT
client.on("message", (topic, msg) => {
    const d = JSON.parse(msg.toString());

    // Filter sesuai ID mesin
    if (d.id != mesinID) return;

    params.forEach(p => {
        const key = p[1];
        const row = document.getElementById("row_" + key);
        row.cells[1].textContent = d[key] ?? "---";
    });
});
</script>

</body>
</html>

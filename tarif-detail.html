<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Tarif Mesin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --bg-body: #f0f2f5; --bg-card: #ffffff; --text-main: #333333; --text-sub: #546e7a; --text-val: #0d47a1; --border: #e0e0e0; --accent: #1a237e; --shadow: rgba(0, 0, 0, 0.07); --btn-bg: #ffffff; }
        [data-theme="dark"] { --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --text-sub: #b0bec5; --text-val: #64b5f6; --border: #333333; --accent: #82b1ff; --shadow: rgba(0, 0, 0, 0.5); --btn-bg: #2c2c2c; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 25px; padding-top: 70px; transition: 0.3s; }
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .back-button { background: #78909c; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; }
        h1 { margin: 0; font-size: 2em; color: var(--accent); }
        h2 { margin: 5px 0 0 0; font-size: 1em; font-weight: 400; color: var(--text-sub); }
        .theme-switch { position: fixed; top: 15px; right: 20px; z-index: 1000; background: var(--bg-card); border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2em; box-shadow: 0 4px 10px var(--shadow); color: var(--text-main); border: 1px solid var(--text-sub); }
        .controls-card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); margin-bottom: 25px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        input[type="date"] { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); }
        .btn-action { padding: 10px 20px; border-radius: 8px; border: none; background: var(--accent); color: white; font-weight: 600; cursor: pointer; }
        .btn-filter { padding: 8px 15px; border-radius: 6px; border: 1px solid var(--border); background: var(--btn-bg); color: var(--text-main); cursor: pointer; }
        .chart-container { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); margin-bottom: 25px; height: 350px; position: relative; }
        .table-container { background: var(--bg-card); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 20px; background-color: var(--bg-body); color: var(--text-sub); border-bottom: 2px solid var(--border); }
        td { padding: 15px 20px; border-bottom: 1px solid var(--border); color: var(--text-main); }
        .val-money { font-weight: 700; color: #43a047; text-align: right; }
        .val-num { text-align: right; font-family: 'Consolas', monospace; }
        tfoot td { font-weight: bold; background-color: var(--bg-body); border-top: 2px solid var(--border); }
        @media (max-width: 768px) { .controls-card { flex-direction: column; align-items: stretch; } .btn-filter { width: 100%; margin-bottom: 5px; } }
    </style>
</head>
<body>

    <button class="theme-switch" onclick="toggleTheme()"><span id="theme-icon">ðŸŒ™</span></button>

    <div class="header-container">
        <a href="tarif.html" class="back-button">&#8592; Pilih Mesin</a>
        <div style="text-align: right;">
            <h1 id="page-title">Detail Tarif Mesin 1</h1>
            <h2 id="current-price-display">Memuat Tarif...</h2>
        </div>
    </div>

    <div class="controls-card">
        <div style="flex-grow: 1; display: flex; gap: 10px; flex-wrap: wrap;">
            <div><span style="display:block; font-size:0.8em; color:var(--text-sub); margin-bottom:5px;">Dari:</span><input type="date" id="date-start"></div>
            <div><span style="display:block; font-size:0.8em; color:var(--text-sub); margin-bottom:5px;">Sampai:</span><input type="date" id="date-end"></div>
            <div style="display:flex; align-items:flex-end;"><button class="btn-action" onclick="fetchData()">Tampilkan</button></div>
        </div>
        <div style="display:flex; gap:5px; align-items:flex-end; flex-wrap: wrap;">
            <button class="btn-filter" onclick="setRange('daily')">Hari Ini</button>
            <button class="btn-filter" onclick="setRange('weekly')">7 Hari</button>
            <button class="btn-filter" onclick="setRange('monthly')">30 Hari</button>
        </div>
    </div>

    <div class="chart-container"><canvas id="costChart"></canvas></div>
    <div class="table-container"><table id="dataTable"><thead><tr><th>Tanggal</th><th style="text-align:right">Konsumsi (kWh)</th><th style="text-align:right">Durasi (Jam)</th><th style="text-align:right">Total Biaya</th></tr></thead><tbody></tbody><tfoot></tfoot></table></div>

<script>
    // --- KONFIGURASI SUPABASE (WAJIB DIISI) ---
    const SUPABASE_URL = "https://khevzqqtswbdatbkkmme.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoZXZ6cXF0c3diZGF0YmtrbW1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MTY4MDgsImV4cCI6MjA3OTA5MjgwOH0.N28mnbk8tTAJkm47DS2pzvsHHChlyCovT6vi2Z4aqHc";
    
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // MQTT
    const MQTT_HOST = "701d32236feb43b38c22855a611f4d42.s1.eu.hivemq.cloud";
    const MQTT_PORT = 8884;
    const MQTT_USER = "web_dashboard";
    const MQTT_PASS = "Tristan12";
    const TOPIC_TARIF = "politeknik/setting/tarif_v2";
    let mqttClient;

    let activeMachineId = 1;
    let myChart = null;
    let globalTarif = 1445.00;

    if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    window.onload = async function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('id')) activeMachineId = urlParams.get('id');
        document.getElementById('page-title').textContent = `Detail Tarif Mesin ${activeMachineId}`;
        
        await loadTarifFromDB(); // Ambil tarif dulu
        setRange('weekly'); // Baru hitung data
        connectMqtt();
    };

    async function loadTarifFromDB() {
        const { data } = await supabase.from('settings').select('*').eq('id', 1).single();
        if (data) {
            globalTarif = data.tarif_value;
            updateDisplayPrice();
        }
    }

    function updateDisplayPrice() {
        let formatted = parseFloat(globalTarif).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        document.getElementById('current-price-display').textContent = `Tarif Ref: Rp ${formatted} / kWh`;
    }

    function connectMqtt() {
        mqttClient = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "web_detail_" + Date.now());
        mqttClient.onMessageArrived = (m) => {
            const d = JSON.parse(m.payloadString);
            if(d.price) {
                globalTarif = parseFloat(d.price);
                updateDisplayPrice();
                fetchData(); // Hitung ulang otomatis
            }
        };
        mqttClient.connect({ useSSL: true, userName: MQTT_USER, password: MQTT_PASS, onSuccess: () => mqttClient.subscribe(TOPIC_TARIF) });
    }

    function setRange(type) {
        const end = new Date(); const start = new Date();
        if (type === 'daily') start.setDate(end.getDate());
        if (type === 'weekly') start.setDate(end.getDate() - 6);
        if (type === 'monthly') start.setDate(end.getDate() - 29);
        document.getElementById('date-start').valueAsDate = start;
        document.getElementById('date-end').valueAsDate = end;
        fetchData();
    }

    function fetchData() {
        const startDate = new Date(document.getElementById('date-start').value);
        const endDate = new Date(document.getElementById('date-end').value);
        const diffTime = Math.abs(endDate - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

        let labels = [], dataCost = [], grandTotalCost = 0, grandTotalKwh = 0;
        let tableRows = "";

        for(let i = 0; i < diffDays; i++) {
            let d = new Date(startDate); d.setDate(d.getDate() + i);
            const kwh = (Math.random() * (150 - 50) + 50).toFixed(2);
            const hours = (Math.random() * (24 - 8) + 8).toFixed(1);
            
            // HITUNG DENGAN TARIF DARI DB
            const cost = kwh * globalTarif; 
            
            const dateStr = d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
            labels.push(dateStr); dataCost.push(cost);
            grandTotalCost += cost; grandTotalKwh += parseFloat(kwh);

            let costFormatted = cost.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            tableRows = `<tr><td>${d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long' })}</td><td class="val-num">${kwh} kWh</td><td class="val-num">${hours} Jam</td><td class="val-money">Rp ${costFormatted}</td></tr>` + tableRows;
        }

        document.querySelector("#dataTable tbody").innerHTML = tableRows;
        let totalFormatted = grandTotalCost.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        document.querySelector("#dataTable tfoot").innerHTML = `<tr><td>TOTAL</td><td class="val-num">${grandTotalKwh.toFixed(2)} kWh</td><td></td><td class="val-money">Rp ${totalFormatted}</td></tr>`;
        renderChart(labels, dataCost);
    }

    // Chart Logic (Sama)
    function toggleTheme() { /* ... (Sama seperti di atas) ... */ }
    function renderChart(labels, data) {
        const ctx = document.getElementById('costChart').getContext('2d');
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Biaya (Rp)', data: data, backgroundColor: isDark ? 'rgba(100, 255, 218, 0.5)' : 'rgba(26, 35, 126, 0.6)', borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: {display:false}, ticks:{color: isDark?'#ccc':'#333'} }, y: { beginAtZero: true, ticks:{color: isDark?'#ccc':'#333'} } }, plugins: { legend: { labels: {color: isDark?'#ccc':'#333'} } } }
        });
    }
    function updateChartColor() { if(myChart) fetchData(); }
</script>
</body>
</html>

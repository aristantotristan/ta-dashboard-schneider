<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Tarif Mesin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; padding: 25px; }
        .back-button { display: inline-block; position: absolute; top: 25px; left: 25px; background: #78909c; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: 600; }
        .back-button:hover { background: #546e7a; }
        h2 { text-align: center; color: #0d47a1; font-size: 1.8em; margin-top: 50px; margin-bottom: 30px; }
        .data-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; max-width: 1200px; margin: 0 auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 12px 20px; border-bottom: 2px solid #ccc; background-color: #f9f9f9; }
        .data-table td { padding: 12px 20px; border-bottom: 1px solid #eee; }
        .data-table tfoot td { font-weight: bold; background: #fafafa; border-top: 2px solid #ccc; padding-top: 10px; }
        .data-table .val { text-align: right; font-weight: 600; color: #263238; }
        .tarif-controls { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 1200px; margin: 20px auto; }
        .tarif-controls input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; }
        .tarif-controls button { padding: 9px 15px; background: #0d47a1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500; margin-left: 10px; }
        #tarif-loading { text-align: center; font-weight: 600; color: #546e7a; padding: 20px; display: none; }
    </style>
</head>
<body>
    
    <a href="tarif.html" class="back-button">&#8592; Kembali (Pilih Mesin)</a>
    <h2 id="tarif-detail-title">Detail Tarif Mesin...</h2>
    
    <div class="tarif-controls">
        <label>Tampilkan data:</label>
        <input type="date" id="tarif-datepicker-start">
        <input type="date" id="tarif-datepicker-end">
        <button onclick="fetchTarifData()">Tampilkan</button>
        <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">
        <button onclick="setTarifRange('daily')">Hari Ini</button>
        <button onclick="setTarifRange('weekly')">Minggu Ini</button>
        <button onclick="setTarifRange('monthly')">Bulan Ini</button>
    </div>
    
    <div id="tarif-loading">Memuat data...</div>
    <div class="data-card">
        <table class="data-table" id="tarif-data-table">
            </table>
    </div>

<script>
    // --- Variabel Global & Helper ---
    let activeMachineId = 1; // Default
    const fmt = (val, dig) => (val != null && !isNaN(val)) ? Number(val).toFixed(dig) : "-";
    const fmt_rp = (val) => (val != null && !isNaN(val)) ? 'Rp ' + Number(val).toLocaleString('id-ID', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : "-";
    const rand = (min, max, dec = 0) => (Math.random() * (max - min) + min).toFixed(dec);

    /**
     * Saat halaman dimuat, ambil ID mesin dari URL
     */
    window.onload = function() {
        try {
            // Ambil parameter "id" dari URL
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (id && !isNaN(id)) {
                activeMachineId = parseInt(id);
            }
        } catch (e) {
            console.error("Gagal membaca ID dari URL", e);
        }
        
        // Update judul
        document.getElementById("tarif-detail-title").textContent = `Detail Tarif Mesin ${activeMachineId}`;
        
        // Set default ke 'Minggu Ini' dan langsung muat data
        setTarifRange('weekly');
        fetchTarifData();
    };

    /**
     * Atur rentang tanggal di kalender
     */
    window.setTarifRange = (range) => {
        const endDate = new Date();
        const startDate = new Date();
        
        if (range === 'daily') {
            // Hari ini saja
            startDate.setDate(startDate.getDate());
        } else if (range === 'weekly') {
            // 7 hari terakhir
            startDate.setDate(startDate.getDate() - 7);
        } else if (range === 'monthly') {
            // 30 hari terakhir
            startDate.setDate(startDate.getDate() - 30);
        }
        
        document.getElementById('tarif-datepicker-start').value = startDate.toISOString().split('T')[0];
        document.getElementById('tarif-datepicker-end').value = endDate.toISOString().split('T')[0];
    }

    /**
     * Buat Data Dummy dan Tampilkan di Tabel
     */
    window.fetchTarifData = async () => {
        const table = document.getElementById("tarif-data-table");
        const loadingDiv = document.getElementById("tarif-loading");
        
        table.innerHTML = ""; 
        loadingDiv.style.display = "block"; 
        
        const startDate = new Date(document.getElementById('tarif-datepicker-start').value);
        const endDate = new Date(document.getElementById('tarif-datepicker-end').value);

        // Hitung selisih hari
        const diffTime = Math.abs(endDate - startDate);
        let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays === 0) diffDays = 1; // Jika milih 1 hari

        // Jeda simulasi (biar terlihat loading)
        await new Promise(resolve => setTimeout(resolve, 500)); 

        try {
            // --- MULAI BAGIAN DATA DUMMY ---
            let data = [];
            for (let i = 0; i < diffDays; i++) {
                let d = new Date(startDate);
                d.setDate(d.getDate() + i);
                data.push({
                    tanggal: d.toISOString().split('T')[0],
                    total_biaya_rp: rand(75000, 200000, 0),
                    total_kwh_harian: rand(50, 120, 2),
                    total_jam_digunakan: rand(5, 15, 1),
                    total_jam_standby: rand(2, 6, 1)
                });
            }
            data.reverse(); // Urutkan dari terbaru
            // --- AKHIR BAGIAN DATA DUMMY ---
            
            let html = `
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th class="val">Biaya (Rp)</th>
                        <th class="val">Konsumsi (kWh)</th>
                        <th class="val">Jam Digunakan</th>
                        <th class="val">Jam Standby</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            let totalBiaya = 0, totalKwh = 0, totalJamGuna = 0, totalJamStandby = 0;

            if (data.length === 0) {
                html += '<tr><td colspan="5" style="text-align:center; padding: 20px;">Tidak ada data riwayat untuk rentang tanggal ini.</td></tr>';
            } else {
                data.forEach(row => {
                    html += `
                        <tr>
                            <td>${new Date(row.tanggal + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })}</td>
                            <td class="val">${fmt_rp(row.total_biaya_rp)}</td>
                            <td class="val">${fmt(row.total_kwh_harian, 2)}</td>
                            <td class="val">${fmt(row.total_jam_digunakan, 1)} jam</td>
                            <td class="val">${fmt(row.total_jam_standby, 1)} jam</td>
                        </tr>
                    `;
                    totalBiaya += parseFloat(row.total_biaya_rp);
                    totalKwh += parseFloat(row.total_kwh_harian);
                    totalJamGuna += parseFloat(row.total_jam_digunakan);
                    totalJamStandby += parseFloat(row.total_jam_standby);
                });
            }
            
            html += `
                </tbody>
                <tfoot>
                    <tr>
                        <td>TOTAL (Mesin ${activeMachineId})</td>
                        <td class="val">${fmt_rp(totalBiaya)}</td>
                        <td class="val">${fmt(totalKwh, 2)}</td>
                        <td class="val">${fmt(totalJamGuna, 1)} jam</td>
                        <td class="val">${fmt(totalJamStandby, 1)} jam</td>
                    </tr>
                </tfoot>
            `;
            
            table.innerHTML = html;
            
        } catch (error) {
            table.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px; color: red;">Error: ${error.message}</td></tr>`;
        } finally {
            loadingDiv.style.display = "none";
        }
    }
</script>

</body>
</html>

<script>
    // --- KONFIGURASI SUPABASE ---
    const SUPABASE_URL = "https://khevzqqtswbdatbkkmme.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoZXZ6cXF0c3diZGF0YmtrbW1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MTY4MDgsImV4cCI6MjA3OTA5MjgwOH0.N28mnbk8tTAJkm47DS2pzvsHHChlyCovT6vi2Z4aqHc";
    
    // PERBAIKAN DISINI: Ganti nama jadi 'supabaseClient'
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // MQTT
    const MQTT_HOST = "701d32236feb43b38c22855a611f4d42.s1.eu.hivemq.cloud";
    const MQTT_PORT = 8884;
    const MQTT_USER = "web_dashboard";
    const MQTT_PASS = "Tristan12";
    const TOPIC_TARIF = "politeknik/setting/tarif_v2";
    let mqttClient;

    let activeMachineId = 1;
    let myChart = null;
    let globalTarif = 1445.00;

    if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    window.onload = async function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('id')) activeMachineId = urlParams.get('id');
        document.getElementById('page-title').textContent = `Detail Tarif Mesin ${activeMachineId}`;
        
        await loadTarifFromDB(); // Ambil tarif dulu
        setRange('weekly'); // Baru hitung data
        connectMqtt();
    };

    async function loadTarifFromDB() {
        // Panggil pakai nama baru 'supabaseClient'
        const { data } = await supabaseClient.from('settings').select('*').eq('id', 1).single();
        if (data) {
            globalTarif = data.tarif_value;
            updateDisplayPrice();
        }
    }

    function updateDisplayPrice() {
        let formatted = parseFloat(globalTarif).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        document.getElementById('current-price-display').textContent = `Tarif Ref: Rp ${formatted} / kWh`;
    }

    function connectMqtt() {
        mqttClient = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "web_detail_" + Date.now());
        mqttClient.onMessageArrived = (m) => {
            const d = JSON.parse(m.payloadString);
            if(d.price) {
                globalTarif = parseFloat(d.price);
                updateDisplayPrice();
                fetchData(); // Hitung ulang otomatis
            }
        };
        mqttClient.connect({ useSSL: true, userName: MQTT_USER, password: MQTT_PASS, onSuccess: () => mqttClient.subscribe(TOPIC_TARIF) });
    }

    function setRange(type) {
        const end = new Date(); const start = new Date();
        if (type === 'daily') start.setDate(end.getDate());
        if (type === 'weekly') start.setDate(end.getDate() - 6);
        if (type === 'monthly') start.setDate(end.getDate() - 29);
        document.getElementById('date-start').valueAsDate = start;
        document.getElementById('date-end').valueAsDate = end;
        fetchData();
    }

    function fetchData() {
        const startDate = new Date(document.getElementById('date-start').value);
        const endDate = new Date(document.getElementById('date-end').value);
        const diffTime = Math.abs(endDate - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

        let labels = [], dataCost = [], grandTotalCost = 0, grandTotalKwh = 0;
        let tableRows = "";

        for(let i = 0; i < diffDays; i++) {
            let d = new Date(startDate); d.setDate(d.getDate() + i);
            const kwh = (Math.random() * (150 - 50) + 50).toFixed(2);
            const hours = (Math.random() * (24 - 8) + 8).toFixed(1);
            
            // HITUNG DENGAN TARIF DARI DB
            const cost = kwh * globalTarif; 
            
            const dateStr = d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
            labels.push(dateStr); dataCost.push(cost);
            grandTotalCost += cost; grandTotalKwh += parseFloat(kwh);

            let costFormatted = cost.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            tableRows = `<tr><td>${d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long' })}</td><td class="val-num">${kwh} kWh</td><td class="val-num">${hours} Jam</td><td class="val-money">Rp ${costFormatted}</td></tr>` + tableRows;
        }

        document.querySelector("#dataTable tbody").innerHTML = tableRows;
        let totalFormatted = grandTotalCost.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        document.querySelector("#dataTable tfoot").innerHTML = `<tr><td>TOTAL</td><td class="val-num">${grandTotalKwh.toFixed(2)} kWh</td><td></td><td class="val-money">Rp ${totalFormatted}</td></tr>`;
        renderChart(labels, dataCost);
    }

    function renderChart(labels, data) {
        const ctx = document.getElementById('costChart').getContext('2d');
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        const color = isDark ? '#64ffda' : '#1a237e';
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Biaya (Rp)', data: data, backgroundColor: isDark ? 'rgba(100, 255, 218, 0.5)' : 'rgba(26, 35, 126, 0.6)', borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: {display:false}, ticks:{color: isDark?'#ccc':'#333'} }, y: { beginAtZero: true, ticks:{color: isDark?'#ccc':'#333'} } }, plugins: { legend: { labels: {color: isDark?'#ccc':'#333'} } } }
        });
    }
    function updateChartColor() { if(myChart) fetchData(); }
</script>

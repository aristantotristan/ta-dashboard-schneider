<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoring Tarif Mesin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    h1 { text-align:center; margin-bottom:25px; }
    .back { display:inline-block; margin-bottom:20px; padding:10px 18px; background:#007bff; color:white; border-radius:8px; text-decoration:none; }
    .mesin-container { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:20px; }
    .card { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer; text-align:center; }
    .popup {
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center;
      z-index: 1000;
    }
    .popup-content {
      background:white;
      padding:25px;
      width:90%; max-width:700px;
      border-radius:10px;
    }
    .row { margin:10px 0; }
    .label { font-weight:bold; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    table, th, td { border:1px solid #ccc; }
    th, td { padding:8px; text-align:center; }
    .close { float:right; cursor:pointer; font-weight:bold; }
    .btn { padding:8px 15px; background:#007bff; color:white; border-radius:6px; text-decoration:none; cursor:pointer; border: none; }
    .flex { display:flex; justify-content:space-between; align-items:center; }
    .flex-center { display:flex; align-items:center; }
  </style>
</head>
<body>

<a href="index.html" class="back">⬅ Back to Home</a>
<h1>Monitoring Tarif Mesin</h1>

<div class="mesin-container" id="mesin-container">
  <script>
    // Membuat 18 kartu mesin (001 sampai 018)
    for(let i=1;i<=18;i++){
      const machineId = String(i).padStart(3, '0');
      document.write(`<div class='card' onclick='openPopup("${machineId}")'>Mesin ${machineId}</div>`);
    }
  </script>
</div>

<div id="popup" class="popup">
  <div class="popup-content">
    <span class="close" onclick="closePopup()">X</span>
    <h2 id="popup-title">Mesin 001</h2>

    <div class="flex" style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #ccc;">
        <div style="font-size:1.1em; font-weight:bold;">Tarif Aktif Saat Ini: <span id="currentTariffDisplay">Memuat...</span> Rp/kWh</div>
        <div style="font-size:14px; color:#444;">Terakhir diubah oleh: <span id="lastChangedBy">---</span></div>
    </div>

    <h3>Ubah Tarif</h3>
    <div class="flex-center" style="gap: 15px; padding:10px 0;">
      <div class="flex-center" style="gap:10px;">
        <label><input type="radio" name="tarif" value="LWBP" checked> LWBP</label>
        <label><input type="radio" name="tarif" value="WBP"> WBP</label>
      </div>

      <div class="flex-center" style="gap:10px;">
        <input type="number" id="newTariffValue" placeholder="Nilai Tarif (Rp/kWh)" style="padding: 8px; width: 150px;" step="0.01" required>
        <input type="date" id="effectiveStartDate" style="padding: 8px;" required>
        <button class="btn" onclick="handleChangeTariff()">Simpan Tarif Baru</button>
      </div>
    </div>


    <h3 style="margin-top:25px;">Log Energi Harian</h3>
    <div class="flex">
      <div class="row">
        <div class="label">Tanggal Awal</div>
        <input type="date" id="dateStart">
      </div>
      <div class="row">
        <div class="label">Tanggal Akhir</div>
        <input type="date" id="dateEnd">
      </div>
      <div class="row" style="align-self:flex-end;">
        <button class="btn" onclick="fetchDailyEnergy(currentMachineId)">Search</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Partial Ea (kWh)</th>
          <th>Tarif Berlaku (Rp)</th>
          <th>Biaya (Rp)</th>
        </tr>
      </thead>
      <tbody id="dataTableBody">
        <tr><td colspan="4">Pilih tanggal dan klik Search.</td></tr>
      </tbody>
    </table>

  </div>
</div>

<script>
// ===============================================
// ⚠️ 2. INISIALISASI SUPABASE (GANTI DENGAN KUNCI ANDA) ⚠️
// ===============================================
const SUPABASE_URL = 'https://rojhcadtqfynlqzubftx.supabase.co'; // Ganti URL Anda
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs'; // Ganti Kunci Anon Anda
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentMachineId = null; 

function createClient(url, key) {
    if (window.supabase) {
        return window.supabase.createClient(url, key);
    } else {
        console.error("Supabase script not loaded.");
        return null;
    }
}

function closePopup(){
  document.getElementById('popup').style.display = 'none';
}

function openPopup(machineId){
  currentMachineId = machineId;
  document.getElementById('popup-title').innerText = `Mesin ${machineId}`;
  document.getElementById('popup').style.display = 'flex';
  
  // Set default date range to last 7 days
  const today = new Date().toISOString().split('T')[0];
  const lastWeek = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  document.getElementById('dateStart').value = lastWeek;
  document.getElementById('dateEnd').value = today;
  document.getElementById('effectiveStartDate').value = today; // Default effective date

  // Muat data saat popup dibuka
  fetchCurrentTariff();
  fetchDailyEnergy(currentMachineId);
}

// ===============================================
// FUNGSI 1: MENGAMBIL TARIF AKTIF (Tabel: tariff_log)
// ===============================================
async function fetchCurrentTariff() {
    const today = new Date().toISOString().split('T')[0];
    
    const { data, error } = await supabase
        .from('tariff_log')
        .select('tariff_value, changed_by')
        .lte('effective_start_date', today) // <= hari ini
        .order('effective_start_date', { ascending: false }) // Ambil yang paling baru
        .limit(1);

    if (error) {
        console.error('Error fetching current tariff:', error);
        document.getElementById('currentTariffDisplay').innerText = 'ERROR';
        document.getElementById('lastChangedBy').innerText = 'System Error';
        return;
    }

    if (data && data.length > 0) {
        const tariff = data[0].tariff_value;
        const changedBy = data[0].changed_by || 'Unknown';
        document.getElementById('currentTariffDisplay').innerText = parseFloat(tariff).toLocaleString('id-ID', {minimumFractionDigits: 2});
        document.getElementById('lastChangedBy').innerText = changedBy;
    } else {
        document.getElementById('currentTariffDisplay').innerText = '0.00';
        document.getElementById('lastChangedBy').innerText = 'Belum ada tarif yang ditetapkan.';
    }
}


// ===============================================
// FUNGSI 2: MENGUBAH DAN MENYIMPAN TARIF BARU (Tabel: tariff_log)
// ===============================================
async function handleChangeTariff() {
    const tariffValue = document.getElementById('newTariffValue').value;
    const effectiveDate = document.getElementById('effectiveStartDate').value;
    const tariffType = document.querySelector('input[name="tarif"]:checked').value; 
    const changedBy = prompt("Masukkan nama/ID Anda untuk log perubahan:") || 'Anonymous'; // Audit trail

    if (!tariffValue || !effectiveDate) {
        alert("Nilai Tarif dan Tanggal Efektif wajib diisi.");
        return;
    }

    if (isNaN(parseFloat(tariffValue)) || parseFloat(tariffValue) <= 0) {
        alert("Nilai Tarif tidak valid.");
        return;
    }
    
    const { data, error } = await supabase
        .from('tariff_log')
        .insert([
            { 
                tariff_value: tariffValue, 
                changed_by: changedBy, 
                effective_start_date: effectiveDate,
                // tariff_type: tariffType // Uncomment jika Anda menambahkan kolom tariff_type
            }
        ]);

    if (error) {
        alert('❌ Gagal menyimpan tarif baru: ' + error.message);
        console.error(error);
    } else {
        alert(`✅ Tarif baru sebesar Rp ${tariffValue} (Efektif: ${effectiveDate}) berhasil disimpan.`);
        // Refresh display
        fetchCurrentTariff();
    }
}

// ===============================================
// FUNGSI 3: MENGAMBIL DATA ENERGI HARIAN (Tabel: daily_energy)
// ===============================================
async function fetchDailyEnergy(machineId) {
    const startDate = document.getElementById('dateStart').value;
    const endDate = document.getElementById('dateEnd').value;
    const tableBody = document.getElementById('dataTableBody');

    if (!startDate || !endDate) {
        tableBody.innerHTML = '<tr><td colspan="4">Mohon pilih Tanggal Awal dan Akhir.</td></tr>';
        return;
    }

    tableBody.innerHTML = '<tr><td colspan="4">Loading data...</td></tr>';
    
    // 1. Ambil Log Energi Harian (daily_energy)
    const { data: energyData, error: energyError } = await supabase
        .from('daily_energy')
        .select('date_only, partial_ea')
        .eq('machine_id', machineId)
        .gte('date_only', startDate)
        .lte('date_only', endDate)
        .order('date_only', { ascending: true });

    if (energyError) {
        console.error('Error fetching energy data:', energyError);
        tableBody.innerHTML = `<tr><td colspan="4">Error: ${energyError.message}</td></tr>`;
        return;
    }

    // 2. Ambil Tarif yang Berlaku di Rentang Tanggal
    const { data: tariffLog, error: tariffError } = await supabase
        .from('tariff_log')
        .select('tariff_value, effective_start_date')
        .order('effective_start_date', { ascending: true });
        
    if (tariffError) {
        console.error('Error fetching tariff log:', tariffError);
        tableBody.innerHTML = `<tr><td colspan="4">Error saat mengambil log tarif.</td></tr>`;
        return;
    }

    if (energyData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4">Tidak ada data yang ditemukan dalam rentang tanggal ini.</td></tr>';
        return;
    }

    let htmlContent = '';
    
    // Fungsi helper untuk mendapatkan tarif yang berlaku pada tanggal tertentu
    function getTariffForDate(date) {
        let activeTariff = 0;
        // Iterasi log tarif untuk mencari tarif yang paling baru dan efektif sebelum tanggal data energi
        for (const log of tariffLog) {
            if (new Date(log.effective_start_date) <= new Date(date)) {
                activeTariff = parseFloat(log.tariff_value);
            }
        }
        return activeTariff;
    }

    // 3. Gabungkan dan Tampilkan Data
    energyData.forEach(entry => {
        const date = entry.date_only;
        const energy = parseFloat(entry.partial_ea);
        const tariff = getTariffForDate(date);
        const cost = energy * tariff; // Kalkulasi Biaya

        htmlContent += `
            <tr>
                <td>${date}</td>
                <td>${energy.toLocaleString('id-ID', {minimumFractionDigits: 2})}</td>
                <td>${tariff.toLocaleString('id-ID', {minimumFractionDigits: 2})}</td>
                <td>Rp ${cost.toLocaleString('id-ID', {minimumFractionDigits: 0})}</td>
            </tr>
        `;
    });

    tableBody.innerHTML = htmlContent;
}

</script>

</body>
</html>

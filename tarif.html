<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ðŸ’° Monitoring Tarif (Supabase Historis)</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{--bg:#07121a;--panel:#0b1724;--muted:#94a3b8;--gold:#FFD700;--accent:#4ADE80}
body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto;background:linear-gradient(180deg,#02111a,#041428);color:#eaf2f8;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
.header h2{margin:0;color:var(--gold)}
.header .nav{display:flex;gap:8px;align-items:center}
.nav .btn{background:var(--accent);color:#02111a;padding:8px 12px;border-radius:8px;font-weight:700;border:none}
.status{font-weight:700;color:var(--muted)}
.topbox{background:#071a26;padding:14px;border-radius:10px;margin-bottom:18px;border:1px solid rgba(255,255,255,0.03)}
.rate-grid{display:flex;gap:12px}
.rate-card{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:8px}
.container{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}
.meter-card{background:#071427;border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03)}
.card-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.kv{color:var(--muted);font-size:0.9rem}
.value{font-weight:800;color:var(--accent)}
.small{font-size:0.85rem;color:var(--muted)}
.canvas-wrap{height:60px;margin-top:8px}
.total{background:#042031;padding:8px;border-radius:8px;margin-top:10px;text-align:center;font-weight:800;color:#fff}
@media(max-width:720px){ .rate-grid{flex-direction:column} }
</style>
</head>
<body>

<div class="header">
  <h2>ðŸ’° Monitoring Biaya & Tarif (Historis)</h2>
  <div class="nav">
    <a href="./realtime.html" class="btn">Lihat Realtime</a>
  </div>
</div>

<div class="topbox">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <div class="small">Konfigurasi Tarif Aktif</div>
      <div class="rate-grid" style="margin-top:8px">
        <div class="rate-card"><div class="kv">Tarif LWBP (Rp/kWh)</div><div id="rate_lwbp" class="value">-</div></div>
        <div class="rate-card"><div class="kv">Tarif WBP (Rp/kWh)</div><div id="rate_wbp" class="value">-</div></div>
        <div class="rate-card"><div class="kv">Denda Reaktif (Rp/kVARh)</div><div id="rate_reaktif" class="value">-</div></div>
      </div>
    </div>
    <div style="text-align:right">
      <div class="small">Updated:</div>
      <div id="lastUpdated" class="status">â€”</div>
    </div>
  </div>
  <div class="small" style="margin-top:8px;color:var(--muted)">
    * Estimasi biaya menggunakan tarif rata-rata (LWBP/WBP). Data historis diambil dari tabel <code>meter_data</code>.
  </div>
</div>

<div id="meterContainer" class="container"></div>

<script>
/* --------------- CONFIG --------------- */
/* from your ESP / earlier file */
const SUPABASE_URL = 'https://rojhcadtqfynlqzubftx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs';

const supabase = supabaseJs = supabase.createClient ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* Settings */
const START_ID = 1, END_ID = 18;
const POINTS_HISTORY = 12; // last X points to show in mini-chart

/* Util */
function rupiah(n) {
  if (n === null || n === undefined || isNaN(n)) return '-';
  return 'Rp ' + Number(n).toLocaleString('id-ID', { maximumFractionDigits: 0 });
}
function energyFmt(n) {
  if (n === null || n === undefined) return '---';
  return Number(n).toLocaleString('id-ID', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
}

/* DOM */
const container = document.getElementById('meterContainer');
const rate_lwbp_el = document.getElementById('rate_lwbp');
const rate_wbp_el = document.getElementById('rate_wbp');
const rate_reaktif_el = document.getElementById('rate_reaktif');
const lastUpdatedEl = document.getElementById('lastUpdated');

function createMeterCard(id) {
  const wrap = document.createElement('div');
  wrap.className = 'meter-card';
  wrap.id = 'card-' + id;
  wrap.innerHTML = `
    <div class="card-head">
      <div><div class="kv">Meter ID</div><div class="value">#${id}</div></div>
      <div style="text-align:right"><div class="kv small">Status</div><div id="status-${id}" class="small">â€”</div></div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <div style="flex:1;min-width:140px">
        <div class="kv">Ea Tot</div><div id="eat-${id}" class="value small">---</div>
        <div class="kv">Er Tot</div><div id="ert-${id}" class="value small">---</div>
      </div>

      <div style="flex:1;min-width:140px">
        <div class="kv">Ea Part</div><div id="eap-${id}" class="value small">---</div>
        <div class="kv">Er Part</div><div id="erp-${id}" class="value small">---</div>
      </div>

      <div style="flex:1;min-width:160px">
        <div class="kv">Biaya Energi (est.)</div><div id="costA-${id}" class="value small">Rp -</div>
        <div class="kv">Biaya Reaktif (est.)</div><div id="costR-${id}" class="value small">Rp -</div>
        <div class="total small" id="costT-${id}">TOTAL: Rp -</div>
      </div>
    </div>

    <div class="canvas-wrap"><canvas id="chart-${id}" style="width:100%;height:100%"></canvas></div>
  `;
  return wrap;
}

/* render 18 cards */
for (let id = START_ID; id <= END_ID; id++) {
  container.appendChild(createMeterCard(id));
}

/* Cost calculator */
let tarifConfig = { rate_lwbp: 1000, rate_wbp: 1500, rate_reaktif: 800 };
function calculateCost(eaTotal, erTotal) {
  const rate_lwbp = tarifConfig.rate_lwbp || 1000;
  const rate_wbp = tarifConfig.rate_wbp || 1500;
  const rate_reaktif = tarifConfig.rate_reaktif || 800;
  const rate_rata = (rate_lwbp + rate_wbp) / 2;
  const cost_aktif = Math.round(Number(eaTotal || 0) * rate_rata);
  const batas_reaktif = Number(eaTotal || 0) * 0.5;
  const kelebihan_reaktif = Math.max(0, Number(erTotal || 0) - batas_reaktif);
  const cost_reaktif = Math.round(kelebihan_reaktif * rate_reaktif);
  return { cost_aktif, cost_reaktif, total: cost_aktif + cost_reaktif };
}

/* Chart store */
const charts = {};

/* fetch tarifa & then data per meter */
async function loadTarifAndHistory() {
  try {
    // 1. fetch tarif config (first row)
    const { data: cfg, error: cfgErr } = await supabase
      .from('config_tarif')
      .select('*')
      .limit(1);

    if (cfgErr) {
      console.error('Tarif fetch error:', cfgErr);
    } else if (cfg && cfg.length) {
      tarifConfig = cfg[0];
      rate_lwbp_el.textContent = rupiah(tarifConfig.rate_lwbp);
      rate_wbp_el.textContent = rupiah(tarifConfig.rate_wbp);
      rate_reaktif_el.textContent = rupiah(tarifConfig.rate_reaktif);
    }

    // 2. for each meter, fetch last POINTS_HISTORY records
    const nowISO = new Date().toISOString();
    lastUpdatedEl.textContent = new Date().toLocaleString();
    for (let id = START_ID; id <= END_ID; id++) {
      // Query REST: select last POINTS_HISTORY for that id, order desc by timestamp
      const { data, error } = await supabase
        .from('meter_data')
        .select('id,eat,ert,eap,erp,timestamp')
        .eq('id', id)
        .order('timestamp', { ascending: false })
        .limit(POINTS_HISTORY);

      if (error) {
        console.error('fetch meter', id, error);
        document.getElementById(`status-${id}`).textContent = 'error';
        continue;
      }
      if (!data || data.length === 0) {
        document.getElementById(`status-${id}`).textContent = 'no data';
        continue;
      }

      // Prepare arrays (reverse chronological -> chart chronological)
      const rev = data.slice().reverse();
      const labels = rev.map(r => new Date(r.timestamp).toLocaleTimeString());
      const values = rev.map(r => Number(r.eap || r.eat || 0)); // choose eap or eat for trend

      // update latest snapshot (last element)
      const latest = data[0];
      document.getElementById(`eat-${id}`).textContent = energyFmt(latest.eat || latest.eat === 0 ? latest.eat : latest.eap);
      document.getElementById(`ert-${id}`).textContent = energyFmt(latest.ert || 0);
      document.getElementById(`eap-${id}`).textContent = energyFmt(latest.eap || 0);
      document.getElementById(`erp-${id}`).textContent = energyFmt(latest.erp || 0);
      document.getElementById(`status-${id}`).textContent = 'ok';

      // compute delta (last - prev) for cost estimation (if at least 2 points)
      let eaDelta = 0, erDelta = 0;
      if (data.length >= 2) {
        eaDelta = Number(data[0].eap || data[0].eat || 0) - Number(data[1].eap || data[1].eat || 0);
        erDelta = Number(data[0].erp || data[0].ert || 0) - Number(data[1].erp || data[1].ert || 0);
        if (isNaN(eaDelta)) eaDelta = 0;
        if (isNaN(erDelta)) erDelta = 0;
      }

      const costs = calculateCost(eaDelta, erDelta);
      document.getElementById(`costA-${id}`).textContent = rupiah(costs.cost_aktif);
      document.getElementById(`costR-${id}`).textContent = rupiah(costs.cost_reaktif);
      document.getElementById(`costT-${id}`).textContent = 'TOTAL: ' + rupiah(costs.total);

      // chart
      const ctx = document.getElementById(`chart-${id}`).getContext('2d');
      if (charts[id]) {
        charts[id].data.labels = labels;
        charts[id].data.datasets[0].data = values;
        charts[id].update();
      } else {
        charts[id] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'kWh',
              data: values,
              fill: true,
              tension: 0.3,
              borderWidth: 1,
              pointRadius: 0,
              backgroundColor: 'rgba(74,222,128,0.08)',
              borderColor: 'rgba(74,222,128,0.9)',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display:false }, tooltip: { mode:'index' } },
            scales: {
              x: { display:false },
              y: { display:false }
            }
          }
        });
      }
    }
  } catch (e) {
    console.error('load error', e);
  }
}

/* initial load */
loadTarifAndHistory();

/* auto refresh every 30s */
setInterval(loadTarifAndHistory, 30000);
</script>

</body>
</html>

<script>
    // --- 1. KONFIGURASI SUPABASE ---
    const SUPABASE_URL = "https://khevzqqtswbdatbkkmme.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoZXZ6cXF0c3diZGF0YmtrbW1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MTY4MDgsImV4cCI6MjA3OTA5MjgwOH0.N28mnbk8tTAJkm47DS2pzvsHHChlyCovT6vi2Z4aqHc"; 

    // PERBAIKAN DISINI: Ganti nama variabel jadi 'supabaseClient'
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // MQTT Config
    const MQTT_HOST = "701d32236feb43b38c22855a611f4d42.s1.eu.hivemq.cloud";
    const MQTT_PORT = 8884;
    const MQTT_USER = "web_dashboard";
    const MQTT_PASS = "Tristan12";
    const TOPIC_TARIF = "politeknik/setting/tarif_v2";
    let mqttClient;
    let globalTarif = 1445.00;
    let lastUpdater = "-";

    if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    window.onload = async function() {
        renderGrid(); // Render Grid Dulu
        await loadTarifFromDB(); // Baru ambil data
        connectMqtt();
    }

    async function loadTarifFromDB() {
        document.getElementById('db-status').textContent = "ðŸŸ ";
        // Panggil pakai nama baru 'supabaseClient'
        const { data, error } = await supabaseClient.from('settings').select('*').eq('id', 1).single();
        
        if (data) {
            globalTarif = data.tarif_value;
            lastUpdater = data.updated_by;
            updateDisplayUI(globalTarif, lastUpdater);
            document.getElementById('db-status').textContent = "ðŸŸ¢";
        } else if (error) {
            console.error("Error DB:", error);
            document.getElementById('db-status').textContent = "ðŸ”´";
        }
    }

    async function saveTarifToDB() {
        let rawPrice = document.getElementById('input-tarif').value.replace(',', '.');
        let price = parseFloat(rawPrice);
        let name = document.getElementById('input-name').value;
        if(!price || price <= 0 || !name) { alert("Isi data dengan benar!"); return; }

        const btn = document.querySelector('.btn-save');
        btn.textContent = "Menyimpan..."; btn.disabled = true;

        // Panggil pakai nama baru 'supabaseClient'
        const { error } = await supabaseClient.from('settings').update({ tarif_value: price, updated_by: name }).eq('id', 1);

        if (!error) {
            publishUpdateSignal(price, name);
            globalTarif = price;
            lastUpdater = name;
            updateDisplayUI(globalTarif, lastUpdater);
            closeModal();
            btn.textContent = "SIMPAN PERMANEN"; btn.disabled = false;
            alert("Berhasil disimpan ke Database!");
        } else {
            alert("Gagal menyimpan: " + error.message);
            btn.textContent = "SIMPAN PERMANEN"; btn.disabled = false;
        }
    }

    function updateDisplayUI(price, user) {
        let formatted = parseFloat(price).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        document.getElementById('display-tarif').textContent = `Rp ${formatted} / kWh`;
        document.getElementById('display-updater').textContent = `Diupdate oleh: ${user}`;
    }

    function renderGrid() {
        const container = document.getElementById("tarif-grid-container");
        let html = "";
        for (let i = 1; i <= 18; i++) { html += `<a href="tarif-detail.html?id=${i}" class="menu-card">Mesin ${i}</a>`; }
        container.innerHTML = html;
    }

    function connectMqtt() {
        mqttClient = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "web_tarif_db_" + Date.now());
        mqttClient.onMessageArrived = () => { loadTarifFromDB(); };
        mqttClient.connect({ useSSL: true, userName: MQTT_USER, password: MQTT_PASS, onSuccess: () => mqttClient.subscribe(TOPIC_TARIF) });
    }

    function publishUpdateSignal(price, name) {
        const payload = JSON.stringify({ price: price, by: name, time: new Date().toISOString() });
        let message = new Paho.MQTT.Message(payload);
        message.destinationName = TOPIC_TARIF;
        message.retained = true;
        mqttClient.send(message);
    }

    function openModal() { document.getElementById('input-tarif').value = globalTarif; document.getElementById('tarifModal').classList.add('show'); }
    function closeModal() { document.getElementById('tarifModal').classList.remove('show'); }
</script>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ESP32 Power Meter - ID 1</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
  }
  h2 {
    text-align: center;
  }
  table {
    margin: auto;
    border-collapse: collapse;
    width: 60%;
    background: #1c1c1c;
  }
  th, td {
    border: 1px solid #444;
    padding: 8px 12px;
    text-align: left;
  }
  th {
    background: #333;
    width: 40%;
  }
  td {
    background: #222;
  }
  .online { color: #00ff88; }
  .offline { color: #ff4444; }
</style>
</head>

<body>

<h2>ESP32 Power Meter<br>ID 1</h2>

<table>
  <tr><th>Status</th><td id="status">Waiting...</td></tr>
  <tr><th>Total Energy (EaT)</th><td id="EaT">-</td></tr>
  <tr><th>Total Reactive (ErT)</th><td id="ErT">-</td></tr>
  <tr><th>Partial Energy (EaP)</th><td id="EaP">-</td></tr>
  <tr><th>Partial Reactive (ErP)</th><td id="ErP">-</td></tr>
  <tr><th>Voltage (V)</th><td id="V">-</td></tr>
  <tr><th>Current I1 (A)</th><td id="I1">-</td></tr>
  <tr><th>Current I2 (A)</th><td id="I2">-</td></tr>
  <tr><th>Current I3 (A)</th><td id="I3">-</td></tr>
  <tr><th>Active Power P (W)</th><td id="P">-</td></tr>
  <tr><th>Reactive Power Q (VAR)</th><td id="Q">-</td></tr>
  <tr><th>Apparent Power S (kVA)</th><td id="S">-</td></tr>
  <tr><th>Power Factor</th><td id="PF">-</td></tr>
  <tr><th>Frequency (Hz)</th><td id="Hz">-</td></tr>
  <tr><th>Operation Time (h)</th><td id="OpH">-</td></tr>
</table>

<script>
const options = {
  username: "vercel_client",
  password: "VercelPass123!",
  reconnectPeriod: 2000,
};

const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  options
);

client.on("connect", () => {
  console.log("âœ… MQTT connected");
  client.subscribe("politeknik/meter/data");
});

client.on("message", (topic, message) => {
  const data = JSON.parse(message.toString());

  if (data.id !== 1) return;

  document.getElementById("status").innerHTML =
    data.status === "online"
      ? '<span class="online">ONLINE</span>'
      : '<span class="offline">OFFLINE</span>';

  const keys = [
    "EaT","ErT","EaP","ErP",
    "V","I1","I2","I3",
    "P","Q","S","PF","Hz","OpH"
  ];

  keys.forEach(k => {
    if (data[k] !== undefined)
      document.getElementById(k).innerText = data[k];
  });
});

client.on("error", err => {
  console.error("MQTT error", err);
});
</script>

</body>
</html>

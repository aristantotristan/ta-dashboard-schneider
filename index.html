<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Power Meter Dashboard</title>

  <!-- MQTT.js CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #1c1c1c;
    }
    th, td {
      border: 1px solid #333;
      padding: 6px;
      text-align: center;
      font-size: 13px;
    }
    th {
      background: #222;
    }
    .online {
      color: #00ff99;
      font-weight: bold;
    }
    .offline {
      color: #ff4d4d;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <h2>⚡ Power Meter Dashboard</h2>
  <p>Status: <span id="mqttStatus">Connecting...</span></p>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Status</th>
        <th>V (V)</th>
        <th>I1 (A)</th>
        <th>I2 (A)</th>
        <th>I3 (A)</th>
        <th>P (W)</th>
        <th>Q (VAR)</th>
        <th>S (kVA)</th>
        <th>PF</th>
        <th>Hz</th>
        <th>E Total (kWh)</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    const broker = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
    const topic  = "politeknik/meter/data";

    const options = {
      username: "web_dashboard",
      password: "Tristan12",
      clean: true,
      reconnectPeriod: 3000,
      connectTimeout: 5000
    };

    const client = mqtt.connect(broker, options);

    const tableBody = document.getElementById("tableBody");
    const mqttStatus = document.getElementById("mqttStatus");

    const meters = {}; // simpan data per ID

    function renderTable() {
      tableBody.innerHTML = "";

      Object.keys(meters).sort().forEach(id => {
        const d = meters[id];

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td class="${d.status === 'online' ? 'online' : 'offline'}">${d.status}</td>
          <td>${d.V ?? "-"}</td>
          <td>${d.I1 ?? "-"}</td>
          <td>${d.I2 ?? "-"}</td>
          <td>${d.I3 ?? "-"}</td>
          <td>${d.P ?? "-"}</td>
          <td>${d.Q ?? "-"}</td>
          <td>${d.S ?? "-"}</td>
          <td>${d.PF ?? "-"}</td>
          <td>${d.Hz ?? "-"}</td>
          <td>${d.EaT ?? "-"}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    client.on("connect", () => {
      mqttStatus.textContent = "Connected ✅";
      client.subscribe(topic);
    });

    client.on("message", (topic, message) => {
      try {
        const data = JSON.parse(message.toString());
        meters[data.id] = data;
        renderTable();
      } catch (e) {
        console.error("JSON error", e);
      }
    });

    client.on("error", err => {
      mqttStatus.textContent = "Error ❌";
      console.error(err);
    });

    client.on("reconnect", () => {
      mqttStatus.textContent = "Reconnecting...";
    });
  </script>

</body>
</html>

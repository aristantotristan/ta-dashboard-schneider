<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Power Meter Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body { background:#111; color:#fff; font-family:Arial }
.container { display:flex }
.list { width:25% }
.list button {
  width:100%; padding:10px; margin:4px 0;
  background:#222; color:#fff; border:1px solid #444;
  cursor:pointer;
}
.list button.active { background:#00aa66 }
table { width:100%; border-collapse:collapse; margin-top:10px }
th, td { border:1px solid #444; padding:6px }
th { background:#222; width:40% }
</style>
</head>

<body>

<h2>âš¡ Power Meter Dashboard</h2>

<div class="container">
  <div class="list" id="machineList"></div>

  <div style="width:75%; padding-left:10px">
    <h3 id="title">Klik Mesin</h3>
    <table>
      <tbody id="detail"></tbody>
    </table>
  </div>
</div>

<script>
const TOTAL_MACHINE = 18;
let selected = 1;
const machines = {};

/* ===== BUAT TOMBOL ===== */
const list = document.getElementById('machineList');
for(let i=1;i<=TOTAL_MACHINE;i++){
  const btn = document.createElement('button');
  btn.textContent = 'Mesin ' + i;
  btn.id = 'btn'+i;
  btn.onclick = () => selectMachine(i);
  if(i===1) btn.classList.add('active');
  list.appendChild(btn);
}

/* ===== SELECT ===== */
function selectMachine(id){
  selected = id;
  document.querySelectorAll('.list button')
    .forEach(b => b.classList.remove('active'));
  document.getElementById('btn'+id).classList.add('active');
  render();
}

/* ===== RENDER DETAIL ===== */
function render(){
  const d = machines[selected];
  const detail = document.getElementById('detail');

  if(!d){
    detail.innerHTML = '<tr><td colspan="2">Menunggu data...</td></tr>';
    return;
  }

  document.getElementById('title')
    .innerText = `Mesin ${selected} (${d.status})`;

  const params = [
    "EaT","ErT","EaP","ErP","V",
    "I1","I2","I3",
    "P","Q","S","PF","Hz","OpH"
  ];

  detail.innerHTML = '';
  params.forEach(p=>{
    detail.innerHTML += `
      <tr>
        <th>${p}</th>
        <td>${d[p] ?? '-'}</td>
      </tr>`;
  });
}

/* ===== MQTT ===== */
const client = mqtt.connect(
  'wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt',
  { username:'web_dashboard', password:'Tristan12' }
);

client.on('connect', () => {
  console.log('MQTT connected');
  client.subscribe('politeknik/meter/data');
});

client.on('message', (topic, msg) => {
  const data = JSON.parse(msg.toString());
  machines[data.id] = data;
  if(data.id === selected) render();
});
</script>

</body>
</html>

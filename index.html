<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚡ Master Power Meter Dashboard - Vertikal</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
/* Global Styling */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #121212; /* Deep Dark Background */
  color: #E0E0E0; /* Soft White Text */
  padding: 20px;
}
h2 {
    color: #00FFC2; /* Neon Green/Cyan for title */
    border-bottom: 2px solid #3A3A3A;
    padding-bottom: 10px;
    margin-bottom: 5px;
}
#conn {
    margin-bottom: 25px;
    font-size: 1.1em;
    font-weight: bold;
    display: block;
}

/* Status Info Box */
.info-box {
    background: #1E1E1E;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#meter-id-display {
    font-size: 1.5em;
    font-weight: bold;
    color: #FFD700; /* Gold */
}
#status-display {
    font-size: 1.3em;
    font-weight: bold;
}
.status-online { color: #10B981; }
.status-offline { color: #EF4444; }


/* Vertical Table Styling */
table {
  border-collapse: separate;
  border-spacing: 0;
  width: 100%;
  max-width: 600px; /* Lebar maksimum agar terlihat rapi */
  margin: 20px auto; /* Tengah */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.7);
  border-radius: 10px;
  overflow: hidden; 
}

th {
    background: #2A2A2A;
    color: #00FFC2;
    padding: 15px;
    text-align: left;
    font-size: 1.1em;
    text-transform: uppercase;
}
td {
    padding: 12px 15px;
    border-bottom: 1px solid #3A3A3A;
    background: #1E1E1E;
}
td:first-child { /* Kolom Parameter */
    font-weight: 500;
    color: #B0B0B0;
    width: 45%;
    text-align: left;
}
td:nth-child(2) { /* Kolom Nilai */
    font-weight: bold;
    font-size: 1.2em;
    text-align: right;
    width: 35%;
    background: #151515;
}
td:last-child { /* Kolom Satuan */
    color: #888888;
    text-align: left;
    width: 20%;
    font-size: 0.9em;
}

/* Color Grouping for Rows */
.group-power td:nth-child(2) { color: #38BDF8; } /* Biru Muda untuk Power */
.group-energy td:nth-child(2) { color: #4ADE80; } /* Hijau untuk Energy */

/* Special style for Operating Time */
tr.group-quality td:nth-child(2)[data-key-value="OpH"] {
    font-size: 1.1em; /* Sedikit lebih kecil karena teks lebih panjang */
}
</style>
</head>

<body>

<h2>⚡ Real-time Power Meter Dashboard</h2>
<div class="info-box">
    <span>Meter ID: <span id="meter-id-display">N/A</span></span>
    <span>Status: <span id="status-display">N/A</span></span>
</div>
<p id="conn">Connecting...</p>


<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th colspan="2">Nilai Saat Ini</th>
        </tr>
    </thead>
    <tbody id="tableBody">
        <tr class="group-vi"><td data-key="V">Voltage (L-L Avg)</td><td>0.00</td><td>V</td></tr>
        <tr class="group-vi"><td data-key="I1">Current Phase 1</td><td>0.000</td><td>A</td></tr>
        <tr class="group-vi"><td data-key="I2">Current Phase 2</td><td>0.000</td><td>A</td></tr>
        <tr class="group-vi"><td data-key="I3">Current Phase 3</td><td>0.000</td><td>A</td></tr>
        
        <tr class="group-power"><td data-key="P">Active Power Total (P)</td><td>0</td><td>Watt</td></tr>
        <tr class="group-power"><td data-key="Q">Reactive Power Total (Q)</td><td>0</td><td>VAR</td></tr>
        <tr class="group-power"><td data-key="S">Apparent Power Total (S)</td><td>0.00</td><td>kVA</td></tr>
        
        <tr class="group-quality"><td data-key="PF">Power Factor (PF)</td><td>0.000</td><td></td></tr>
        <tr class="group-quality"><td data-key="Hz">Frequency</td><td>0.0</td><td>Hz</td></tr>
        <tr class="group-quality"><td data-key="OpH">Load Time / Op Time</td><td>0.0</td><td></td></tr> <tr class="group-energy"><td data-key="EaT">Energy Active Total</td><td>0.00</td><td>kWh</td></tr>
        <tr class="group-energy"><td data-key="ErT">Energy Reactive Total</td><td>0.00</td><td>kVARh</td></tr>
        <tr class="group-energy"><td data-key="EaP">Energy Active Partial</td><td>0.00</td><td>kWh</td></tr>
        <tr class="group-energy"><td data-key="ErP">Energy Reactive Partial</td><td>0.00</td><td>kVARh</td></tr>
    </tbody>
</table>

<script>
// --- KONFIGURASI MQTT WEB CLIENT ---
const options = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 2000,
};

// Menggunakan WSS (WebSockets Secure) port 8884
const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  options
);

const tableBody = document.getElementById("tableBody");
const conn = document.getElementById("conn");
const statusDisplay = document.getElementById("status-display");
const meterIdDisplay = document.getElementById("meter-id-display");

/**
 * Mengonversi total jam (decimal) menjadi format Hari dan Jam.
 * Contoh: 48.5 -> "2 Hari 0.5 Jam"
 * @param {number} totalHours - Total jam dari data MQTT (OpH).
 */
function formatOperatingTime(totalHours) {
    // Cek jika data invalid atau belum ada
    if (totalHours === undefined || totalHours === null || isNaN(totalHours) || totalHours < 0) {
        return '---';
    }
    
    const hours = parseFloat(totalHours); 
    
    // Perhitungan
    const days = Math.floor(hours / 24);
    const remainingHours = hours % 24;
    
    let result = '';
    
    if (days > 0) {
        result += `${days} Hari `;
    }

    // Jika total jam kurang dari 24 atau ada sisa jam, tampilkan jam
    if (remainingHours > 0 || days === 0) {
        // Tampilkan 1 angka di belakang koma untuk jam
        result += `${remainingHours.toFixed(1)} Jam`;
    }
    
    return result.trim();
}


client.on("connect", () => {
  conn.innerHTML = "✅ MQTT Connected";
  client.subscribe("politeknik/meter/data");
});

client.on("error", err => {
  conn.innerHTML = "❌ MQTT Error";
  console.error("MQTT Connection Error:", err);
});

client.on("message", (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    
    // 1. Update Status & ID
    meterIdDisplay.textContent = d.id || 'N/A';
    statusDisplay.textContent = d.status.toUpperCase();
    statusDisplay.className = d.status === "online" ? "status-online" : "status-offline";
    conn.style.display = 'none'; // Sembunyikan pesan connecting setelah data pertama masuk

    // 2. Update Data di Tabel
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => {
        // Ambil elemen <td> pertama yang berisi data-key
        const keyCell = row.querySelector('td[data-key]');
        
        if (keyCell) {
            const key = keyCell.getAttribute('data-key');
            const value = d[key];
            
            // Ambil elemen <td> kedua (tempat nilai)
            const valueCell = row.children[1]; 
            
            if (valueCell) {
                if (key === 'OpH') {
                    // Gunakan fungsi konversi untuk Operating Time
                    valueCell.textContent = formatOperatingTime(value);
                } else {
                    // Tampilkan nilai standar (0 atau angka)
                    valueCell.textContent = (value === 0 || value) ? value : '---';
                }
            }
        }
    });

  } catch (e) {
    console.error("JSON Parsing Error:", e);
  }
});
</script>

</body>
</html>

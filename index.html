<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ESP32 Power Meter Dashboard - ID 1</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body { margin:0; font-family: Arial; background:#0e0e0e; color:#fff; }
header { background:#161616; padding:10px 20px; border-bottom:2px solid #222; }
header span { font-weight:bold; }
.main { display:flex; height: calc(100vh - 60px); }
.detail { flex:1; padding:20px; }
table { width:100%; border-collapse:collapse; background:#1b1b1b; }
th, td { padding:10px; border:1px solid #333; }
th { background:#242424; width:60%; }
.online { color:#00ff88; }
.offline { color:#ff4444; }
.wait { color:orange; }
</style>
</head>

<body>

<header>
  MQTT Status: <span id="mqttStatus" class="wait">CONNECTING...</span> |
  Selected Mesin: <span id="selectedMachine">1</span>
</header>

<div class="main">
  <div class="detail">
    <h2>ðŸ“Š Mesin <span id="detailId">1</span></h2>
    Status: <span id="detailStatus" class="offline">OFFLINE</span>
    <table>
      <tr><th>Voltage (V)</th><td id="V">0</td></tr>
      <tr><th>Current I1 (A)</th><td id="I1">0</td></tr>
      <tr><th>Current I2 (A)</th><td id="I2">0</td></tr>
      <tr><th>Current I3 (A)</th><td id="I3">0</td></tr>
      <tr><th>Active Power (W)</th><td id="P">0</td></tr>
      <tr><th>Reactive Power (VAR)</th><td id="Q">0</td></tr>
      <tr><th>Apparent Power (kVA)</th><td id="S">0</td></tr>
      <tr><th>Power Factor</th><td id="PF">0</td></tr>
      <tr><th>Frequency (Hz)</th><td id="Hz">0</td></tr>
      <tr><th>Total Ea (kWh)</th><td id="EaT">0</td></tr>
      <tr><th>Total Er (kVARh)</th><td id="ErT">0</td></tr>
      <tr><th>Partial Ea (kWh)</th><td id="EaP">0</td></tr>
      <tr><th>Partial Er (kVARh)</th><td id="ErP">0</td></tr>
      <tr><th>Operation Time (h)</th><td id="OpH">0</td></tr>
    </table>
  </div>
</div>

<script>
// ================= CONFIG =================
const activeId = 1;
const fields = ["V","I1","I2","I3","P","Q","S","PF","Hz","EaT","ErT","EaP","ErP","OpH"];
const cache = {};

// ================= MQTT CONNECT =================
const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  {
    username: "web_dashboard",
    password: "Tristan12",
    reconnectPeriod: 2000
  }
);

client.on("connect", () => {
  console.log("MQTT CONNECTED âœ…");
  document.getElementById("mqttStatus").innerText = "CONNECTED âœ…";
  document.getElementById("mqttStatus").className = "online";
  client.subscribe("politeknik/meter/data");
});

client.on("offline", () => {
  console.log("MQTT DISCONNECTED âŒ");
  document.getElementById("mqttStatus").innerText = "DISCONNECTED âŒ";
  document.getElementById("mqttStatus").className = "offline";
});

client.on("message", (_, msg) => {
  console.log("MQTT msg received:", msg.toString()); // cek data masuk
  try {
    const data = JSON.parse(msg.toString());
    if (data.id === activeId) {
      cache[activeId] = { ...cache[activeId], ...data };
      updateDetail(cache[activeId]);
    }
  } catch(e) { console.error("JSON parse error:", e); }
});

// ================= UPDATE DETAIL =================
function updateDetail(data) {
  document.getElementById("detailStatus").innerText = data.status === "online"? "ONLINE âœ…" : "OFFLINE âŒ";
  document.getElementById("detailStatus").className = data.status === "online"? "online":"offline";
  fields.forEach(f => {
    document.getElementById(f).innerText = data[f] !== undefined ? data[f] : 0;
  });
}
</script>

</body>
</html>

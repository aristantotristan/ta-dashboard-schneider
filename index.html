<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Power Meter Dashboard</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
}

h1 {
  text-align: center;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

th, td {
  border: 1px solid #334155;
  padding: 6px;
  text-align: center;
}

th {
  background: #020617;
}

.online { background: #064e3b; }
.offline { background: #450a0a; }

</style>
</head>

<body>

<h1>⚡ Power Meter Dashboard – 18 Mesin</h1>

<table>
<thead>
<tr>
  <th>ID</th>
  <th>Status</th>
  <th>V (V)</th>
  <th>I1 (A)</th>
  <th>I2 (A)</th>
  <th>I3 (A)</th>
  <th>P (W)</th>
  <th>Q (VAR)</th>
  <th>S (VA)</th>
  <th>PF</th>
  <th>Hz</th>
  <th>EaT (kWh)</th>
  <th>ErT (kWh)</th>
  <th>EaP (kWh)</th>
  <th>ErP (kWh)</th>
  <th>OpH (Jam)</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
// ================= MQTT CONFIG =================
const options = {
  username: "web_dashboard",
  password: "Tristan12",
  protocol: "wss",
};

const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  options
);

// ================= INIT TABLE =================
const tableBody = document.getElementById("tableBody");

const mesin = {};
for (let i = 1; i <= 18; i++) {
  mesin[i] = {};
  insertRow(i);
}

function insertRow(id) {
  const row = document.createElement("tr");
  row.id = `row-${id}`;
  row.className = "offline";
  row.innerHTML = `
    <td>${id}</td>
    <td>OFFLINE</td>
    ${"<td>-</td>".repeat(14)}
  `;
  tableBody.appendChild(row);
}

// ================= MQTT EVENT =================
client.on("connect", () => {
  console.log("✅ MQTT Connected");
  client.subscribe("politeknik/meter/data");
});

client.on("message", (topic, message) => {
  const data = JSON.parse(message.toString());
  updateRow(data);
});

// ================= UPDATE TABLE =================
function updateRow(d) {
  const row = document.getElementById(`row-${d.id}`);
  if (!row) return;

  if (d.status === "online") {
    row.className = "online";
    row.innerHTML = `
      <td>${d.id}</td>
      <td>ONLINE</td>
      <td>${d.V?.toFixed(1)}</td>
      <td>${d.I1?.toFixed(2)}</td>
      <td>${d.I2?.toFixed(2)}</td>
      <td>${d.I3?.toFixed(2)}</td>
      <td>${d.P}</td>
      <td>${d.Q}</td>
      <td>${d.S?.toFixed(2)}</td>
      <td>${d.PF?.toFixed(3)}</td>
      <td>${d.Hz?.toFixed(2)}</td>
      <td>${d.EaT?.toFixed(2)}</td>
      <td>${d.ErT?.toFixed(2)}</td>
      <td>${d.EaP?.toFixed(2)}</td>
      <td>${d.ErP?.toFixed(2)}</td>
      <td>${d.OpH?.toFixed(2)}</td>
    `;
  } else {
    row.className = "offline";
    row.innerHTML = `
      <td>${d.id}</td>
      <td>OFFLINE</td>
      ${"<td>-</td>".repeat(14)}
    `;
  }
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schneider 18 Mesin - Realtime Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <style>
        body { background-color: #eef2f7; font-family: 'Segoe UI', sans-serif; }
        .header-title { padding: 20px 0; color: #1a1a1a; font-weight: 800; letter-spacing: -0.5px; }
        
        /* Styling Kartu Mesin */
        .machine-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            background: white;
            overflow: hidden;
        }
        .card-header-custom {
            background-color: #fff;
            border-bottom: 1px solid #eee;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .machine-name { font-weight: 700; font-size: 1rem; margin: 0; color: #333; }
        
        /* Kotak Parameter Kecil */
        .param-box {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #eee;
        }
        .lbl { font-size: 0.65rem; color: #888; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 2px; }
        .val { font-size: 0.95rem; font-weight: 700; color: #222; line-height: 1.1; }
        .unit { font-size: 0.65rem; color: #aaa; }

        /* Indikator Status Bulat */
        .status-indicator {
            font-size: 0.7rem; font-weight: bold; 
            padding: 3px 8px; border-radius: 20px;
            display: flex; align-items: center; gap: 5px;
        }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .st-online { color: #198754; background: #d1e7dd; }
        .st-online .dot { background: #198754; box-shadow: 0 0 5px #198754; }
        .st-offline { color: #dc3545; background: #f8d7da; }
        .st-offline .dot { background: #dc3545; }

        /* Warna Khusus Parameter */
        .color-p { color: #27ae60; } /* Watt Hijau */
        .color-q { color: #d35400; } /* VAR Orange */
        .color-s { color: #2980b9; } /* kVA Biru */
    </style>
</head>
<body>

<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12 text-center">
            <h3 class="header-title">DASHBOARD ENERGI - 18 MESIN</h3>
            <div id="mqtt-status" class="badge bg-secondary mb-3">Connecting to Cloud...</div>
        </div>
    </div>

    <div class="row" id="machine-container"></div>
</div>

<script>
    // ==========================================
    // 1. KONFIGURASI KONEKSI (JANGAN DIUBAH)
    // ==========================================
    const MQTT_HOST = "701d32236feb43b38c22855a611f4d42.s1.eu.hivemq.cloud";
    const MQTT_PORT = 8884; // Port WSS (Secure WebSocket)
    const MQTT_CLIENT_ID = "WebClient_" + Math.random().toString(16).substr(2, 8);
    const MQTT_TOPIC = "politeknik/meter/data";
    
    // Credential
    const MQTT_USER = "vercel_client"; 
    const MQTT_PASS = "VercelPass123!";

    // ==========================================
    // 2. GENERATE 18 KARTU OTOMATIS
    // ==========================================
    const container = document.getElementById("machine-container");
    let cardsHTML = "";

    for (let i = 1; i <= 18; i++) {
        cardsHTML += `
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
            <div class="machine-card">
                <div class="card-header-custom">
                    <h5 class="machine-name">MESIN ${i}</h5>
                    <div class="status-indicator st-offline" id="status-badge-${i}">
                        <span class="dot"></span> <span id="status-text-${i}">OFF</span>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="row g-1 mb-1">
                        <div class="col-6">
                            <div class="param-box">
                                <span class="lbl">VOLTAGE</span>
                                <span class="val" id="v-${i}">0</span> <span class="unit">V</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="param-box">
                                <span class="lbl">CURRENT</span>
                                <span class="val" id="i-${i}">0</span> <span class="unit">A</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-1 mb-1">
                        <div class="col-4">
                            <div class="param-box">
                                <span class="lbl">ACTIVE</span>
                                <span class="val color-p" id="p-${i}">0</span> <span class="unit">W</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="param-box">
                                <span class="lbl">REACT</span>
                                <span class="val color-q" id="q-${i}">0</span> <span class="unit">VAR</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="param-box">
                                <span class="lbl">APPAR</span>
                                <span class="val color-s" id="s-${i}">0</span> <span class="unit">kVA</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-1 mb-1">
                        <div class="col-6">
                            <div class="param-box">
                                <span class="lbl">FREQ</span>
                                <span class="val" id="hz-${i}">0</span> <span class="unit">Hz</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="param-box">
                                <span class="lbl">P. FACTOR</span>
                                <span class="val" id="pf-${i}">0</span>
                            </div>
                        </div>
                    </div>

                    <hr style="margin: 5px 0; border-top: 1px dashed #ddd;">

                    <div class="row g-1 mb-1">
                        <div class="col-6">
                            <div class="param-box" style="background:#fdfdfd;">
                                <span class="lbl">TOT ACTIVE E</span>
                                <span class="val" id="e-${i}">0</span> <span class="unit">kWh</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="param-box" style="background:#fdfdfd;">
                                <span class="lbl">TOT REACT E</span>
                                <span class="val" id="qtot-${i}">0</span> <span class="unit">kVARh</span>
                            </div>
                        </div>
                    </div>

                     <div class="row g-1 mb-1">
                        <div class="col-6">
                            <div class="param-box" style="background:#fdfdfd;">
                                <span class="lbl">PART ACTIVE</span>
                                <span class="val" id="epart-${i}">0</span> <span class="unit">kWh</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="param-box" style="background:#fdfdfd;">
                                <span class="lbl">PART REACT</span>
                                <span class="val" id="qpart-${i}">0</span> <span class="unit">kVARh</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-2 p-2 bg-light border rounded text-center">
                        <span class="lbl">OPERATION TIME</span>
                        <div class="fw-bold text-primary" id="time-${i}">0d 0h</div>
                    </div>

                </div>
            </div>
        </div>`;
    }
    container.innerHTML = cardsHTML;

    // ==========================================
    // 3. LOGIKA MQTT CLIENT (PAHO)
    // ==========================================
    const client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, MQTT_CLIENT_ID);

    client.onConnectionLost = function(responseObject) {
        console.log("Koneksi Putus: " + responseObject.errorMessage);
        document.getElementById("mqtt-status").className = "badge bg-danger";
        document.getElementById("mqtt-status").innerText = "OFFLINE - RECONNECTING...";
        setTimeout(connectToMqtt, 5000); // Coba connect lagi setelah 5 detik
    };

    client.onMessageArrived = function(message) {
        // console.log("Data Masuk: " + message.payloadString); // Un-comment untuk debug di Console
        try {
            const data = JSON.parse(message.payloadString);
            updateUI(data);
        } catch (e) {
            console.error("JSON Error: ", e);
        }
    };

    function connectToMqtt() {
        console.log("Mencoba Connect ke " + MQTT_HOST);
        client.connect({
            useSSL: true, // WAJIB TRUE untuk HiveMQ Cloud
            userName: MQTT_USER,
            password: MQTT_PASS,
            onSuccess: function() {
                console.log("BERHASIL CONNECT!");
                document.getElementById("mqtt-status").className = "badge bg-success";
                document.getElementById("mqtt-status").innerText = "SYSTEM ONLINE (RECEIVING DATA)";
                client.subscribe(MQTT_TOPIC);
            },
            onFailure: function(message) {
                console.log("Gagal Connect: " + message.errorMessage);
                document.getElementById("mqtt-status").className = "badge bg-danger";
                document.getElementById("mqtt-status").innerText = "CONNECTION FAILED";
                setTimeout(connectToMqtt, 5000);
            }
        });
    }

    // Start Connection
    connectToMqtt();

    // ==========================================
    // 4. FUNGSI UPDATE TAMPILAN
    // ==========================================
    function updateUI(d) {
        const id = d.id_mesin; // Ambil ID Mesin
        if (!id || id < 1 || id > 18) return;

        // Update Status Badge
        const badge = document.getElementById(`status-badge-${id}`);
        const txt = document.getElementById(`status-text-${id}`);

        if (d.status === "online") {
            badge.className = "status-indicator st-online";
            txt.innerText = "ON";
            
            // Update Angka Parameter
            setVal(`v-${id}`, d.v, 1);      // 1 desimal
            setVal(`i-${id}`, d.i, 2);      // 2 desimal
            setVal(`p-${id}`, d.p, 0);      // 0 desimal (Watt)
            setVal(`q-${id}`, d.q, 0);      // 0 desimal (VAR)
            setVal(`s-${id}`, d.s, 2);      // 2 desimal (kVA)
            setVal(`hz-${id}`, d.hz, 1);
            setVal(`pf-${id}`, d.pf, 2);
            
            setVal(`e-${id}`, d.e, 1);
            setVal(`qtot-${id}`, d.q_tot, 1);
            setVal(`epart-${id}`, d.e_part, 1);
            setVal(`qpart-${id}`, d.q_part, 1);

            // Convert Jam ke Hari
            document.getElementById(`time-${id}`).innerText = formatTime(d.op_time);

        } else {
            badge.className = "status-indicator st-offline";
            txt.innerText = "OFF";
            // Opsional: Kalau OFF, angka mau di-nol-kan atau dibiarkan nilai terakhir?
            // Saat ini dibiarkan nilai terakhir agar tidak kedip-kedip.
        }
    }

    // Helper Update Text
    function setVal(elemId, value, decimal) {
        const el = document.getElementById(elemId);
        if (el) el.innerText = parseFloat(value).toFixed(decimal);
    }

    // Helper Convert Hours -> Days Hours
    function formatTime(hoursVal) {
        if (!hoursVal || isNaN(hoursVal)) return "0d 0h";
        const days = Math.floor(hoursVal / 24);
        const hours = (hoursVal % 24).toFixed(1);
        if (days > 0) return `${days}d ${hours}h`;
        return `${hours}h`;
    }

</script>

</body>
</html>

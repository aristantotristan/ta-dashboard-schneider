<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Energi (v50 - Clean)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gauge.js/1.3.7/gauge.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; padding: 20px; color: #333; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        h2 { text-align: center; color: #7f8c8d; font-size: 1.1em; margin-top: 0; margin-bottom: 30px; }
        
        #status { text-align: center; padding: 10px; margin-bottom: 20px; font-weight: bold; color: white; border-radius: 5px; }
        .bg-ok { background: #27ae60; } .bg-err { background: #c0392b; } .bg-wait { background: #f39c12; }
        
        .page { display: none; } .page.active { display: block; }
        
        /* MENU GRID */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .menu-card { background: #fff; padding: 20px; border-radius: 10px; text-align: center; font-weight: 600; color: #555; border-top: 5px solid #bdc3c7; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .menu-card:hover { transform: translateY(-5px); }
        .menu-card.online { border-top-color: #27ae60; }
        .menu-badge { display: block; font-size: 0.75em; margin-top: 5px; color: #95a5a6; }
        .menu-card.online .menu-badge { color: #27ae60; font-weight: bold; }

        /* DETAIL VIEW */
        .back-btn { display: inline-block; padding: 8px 20px; background: #34495e; color: white; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        
        .gauge-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .gauge-box { background: #fff; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .gauge-box canvas { width: 100%; height: auto; }
        .gauge-title { margin-top: 10px; font-weight: bold; color: #2980b9; }

        .data-card { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .lbl { color: #7f8c8d; font-weight: 500; }
        .val { text-align: right; font-weight: bold; color: #2c3e50; }
        .unit { color: #95a5a6; font-size: 0.85em; width: 50px; text-align: right; }
        .row-head { background: #ecf0f1; font-weight: bold; color: #2c3e50; }
        .row-time { background: #eafaf1; }
    </style>
</head>
<body>

    <h1>MONITORING ENERGI</h1>
    <h2>PT. Amarilys Karisma Gemilang</h2>
    <div id="status" class="bg-wait">Memuat Sistem...</div>

    <div id="page-menu" class="page active">
        <div class="menu-grid" id="menu-container"></div>
    </div>

    <div id="page-detail" class="page">
        <div class="back-btn" onclick="showMenu()">&#8592; Kembali</div>
        
        <div class="gauge-grid">
            <div class="gauge-box"><canvas id="g-v"></canvas><div class="gauge-title">Tegangan (V)</div></div>
            <div class="gauge-box"><canvas id="g-a"></canvas><div class="gauge-title">Arus Avg (A)</div></div>
            <div class="gauge-box"><canvas id="g-p"></canvas><div class="gauge-title">Daya Aktif (W)</div></div>
            <div class="gauge-box"><canvas id="g-f"></canvas><div class="gauge-title">Freq (Hz)</div></div>
        </div>

        <div class="data-card">
            <table class="data-table">
                <tr class="row-head"><td colspan="3">1. Kelistrikan (3 Phase)</td></tr>
                <tr><td class="lbl">Tegangan (Avg L-L)</td><td class="val" id="d-v">-</td><td class="unit">V</td></tr>
                <tr><td class="lbl">Arus (Rata-rata)</td><td class="val" id="d-i">-</td><td class="unit">A</td></tr>
                <tr><td class="lbl" style="padding-left:30px">Phase L1</td><td class="val" id="d-i1">-</td><td class="unit">A</td></tr>
                <tr><td class="lbl" style="padding-left:30px">Phase L2</td><td class="val" id="d-i2">-</td><td class="unit">A</td></tr>
                <tr><td class="lbl" style="padding-left:30px">Phase L3</td><td class="val" id="d-i3">-</td><td class="unit">A</td></tr>
                
                <tr class="row-head"><td colspan="3">2. Daya & Kualitas</td></tr>
                <tr><td class="lbl">Active Power (P)</td><td class="val" id="d-p">-</td><td class="unit">W</td></tr>
                <tr><td class="lbl">Reactive Power (Q)</td><td class="val" id="d-q">-</td><td class="unit">VAR</td></tr>
                <tr><td class="lbl">Apparent Power (S)</td><td class="val" id="d-s">-</td><td class="unit">kVA</td></tr>
                <tr><td class="lbl">Power Factor</td><td class="val" id="d-pf">-</td><td class="unit">PF</td></tr>
                <tr><td class="lbl">Frequency</td><td class="val" id="d-hz">-</td><td class="unit">Hz</td></tr>

                <tr class="row-head"><td colspan="3">3. Energi (Akumulasi)</td></tr>
                <tr><td class="lbl">Total Ea Import</td><td class="val" id="d-e">-</td><td class="unit">kWh</td></tr>
                <tr><td class="lbl">Total Er Import</td><td class="val" id="d-qtot">-</td><td class="unit">kVARh</td></tr>
                <tr><td class="lbl">Partial Active</td><td class="val" id="d-epart">-</td><td class="unit">kWh</td></tr>
                <tr><td class="lbl">Partial Reactive</td><td class="val" id="d-qpart">-</td><td class="unit">kVARh</td></tr>

                <tr class="row-time"><td class="lbl">Operation Time</td><td class="val" id="d-op">-</td><td class="unit"></td></tr>
            </table>
        </div>
    </div>

<script>
window.onload = function() {
    // CONFIG MQTT
    const HOST = "701d32236feb43b38c22855a611f4d42.s1.eu.hivemq.cloud";
    const PORT = 8884;
    const USER = "web_dashboard";
    const PASS = "Tristan12";
    const TOPIC = "politeknik/meter/data";

    let client, gV, gA, gP, gF;
    let activeId = 0;
    let cache = {};

    // --- FORMATTER WAKTU (HARI & JAM) ---
    function fmtTime(hoursFloat) {
        if (hoursFloat == null || isNaN(hoursFloat)) return "-";
        const days = Math.floor(hoursFloat / 24);
        const hrs = (hoursFloat % 24).toFixed(1);
        return `${days} Days ${hrs} Hrs`;
    }
    
    const fmt = (n, d) => (n != null && !isNaN(n)) ? Number(n).toFixed(d) : "-";

    function init() {
        let grid = "";
        for(let i=1; i<=18; i++) grid += `<div class="menu-card" id="card-${i}" onclick="openDetail(${i})">Mesin ${i}<span class="menu-badge">OFFLINE</span></div>`;
        document.getElementById("menu-container").innerHTML = grid;
        
        initGauges();
        connectMQTT();
    }

    function connectMQTT() {
        setStatus("Menghubungkan...", "bg-wait");
        client = new Paho.MQTT.Client(HOST, PORT, "web_" + Date.now());
        
        client.onConnectionLost = (r) => { 
            if (r.errorCode !== 0) { setStatus("Koneksi Putus...", "bg-err"); setTimeout(connectMQTT, 3000); } 
        };
        
        client.onMessageArrived = (m) => {
            try {
                const d = JSON.parse(m.payloadString);
                if(d.id_mesin) d.id = d.id_mesin;
                if(!d.id) return;
                
                cache[d.id] = d;
                updateMenu(d);
                if(d.id === activeId) updateDetail(d);
                
            } catch(e) { console.error(e); }
        };
        
        client.connect({
            useSSL: true, userName: USER, password: PASS,
            onSuccess: () => { setStatus("ONLINE - SYSTEM READY", "bg-ok"); client.subscribe(TOPIC); },
            onFailure: (e) => { setStatus("Gagal Konek: " + e.errorMessage, "bg-err"); }
        });
    }

    function updateMenu(d) {
        const el = document.getElementById(`card-${d.id}`);
        if(el) {
            const badge = el.querySelector("span");
            if(d.status === 'online') {
                el.classList.add("online"); badge.innerText = "ONLINE"; badge.style.color = "#27ae60";
            } else {
                el.classList.remove("online"); badge.innerText = "OFFLINE"; badge.style.color = "#95a5a6";
            }
        }
    }

    function updateDetail(d) {
        if(d.status === 'offline') {
            gV.set(0); gA.set(0); gP.set(0); gF.set(0);
            return; 
        }

        // Update Gauges
        gV.set(d.v); gA.set(d.i); gP.set(d.p); gF.set(d.hz);

        // Update Values
        document.getElementById("d-v").innerText = fmt(d.v, 1);
        document.getElementById("d-i").innerText = fmt(d.i, 2);
        document.getElementById("d-i1").innerText = fmt(d.i1, 2); // Arus L1
        document.getElementById("d-i2").innerText = fmt(d.i2, 2); // Arus L2
        document.getElementById("d-i3").innerText = fmt(d.i3, 2); // Arus L3
        
        document.getElementById("d-p").innerText = fmt(d.p, 0);
        document.getElementById("d-q").innerText = fmt(d.q, 0);
        document.getElementById("d-s").innerText = fmt(d.s, 2);
        document.getElementById("d-pf").innerText = fmt(d.pf, 3);
        document.getElementById("d-hz").innerText = fmt(d.hz, 1);
        
        document.getElementById("d-e").innerText = fmt(d.e, 2);
        document.getElementById("d-qtot").innerText = fmt(d.q_tot, 2);
        document.getElementById("d-epart").innerText = fmt(d.e_part, 2);
        document.getElementById("d-qpart").innerText = fmt(d.q_part, 2);
        
        // Update Waktu dengan Format Hari & Jam
        document.getElementById("d-op").innerText = fmtTime(d.op_time);
    }

    window.openDetail = (id) => {
        activeId = id;
        document.getElementById("page-menu").style.display = "none";
        document.getElementById("page-detail").style.display = "block";
        
        if(cache[id]) updateDetail(cache[id]);
        else {
             gV.set(0); gA.set(0); gP.set(0); gF.set(0);
             document.getElementById("d-op").innerText = "-";
        }
    };

    window.showMenu = () => {
        activeId = 0;
        document.getElementById("page-detail").style.display = "none";
        document.getElementById("page-menu").style.display = "block";
    };

    function setStatus(t, c) { const el=document.getElementById("status"); el.innerText=t; el.className=c; }

    function initGauges() {
        var opts = { angle: 0, lineWidth: 0.2, radiusScale: 1, pointer: { length: 0.5, strokeWidth: 0.03, color: '#000' }, limitMax: false, limitMin: false, colorStart: '#6FADCF', colorStop: '#8FC0DA', strokeColor: '#E0E0E0', generateGradient: true, highDpiSupport: true };
        
        gV = new Gauge(document.getElementById("g-v")).setOptions(opts); gV.maxValue = 450; gV.setMinValue(0); gV.set(0);
        gA = new Gauge(document.getElementById("g-a")).setOptions(opts); gA.maxValue = 100; gA.setMinValue(0); gA.set(0);
        gP = new Gauge(document.getElementById("g-p")).setOptions(opts); gP.maxValue = 25000; gP.setMinValue(0); gP.set(0);
        gF = new Gauge(document.getElementById("g-f")).setOptions(opts); gF.maxValue = 60; gF.setMinValue(40); gF.set(0);
    }

    init();
};
</script>
</body>
</html>

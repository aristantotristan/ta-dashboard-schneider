<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ö° Master Power Meter Dashboard (18 SLAVES)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* Global Styling */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #E0E0E0;
    padding: 20px;
}
h2 {
    color: #00FFC2;
    border-bottom: 2px solid #3A3A3A;
    padding-bottom: 10px;
    margin-bottom: 5px;
}
#conn {
    margin-bottom: 25px;
    font-size: 1.1em;
    font-weight: bold;
}

/* Navbar Style */
#nav-buttons {
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
}
.nav-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
    background-color: #2A2A2A;
    color: #E0E0E0;
    border: 1px solid #3A3A3A;
}
.nav-btn:hover {
    background-color: #3A3A3A;
}
.nav-btn.active {
    background-color: #00FFC2;
    color: #121212;
    box-shadow: 0 0 10px #00FFC280;
}

/* Tabel Styling */
table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    overflow: hidden; 
}
th, td {
    border: 1px solid #2A2A2A;
    padding: 10px 12px;
    text-align: center;
    transition: background-color 0.3s;
}
thead th {
    background: #2A2A2A;
    color: #00FFC2;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9em;
}
tbody tr {
    background: #1E1E1E;
}
.cell-id { font-weight: bold; background: #111827; }
.status-online { color: #10B981; font-weight: bold; } 
.status-offline { color: #EF4444; font-weight: bold; }
.status-standby { color: #F59E0B; font-weight: bold; } 
.col-power { background-color: #0F334A; color: #38BDF8; font-weight: 600; }
.col-energy { color: #4ADE80; font-weight: 600; }
.col-v, .col-i, .col-pf { font-weight: 500; }

/* Tarif Form Styling */
.tarif-form {
    background: #1E1E1E;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    max-width: 600px;
    margin-top: 20px;
}
.tarif-form h3 { color: #00FFC2; }
.tarif-form label {
    display: block;
    margin-top: 15px;
    margin-bottom: 5px;
    font-weight: bold;
    color: #00FFC2;
}
.tarif-form select, .tarif-form input[type="date"] {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #3A3A3A;
    background: #2A2A2A;
    color: #E0E0E0;
}
.tarif-form button {
    margin-top: 20px;
    background-color: #38BDF8;
    color: #121212;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
}
</style>
</head>

<body>

<h2>‚ö° Real-time Power Meter Dashboard (18 Mesin)</h2>
<p id="conn">Connecting...</p>

<div id="nav-buttons">
    <button class="nav-btn active" id="btn-realtime" onclick="showView('realtime')">Monitoring Realtime</button>
    <button class="nav-btn" id="btn-tarif" onclick="showView('tarif')">Monitoring Tarif</button>
</div>

<div id="content">
    </div>

<script>
// =======================================================
// SEMUA LOGIKA JAVASCRIPT ADA DI SINI
// =======================================================

// --- KONFIGURASI GLOBAL ---
const MAX_SLAVE_ID = 18; 
const devices = {}; // Menyimpan referensi baris tabel untuk pembaruan realtime
const dataMap = [
    { key: 'V', class: 'col-v' }, { key: 'I1', class: 'col-i' }, { key: 'I2', class: 'col-i' }, 
    { key: 'I3', class: 'col-i' }, { key: 'P', class: 'col-power' }, { key: 'Q', class: 'col-power' }, 
    { key: 'S', class: 'col-power' }, { key: 'PF', class: 'col-pf' }, { key: 'Hz', class: 'col-pf' }, 
    { key: 'OpH', class: 'col-pf' }, { key: 'EaT', class: 'col-energy' }, { key: 'ErT', class: 'col-energy' }, 
    { key: 'EaP', class: 'col-energy' }, { key: 'ErP', class: 'col-energy' }
];

// --- KONFIGURASI SUPABASE (HARUS DIGANTI) ---
const SUPABASE_URL = 'https://[your-project-ref].supabase.co'; 
const SUPABASE_ANON_KEY = '[your-anon-public-key]'; 
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


// --- FUNGSI UTILITY GLOBAL ---

/**
 * Mengonversi total jam (decimal) menjadi format Hari dan Jam.
 */
function formatOperatingTime(totalHours) {
    if (totalHours === undefined || totalHours === null || isNaN(totalHours) || totalHours < 0) {
        return '---';
    }
    const totalMinutes = Math.round(parseFloat(totalHours) * 60);
    const days = Math.floor(totalMinutes / (24 * 60));
    const remainingMinutes = totalMinutes % (24 * 60);
    const hours = Math.floor(remainingMinutes / 60);
    const minutes = remainingMinutes % 60;
    
    let result = '';
    if (days > 0) result += `${days} Hari `;
    if (hours > 0 || days === 0) {
        result += `${hours} Jam`;
        if (minutes > 0) result += ` ${minutes} Mnt`;
    } else if (minutes > 0) {
        result += `${minutes} Mnt`;
    }
    return result.trim() || '0 Jam'; 
}


// --- FUNGSI MQTT (REALTIME) ---
const mqttClient = (() => {
    const options = {
        username: "web_dashboard",
        password: "Tristan12",
        connectTimeout: 4000,
        reconnectPeriod: 2000,
    };
    let client = null;

    const handleMessage = (topic, message) => {
        try {
            const d = JSON.parse(message.toString());
            const id = d.id;

            if (devices[id]) { 
                const row = devices[id];
                const cells = row.cells;
                
                // Update Status (Index 1)
                cells[1].textContent = d.status.toUpperCase();
                cells[1].className = d.status === "online" ? "status-online" : "status-offline";
                
                // Update Data (Mulai dari Index 2)
                dataMap.forEach((item, index) => {
                    const cellIndex = index + 2; 
                    const value = d[item.key];
                    
                    let displayValue;
                    
                    if (d.status === "offline") {
                        displayValue = '---'; 
                    } else if (item.key === 'OpH') {
                        displayValue = formatOperatingTime(value);
                    } else {
                        displayValue = (value === 0 || value) ? value : '---';
                    }
                    
                    cells[cellIndex].textContent = displayValue;
                });
            }
        } catch (e) {
            console.error(`JSON Parsing Error for ID ${d.id || 'Unknown'}:`, e);
        }
    };

    const init = () => {
        client = mqtt.connect(
            "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
            options
        );
        client.on("connect", () => {
            document.getElementById("conn").innerHTML = "‚úÖ MQTT Connected";
            client.subscribe("politeknik/meter/data");
        });
        client.on("error", err => {
            document.getElementById("conn").innerHTML = "‚ùå MQTT Error";
            console.error("MQTT Connection Error:", err);
        });
        client.on("message", handleMessage);
    };

    return { init };
})();


// --- FUNGSI TAMPILAN REALTIME ---

/**
 * Membuat dan menampilkan Tampilan Monitoring Realtime dengan 18 baris STANDBY.
 */
function createRealtimeView() {
    let html = `
    <table>
        <thead>
        <tr>
            <th class="cell-id">ID</th>
            <th>Status</th>
            <th class="col-v">V (Volt)</th>
            <th class="col-i">I1 (A)</th>
            <th class="col-i">I2 (A)</th>
            <th class="col-i">I3 (A)</th>
            <th class="col-power">P (Watt)</th>
            <th class="col-power">Q (VAR)</th>
            <th class="col-power">S (kVA)</th>
            <th class="col-pf">PF</th>
            <th class="col-pf">Hz</th>
            <th class="col-pf">OpH (Hari/Jam)</th>
            <th class="col-energy">Ea Tot (kWh)</th>
            <th class="col-energy">Er Tot (kVARh)</th>
            <th class="col-energy">Ea Part (kWh)</th>
            <th class="col-energy">Er Part (kVARh)</th>
        </tr>
        </thead>
        <tbody id="tableBodyRealtime">
        </tbody>
    </table>`;

    document.getElementById('content').innerHTML = html;
    const tableBody = document.getElementById("tableBodyRealtime");

    // LOGIKA UTAMA STANDBY: Membuat 18 Baris
    for (let id = 1; id <= MAX_SLAVE_ID; id++) {
        const row = tableBody.insertRow(); 
        devices[id] = row; // Simpan referensi ke objek global 'devices'
        
        // Sel ID
        row.insertCell().textContent = id;
        row.cells[0].className = 'cell-id';
        
        // Sel Status (STANDBY)
        const statusCell = row.insertCell();
        statusCell.textContent = 'STANDBY';
        statusCell.className = 'status-standby';
        
        // Sel Data (---)
        dataMap.forEach(item => {
            const cell = row.insertCell();
            cell.className = item.class;
            cell.textContent = '---'; 
        });
    }
}


// --- FUNGSI TAMPILAN TARIF & SUPABASE API ---

/**
 * Membuat dan menampilkan Tampilan Monitoring Tarif.
 */
function createTarifView() {
    let optionsHtml = '';
    for (let id = 1; id <= MAX_SLAVE_ID; id++) {
        optionsHtml += `<option value="${id}">Mesin ID ${id}</option>`;
    }
    
    // Tampilan Form
    let html = `
    <div class="tarif-form">
        <h3>Filter Data Tarif (Historis)</h3>
        <p style="color: #94A3B8;">Menggunakan Supabase API untuk menampilkan laporan. Pastikan SUPABASE_URL di main.js sudah benar.</p>
        
        <label for="machineId">Pilih Mesin (ID)</label>
        <select id="machineId">
            ${optionsHtml}
        </select>

        <label for="period">Pilih Periode Analisis</label>
        <select id="period">
            <option value="daily">Harian</option>
            <option value="weekly">Mingguan</option>
            <option value="monthly">Bulanan</option>
        </select>
        
        <label for="startDate">Tanggal Mulai Referensi</label>
        <input type="date" id="startDate">

        <button onclick="fetchTarifData()">Tampilkan Data</button>

        <div id="tarifResult" style="margin-top: 30px; border-top: 1px solid #3A3A3A; padding-top: 20px;">
            </div>
    </div>`;

    document.getElementById('content').innerHTML = html;
}

/**
 * Mengambil dan menampilkan data tarif dari Supabase berdasarkan filter.
 */
async function fetchTarifData() {
    const id = document.getElementById('machineId').value;
    const period = document.getElementById('period').value;
    const date = document.getElementById('startDate').value;
    const resultDiv = document.getElementById('tarifResult');
    
    if (!date) {
        resultDiv.innerHTML = '<p style="color: #EF4444;">Harap pilih Tanggal Referensi.</p>';
        return;
    }
    
    resultDiv.innerHTML = '<p style="color: #38BDF8;">Mengambil data dari Supabase...</p>';

    try {
        let dateFrom, dateTo;
        // Logika penentuan rentang tanggal
        const refDate = new Date(date);
        
        if (period === 'daily') {
            dateFrom = new Date(date).toISOString().split('T')[0];
            dateTo = dateFrom; 
        } else if (period === 'weekly') {
            const startOfWeek = new Date(refDate);
            startOfWeek.setDate(refDate.getDate() - refDate.getDay()); 
            dateFrom = startOfWeek.toISOString().split('T')[0];
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            dateTo = endOfWeek.toISOString().split('T')[0];
        } else if (period === 'monthly') {
            const startOfMonth = new Date(refDate.getFullYear(), refDate.getMonth(), 1);
            dateFrom = startOfMonth.toISOString().split('T')[0];
            const endOfMonth = new Date(refDate.getFullYear(), refDate.getMonth() + 1, 0);
            dateTo = endOfMonth.toISOString().split('T')[0];
        }

        // --- PANGGILAN API SUPABASE ---
        const { data, error } = await supabase
            .from('daily_meter_summary') // NAMA TABEL SUPABASE ANDA
            .select('*')
            .eq('meter_id', id)
            .gte('date_key', dateFrom)
            .lte('date_key', dateTo)
            .order('date_key', { ascending: true });

        if (error) throw error;

        // --- TAMPILKAN HASIL ---
        if (data && data.length > 0) {
            let totalKwh = data.reduce((sum, item) => sum + parseFloat(item.total_energy_kwh), 0);
            let totalOpH = data.reduce((sum, item) => sum + parseFloat(item.total_oph_hours), 0);
            
            let htmlResult = `
                <h4 style="color: #4ADE80;">Laporan Tarif Mesin ID ${id}</h4>
                <p>Periode ${period.toUpperCase()}: ${dateFrom} s/d ${dateTo}</p>
                <hr style="border-color: #3A3A3A;">
                <p>Total Energi Konsumsi (${period.toUpperCase()}): <b>${totalKwh.toFixed(2)} kWh</b></p>
                <p>Total Jam Operasi (${period.toUpperCase()}): <b>${totalOpH.toFixed(1)} Jam</b></p>
                
                <h5 style="margin-top: 20px;">Detail Harian:</h5>
                <ul style="list-style-type: none; padding: 0;">
                    ${data.map(item => `
                        <li>üóìÔ∏è ${item.date_key}: ${item.total_energy_kwh} kWh / ${item.total_oph_hours} OpH</li>
                    `).join('')}
                </ul>
            `;
            resultDiv.innerHTML = htmlResult;
            
        } else {
            resultDiv.innerHTML = `<p style="color: #F59E0B;">Tidak ada data historis ditemukan untuk Mesin ID ${id} pada periode tersebut.</p>`;
        }

    } catch (e) {
        console.error("Error fetching data from Supabase:", e);
        resultDiv.innerHTML = `<p style="color: #EF4444;">Gagal mengambil data: ${e.message || 'Cek konfigurasi Supabase.'}</p>`;
    }
}


// --- INISIASI APLIKASI ---
document.addEventListener('DOMContentLoaded', () => {
    // Tampilkan tampilan Realtime secara default saat pertama kali dimuat
    showView('realtime'); 
    // Mulai koneksi MQTT
    mqttClient.init();
});
</script>

</body>
</html>

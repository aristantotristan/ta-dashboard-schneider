<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Energi V15 (Unit Dikonversi)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        h1 { text-align: center; color: #0d47a1; margin-bottom: 5px; }
        h2 { text-align: center; color: #546e7a; font-size: 1.1em; margin-top: 0; margin-bottom: 25px; font-weight: 400; }
        #status { text-align: center; padding: 12px; margin-bottom: 30px; font-weight: 600; color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .bg-ok { background: #2e7d32; } .bg-err { background: #c62828; } .bg-wait { background: #f57c00; }

        .grid { display: grid; grid-template-columns: 1fr; justify-items: center; }
        .card { background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; border-top: 6px solid #90a4ae; transition: all 0.3s ease; width: 100%; max-width: 400px; }
        .card.online { border-top-color: #2e7d32; } 
        
        .card-header { padding: 15px 20px; background: #fafafa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { margin: 0; font-size: 1.2em; color: #37474f; }
        .badge { font-size: 0.75em; padding: 5px 10px; border-radius: 20px; background: #eceff1; color: #b0bec5; font-weight: 700; }
        .badge.on { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }

        .card-body { padding: 15px 20px; }
        .data-table { width: 100%; font-size: 0.9em; border-collapse: separate; border-spacing: 0 5px; }
        .data-table td { vertical-align: middle; padding: 2px 4px; }
        .lbl { color: #78909c; font-weight: 500; }
        .val { text-align: right; font-weight: 700; color: #263238; font-size: 1.15em; }
        .unit { color: #b0bec5; font-size: 0.85em; width: 45px; text-align: right; padding-left: 5px; }
        
        .row-energy { background: #e3f2fd; }
        .row-time { background: #e8f5e9; }

        .update-flash { animation: flash 1s ease-out; }
        @keyframes flash { 0% { background-color: #e8f5e9; } 100% { background-color: #fff; } }
    </style>
</head>
<body>
    <h1>MONITORING ENERGI</h1>
    <h2>PT. Amarilys Karisma Gemilang</h2>
    
    <div id="status" class="bg-wait">Menghubungkan ke Broker MQTT...</div>
    <div class="grid" id="main"></div>

<script>
    // === KONFIGURASI MQTT (SAMA) ===
    const MQTT_HOST = "701d32236feb43b38c22855a611f4d42.s1.eu.hivemq.cloud";
    const MQTT_PORT = 8884;
    const MQTT_USER = "web_dashboard";
    const MQTT_PASS = "Tristan12";
    const MQTT_TOPIC = "politeknik/meter/data";
    // ========================

    const client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "web_v15_solo_" + Date.now());

    function initDashboard() {
        let html = "";
        const i = 1; // Hanya buat kartu ID 1

        // ==========================================================
        // --- LABEL SATUAN HTML DI-UPDATE DI SINI ---
        // ==========================================================
        html += `
        <div class="card" id="c${i}">
            <div class="card-header">
                <h3>Mesin ${i}</h3>
                <span id="s${i}" class="badge">OFFLINE</span>
            </div>
            <div class="card-body">
                <table class="data-table">
                    <tr class="row-energy"><td class="lbl">1. Total Active Energy</td><td class="val" id="e${i}">-</td><td class="unit">kWh</td></tr>
                    <tr class="row-energy"><td class="lbl">2. Total Reactive Energy</td><td class="val" id="q_tot${i}">-</td><td class="unit">kVARh</td></tr>
                    <tr class="row-energy"><td class="lbl">3. Partial Active Energy</td><td class="val" id="e_part${i}">-</td><td class="unit">kWh</td></tr>
                    <tr class="row-energy"><td class="lbl">4. Partial Reactive Energy</td><td class="val" id="q_part${i}">-</td><td class="unit">kVARh</td></tr>
                    <tr class="row-energy"><td class="lbl">5. Tariff 1 Active Energy</td><td class="val" id="e_t1${i}">-</td><td class="unit">kWh</td></tr>

                    <tr><td class="lbl">6. Tegangan (Avg)</td><td class="val" id="v${i}">-</td><td class="unit">V</td></tr>
                    <tr><td class="lbl">7. Arus (Avg)</td><td class="val" id="i${i}">-</td><td class="unit">A</td></tr>
                    
                    <tr><td class="lbl">8. Daya Aktif (P)</td><td class="val" id="p${i}">-</td><td class="unit">W</td></tr>
                    <tr><td class="lbl">9. Daya Reaktif (Q)</td><td class="val" id="q${i}">-</td><td class="unit">VAR</td></tr>
                    <tr><td class="lbl">10. Daya Semu (S)</td><td class="val" id="s${i}">-</td><td class="unit">kVA</td></tr>
                    
                    <tr><td class="lbl">11. Power Factor (PF)</td><td class="val" id="pf${i}">-</td><td class="unit">PF</td></tr>
                    <tr><td class="lbl">12. Frekuensi</td><td class="val" id="hz${i}">-</td><td class="unit">Hz</td></tr>
                    
                    <tr class="row-time"><td class="lbl">13. Operation Time</td><td class="val" id="op_time${i}">-</td><td class="unit">Jam</td></tr>
                </table>
            </div>
        </div>`;
        
        document.getElementById("main").innerHTML = html;
        startConnection();
    }

    // ... (Fungsi startConnection, onConnect, onConnectionLost SAMA) ...
    function startConnection() {
        setStatus("Menghubungkan...", "bg-wait");
        client.connect({
            useSSL: true, userName: MQTT_USER, password: MQTT_PASS,
            onSuccess: onConnect,
            onFailure: (e) => { setStatus("Gagal Terhubung: " + e.errorMessage, "bg-err"); setTimeout(startConnection, 5000); }
        });
    }
    function onConnect() {
        setStatus("ONLINE - MONITORING AKTIF", "bg-ok");
        client.subscribe(MQTT_TOPIC);
    }
    client.onConnectionLost = (r) => { if (r.errorCode !== 0) { setStatus("⚠️ Koneksi Terputus. Menyambung ulang...", "bg-wait"); setTimeout(startConnection, 5000); }};
    client.onMessageArrived = (m) => { try { updateMeter(JSON.parse(m.payloadString)); } catch (e) { console.error(e); }};

    // Helper (SAMA)
    const fmt = (val, dig) => (val != null && !isNaN(val)) ? Number(val).toFixed(dig) : "-";
    const fmt_large = (val) => (val != null && !isNaN(val)) ? Number(val).toLocaleString('id-ID') : "-";

    // Fungsi updateMeter (SAMA)
    function updateMeter(d) {
        const id = d.id; if (!id) return;
        if (id !== 1) return; // Hanya proses ID 1
        if (d.status === "offline") {
            setMeterOffline(id);
        } else {
            setMeterOnline(id, d);
        }
    }

    // ==========================================================
    // --- FORMAT ANGKA DISESUAIKAN DENGAN UNIT BARU ---
    // ==========================================================
    function setMeterOnline(id, d) {
        const badge = document.getElementById(`s${id}`);
        badge.textContent = "ONLINE";
        badge.className = "badge on";
        document.getElementById(`c${id}`).classList.add("online");

        // Grup Energi (kWh/kVARh - pakai 2 desimal)
        document.getElementById(`e${id}`).textContent  = fmt(d.e, 2);
        document.getElementById(`q_tot${id}`).textContent = fmt(d.q_tot, 2);
        document.getElementById(`e_part${id}`).textContent  = fmt(d.e_part, 2);
        document.getElementById(`q_part${id}`).textContent  = fmt(d.q_part, 2);
        document.getElementById(`e_t1${id}`).textContent  = fmt(d.e_t1, 2);
        
        // Grup V & I (Sama)
        document.getElementById(`v${id}`).textContent  = fmt(d.v, 1);
        document.getElementById(`i${id}`).textContent  = fmt(d.i, 3);
        
        // Grup P,Q,S (W/VAR pakai 0 desimal, kVA pakai 2 desimal)
        document.getElementById(`p${id}`).textContent  = fmt(d.p, 0); 
        document.getElementById(`q${id}`).textContent  = fmt(d.q, 0); 
        document.getElementById(`s${id}`).textContent  = fmt(d.s, 2); 
        
        // Grup PF & Freq (Sama)
        document.getElementById(`pf${id}`).textContent = fmt(d.pf, 2);
        document.getElementById(`hz${id}`).textContent = fmt(d.hz, 1);
        
        // Grup Waktu (Jam - pakai 1 desimal)
        document.getElementById(`op_time${id}`).textContent = fmt(d.op_time, 1);
        
        const cb = document.getElementById(`c${id}`).querySelector('.card-body');
        cb.classList.remove("update-flash"); void cb.offsetWidth; cb.classList.add("update-flash");
    }

    // Fungsi setMeterOffline (SAMA, me-reset semua 13 parameter)
    function setMeterOffline(id) {
        const badge = document.getElementById(`s${id}`);
        badge.textContent = "OFFLINE";
        badge.className = "badge"; 
        document.getElementById(`c${id}`).classList.remove("online"); 

        document.getElementById(`e${id}`).textContent  = "-";
        document.getElementById(`q_tot${id}`).textContent = "-";
        document.getElementById(`e_part${id}`).textContent  = "-";
        document.getElementById(`q_part${id}`).textContent  = "-";
        document.getElementById(`e_t1${id}`).textContent  = "-";
        document.getElementById(`v${id}`).textContent  = "-";
        document.getElementById(`i${id}`).textContent  = "-";
        document.getElementById(`p${id}`).textContent  = "-";
        document.getElementById(`q${id}`).textContent  = "-";
        document.getElementById(`s${id}`).textContent  = "-";
        document.getElementById(`pf${id}`).textContent = "-";
        document.getElementById(`hz${id}`).textContent = "-";
        document.getElementById(`op_time${id}`).textContent = "-";
    }

    function setStatus(msg, cls) { const s = document.getElementById("status"); s.textContent = msg; s.className = cls; }
    initDashboard();
</script>
</body>
</html>

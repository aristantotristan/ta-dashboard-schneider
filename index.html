<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TA Monitoring Schneider (Supabase)</title>
    <!-- Kita akan menggunakan 'Supabase.js' untuk mempermudah koneksi -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { color: #3ecf8e; border-bottom: 2px solid #3ecf8e; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #3ecf8e; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .status { font-size: 0.9em; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Dashboard Monitoring Schneider iEM3255 (Supabase + Vercel)</h1>
        <p class="status" id="status-message">Menghubungkan ke Database Supabase...</p>
        <table>
            <thead>
                <tr>
                    <th>ID Meter</th>
                    <th>Tegangan (V)</th>
                    <th>Arus (A)</th>
                    <th>Daya Aktif (W)</th>
                    <th>Frekuensi (Hz)</th>
                    <th>Energi (kWh)</th>
                    <th>Biaya (Rp)</th>
                    <th>Update Terakhir</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Data akan diisi oleh JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        // --- üî• KONFIGURASI (WAJIB DIISI!) ---
        // Ganti dengan nilai dari FASE 1, Langkah 4 (Supabase API Settings)
        
        const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";     // <-- GANTI INI
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs"; // <-- GANTI INI

        // --- Inisialisasi Supabase Client ---
        let _supabase;
        try {
             _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
             console.log("Supabase client initialized.");
        } catch (e) {
            console.error("Gagal inisialisasi Supabase. Cek URL dan Key.");
            document.getElementById('status-message').textContent = "ERROR: Gagal inisialisasi Supabase. Cek URL dan Key.";
        }


        const tableBody = document.getElementById('table-body');
        const statusMessage = document.getElementById('status-message');
        const MAX_METERS = 18;

        // Inisialisasi tabel dengan 18 baris kosong
        function initializeTable() {
            tableBody.innerHTML = ''; // Kosongkan dulu
            for (let i = 1; i <= MAX_METERS; i++) {
                const row = tableBody.insertRow();
                row.id = `meter-${i}`; // Beri ID unik untuk setiap baris
                row.innerHTML = `
                    <td>${i}</td>
                    <td>0.00 V</td>
                    <td>0.000 A</td>
                    <td>0.00 W</td>
                    <td>0.00 Hz</td>
                    <td>0.00 kWh</td>
                    <td>Rp 0.00</td>
                    <td>Menunggu data...</td>
                `;
                row.style.backgroundColor = '#ffdddd'; // Tandai sebagai offline
            }
        }

        // Fungsi untuk mengambil data terbaru dari Supabase
        async function fetchData() {
            if (!_supabase) return; // Jangan jalankan jika Supabase gagal inisialisasi

            try {
                statusMessage.textContent = "Mengambil data terbaru dari Supabase...";
                
                // --- üî• PERBAIKAN: Menggunakan query SELECT sederhana ---
                // Mengambil 100 data terbaru (mencakup semua 18 meter)
                let { data, error } = await _supabase
                    .from('meter_data')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(100); // Ambil 100 data terbaru

                if (error) {
                    statusMessage.textContent = `‚ùå GAGAL query data: ${error.message}.`;
                    console.error("Fetch Error:", error.message);
                    return; 
                }

                if (data) {
                    // Filter data di JavaScript untuk mendapatkan data unik terbaru per meter
                    const latestDataMap = new Map();
                    data.forEach(row => {
                        if (!latestDataMap.has(row.meter_id)) {
                            latestDataMap.set(row.meter_id, row);
                        }
                    });
                    
                    updateTable(Array.from(latestDataMap.values()));
                    statusMessage.textContent = "Data berhasil diperbarui: " + new Date().toLocaleTimeString();
                }

            } catch (error) {
                console.error("Error fetching data:", error.message);
                statusMessage.textContent = `‚ùå GAGAL mengambil data: ${error.message}`;
            }
        }

        // Fungsi untuk memperbarui tabel HTML
        function updateTable(meters) {
            // Reset semua baris ke offline dulu
            for (let i = 1; i <= MAX_METERS; i++) {
                 const row = document.getElementById(`meter-${i}`);
                 if (row) {
                    row.style.backgroundColor = '#ffdddd'; // Offline
                    // Jangan reset innerHTML agar data lama tetap terlihat jika 1 meter offline
                 }
            }
            
            // Update baris yang datanya masuk
            meters.forEach(meter => {
                const row = document.getElementById(`meter-${meter.meter_id}`);
                if (row) {
                    row.innerHTML = `
                        <td>${meter.meter_id}</td>
                        <td>${meter.voltage.toFixed(2)} V</td>
                        <td>${meter.current.toFixed(3)} A</td>
                        <td>${meter.power.toFixed(2)} W</td>
                        <td>${meter.frequency.toFixed(2)} Hz</td>
                        <td>${meter.energy.toFixed(2)} kWh</td>
                        <td>Rp ${meter.cost.toFixed(2)}</td>
                        <td>${new Date(meter.timestamp).toLocaleTimeString()}</td>
                    `;
                    // Tandai sebagai online jika data valid (V > 0)
                    if (meter.voltage > 0) {
                        row.style.backgroundColor = 'transparent'; 
                    }
                }
            });
        }

        // --- Inisialisasi ---
        initializeTable(); // Buat tabel kosong
        fetchData(); // Ambil data pertama kali
        setInterval(fetchData, 5000); // Refresh data setiap 5 detik
    </script>
</body>
</html>


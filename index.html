<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Power Meter Dashboard</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f0f0f;
  color: #fff;
}

h2 {
  text-align: center;
}

/* STATUS BAR */
#statusBar {
  margin: 10px auto;
  width: 90%;
  padding: 10px;
  border: 1px solid #333;
  background: #1a1a1a;
}

.online { color: #00ff88; }
.offline { color: #ff4444; }
.waiting { color: orange; }

/* DASHBOARD */
.container {
  display: flex;
  justify-content: center;
  gap: 20px;
}

.machine-list {
  width: 200px;
  border: 1px solid #333;
  background: #1c1c1c;
}

.machine-item {
  padding: 10px;
  border-bottom: 1px solid #333;
  cursor: pointer;
}

.machine-item.active {
  background: #333;
}

.param-table {
  width: 500px;
  border-collapse: collapse;
  background: #1c1c1c;
}

.param-table th,
.param-table td {
  border: 1px solid #333;
  padding: 8px;
}

.param-table th {
  background: #2a2a2a;
  width: 60%;
}
</style>
</head>

<body>

<h2>⚡ Power Meter Dashboard</h2>

<!-- MQTT STATUS -->
<div id="statusBar">
  MQTT : <span id="mqttStatus" class="waiting">CONNECTING...</span><br>
  Mesin 1 : <span id="machineStatus" class="offline">OFFLINE</span>
</div>

<div class="container">

  <!-- MACHINE LIST -->
  <div class="machine-list">
    <div class="machine-item active">Mesin 1</div>
  </div>

  <!-- PARAMETER TABLE -->
  <table class="param-table">
    <tr><th>Total Ea (kWh)</th><td id="EaT">0</td></tr>
    <tr><th>Total Er (kVARh)</th><td id="ErT">0</td></tr>
    <tr><th>Partial Ea (kWh)</th><td id="EaP">0</td></tr>
    <tr><th>Partial Er (kVARh)</th><td id="ErP">0</td></tr>
    <tr><th>Voltage (V)</th><td id="V">0</td></tr>
    <tr><th>Current I1 (A)</th><td id="I1">0</td></tr>
    <tr><th>Current I2 (A)</th><td id="I2">0</td></tr>
    <tr><th>Current I3 (A)</th><td id="I3">0</td></tr>
    <tr><th>Active Power (W)</th><td id="P">0</td></tr>
    <tr><th>Reactive Power (VAR)</th><td id="Q">0</td></tr>
    <tr><th>Apparent Power (kVA)</th><td id="S">0</td></tr>
    <tr><th>Power Factor</th><td id="PF">0</td></tr>
    <tr><th>Frequency (Hz)</th><td id="Hz">0</td></tr>
    <tr><th>Operation Time (h)</th><td id="OpH">0</td></tr>
  </table>

</div>

<script>
// ================= MQTT SETUP =================
const options = {
  username: "vercel_client",
  password: "VercelPass123!",
  reconnectPeriod: 2000
};

const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  options
);

const mqttStatus = document.getElementById("mqttStatus");
const machineStatus = document.getElementById("machineStatus");

client.on("connect", () => {
  mqttStatus.innerText = "CONNECTED ✅";
  mqttStatus.className = "online";
  client.subscribe("politeknik/meter/data");
});

client.on("reconnect", () => {
  mqttStatus.innerText = "RECONNECTING...";
  mqttStatus.className = "waiting";
});

client.on("offline", () => {
  mqttStatus.innerText = "DISCONNECTED ❌";
  mqttStatus.className = "offline";
});

client.on("error", () => {
  mqttStatus.innerText = "ERROR ❌";
  mqttStatus.className = "offline";
});

// ================= DATA HANDLING =================
const fields = [
  "EaT","ErT","EaP","ErP","V",
  "I1","I2","I3",
  "P","Q","S","PF","Hz","OpH"
];

let lastUpdateTimer = null;

client.on("message", (topic, message) => {
  const data = JSON.parse(message.toString());

  if (data.id !== 1) return;

  // STATUS MESIN
  if (data.status === "online") {
    machineStatus.innerText = "ONLINE ✅";
    machineStatus.className = "online";
  } else {
    machineStatus.innerText = "OFFLINE ❌";
    machineStatus.className = "offline";
  }

  // UPDATE DATA
  fields.forEach(f => {
    if (data[f] !== undefined && data[f] !== null) {
      document.getElementById(f).innerText = data[f];
    }
  });

  // TIMEOUT OFFLINE DETECTION
  if (lastUpdateTimer) clearTimeout(lastUpdateTimer);
  lastUpdateTimer = setTimeout(() => {
    machineStatus.innerText = "OFFLINE (TIMEOUT)";
    machineStatus.className = "offline";
  }, 35000);
});
</script>

</body>
</html>

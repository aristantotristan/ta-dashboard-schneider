<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Dashboard Energi — Mobile</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#071022; --card:#0f1724; --muted:#9fb0c2; --accent:#34d399; --danger:#fb7185;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg),#05111a);color:#e6f0f6}
  .app{max-width:900px;margin:0 auto;padding:14px}
  header{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:8px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#0ea5a0,#34d399);display:flex;align-items:center;justify-content:center;color:#001;font-weight:700}
  h1{font-size:18px;margin:0}
  p.sub{margin:0;color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
  .big{grid-column:1/-1}
  .stat{font-size:20px;font-weight:700;color:#fff}
  .muted{color:var(--muted);font-size:12px}
  .btn{background:#0ea5a0;color:#022;font-weight:700;padding:8px 10px;border-radius:10px;border:none;cursor:pointer}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center}
  .small{font-size:12px;color:var(--muted)}
  .chart-wrap{height:220px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:6px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03)}
  .center{display:flex;align-items:center;gap:8px}
  footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
  @media(min-width:720px){
    .grid{grid-template-columns:repeat(3,1fr)}
    .big{grid-column:1/-1}
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">AKG</div>
        <div>
          <h1>Monitoring Energi — PT Amarilys</h1>
          <p class="sub">Realtime • WBP 17:00–22:00 • LWBP lainnya</p>
        </div>
      </div>
      <div class="center">
        <button id="btnRefresh" class="btn secondary">Refresh</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="small">Terakhir (live)</div>
        <div id="lastTs" class="muted small">—</div>
        <div style="height:8px"></div>
        <div class="stat" id="lastKwh">- kWh</div>
        <div class="small" id="lastPower">P: - W • V: - V • I: - A</div>
      </div>

      <div class="card">
        <div class="small">Hari ini — LWBP</div>
        <div class="stat" id="sumLWBP">- kWh</div>
        <div class="small" id="costLWBP">Rp -</div>
      </div>

      <div class="card">
        <div class="small">Hari ini — WBP</div>
        <div class="stat" id="sumWBP">- kWh</div>
        <div class="small" id="costWBP">Rp -</div>
      </div>

      <div class="card big">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div class="small">Ringkasan Biaya Hari Ini</div><div class="stat" id="totalCost">Rp -</div></div>
          <div>
            <button id="btnExportDaily" class="btn">Export CSV</button>
          </div>
        </div>
        <div style="height:10px"></div>

        <div class="chart-wrap card" style="padding:8px;background:transparent;border-radius:8px">
          <canvas id="chartHourly" style="width:100%;height:100%"></canvas>
        </div>
      </div>

      <div class="card big">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><div class="small">Log Terbaru</div><div class="small muted" id="logCount">—</div></div>
          <div>
            <button id="btnExportLog" class="btn secondary">Export Log CSV</button>
          </div>
        </div>

        <div style="max-height:260px;overflow:auto">
          <table>
            <thead><tr><th>Waktu</th><th>KWh</th><th>Δ kWh</th><th>Periode</th></tr></thead>
            <tbody id="logRows"></tbody>
          </table>
        </div>
      </div>
    </div>

    <footer>Build for PT Amarilys • Data bersumber dari Supabase</footer>
  </div>

<script>
/* ================= CONFIG (ganti kalau perlu) ================= */
const SUPA_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";

/* endpoints */
const ENDPOINT_CALC = "/rest/v1/energy_calc";      // view
const ENDPOINT_DAILY = "/rest/v1/energy_daily";    // table of daily summary
const ENDPOINT_LOG  = "/rest/v1/energy_log";       // raw log table

/* Tarif (subsidi) */
const TARIF = 996.74;

/* helper headers */
const HEADERS = {
  "apikey": SUPA_KEY,
  "Authorization": "Bearer " + SUPA_KEY,
  "Content-Type": "application/json"
};

/* DOM */
const lastKwh = document.getElementById("lastKwh");
const lastPower = document.getElementById("lastPower");
const lastTs = document.getElementById("lastTs");
const sumLWBP = document.getElementById("sumLWBP");
const sumWBP = document.getElementById("sumWBP");
const costLWBP = document.getElementById("costLWBP");
const costWBP = document.getElementById("costWBP");
const totalCost = document.getElementById("totalCost");
const logRows = document.getElementById("logRows");
const logCount = document.getElementById("logCount");
const btnRefresh = document.getElementById("btnRefresh");
const btnExportDaily = document.getElementById("btnExportDaily");
const btnExportLog = document.getElementById("btnExportLog");

/* chart */
let hourlyChart = null;

/* ================= HELPERS ================= */
function supaFetch(path, opts = {}) {
  return fetch(SUPA_URL + path, { headers: HEADERS, ...opts })
    .then(r => {
      if (!r.ok) return r.text().then(t => { throw new Error(`${r.status} ${t}`); });
      return r.json();
    });
}

function toDateLocalString(ts) {
  try {
    const d = new Date(ts);
    return d.toLocaleString();
  } catch (e) { return ts; }
}

function formatRp(v) {
  if (v === null || v === undefined) return "-";
  return "Rp " + Math.round(v).toLocaleString('id-ID');
}

/* ================= CORE ================= */

/** load latest live sample + small history */
async function loadLive() {
  try {
    // latest sample
    const last = await supaFetch(`${ENDPOINT_CALC}?select=ts,total_kwh,delta_kwh,power,voltage,is_wbp&order=ts.desc&limit=1`);
    if (last && last.length) {
      const row = last[0];
      lastKwh.innerText = (row.total_kwh || 0).toFixed(6) + " kWh";
      lastPower.innerText = `P: ${row.power?row.power.toFixed(1):"-"} W • V: ${row.voltage?row.voltage.toFixed(1):"-"} V • ${row.is_wbp ? "WBP" : "LWBP"}`;
      lastTs.innerText = toDateLocalString(row.ts || row.timestamp || new Date().toISOString());
    } else {
      lastKwh.innerText = "- kWh";
      lastPower.innerText = "-";
      lastTs.innerText = "-";
    }

    // latest 100 for log
    const logs = await supaFetch(`${ENDPOINT_CALC}?select=ts,total_kwh,delta_kwh,is_wbp&order=ts.desc&limit=100`);
    logRows.innerHTML = "";
    let cnt = 0;
    logs.forEach(r => {
      cnt++;
      const tr = document.createElement("tr");
      const d = new Date(r.ts);
      tr.innerHTML = `<td>${d.toLocaleTimeString()}</td>
                      <td>${(r.total_kwh||0).toFixed(6)}</td>
                      <td>${(r.delta_kwh||0).toFixed(6)}</td>
                      <td>${r.is_wbp ? 'WBP' : 'LWBP'}</td>`;
      logRows.appendChild(tr);
    });
    logCount.innerText = `${cnt} entries`;
  } catch (e) {
    console.error("loadLive:", e);
  }
}

/** load daily summary (today) and update UI + chart */
async function loadDailyAndChart() {
  try {
    // Get today (ISO date)
    const d = new Date(); d.setHours(0,0,0,0);
    const iso = d.toISOString().slice(0,10);

    // Fetch daily calc view grouped per hour (using energy_calc)
    // We will fetch recent energy_calc for today and aggregate by hour
    const rows = await supaFetch(`${ENDPOINT_CALC}?select=ts,delta_kwh,is_wbp&ts=gte.${iso}T00:00:00Z&order=ts.asc`);
    // aggregate per hour
    const hours = Array.from({length:24},(_,i)=>0);
    let totalWBP=0, totalLWBP=0;
    rows.forEach(r=>{
      const hh = new Date(r.ts).getHours();
      hours[hh] += (r.delta_kwh||0);
      if (r.is_wbp) totalWBP += (r.delta_kwh||0); else totalLWBP += (r.delta_kwh||0);
    });

    sumLWBP.innerText = totalLWBP.toFixed(3) + " kWh";
    sumWBP.innerText = totalWBP.toFixed(3) + " kWh";
    const costL = totalLWBP * TARIF;
    const costW = totalWBP * TARIF;
    costLWBP.innerText = formatRp(costL);
    costWBP.innerText = formatRp(costW);
    totalCost.innerText = formatRp(costL + costW);

    // build chart
    const ctx = document.getElementById('chartHourly').getContext('2d');
    if (hourlyChart) hourlyChart.destroy();
    hourlyChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Array.from({length:24},(_,i)=>String(i).padStart(2,'0') + ':00'),
        datasets: [{
          label: 'kWh per jam',
          data: hours
        }]
      },
      options: { plugins:{legend:{display:false}}, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });

  } catch (e) { console.error("loadDailyAndChart:", e); }
}

/* ========== Export helpers ========== */
function downloadCSV(filename, rows) {
  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

async function exportDailyCSV() {
  try {
    const dayRows = await supaFetch(`${ENDPOINT_DAILY}?select=day,lwbp_kwh,wbp_kwh,cost_lwbp,cost_wbp,total_cost&order=day.desc`);
    const rows = [["day","lwbp_kwh","wbp_kwh","cost_lwbp","cost_wbp","total_cost"]];
    dayRows.forEach(r => rows.push([r.day, r.lwbp_kwh, r.wbp_kwh, r.cost_lwbp, r.cost_wbp, r.total_cost]));
    downloadCSV('energy_daily.csv', rows);
  } catch(e){ alert("Gagal export: "+e.message); console.error(e); }
}

async function exportLogCSV() {
  try {
    const logs = await supaFetch(`${ENDPOINT_CALC}?select=ts,total_kwh,delta_kwh,is_wbp&order=ts.desc&limit=1000`);
    const rows = [["ts","total_kwh","delta_kwh","is_wbp"]];
    logs.forEach(r=> rows.push([r.ts, r.total_kwh, r.delta_kwh, r.is_wbp]));
    downloadCSV('energy_log.csv', rows);
  } catch(e){ alert("Gagal export: "+e.message); console.error(e); }
}

/* ========== init & handlers ========== */
btnRefresh.addEventListener('click', ()=>{ loadAll(); });
btnExportDaily.addEventListener('click', exportDailyCSV);
btnExportLog.addEventListener('click', exportLogCSV);

async function loadAll() {
  await loadLive();
  await loadDailyAndChart();
}

/* auto refresh */
loadAll();
setInterval(loadAll, 5000);
</script>
</body>
</html>

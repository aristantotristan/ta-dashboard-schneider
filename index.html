<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Monitoring Energi — PT Amarilys</title>

<!-- MQTT.js -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: Inter, Roboto, Arial; background:#0f172a; color:#e6eef8; margin:0; padding:20px;}
  .card { background:#0b1220; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.6); }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px;}
  h1 { margin:0; color:#7ef0c7; }
  .btn { display:inline-block; padding:10px 14px; border-radius:8px; background:#063b3b; color:#c9fff0; cursor:pointer; margin-right:8px; }
  .btn.primary { background:#0ea5a0; color:#002; }
  nav { margin-bottom:14px; }
  #container { display:grid; grid-template-columns: 1fr; gap:16px; }
  table { width:100%; border-collapse:collapse; color:#cfe9f1; font-size:13px; }
  th, td { padding:8px 6px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:center; }
  thead th { color:#7ef0c7; font-weight:700; }
  .status-online { color:#10b981; font-weight:700; } .status-offline { color:#ef4444; font-weight:700; }
  .hidden { display:none; }
  .form-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  input[type=number] { padding:8px; border-radius:6px; border:1px solid #21303a; background:#071220; color:#e6eef8; }
</style>
</head>
<body>

<header>
  <h1>⚡ Monitoring Energi — PT Amarilys Karisma Gemilang</h1>
  <div>
    <button id="btnHome" class="btn">Home</button>
    <button id="btnRealtime" class="btn">Monitoring Real-Time</button>
    <button id="btnTarif" class="btn">Monitoring Tarif Mesin</button>
  </div>
</header>

<main id="container">
  <!-- HOME -->
  <section id="pageHome" class="card">
    <h2>Selamat datang</h2>
    <p>Pilih menu:</p>
    <div style="margin-top:12px;">
      <button id="goRealtime" class="btn primary">Monitoring Real-Time</button>
      <button id="goTarif" class="btn">Monitoring Tarif Mesin</button>
    </div>
  </section>

  <!-- REALTIME -->
  <section id="pageRealtime" class="card hidden">
    <h2>Monitoring Real-Time (18 Mesin)</h2>
    <p id="conn">Connecting to MQTT...</p>
    <div style="overflow:auto; max-height:60vh;">
      <table id="rtTable">
        <thead>
          <tr>
            <th>ID</th><th>Status</th><th>V</th><th>I1</th><th>I2</th><th>I3</th><th>P (W)</th><th>Q</th><th>S</th><th>PF</th><th>Hz</th><th>OpH</th><th>EAT</th><th>EAP</th><th>Biaya Hari (Rp)</th>
          </tr>
        </thead>
        <tbody id="rtBody">
          <tr><td colspan="15" style="padding:30px; color:#94a3b8;">Awaiting data...</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- TARIF -->
  <section id="pageTarif" class="card hidden">
    <h2>Monitoring Tarif Mesin</h2>
    <div class="form-row">
      <label>Tarif per kWh (Rp):</label>
      <input id="inputTarif" type="number" step="0.01" />
      <button id="saveTarif" class="btn">Update Tarif</button>
      <span id="tarifStatus" style="margin-left:12px;color:#9fd8c9"></span>
    </div>

    <div style="margin-top:12px;">
      <strong>Ringkasan Hari Ini:</strong>
      <div id="summaryToday" style="margin-top:8px; color:#cfe9f1;">-</div>
    </div>

    <div style="margin-top:16px;">
      <canvas id="chartEnergy" width="800" height="300"></canvas>
    </div>
  </section>
</main>

<script>
/* =================== CONFIG =================== 
   Masukkan nilai Supabase & MQTT mu di sini
*/
const SUPABASE_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs"; // caution
const MQTT_WS = "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_USER = "vercel_client";
const MQTT_PASS = "VercelPass123!";
const MQTT_TOPIC = "politeknik/meter/data";
const MESIN_COUNT = 18;
/* ============================================== */

///// --- UI navigation
const pageHome = document.getElementById("pageHome");
const pageRealtime = document.getElementById("pageRealtime");
const pageTarif = document.getElementById("pageTarif");

document.getElementById("btnHome").onclick = () => showPage("home");
document.getElementById("btnRealtime").onclick = () => showPage("realtime");
document.getElementById("btnTarif").onclick = () => showPage("tarif");
document.getElementById("goRealtime").onclick = () => showPage("realtime");
document.getElementById("goTarif").onclick = () => showPage("tarif");

function showPage(p){
  pageHome.classList.add("hidden");
  pageRealtime.classList.add("hidden");
  pageTarif.classList.add("hidden");
  if (p === "home") pageHome.classList.remove("hidden");
  if (p === "realtime") pageRealtime.classList.remove("hidden");
  if (p === "tarif") { pageTarif.classList.remove("hidden"); loadTarifAndSummary(); }
}

/* ========== MQTT Real-time ========== */
const client = mqtt.connect(MQTT_WS, {
  username: MQTT_USER,
  password: MQTT_PASS,
  reconnectPeriod: 2000
});

const connEl = document.getElementById("conn");
const rtBody = document.getElementById("rtBody");
const devices = {}; // id -> row
const tarifCache = { value: null }; // current tariff

client.on("connect", () => {
  connEl.textContent = "✅ MQTT Connected";
  client.subscribe(MQTT_TOPIC);
});
client.on("error", (e) => { connEl.textContent = "❌ MQTT Error"; console.error(e); });
client.on("message", (topic, msg) => {
  try {
    const d = JSON.parse(msg.toString());
    const id = d.id;
    if (!devices[id]) {
      const row = rtBody.insertRow();
      devices[id] = row;
      row.insertCell().textContent = id;
      row.cells[0].className = "cell-id";
      row.insertCell().textContent = d.status;
      for (let i=0;i<13;i++){ row.insertCell().textContent = '---'; }
      // remove placeholder row
      if (rtBody.rows.length>1 && rtBody.rows[0].cells[0].colSpan === 15) rtBody.deleteRow(0);
    }
    const row = devices[d.id];
    const cells = row.cells;
    cells[1].textContent = (d.status || '').toUpperCase();
    cells[1].className = d.status === "online" ? "status-online" : "status-offline';
    // mapping: V,I1,I2,I3,P,Q,S,PF,Hz,OpH,EaT,EaP, biaya
    const mapping = ['V','I1','I2','I3','P','Q','S','PF','Hz','OpH','EaT','EaP'];
    mapping.forEach((k, idx) => {
      let val = d[k];
      if (k === 'P') { val = (val===undefined || val===null) ? '---' : val + ' W'; }
      if (k === 'EaT' || k === 'EaP') { val = (val===undefined || val===null) ? '---' : val + ' kWh'; }
      cells[idx+2].textContent = (val===0 || val) ? val : '---';
    });
    // Biaya hari = EaP * tarif (if tarif loaded)
    let biayaText = '---';
    if (tarifCache.value !== null && (d.EaP === 0 || d.EaP)) {
      const biaya = parseFloat(d.EaP) * parseFloat(tarifCache.value);
      biayaText = Math.round(biaya);
    }
    cells[14].textContent = biayaText === '---' ? '---' : biayaText.toLocaleString('id-ID');
  } catch (e) { console.error("parse error", e); }
});

/* ========== SUPABASE helper ========== */
async function supabaseGetTarif() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/tariff?id=eq.1`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });
  if (!res.ok) throw new Error("Failed fetch tarif");
  const arr = await res.json();
  if (arr.length) return arr[0].tarif_per_kwh;
  return null;
}

async function supabaseUpdateTarif(val) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/tariff?id=eq.1`, {
    method: 'PATCH',
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      'Content-Type':'application/json',
      Prefer: 'return=representation'
    },
    body: JSON.stringify({ tarif_per_kwh: val })
  });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error('Update failed: ' + txt);
  }
  return await res.json();
}

// Load tarif & summary when opening page Tarif
document.getElementById("saveTarif").onclick = async () => {
  const v = parseFloat(document.getElementById("inputTarif").value);
  if (isNaN(v)) return alert("Masukkan angka tarif");
  document.getElementById("tarifStatus").textContent = "Saving...";
  try {
    await supabaseUpdateTarif(v);
    document.getElementById("tarifStatus").textContent = "Saved ✅";
    tarifCache.value = v;
    setTimeout(()=>document.getElementById("tarifStatus").textContent='', 2000);
    loadTarifAndSummary();
  } catch (e) {
    console.error(e);
    document.getElementById("tarifStatus").textContent = "Error ❌";
  }
};

async function loadTarifAndSummary(){
  try {
    const t = await supabaseGetTarif();
    tarifCache.value = t;
    document.getElementById("inputTarif").value = t;
    // fetch today's energy totals (sum EAP for each mesin for today)
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
    const res = await fetch(`${SUPABASE_URL}/rest/v1/energy_history?ts=gte.${start}`, {
      headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
    });
    if (!res.ok) throw new Error("Failed load history");
    const rows = await res.json();
    // aggregate EAP per mesin for today
    const sumByMesin = {};
    rows.forEach(r => {
      const id = r.mesin_id;
      sumByMesin[id] = (sumByMesin[id] || 0) + (r.eap ? parseFloat(r.eap) : 0);
    });
    // total biaya hari ini
    let totalE = 0;
    for (let m in sumByMesin) totalE += sumByMesin[m];
    const totalCost = totalE * parseFloat(t);
    document.getElementById("summaryToday").textContent =
      `Total energi hari ini: ${totalE.toFixed(3)} kWh • Est. biaya: Rp ${Math.round(totalCost).toLocaleString('id-ID')}`;
    // build simple daily chart (sum per hour)
    buildChart(rows);
  } catch (e) {
    console.error(e); document.getElementById("summaryToday").textContent = "Gagal load data.";
  }
}

/* Chart - simple histogram (hourly) */
let chartInstance = null;
function buildChart(rows) {
  // group by hour
  const byHour = {};
  rows.forEach(r => {
    const d = new Date(r.ts);
    const hour = d.getHours();
    byHour[hour] = (byHour[hour] || 0) + (r.eap ? parseFloat(r.eap) : 0);
  });
  const labels = Array.from({length:24}, (_,i) => `${i}:00`);
  const data = labels.map((_,i) => byHour[i] || 0);
  const ctx = document.getElementById('chartEnergy').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{ label: 'kWh per Jam (hari ini)', data: data }]
    },
    options: { responsive: true, plugins: { legend: { display:false } } }
  });
}

/* initialize: show home */
showPage('home');

/* Try load tarif at start (if page stays in realtime this still caches tarif) */
supabaseGetTarif().then(t => { tarifCache.value = t; document.getElementById("inputTarif").value = t; }).catch(e=>console.warn(e));
</script>
</body>
</html>

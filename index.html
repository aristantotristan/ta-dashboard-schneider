<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>⚡ Power Meter Dashboard</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
  body {
    background:#111;
    font-family:Arial, sans-serif;
    color:#fff;
  }
  h2 {
    text-align:center;
    margin-bottom:5px;
  }
  .status {
    text-align:center;
    margin-bottom:20px;
    font-weight:bold;
  }
  .online { color:#00ff88; }
  .offline { color:#ff4444; }

  table {
    margin:auto;
    width:70%;
    border-collapse:collapse;
    background:#1c1c1c;
  }
  th, td {
    padding:8px 12px;
    border:1px solid #444;
  }
  th {
    width:50%;
    background:#222;
    text-align:left;
  }
  td {
    background:#111;
    text-align:right;
  }
</style>
</head>

<body>

<h2>⚡ Power Meter Dashboard</h2>
<div class="status" id="connStatus">Status: Connecting...</div>

<table>
<tr><th>Status</th><td id="status">-</td></tr>

<tr><th>Voltage (V)</th><td id="V">-</td></tr>
<tr><th>Current I1 (A)</th><td id="I1">-</td></tr>
<tr><th>Current I2 (A)</th><td id="I2">-</td></tr>
<tr><th>Current I3 (A)</th><td id="I3">-</td></tr>

<tr><th>Active Power P (W)</th><td id="P">-</td></tr>
<tr><th>Reactive Power Q (VAR)</th><td id="Q">-</td></tr>
<tr><th>Apparent Power S (kVA)</th><td id="S">-</td></tr>

<tr><th>Power Factor</th><td id="PF">-</td></tr>
<tr><th>Frequency (Hz)</th><td id="Hz">-</td></tr>

<tr><th>Total Energy (kWh)</th><td id="EaT">-</td></tr>
<tr><th>Total Reactive (kVARh)</th><td id="ErT">-</td></tr>

<tr><th>Partial Energy (kWh)</th><td id="EaP">-</td></tr>
<tr><th>Partial Reactive (kVARh)</th><td id="ErP">-</td></tr>

<tr><th>Operation Time (h)</th><td id="OpH">-</td></tr>
</table>

<script>
/* ================= MQTT CONFIG ================= */
const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  {
    username: "vercel_client",
    password: "VercelPass123!",
    reconnectPeriod: 2000
  }
);

let lastUpdate = 0;

/* ================= HELPERS ================= */
function val(v, unit="") {
  if (v === null || v === undefined || isNaN(v)) return "-";
  return v + unit;
}

/* ================= MQTT EVENTS ================= */
client.on("connect", () => {
  document.getElementById("connStatus").innerHTML =
    "Status: Connected ✅";
  client.subscribe("politeknik/meter/data");
});

client.on("message", (topic, msg) => {
  const d = JSON.parse(msg.toString());

  if (d.id !== 1) return;

  lastUpdate = Date.now();

  document.getElementById("status").innerHTML =
    `<span class="online">ONLINE</span>`;

  document.getElementById("V").innerText   = val(d.V);
  document.getElementById("I1").innerText  = val(d.I1);
  document.getElementById("I2").innerText  = val(d.I2);
  document.getElementById("I3").innerText  = val(d.I3);

  document.getElementById("P").innerText   = val(d.P);
  document.getElementById("Q").innerText   = val(d.Q);
  document.getElementById("S").innerText   = val(d.S);

  document.getElementById("PF").innerText  = val(d.PF);
  document.getElementById("Hz").innerText  = val(d.Hz);

  document.getElementById("EaT").innerText = val(d.EaT);
  document.getElementById("ErT").innerText = val(d.ErT);
  document.getElementById("EaP").innerText = val(d.EaP);
  document.getElementById("ErP").innerText = val(d.ErP);

  document.getElementById("OpH").innerText = val(d.OpH);
});

/* ================= OFFLINE DETECTOR ================= */
setInterval(() => {
  if (Date.now() - lastUpdate > 5000) {
    document.getElementById("status").innerHTML =
      `<span class="offline">OFFLINE</span>`;
  }
}, 1000);

client.on("error", err => {
  console.error("MQTT Error:", err);
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Real-Time MESIN_01</title>
    <!-- Library Klien MQTT (Paho) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f4; padding: 20px; }
        .back-button { padding: 10px 15px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
        .detail-pane { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 1000px; margin: 0 auto; }
        
        /* Gauges Style */
        .gauge-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .gauge-box { background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ccc; position: relative; }
        .gauge-value { font-size: 2.5em; font-weight: bold; color: #007bff; }
        .gauge-label { font-size: 0.9em; color: #555; margin-bottom: 10px; }
        .gauge-visual { width: 100%; height: 10px; background-color: #e0e0e0; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .gauge-fill { height: 100%; width: 0; background-color: #28a745; transition: width 0.5s; }
        .gauge-fill.warning { background-color: orange; }
        .gauge-fill.danger { background-color: red; }

        /* Detail Table */
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .detail-table th, .detail-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .detail-table th { background-color: #eee; }
    </style>
</head>
<body>

    <button class="back-button" onclick="window.location.href='index.html'">‚Üê Kembali</button>
    
    <div class="detail-pane">
        <h1>Monitoring Real-Time: MESIN_01</h1>
        <p id="mqttStatus" style="font-weight: bold; color: blue;">Status Koneksi MQTT: Disconnecting...</p>

        <p>Data terakhir diperbarui pada: <span id="lastUpdateTimestamp">N/A</span></p>
        
        <hr>
        
        <!-- Area 1: Parameter Inti (Gauges) -->
        <h2>Parameter Inti (Core)</h2>
        <div class="gauge-container" id="coreParameters">
            Menunggu data...
        </div>
        
        <hr>
        
        <!-- Area 2: Semua Parameter (Tabel Detail) -->
        <h2>Semua Parameter Detail</h2>
        <table class="detail-table" id="allParametersTable">
            <thead>
                <tr><th>Parameter</th><th>Nilai</th><th>Satuan</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="3">Menunggu data dari HiveMQ...</td></tr>
            </tbody>
        </table>

    </div>

    <script>
        // =======================================================
        // LOGIC MQTT SUBSCRIBER FINAL (HARUS SAMA DENGAN ESP32)
        // =======================================================

        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8000; // Port standar Websocket MQTT
        const MQTT_TOPIC = "power/iem3255/data"; // Topik yang sama dengan ESP32
        const CLIENT_ID = "WebApp-Subscriber-" + parseInt(Math.random() * 100000);

        let client = null;

        // Definisikan Parameter (Wajib sama persis dengan payload JSON dari ESP32)
        const ALL_PARAMETERS_DEFINITION = {
            // Core Parameters (untuk Gauge)
            'Voltage (L-L Avg)': { col: 'V_LL_Avg', unit: 'Volt', isCore: true, precision: 1, max: 400 },
            'Current (I1)': { col: 'I1', unit: 'Ampere', isCore: true, precision: 1, max: 100 },
            'Power (P Total/kW)': { col: 'P', unit: 'W', isCore: true, precision: 0, max: 50000 }, // Dikirimlkan dalam Watt
            'Power Factor (Total)': { col: 'PF', unit: '-', isCore: true, precision: 3, max: 1.0 },
            
            // Non-Core Parameters (Sisanya)
            'Total Ea': { col: 'Ea_Total', unit: 'kWh', isCore: false, precision: 2 },
            'Total Er': { col: 'Er_Total', unit: 'kVARh', isCore: false, precision: 2 },
            'Partial Ea': { col: 'Ea_Partial', unit: 'kWh', isCore: false, precision: 2 },
            'Partial Er': { col: 'Er_Partial', unit: 'kVARh', isCore: false, precision: 2 },
            'Current (I2)': { col: 'I2', unit: 'Ampere', isCore: false, precision: 1 },
            'Current (I3)': { col: 'I3', unit: 'Ampere', isCore: false, precision: 1 },
            'Power (Q VAR)': { col: 'Q', unit: 'VAR', isCore: false, precision: 0 },
            'Power (S VA)': { col: 'S', unit: 'VA', isCore: false, precision: 0 },
            'Frequency': { col: 'Freq', unit: 'Hz', isCore: false, precision: 2 },
            'Operating Time (Sec)': { col: 'OpTime', unit: 'Sec', isCore: false, precision: 0 },
        };

        // --- 1. FUNGSI KONEKSI MQTT ---
        function initMQTT() {
            // Paho client global
            var wsclient = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, "/mqtt", CLIENT_ID);
            
            wsclient.onConnectionLost = onConnectionLost;
            wsclient.onMessageArrived = onMessageArrived;

            wsclient.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                cleanSession: true,
                useSSL: false
            });
            client = wsclient; // Tetapkan client global
        }

        function onFailure(responseObject) {
            document.getElementById('mqttStatus').textContent = 'Koneksi GAGAL: ' + responseObject.errorMessage;
            document.getElementById('mqttStatus').style.color = 'red';
            setTimeout(initMQTT, 5000); 
        }

        function onConnectionLost(responseObject) {
            document.getElementById('mqttStatus').textContent = 'Koneksi Hilang. Mencoba sambung ulang...';
            document.getElementById('mqttStatus').style.color = 'red';
            // Mencoba reconnect
        }

        function onConnect() {
            document.getElementById('mqttStatus').textContent = 'Koneksi BERHASIL!';
            document.getElementById('mqttStatus').style.color = 'green';
            client.subscribe(MQTT_TOPIC);
        }

        // --- 2. FUNGSI PENERIMA PESAN (Updater) ---
        function onMessageArrived(message) {
            document.getElementById('lastUpdateTimestamp').textContent = new Date().toLocaleTimeString('id-ID');
            
            try {
                const data = JSON.parse(message.payloadString);
                
                renderCoreParameters(data);
                renderAllParameters(data);

            } catch (e) {
                console.error("Gagal parsing JSON dari MQTT:", e);
                document.getElementById('mqttStatus').textContent = 'Error Parsing Data!';
            }
        }

        // --- 3. FUNGSI RENDERING (Core Parameters / Gauges) ---
        function renderCoreParameters(data) {
            const container = document.getElementById('coreParameters');
            container.innerHTML = '';
            
            for (const key in ALL_PARAMETERS_DEFINITION) {
                const paramDef = ALL_PARAMETERS_DEFINITION[key];
                if (paramDef.isCore) {
                    const value = data[paramDef.col] || 0;
                    const maxValue = paramDef.max;

                    // Hitung Persentase Isi Bar
                    let percentage = Math.min(100, (value / maxValue) * 100);
                    
                    // Logic Warna
                    let colorClass = 'gauge-fill';
                    if (paramDef.col === 'PF') {
                        if (value < 0.85) colorClass = 'gauge-fill danger';
                        else if (value < 0.95) colorClass = 'gauge-fill warning';
                    } else {
                        if (percentage > 95) colorClass = 'gauge-fill danger'; 
                        else if (percentage > 80) colorClass = 'gauge-fill warning';
                    }

                    const box = document.createElement('div');
                    box.className = 'gauge-box';
                    box.innerHTML = `
                        <div class="gauge-label">${key}</div>
                        <div class="gauge-value">${value.toFixed(paramDef.precision)} ${paramDef.unit}</div>
                        <div class="gauge-visual">
                            <div class="${colorClass}" style="width: ${percentage}%;"></div>
                        </div>
                    `;
                    container.appendChild(box);
                }
            }
        }

        // --- 4. FUNGSI RENDERING (All Parameters / Tabel) ---
        function renderAllParameters(data) {
            const tbody = document.querySelector('#allParametersTable tbody');
            tbody.innerHTML = '';
            
            for (const key in ALL_PARAMETERS_DEFINITION) {
                const paramDef = ALL_PARAMETERS_DEFINITION[key];
                const value = data[paramDef.col];
                
                const row = tbody.insertRow();
                row.insertCell().textContent = key;
                row.insertCell().textContent = value !== null ? value.toFixed(paramDef.precision) : 'N/A';
                row.insertCell().textContent = paramDef.unit;
            }
        }


        // --- INISIALISASI ---
        document.addEventListener('DOMContentLoaded', initMQTT);
    </script>
</body>
</html>

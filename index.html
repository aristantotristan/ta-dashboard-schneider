<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚡ Real-time Power Meter Dashboard</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
/* Global Styling */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #0F172A; /* Dark Blue/Slate Background */
  color: #F8FAFC; /* Light Text */
  padding: 20px;
}
h2 {
    color: #4ADE80; /* Green highlight for title */
    border-bottom: 2px solid #334155;
    padding-bottom: 10px;
}
#conn {
    margin-bottom: 20px;
    font-size: 1.1em;
    font-weight: bold;
}

/* Table Styling */
table {
  border-collapse: separate;
  border-spacing: 0;
  width: 100%;
  margin-top: 15px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  overflow: hidden; 
}
th, td {
  border: none;
  padding: 12px 15px;
  text-align: center;
  transition: background-color 0.3s;
}
thead th {
  background: #1E293B;
  color: #94A3B8;
  font-weight: 600;
  text-transform: uppercase;
}
tbody tr {
    background: #151F33; 
}
tbody tr:nth-child(even) {
    background: #1E293B; 
}
tbody tr:hover {
    background-color: #334155; 
}

/* Specific Cell Styling (Data Groups) */
.col-power { 
    background-color: #0F334A !important; 
    font-weight: bold;
    color: #38BDF8; 
}
.col-energy {
    font-size: 1.1em;
    color: #4ADE80; 
}
.col-i, .col-v, .col-pf {
    font-weight: 500;
}

/* Status Styling */
.status-online { color: #10B981; font-weight: bold; } 
.status-offline { color: #EF4444; font-weight: bold; }
.cell-id {
    font-weight: bold;
    background: #111827;
}
</style>
</head>

<body>

<h2>⚡ Real-time Power Meter Dashboard</h2>
<p id="conn">Connecting...</p>

<table>
<thead>
<tr>
  <th class="cell-id">ID</th>
  <th>Status</th>
  <th class="col-v">V (Volt)</th>
  <th class="col-i">I1 (A)</th>
  <th class="col-i">I2 (A)</th>
  <th class="col-i">I3 (A)</th>
  <th class="col-power">P (Watt)</th>
  <th class="col-power">Q (VAR)</th>
  <th class="col-power">S (kVA)</th>
  <th class="col-pf">PF</th>
  <th class="col-pf">Hz</th>
  <th class="col-pf">OpH (Jam)</th>
  <th class="col-energy">Ea Tot (kWh)</th>
  <th class="col-energy">Er Tot (kVARh)</th>
  <th class="col-energy">Ea Part (kWh)</th>
  <th class="col-energy">Er Part (kVARh)</th>
</tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="16" style="padding: 30px; color: #94A3B8;">Awaiting Real-time Data from ESP32...</td></tr>
</tbody>
</table>

<script>
// --- KONFIGURASI MQTT WEB CLIENT ---
const options = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 2000,
};

// Menggunakan WSS (WebSockets Secure) port 8884
const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  options
);

const tableBody = document.getElementById("tableBody");
const conn = document.getElementById("conn");
const devices = {}; // Menyimpan referensi baris tabel berdasarkan ID meter

// Definisikan urutan KEY JSON dan CLASS CSS
const dataMap = [
    { key: 'V', class: 'col-v' },
    { key: 'I1', class: 'col-i' },
    { key: 'I2', class: 'col-i' },
    { key: 'I3', class: 'col-i' },
    { key: 'P', class: 'col-power' },
    { key: 'Q', class: 'col-power' },
    { key: 'S', class: 'col-power' },
    { key: 'PF', class: 'col-pf' },
    { key: 'Hz', class: 'col-pf' },
    { key: 'OpH', class: 'col-pf' },
    { key: 'EaT', class: 'col-energy' },
    { key: 'ErT', class: 'col-energy' },
    { key: 'EaP', class: 'col-energy' },
    { key: 'ErP', class: 'col-energy' }
];

client.on("connect", () => {
  conn.innerHTML = "✅ MQTT Connected";
  client.subscribe("politeknik/meter/data");
});

client.on("error", err => {
  conn.innerHTML = "❌ MQTT Error";
  console.error("MQTT Connection Error:", err);
});

client.on("message", (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    const id = d.id;

    // 1. Cek atau Buat Baris Baru
    if (!devices[id]) {
      const row = document.createElement("tr");
      row.id = `row-${id}`;
      
      // Cell 0: ID
      let cellsHTML = `<td class="cell-id">${id}</td>`;
      // Cell 1: Status
      cellsHTML += `<td class="status-offline">offline</td>`;
      
      // Cell 2 - 15: Data
      dataMap.forEach(item => {
        // Membuat kolom kosong dengan class CSS yang sudah benar
        cellsHTML += `<td class="${item.class}">---</td>`; 
      });
      
      row.innerHTML = cellsHTML;
      
      tableBody.innerHTML = ""; // Hapus pesan "Awaiting Data..."
      tableBody.appendChild(row);
      devices[id] = row;
    }

    const cells = devices[id].children;
    
    // 2. Update Status (Cell Index 1)
    cells[1].innerHTML = d.status;
    cells[1].className = d.status === "online" ? "status-online" : "status-offline";
    
    // 3. Update Data (Mulai dari Cell Index 2)
    dataMap.forEach((item, index) => {
      // cellIndex = 0(ID) + 1(Status) + index
      const cellIndex = index + 2; 
      
      // Mengambil nilai dari JSON
      const value = d[item.key];
      
      // Jika nilai 0 atau memiliki nilai, tampilkan. Jika tidak, tampilkan '---'.
      cells[cellIndex].innerHTML = (value === 0 || value) ? value : '---'; 
    });

  } catch (e) {
    console.error("JSON Parsing Error:", e);
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>Monitoring 18 Mesin</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
        .status-online { background: #c7ffd1; }
        .status-offline { background: #ffd1d1; }
    </style>
</head>

<body>
<h2>Realtime Monitoring Mesin (18 Unit)</h2>

<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Status</th>

            <th>Total Ea (kWh)</th>
            <th>Total Er (kVARh)</th>
            <th>Partial Ea (kWh)</th>
            <th>Partial Er (kVARh)</th>

            <th>Voltage (V)</th>
            <th>Current (A)</th>

            <th>Power P (W)</th>
            <th>Power Q (VAR)</th>
            <th>Power S (kVA)</th>

            <th>PF</th>
            <th>Freq (Hz)</th>
            <th>OpTime (Days Hrs)</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
/* -----------------------------------------
   VARIABEL & MAPPING
------------------------------------------*/

const tableBody = document.getElementById("tableBody");
const devices = {}; // menyimpan baris HTML tiap ID

// mapping agar parameter langsung masuk ke cell yg benar
const dataMap = [
    { key: "total_ea",    class: "c-total-ea" },
    { key: "total_er",    class: "c-total-er" },
    { key: "partial_ea",  class: "c-partial-ea" },
    { key: "partial_er",  class: "c-partial-er" },

    { key: "voltage",     class: "c-voltage" },
    { key: "current",     class: "c-current" },

    { key: "power_p",     class: "c-power-p" },
    { key: "power_q",     class: "c-power-q" },
    { key: "power_s",     class: "c-power-s" },

    { key: "pf",          class: "c-pf" },
    { key: "freq",        class: "c-freq" },
    { key: "optime",      class: "c-optime" }
];

/* -----------------------------------------
   ðŸ”¥ BUILD 18 BARIS STANDBY (AWAL)
------------------------------------------*/
function buildStandbyTable() {

    tableBody.innerHTML = ""; // clear semua

    for (let i = 1; i <= 18; i++) {

        const row = tableBody.insertRow();
        devices[i] = row; // simpan baris sesuai ID

        // Kolom ID
        const idCell = row.insertCell();
        idCell.textContent = i;

        // Kolom Status
        const st = row.insertCell();
        st.textContent = "offline";
        st.className = "status-offline";

        // Kolom data lain (isi ---)
        dataMap.forEach(item => {
            const c = row.insertCell();
            c.className = item.class;
            c.textContent = "---";
        });
    }
}

// Panggil langsung
buildStandbyTable();


/* -----------------------------------------
   ðŸ”¥ MQTT SETUP
------------------------------------------*/

const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt");

client.on("connect", () => {
    console.log("MQTT Connected");
    client.subscribe("mesin/#");  // subscribe semua mesin
});

client.on("message", (topic, message) => {
    try {
        const data = JSON.parse(message.toString());
        updateRow(data);
    } catch (e) {
        console.log("Invalid JSON");
    }
});


/* -----------------------------------------
   ðŸ”¥ UPDATE BARIS SAAT DATA MASUK
------------------------------------------*/
function updateRow(data) {
    const id = data.id;
    if (!devices[id]) return;

    const row = devices[id];
    const statusCell = row.cells[1];

    // status online
    statusCell.textContent = "online";
    statusCell.className = "status-online";

    // update parameter sesuai mapping
    dataMap.forEach((item, idx) => {
        const cell = row.cells[idx + 2]; // +2 karena ID + Status

        if (item.key === "optime") {
            // convert jam â†’ days hrs
            const jam = data[item.key] || 0;
            const days = Math.floor(jam / 24);
            const hrs = jam % 24;
            cell.textContent = `${days}d ${hrs}h`;
        } else {
            cell.textContent = data[item.key] ?? "---";
        }
    });
}

</script>

<!-- MQTT CDN -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

</body>
</html>

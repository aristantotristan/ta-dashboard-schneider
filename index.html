
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚡ Master Power Meter Dashboard (18 SLAVES)</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
/* Global Styling */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212; /* Deep Dark Background */
    color: #E0E0E0; /* Soft White Text */
    padding: 20px;
}
h2 {
    color: #00FFC2; /* Neon Green/Cyan for title */
    border-bottom: 2px solid #3A3A3A;
    padding-bottom: 10px;
    margin-bottom: 5px;
}
#conn {
    margin-bottom: 25px;
    font-size: 1.1em;
    font-weight: bold;
}
table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    overflow: hidden; 
}
th, td {
    border: 1px solid #2A2A2A; /* Border antar sel */
    padding: 10px 12px;
    text-align: center;
    transition: background-color 0.3s;
}
thead th {
    background: #2A2A2A;
    color: #00FFC2;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9em;
}
tbody tr {
    background: #1E1E1E;
}
tbody tr:hover {
    background-color: #334155; 
}

/* Data Group Styling */
.cell-id { font-weight: bold; background: #111827; }
.status-online { color: #10B981; font-weight: bold; } 
.status-offline { color: #EF4444; font-weight: bold; }
.col-power { background-color: #0F334A; color: #38BDF8; font-weight: 600; }
.col-energy { color: #4ADE80; font-weight: 600; }
.col-v, .col-i, .col-pf { font-weight: 500; }
</style>
</head>

<body>

<h2>⚡ Real-time Power Meter Dashboard (18 Mesin)</h2>
<p id="conn">Connecting...</p>

<table>
<thead>
<tr>
  <th class="cell-id">ID</th>
  <th>Status</th>
  <th class="col-v">V (Volt)</th>
  <th class="col-i">I1 (A)</th>
  <th class="col-i">I2 (A)</th>
  <th class="col-i">I3 (A)</th>
  <th class="col-power">P (Watt)</th>
  <th class="col-power">Q (VAR)</th>
  <th class="col-power">S (kVA)</th>
  <th class="col-pf">PF</th>
  <th class="col-pf">Hz</th>
  <th class="col-pf">OpH (Hari/Jam)</th>
  <th class="col-energy">Ea Tot (kWh)</th>
  <th class="col-energy">Er Tot (kVARh)</th>
  <th class="col-energy">Ea Part (kWh)</th>
  <th class="col-energy">Er Part (kVARh)</th>
</tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="16" style="padding: 30px; color: #94A3B8;">Awaiting Real-time Data from ESP32...</td></tr>
</tbody>
</table>

<script>
// --- KONFIGURASI MQTT WEB CLIENT ---
const options = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 2000,
};

const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  options
);

const tableBody = document.getElementById("tableBody");
const conn = document.getElementById("conn");
const devices = {}; // Menyimpan referensi baris tabel berdasarkan ID meter

// Definisikan urutan KEY JSON dan CLASS CSS
const dataMap = [
    { key: 'V', class: 'col-v' }, { key: 'I1', class: 'col-i' }, { key: 'I2', class: 'col-i' }, 
    { key: 'I3', class: 'col-i' }, { key: 'P', class: 'col-power' }, { key: 'Q', class: 'col-power' }, 
    { key: 'S', class: 'col-power' }, { key: 'PF', class: 'col-pf' }, { key: 'Hz', class: 'col-pf' }, 
    { key: 'OpH', class: 'col-pf' }, { key: 'EaT', class: 'col-energy' }, { key: 'ErT', class: 'col-energy' }, 
    { key: 'EaP', class: 'col-energy' }, { key: 'ErP', class: 'col-energy' }
];

/**
 * Mengonversi total jam (decimal) menjadi format Hari dan Jam.
 * Contoh: 76.5 jam -> "3 Hari 4.5 Jam"
 * @param {number} totalHours - Total jam dari data MQTT (OpH).
 */
function formatOperatingTime(totalHours) {
    if (totalHours === undefined || totalHours === null || isNaN(totalHours) || totalHours < 0) {
        return '---';
    }
    const totalMinutes = Math.round(parseFloat(totalHours) * 60); // Total jam diubah ke menit (untuk akurasi)

    const days = Math.floor(totalMinutes / (24 * 60)); // Total hari
    const remainingMinutes = totalMinutes % (24 * 60);
    
    const hours = Math.floor(remainingMinutes / 60); // Jam sisa
    const minutes = remainingMinutes % 60; // Menit sisa
    
    let result = '';
    
    if (days > 0) {
        result += `${days} Hari `;
    }
    
    // Tampilkan Jam/Menit jika ada sisa waktu atau total waktu < 1 hari
    if (hours > 0 || days === 0) {
        result += `${hours} Jam`;
        if (minutes > 0) {
            result += ` ${minutes} Mnt`; // Opsi: tampilkan menit jika ada
        }
    } else if (minutes > 0) {
        result += `${minutes} Mnt`;
    }
    
    // Jika hasilnya masih kosong, (e.g. 0 jam) tampilkan 0 Jam
    return result.trim() || '0 Jam'; 
}


client.on("connect", () => {
  conn.innerHTML = "✅ MQTT Connected";
  client.subscribe("politeknik/meter/data");
});

client.on("error", err => {
  conn.innerHTML = "❌ MQTT Error";
  console.error("MQTT Connection Error:", err);
});

client.on("message", (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    const id = d.id;

    // 1. Cek atau Buat Baris Baru untuk ID ini
    if (!devices[id]) {
      const row = tableBody.insertRow(); 
      devices[id] = row;
      
      // Membuat sel awal (ID dan Status)
      row.insertCell().textContent = id;
      row.cells[0].className = 'cell-id';
      row.insertCell().textContent = d.status;
      
      // Membuat 14 sel data kosong dengan class
      dataMap.forEach(item => {
        const cell = row.insertCell();
        cell.className = item.class;
        cell.textContent = '---'; 
      });
      
      // Hapus pesan "Awaiting Data..." setelah baris pertama berhasil dibuat
      if (tableBody.rows.length > 1 && tableBody.rows[0].cells[0].colSpan === 16) {
          tableBody.deleteRow(0);
      }
    }

    const row = devices[id];
    const cells = row.cells;
    
    // 2. Update Status (Index 1)
    cells[1].textContent = d.status.toUpperCase();
    cells[1].className = d.status === "online" ? "status-online" : "status-offline";
    
    // 3. Update Data (Mulai dari Index 2)
    dataMap.forEach((item, index) => {
      const cellIndex = index + 2; 
      const value = d[item.key];
      
      let displayValue;
      
      if (item.key === 'OpH') {
        // Gunakan fungsi konversi untuk Operating Time
        displayValue = formatOperatingTime(value);
      } else {
        // Nilai V, I, P, E, dll.
        displayValue = (value === 0 || value) ? value : '---';
      }
      
      cells[cellIndex].textContent = displayValue;
    });

  } catch (e) {
    console.error(`JSON Parsing Error for ID ${d.id || 'Unknown'}:`, e);
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ESP32 Meter – MQTT Table Dashboard</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#0b1220;
  color:#fff;
  padding:20px;
}
table {
  border-collapse: collapse;
  width:100%;
}
th, td {
  border:1px solid #333;
  padding:8px;
  text-align:center;
}
th {
  background:#111827;
}
.status-online { color:#22c55e; font-weight:bold; }
.status-offline { color:#ef4444; font-weight:bold; }
</style>
</head>

<body>

<h2>ESP32 Meter – MQTT Table Dashboard</h2>
<p id="conn">Connecting...</p>

<table>
<thead>
<tr>
  <th>ID</th>
  <th>Status</th>
  <th>V (V)</th>
  <th>I1 (A)</th>
  <th>I2 (A)</th>
  <th>I3 (A)</th>
  <th>P (W)</th>
  <th>Q (VAR)</th>
  <th>S (kVA)</th>
  <th>PF</th>
  <th>Hz</th>
  <th>OpH (h)</th>
  <th>E Active Tot (kWh)</th>
  <th>E Reactive Tot (kVARh)</th>
  <th>E Active Part</th>
  <th>E Reactive Part</th>
</tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="16">Waiting MQTT data...</td></tr>
</tbody>
</table>

<script>
const options = {
  username: "web_dashboard",
  password: "Tristan12",
  connectTimeout: 4000,
  reconnectPeriod: 2000,
};

const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  options
);

const tableBody = document.getElementById("tableBody");
const conn = document.getElementById("conn");
const devices = {}; // store row per ID

client.on("connect", () => {
  conn.innerHTML = "✅ MQTT Connected";
  client.subscribe("politeknik/meter/data");
});

client.on("error", err => {
  conn.innerHTML = "❌ MQTT Error";
  console.error(err);
});

client.on("message", (topic, message) => {
  try {
    const d = JSON.parse(message.toString());
    const id = d.id;

    if (!devices[id]) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${id}</td>
        <td></td><td></td><td></td><td></td><td></td>
        <td></td><td></td><td></td><td></td>
        <td></td><td></td><td></td><td></td>
        <td></td><td></td>
      `;
      tableBody.innerHTML = "";
      tableBody.appendChild(row);
      devices[id] = row;
    }

    const cells = devices[id].children;
    cells[1].innerHTML = d.status;
    cells[1].className = d.status === "online" ? "status-online" : "status-offline";
    cells[2].innerHTML = d.V;
    cells[3].innerHTML = d.I1;
    cells[4].innerHTML = d.I2;
    cells[5].innerHTML = d.I3;
    cells[6].innerHTML = d.P;
    cells[7].innerHTML = d.Q;
    cells[8].innerHTML = d.S;
    cells[9].innerHTML = d.PF;
    cells[10].innerHTML = d.Hz;
    cells[11].innerHTML = d.OpH;
    cells[12].innerHTML = d.EaT;
    cells[13].innerHTML = d.ErT;
    cells[14].innerHTML = d.EaP;
    cells[15].innerHTML = d.ErP;

  } catch (e) {
    console.error("JSON Error", e);
  }
});
</script>

</body>
</html>

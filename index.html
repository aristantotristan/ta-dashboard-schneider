<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Meteran (18-Meter)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .meter-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 2px 2px 5px #eee;
        }
        .meter-card h3 { margin-top: 0; }
        .meter-card p { margin: 5px 0; font-size: 14px; }
        .meter-card .value { font-weight: bold; }
    </style>
</head>
<body>

    <h1>Live Dashboard Schneider (18 Meter)</h1>
    <p>Status: <span id="status">Menyambungkan...</span></p>

    <div class="grid-container" id="dashboard-grid">
        </div>

<script>
    // --- SESUAIKAN PENGATURAN INI ---
    const HIVEMQ_HOST = "9ae48494805f4ac0895d5bdd40731dfa.s1.eu.hivemq.cloud"; // üëà Ganti dengan Host Anda
    const HIVEMQ_PORT = 8884; // Port WSS (WebSockets)
    const HIVEMQ_USER = "web_dashboard";          // üëà Ganti dengan user SUBSCRIBER
    const HIVEMQ_PASS = "VercelPass123!";      // üëà Ganti dengan password SUBSCRIBER
    
    // Topik yang akan didengarkan
    const TOPIC_DATA = "politeknik/meter/data";
    // ---------------------------------

    // Buat ClientID unik untuk browser
    const CLIENT_ID = "web_client_" + parseInt(Math.random() * 1000);

    // Buat Paho MQTT Client
    var client = new Paho.MQTT.Client(HIVEMQ_HOST, HIVEMQ_PORT, CLIENT_ID);

    // Set callback handlers
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    // Opsi koneksi
    var options = {
        useSSL: true, // Wajib untuk HiveMQ Cloud (WSS)
        userName: HIVEMQ_USER,
        password: HIVEMQ_PASS,
        onSuccess: onConnect,
        onFailure: onFail
    };

    // Panggil fungsi connect
    client.connect(options);

    function onConnect() {
        console.log("Terhubung ke HiveMQ!");
        document.getElementById("status").innerHTML = "Terhubung ‚úÖ";
        
        // Subscribe ke topik data
        client.subscribe(TOPIC_DATA);
        console.log("Subscribed ke: " + TOPIC_DATA);

        // Buat 18 card meteran
        createMeterCards();
    }

    function onFail(message) {
        console.error("Koneksi gagal: " + message.errorMessage);
        document.getElementById("status").innerHTML = "Koneksi Gagal ‚ùå: " + message.errorMessage;
    }

    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Koneksi terputus: " + responseObject.errorMessage);
            document.getElementById("status").innerHTML = "Koneksi Terputus ‚ùå";
            // Coba sambungkan lagi (opsional)
            // client.connect(options);
        }
    }

    function onMessageArrived(message) {
        console.log("Pesan diterima di topik: " + message.destinationName);
        
        try {
            // Ubah teks pesan (JSON) menjadi objek JavaScript
            var data = JSON.parse(message.payloadString);
            
            // Panggil fungsi untuk update card
            updateCard(data);
        } catch (e) {
            console.error("Error parsing JSON:", e);
        }
    }

    // Fungsi untuk membuat 18 card di awal
    function createMeterCards() {
        var grid = document.getElementById("dashboard-grid");
        grid.innerHTML = ""; // Bersihkan grid

        for (var i = 1; i <= 18; i++) {
            var card = document.createElement("div");
            card.className = "meter-card";
            card.id = "meter_" + i; // ID unik untuk setiap card (meter_1, meter_2, ...)
            
            card.innerHTML = `
                <h3>Meter ID: ${i}</h3>
                <p>Status: <span class="value" id="status_${i}">Menunggu data...</span></p>
                <p>Voltage: <span class="value" id="v_${i}">-</span> V</p>
                <p>Current: <span class="value" id="a_${i}">-</span> A</p>
                <p>Power: <span class="value" id="p_${i}">-</span> W</p>
                <p>Energy: <span class="value" id="e_${i}">-</span> kWh</p>
                <p>Freq: <span class="value" id="f_${i}">-</span> Hz</p>
            `;
            grid.appendChild(card);
        }
    }

    // Fungsi untuk update data di card yang spesifik
    function updateCard(data) {
        var id = data.id; // Ambil ID dari data JSON (misal: 1, 2, 3...)
        
        // Cek jika ID valid
        if (id < 1 || id > 18) {
            console.warn("ID meter tidak valid:", id);
            return;
        }

        // Update nilai di card yang sesuai
        document.getElementById(`status_${id}`).innerHTML = "Online ‚úÖ";
        document.getElementById(`v_${id}`).innerHTML = data.v_avg.toFixed(2);
        document.getElementById(`a_${id}`).innerHTML = data.a_avg.toFixed(3);
        document.getElementById(`p_${id}`).innerHTML = data.p_total.toFixed(2);
        document.getElementById(`e_${id}`).innerHTML = data.energy.toFixed(4);
        document.getElementById(`f_${id}`).innerHTML = data.freq.toFixed(2);

        // (Opsional) tambahkan highlight atau ganti warna
        var card = document.getElementById(`meter_${id}`);
        card.style.borderColor = "green";
        setTimeout(() => { card.style.borderColor = "#ccc"; }, 500); // Hilangkan highlight setelah 0.5 dtk
    }

</script>
</body>
</html>

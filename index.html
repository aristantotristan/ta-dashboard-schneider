<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor Energi 18 Titik (v7 ESP32)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; padding: 20px; }
    h1 { text-align: center; color: #1a237e; }
    #status { text-align: center; padding: 10px; margin-bottom: 20px; font-weight: bold; color: white; border-radius: 5px; }
    .bg-ok { background: #43a047; } .bg-err { background: #e53935; } .bg-wait { background: #fb8c00; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px; }
    .card { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); border-top: 5px solid #bdbdbd; transition: 0.3s; }
    .card h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .badge { font-size: 0.75em; padding: 3px 8px; border-radius: 10px; background: #eee; color: #666; }
    .badge.on { background: #c8e6c9; color: #2e7d32; }

    .data-table { width: 100%; font-size: 0.9em; border-collapse: collapse; margin-top: 10px; }
    .data-table td { padding: 3px 5px; border-bottom: 1px dotted #eee; }
    .lbl { color: #555; font-weight: 500; }
    .val { text-align: right; font-weight: bold; color: #000; }
    .unit { color: #999; font-size: 0.8em; margin-left: 2px; }
    .group-header { background: #e3f2fd; color: #1565c0; font-weight: bold; font-size: 0.85em; }

    .highlight { animation: pulse 0.8s; }
    @keyframes pulse { 0% { background: #e8f5e9; } 100% { background: #fff; } }
  </style>
</head>
<body>
  <h1>Monitoring Energi Schneider iEM3255 (18 Titik)</h1>
  <div id="status" class="bg-wait">Menghubungkan...</div>
  <div class="grid" id="main"></div>

  <script>
    // --- KONFIGURASI MQTT ---
    const HOST = "701d32236feb43b38c22855a611f4d42.s1.eu.hivemq.cloud";
    const PORT = 8884;
    const USER = "web_dashboard";
    const PASS = "Tristan12";
    const TOPIC = "politeknik/meter/data";

    const client = new Paho.MQTT.Client(HOST, PORT, "web_" + Date.now());

    // --- INISIALISASI 18 METER ---
    function init() {
      let html = "";
      for (let i = 1; i <= 18; i++) {
        html += `
        <div class="card" id="c${i}">
          <h3>Meter #${i} <span id="s${i}" class="badge">Offline</span></h3>
          <table class="data-table">
            <tr class="group-header"><td colspan="3">DATA DASAR</td></tr>
            <tr><td class="lbl">Tegangan</td><td class="val" id="v${i}">-</td><td class="unit">V</td></tr>
            <tr><td class="lbl">Arus</td><td class="val" id="a${i}">-</td><td class="unit">A</td></tr>
            <tr><td class="lbl">Frekuensi</td><td class="val" id="f${i}">-</td><td class="unit">Hz</td></tr>

            <tr class="group-header"><td colspan="3">DAYA</td></tr>
            <tr><td class="lbl">Daya Aktif</td><td class="val" id="p${i}">-</td><td class="unit">W</td></tr>

            <tr class="group-header"><td colspan="3">ENERGI</td></tr>
            <tr><td class="lbl">Energi Import</td><td class="val" id="e${i}">-</td><td class="unit">kWh</td></tr>
          </table>
        </div>`;
      }
      document.getElementById("main").innerHTML = html;
      connect();
    }

    // --- KONEKSI MQTT ---
    function connect() {
      client.connect({
        useSSL: true,
        userName: USER,
        password: PASS,
        onSuccess: () => {
          document.getElementById("status").textContent = "Terhubung ke HiveMQ ✅";
          document.getElementById("status").className = "bg-ok";
          client.subscribe(TOPIC);
        },
        onFailure: (e) => {
          document.getElementById("status").textContent = "Gagal Terhubung: " + e.errorMessage;
          document.getElementById("status").className = "bg-err";
          setTimeout(connect, 5000);
        }
      });
    }

    client.onConnectionLost = (r) => {
      if (r.errorCode !== 0) {
        document.getElementById("status").textContent = "Koneksi Terputus ⚠️";
        document.getElementById("status").className = "bg-wait";
        setTimeout(connect, 5000);
      }
    };

    client.onMessageArrived = (msg) => {
      try {
        const data = JSON.parse(msg.payloadString);
        updateMeter(data);
      } catch (e) {
        console.error("Error parsing JSON:", e);
      }
    };

    // --- UPDATE DATA KE UI ---
    function updateMeter(d) {
      const id = d.id;
      if (!id || id > 18) return;
      const f = (v, n = 2) => (v != null && !isNaN(v)) ? Number(v).toFixed(n) : "-";

      document.getElementById(`s${id}`).textContent = "ONLINE";
      document.getElementById(`s${id}`).classList.add("on");
      document.getElementById(`c${id}`).style.borderTopColor = "#43a047";

      document.getElementById(`v${id}`).textContent = f(d.v_avg, 1);
      document.getElementById(`a${id}`).textContent = f(d.a_avg, 3);
      document.getElementById(`f${id}`).textContent = f(d.freq, 2);
      document.getElementById(`p${id}`).textContent = f(d.p_total, 1);
      document.getElementById(`e${id}`).textContent = f(d.energy, 3);

      // Efek highlight
      const card = document.getElementById(`c${id}`);
      card.classList.remove("highlight");
      void card.offsetWidth;
      card.classList.add("highlight");
    }

    init();
  </script>
</body>
</html>

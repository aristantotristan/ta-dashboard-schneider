<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Power Meter + Tarif</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { background:#111; color:#eee; font-family:Arial; padding:20px }
button { padding:6px 12px; margin-left:6px; cursor:pointer }
table { border-collapse:collapse; width:100%; margin-top:12px }
th, td { border:1px solid #333; padding:6px; text-align:center }
</style>
</head>

<body>

<h2>âš¡ Power Meter Dashboard</h2>

<!-- TARIF SECTION -->
<div>
  Tarif:
  <b><span id="tarif">-</span></b> Rp/kWh
  <button onclick="changeTarif()">Change Tarif</button>
</div>

<!-- TABLE -->
<table>
<thead>
<tr>
  <th>ID</th>
  <th>Status</th>
  <th>Energy (kWh)</th>
  <th>Biaya (Rp)</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<script>
// ================= SUPABASE =================
const supabaseUrl = "SUPABASE_URL";
const supabaseKey = "SUPABASE_ANON_KEY";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let tarif = 0;

// BACA TARIF
async function loadTarif() {
  const { data } = await supabase
    .from("tarif")
    .select("harga_per_kwh")
    .eq("id", 1)
    .single();

  if (data) {
    tarif = data.harga_per_kwh;
    document.getElementById("tarif").innerText = tarif;
  }
}
loadTarif();

// TOMBOL GANTI TARIF
async function changeTarif() {
  const val = prompt("Tarif baru (Rp/kWh):", tarif);
  if (!val) return;

  await supabase
    .from("tarif")
    .update({ harga_per_kwh: parseFloat(val) })
    .eq("id", 1);

  loadTarif();
}

// ================= MQTT =================
const client = mqtt.connect(
  "wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt",
  {
    username: "web_dashboard",
    password: "Tristan12"
  }
);

const body = document.getElementById("body");
const rows = {};

client.on("connect", () => {
  client.subscribe("politeknik/meter/data");
});

client.on("message", (topic, message) => {
  const d = JSON.parse(message.toString());
  const id = d.id;

  if (!rows[id]) {
    const row = body.insertRow();
    rows[id] = row;
    row.insertCell().innerText = id;
    row.insertCell();
    row.insertCell();
    row.insertCell();
  }

  const row = rows[id];
  row.cells[1].innerText = d.status;
  row.cells[2].innerText = d.EaT || 0;

  // HITUNG BIAYA
  const biaya = (d.EaT || 0) * tarif;
  row.cells[3].innerText =
    biaya.toLocaleString("id-ID");
});
</script>

</body>
</html>

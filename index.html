<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Monitoring Tarif Energi — PT Amarilys</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:Arial;background:#0e1b2e;color:#e8f0fa;padding:20px}
  .card{background:#13233a;padding:15px;border-radius:10px;margin-bottom:15px}
  h2{color:#6fffd8}
  .btn{padding:10px;border-radius:8px;background:#19a7a8;color:#fff;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:15px}
  th,td{padding:8px;border-bottom:1px solid #26405a;text-align:center}
  th{color:#6fffd8}
</style>
</head>
<body>

<h1>⚡ Monitoring Biaya Energi — PT Amarilys</h1>

<div class="card">
  <h2>Tarif</h2>
  <p>LWBP (Rp/kWh): <input id="lwbp" type="number" step="0.01" value="996.74"></p>
  <p>WBP  (Rp/kWh): <input id="wbp" type="number" step="0.01" value="1699.53"></p>
  <button class="btn" onclick="loadData()">Hitung Ulang</button>
</div>

<div class="card">
  <h2>Ringkasan Hari Ini</h2>
  <div id="summary">Loading...</div>
</div>

<div class="card">
  <h2>Detail Per Data (energy_today)</h2>
  <table>
    <thead>
      <tr>
        <th>Waktu</th>
        <th>KWh</th>
        <th>LWBP?</th>
        <th>WBP?</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<div class="card">
  <button class="btn" onclick="exportCSV()">Export Excel (CSV)</button>
</div>

<script>
const SUPA_URL = "https://rojhcadtqfynlqzubftx.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvamhjYWR0cWZ5bmxxenViZnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzYzNTksImV4cCI6MjA3NzcxMjM1OX0.XZElBWD-QdS8XVKex92VKUAlifC6BXqe3kGYPmZ1Mcs";

async function supa(path) {
  const r = await fetch(SUPA_URL + path, {
    headers: {
      apikey: SUPA_KEY,
      Authorization: "Bearer " + SUPA_KEY
    }
  });
  return r.json();
}

function isWbp(h) {
  return h >= 17 && h < 22;
}

async function loadData() {
  const rows = await supa("/rest/v1/energy_today?select=*");

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  let sumLWBP = 0;
  let sumWBP = 0;

  rows.forEach(r => {
    const t = new Date(r.created_at);
    const h = t.getHours();
    const kwh = parseFloat(r.total_kwh || 0);

    if (isWbp(h)) sumWBP += kwh;
    else sumLWBP += kwh;

    tbody.innerHTML += `
      <tr>
        <td>${t.toLocaleTimeString()}</td>
        <td>${kwh.toFixed(3)}</td>
        <td>${isWbp(h) ? "-" : "✔"}</td>
        <td>${isWbp(h) ? "✔" : "-"}</td>
      </tr>`;
  });

  const lwbpRate = parseFloat(document.getElementById("lwbp").value);
  const wbpRate  = parseFloat(document.getElementById("wbp").value);

  const costLWBP = sumLWBP * lwbpRate;
  const costWBP  = sumWBP * wbpRate;
  const totalCost = costLWBP + costWBP;

  document.getElementById("summary").innerHTML = `
    Total LWBP: <b>${sumLWBP.toFixed(3)} kWh</b><br>
    Total WBP : <b>${sumWBP.toFixed(3)} kWh</b><br><br>
    Biaya LWBP: <b>Rp ${costLWBP.toLocaleString('id-ID')}</b><br>
    Biaya WBP : <b>Rp ${costWBP.toLocaleString('id-ID')}</b><br><br>
    TOTAL BIAYA: <h2>Rp ${totalCost.toLocaleString('id-ID')}</h2>
  `;
}

function exportCSV() {
  const rows = document.getElementById("rows").innerText;
  const blob = new Blob([rows], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "energy_today.csv";
  a.click();
}

loadData();
</script>

</body>
</html>

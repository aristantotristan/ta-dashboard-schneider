<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Power Meter Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body { background:#111; color:#fff; font-family:Arial }
.container { display:flex }
.list { width:25% }
.list button {
  width:100%; padding:10px; margin:4px 0;
  background:#222; color:#fff;
  border:1px solid #444;
  cursor:pointer;
}
.list button.active { background:#00aa66 }

table { width:100%; border-collapse:collapse }
th, td { border:1px solid #444; padding:6px }
th { background:#222; width:40% }
.value { text-align:right }
</style>
</head>

<body>

<h2>âš¡ Power Meter Dashboard</h2>

<div class="container">
  <div class="list" id="machineList"></div>

  <div style="width:75%; padding-left:10px">
    <h3 id="title">Mesin 1</h3>

    <table>
      <tbody>
        <tr><th>Total Ea (kWh)</th><td class="value" id="EaT">-</td></tr>
        <tr><th>Total Er (kVARh)</th><td class="value" id="ErT">-</td></tr>
        <tr><th>Partial Ea (kWh)</th><td class="value" id="EaP">-</td></tr>
        <tr><th>Partial Er (kVARh)</th><td class="value" id="ErP">-</td></tr>
        <tr><th>Voltage (V)</th><td class="value" id="V">-</td></tr>
        <tr><th>Current I1 (A)</th><td class="value" id="I1">-</td></tr>
        <tr><th>Current I2 (A)</th><td class="value" id="I2">-</td></tr>
        <tr><th>Current I3 (A)</th><td class="value" id="I3">-</td></tr>
        <tr><th>Active Power P (W)</th><td class="value" id="P">-</td></tr>
        <tr><th>Reactive Power Q (VAR)</th><td class="value" id="Q">-</td></tr>
        <tr><th>Apparent Power S (kVA)</th><td class="value" id="S">-</td></tr>
        <tr><th>Power Factor</th><td class="value" id="PF">-</td></tr>
        <tr><th>Frequency (Hz)</th><td class="value" id="Hz">-</td></tr>
        <tr><th>Operation Time (h)</th><td class="value" id="OpH">-</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const TOTAL_MACHINE = 18;
let selected = 1;
const store = {};

/* ========== BUTTON MACHINE ========== */
const list = document.getElementById('machineList');
for(let i=1;i<=TOTAL_MACHINE;i++){
  const b=document.createElement('button');
  b.textContent='Mesin '+i;
  b.id='btn'+i;
  b.onclick=()=>selectMachine(i);
  if(i===1) b.classList.add('active');
  list.appendChild(b);
}

/* ========== SELECT MACHINE ========== */
function selectMachine(id){
  selected=id;
  document.querySelectorAll('.list button')
    .forEach(x=>x.classList.remove('active'));
  document.getElementById('btn'+id).classList.add('active');

  document.getElementById('title').innerText='Mesin '+id;
  updateTable();
}

/* ========== UPDATE VALUE ONLY ========== */
function updateTable(){
  const d = store[selected];
  const fields=[
    "EaT","ErT","EaP","ErP","V",
    "I1","I2","I3",
    "P","Q","S","PF","Hz","OpH"
  ];

  fields.forEach(f=>{
    document.getElementById(f).innerText =
      d && d[f]!=null ? d[f] : '-';
  });
}

/* ========== MQTT ========== */
const client = mqtt.connect(
  'wss://3367c11cb6104f8ea02e99014f2015ba.s1.eu.hivemq.cloud:8884/mqtt',
  { username:'web_dashboard', password:'Tristan12' }
);

client.on('connect',()=>client.subscribe('politeknik/meter/data'));

client.on('message',(t,m)=>{
  const data=JSON.parse(m.toString());
  store[data.id]=data;
  if(data.id===selected) updateTable();
});
</script>

</body>
</html>

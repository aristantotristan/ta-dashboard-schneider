<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Listrik MQTT (HiveMQ Cloud)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; text-align: center; }
        .status { margin-bottom: 20px; padding: 10px; border-radius: 4px; font-weight: bold; }
        .status.connected { background-color: #d4edda; color: #155724; }
        .status.disconnected { background-color: #f8d7da; color: #721c24; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .data-item { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .data-label { font-size: 0.9em; color: #555; }
        .data-value { font-size: 1.5em; font-weight: bold; color: #333; }
    </style>
</head>
<body>

<div class="container">
    <h1>âš¡ Live Power Meter Dashboard</h1>
    
    <div id="status" class="status disconnected">Status: Disconnected</div>

    <div class="data-grid">
        <div class="data-item">
            <div class="data-label">Tegangan (Volt)</div>
            <div class="data-value" id="Voltage_V">--</div>
        </div>
        <div class="data-item">
            <div class="data-label">Daya Aktif (Watt)</div>
            <div class="data-value" id="ActivePower_W">--</div>
        </div>
        <div class="data-item">
            <div class="data-label">Arus (Ampere)</div>
            <div class="data-value" id="Current_I1_A">--</div>
        </div>
        <div class="data-item">
            <div class="data-label">Power Factor</div>
            <div class="data-value" id="PowerFactor">--</div>
        </div>
        <div class="data-item">
            <div class="data-label">Energi Total (kWh)</div>
            <div class="data-value" id="EnergyTotal_kWh">--</div>
        </div>
        <div class="data-item">
            <div class="data-label">Frekuensi (Hz)</div>
            <div class="data-value" id="Frequency_Hz">--</div>
        </div>
        </div>
</div>

<script>
    // ==========================================================
    // --- KONFIGURASI MQTT JAVASCRIPT (WAJIB SESUAIKAN) ---
    // ==========================================================
    const host = 'cbc4d19f6f3d4371b47d363751d186d1.s1.eu.hivemq.cloud'; // Host Name HiveMQ Cloud Anda
    const port = 8884; // Port 8884 adalah port WebSocket Secure (WSS) untuk HiveMQ Cloud
    const path = '/mqtt';
    const topic = 'esp32/powermeter/data'; 
    const clientId = 'WebClient-' + Math.random().toString(16).substr(2, 8); // Client ID unik
    
    // Kredensial untuk koneksi
    const username = 'esp32_user'; 
    const password = 'Tristan12#'; 
    
    // Inisialisasi Klien
    const client = new Paho.MQTT.Client(host, port, path, clientId);
    
    // Atur fungsi callback
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    // Coba koneksi ke Broker
    client.connect({
        onSuccess: onConnect,
        onFailure: onFailure,
        userName: username,
        password: password,
        useSSL: true // WAJIB True karena kita menggunakan Port 8884 (WSS)
    });

    // ==========================================================
    // --- FUNGSI MQTT ---
    // ==========================================================

    function onConnect() {
        console.log("Connected to MQTT Broker!");
        document.getElementById('status').className = 'status connected';
        document.getElementById('status').innerHTML = 'Status: Connected';
        
        // Berlangganan ke Topik setelah berhasil terhubung
        client.subscribe(topic);
        console.log("Subscribed to topic: " + topic);
    }

    function onFailure(responseObject) {
        console.log("Connection failed: " + responseObject.errorMessage);
        document.getElementById('status').className = 'status disconnected';
        document.getElementById('status').innerHTML = 'Status: Connection Failed';
    }

    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Connection Lost: " + responseObject.errorMessage);
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('status').innerHTML = 'Status: Connection Lost';
        }
        // Coba koneksi ulang
        // client.connect({onSuccess:onConnect, userName:username, password:password, useSSL:true});
    }

    function onMessageArrived(message) {
        console.log("Message Arrived: " + message.payloadString);
        
        try {
            // Parsing payload JSON dari ESP32
            const data = JSON.parse(message.payloadString);
            
            // Memperbarui nilai di dashboard berdasarkan ID HTML
            for (const key in data) {
                const element = document.getElementById(key);
                if (element) {
                    // Tampilkan nilai dengan 2 angka di belakang koma (atau sesuai kebutuhan)
                    if (typeof data[key] === 'number') {
                         element.innerText = data[key].toFixed(2);
                    } else {
                         element.innerText = data[key];
                    }
                }
            }
        } catch (e) {
            console.error("Error parsing JSON: ", e);
        }
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TA Monitoring Schneider (Hyper-Detail)</title>
    <!-- Auto-refresh setiap 10 detik -->
    <meta http-equiv="refresh" content="10">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; padding: 10px; font-size: 0.8rem; }
        /* Kontainer dibuat responsif dan bisa di-scroll horizontal */
        .container { max-width: 98%; margin: auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow-x: auto; }
        h1 { color: #007bff; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        /* Pastikan kolom tidak terpotong (nowrap) */
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; }
        /* Header tabel tetap di atas saat di-scroll */
        th { background-color: #007bff; color: white; position: sticky; top: 0; z-index: 10; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        /* Baris data 'offline' (V=0) akan berwarna merah muda */
        tr.offline { background-color: #ffebee !important; color: #b71c1c; }
        .status { font-size: 0.9em; color: #555; }
    </style>
    <!-- Import Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1>âš¡ Dashboard Kualitas Daya (iEM3255 Hyper-Detail)</h1>
        <p class="status">Data diperbarui otomatis... <span id="last-update"></span></p>
        
        <table>
            <thead>
                <tr>
                    <!-- Kolom Identifikasi -->
                    <th>ID</th>
                    <th>Update Terakhir (Timestamp)</th>
                    
                    <!-- Kolom Total/Ringkasan (Sesuai Skema DB Baru) -->
                    <th>Frekuensi (Hz)</th>
                    <th>PF Total</th>
                    <th>P Total (W)</th>
                    <th>Q Total (VAR)</th>
                    <th>S Total (VA)</th>
                    <th>Energi (kWh)</th>
                    <th>Biaya (Rp)</th>

                    <!-- Kolom Fasa 1 -->
                    <th>V1 (V)</th>
                    <th>A1 (A)</th>
                    <th>P1 (W)</th>
                    <th>PF1</th>
                    
                    <!-- Kolom Fasa 2 -->
                    <th>V2 (V)</th>
                    <th>A2 (A)</th>
                    <th>P2 (W)</th>
                    <th>PF2</th>

                    <!-- Kolom Fasa 3 -->
                    <th>V3 (V)</th>
                    <th>A3 (A)</th>
                    <th>P3 (W)</th>
                    <th>PF3</th>
                </tr>
            </thead>
            <tbody id="meter-table-body">
                <!-- Data akan diisi oleh JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        // --- ðŸ”¥ KONFIGURASI (WAJIB DIISI!) ---
        // Ganti dengan URL Proyek Anda (dari Supabase API Settings)
        const SUPABASE_URL = 'httpsa://URL_PROYEK_SUPABASE_ANDA.supabase.co';
        // GANTI INI dengan "anon" (PUBLIC KEY) dari Supabase API Settings
        const SUPABASE_KEY = 'ANON_PUBLIC_KEY_ANDA'; 
        // -----------------------------------

        // Inisialisasi Supabase Client
        let supabase;
        try {
             supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) {
            console.error("Gagal inisialisasi Supabase. Cek URL/Key.", e);
        }
        
        const tableBody = document.getElementById('meter-table-body');
        const lastUpdateSpan = document.getElementById('last-update');

        // Fungsi untuk mengambil data terbaru
        async function fetchData() {
            if (!supabase) {
                lastUpdateSpan.textContent = "âŒ Supabase URL/Key belum diisi.";
                return;
            }

            console.log("Mengambil data dari Supabase...");
            lastUpdateSpan.textContent = "Memuat...";

            try {
                // Panggil fungsi 'get_latest_meter_data' yang kita buat di Supabase
                // (Ini mengambil 1 data terbaru per meter_id)
                const { data, error } = await supabase.rpc('get_latest_meter_data');

                if (error) {
                    throw error;
                }

                if (data) {
                    console.log("Data diterima:", data);
                    renderTable(data);
                    lastUpdateSpan.textContent = "Data berhasil diperbarui: " + new Date().toLocaleTimeString();
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                lastUpdateSpan.textContent = `âŒ GAGAL mengambil data: ${error.message}`;
            }
        }

        // Fungsi untuk menampilkan data di tabel
        function renderTable(meters) {
            tableBody.innerHTML = ''; // Kosongkan tabel lama
            
            // Urutkan data berdasarkan meter_id
            meters.sort((a, b) => a.meter_id - b.meter_id);

            meters.forEach(meter => {
                const row = tableBody.insertRow();
                
                // Cek apakah meter offline (V=0)
                const isOffline = meter.v1 === 0 && meter.v2 === 0 && meter.v3 === 0;
                if(isOffline) {
                    row.classList.add('offline');
                }
                
                // Fungsi helper untuk memformat angka (2 desimal)
                const f = (num) => (num || 0).toFixed(2);
                // Fungsi helper untuk memformat angka (3 desimal, untuk Arus/PF)
                const f3 = (num) => (num || 0).toFixed(3);

                // Format timestamp
                const ts = new Date(meter.timestamp).toLocaleTimeString();

                // Masukkan data (HARUS URUT SESUAI <thead>)
                row.insertCell().textContent = meter.meter_id;
                row.insertCell().textContent = ts;
                row.insertCell().textContent = f(meter.frequency);
                row.insertCell().textContent = f3(meter.pf_total);
                row.insertCell().textContent = f(meter.p_total);
                row.insertCell().textContent = f(meter.q_total);
                row.insertCell().textContent = f(meter.s_total);
                row.insertCell().textContent = f(meter.energy_total);
                row.insertCell().textContent = "Rp " + f(meter.cost);
                row.insertCell().textContent = f(meter.v1);
                row.insertCell().textContent = f3(meter.a1);
                row.insertCell().textContent = f(meter.p1);
                row.insertCell().textContent = f3(meter.pf1);
                row.insertCell().textContent = f(meter.v2);
                row.insertCell().textContent = f3(meter.a2);
                row.insertCell().textContent = f(meter.p2);
                row.insertCell().textContent = f3(meter.pf2);
                row.insertCell().textContent = f(meter.v3);
                row.insertCell().textContent = f3(meter.a3);
                row.insertCell().textContent = f(meter.p3);
                row.insertCell().textContent = f3(meter.pf3);
            });
        }

        // Panggil fungsi saat halaman dimuat
        fetchData();
        
    </script>
</body>
</html>

